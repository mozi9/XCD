name: Source Commit Sync - Reset Base

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: 'æºä»“åº“åœ°å€'
        required: true
        default: 'owner/source-repo'
      source_branch:
        description: 'æºåˆ†æ”¯å'
        required: true
        default: 'susfs-2.0.0'
      target_repo:
        description: 'ç›®æ ‡ä»“åº“åœ°å€'
        required: true
        default: 'owner/target-repo'
      target_branch:
        description: 'ç›®æ ‡åˆ†æ”¯å'
        required: true
        default: 'MIUI'
      commit_hashes:
        description: 'è¦åŒæ­¥çš„æäº¤å“ˆå¸Œ'
        required: true
        default: '32ac13d'
      new_branch_name:
        description: 'æ–°åˆ†æ”¯å'
        required: false
        default: 'susfs-sync'

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  sync-reset-base:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout target repository
      uses: actions/checkout@v4
      with:
        repository: ${{ github.event.inputs.target_repo }}
        token: ${{ secrets.Mozi9_PAT }}
        ref: ${{ github.event.inputs.target_branch }}
        fetch-depth: 0

    - name: Setup Git identity
      run: |
        git config user.name "mozi9"
        git config user.email "mozi9"

    - name: Add source repository
      run: |
        git remote add source https://github.com/${{ github.event.inputs.source_repo }}.git
        git fetch source ${{ github.event.inputs.source_branch }}

    - name: Create clean branch from source base
      id: create_branch
      run: |
        # è·å–æºæäº¤çš„çˆ¶æäº¤ä½œä¸ºèµ·ç‚¹
        COMMITS=($(echo '${{ github.event.inputs.commit_hashes }}' | tr ',' ' '))
        FIRST_COMMIT=${COMMITS[0]}
        PARENT_COMMIT=$(git log --pretty=%P -n 1 "$FIRST_COMMIT")
        
        echo "æºæäº¤: $FIRST_COMMIT"
        echo "çˆ¶æäº¤: $PARENT_COMMIT"
        
        # åŸºäºçˆ¶æäº¤åˆ›å»ºæ–°åˆ†æ”¯
        git checkout -b "${{ github.event.inputs.new_branch_name }}" "$PARENT_COMMIT"
        echo "parent_commit=$PARENT_COMMIT" >> $GITHUB_OUTPUT

    - name: Apply commits with exact file copy
      id: apply_commits
      run: |
        echo "åº”ç”¨æäº¤ï¼ˆç²¾ç¡®æ–‡ä»¶å¤åˆ¶ï¼‰..."
        COMMITS=$(echo '${{ github.event.inputs.commit_hashes }}' | tr ',' ' ')
        APPLIED_COUNT=0
        
        for COMMIT in $COMMITS; do
          echo "å¤„ç†æäº¤: $COMMIT"
          
          # è·å–æäº¤ä¿¡æ¯
          ORIG_MSG=$(git log -1 --format=%B "$COMMIT")
          ORIG_DATE=$(git log -1 --format="%ci" "$COMMIT")
          CLEAN_MSG=$(echo "$ORIG_MSG" | grep -v -E "(Co-authored-by|Reviewed-by|Signed-off-by):")
          
          # è·å–æäº¤ä¸­çš„æ‰€æœ‰æ–‡ä»¶
          FILES=$(git ls-tree -r --name-only "$COMMIT")
          echo "æäº¤å®é™…åŒ…å«æ–‡ä»¶: $(echo "$FILES" | wc -l) ä¸ª"
          echo "æ–‡ä»¶åˆ—è¡¨:"
          echo "$FILES"
          
          # å¼ºåˆ¶å¤åˆ¶æ‰€æœ‰æºæ–‡ä»¶
          for file in $FILES; do
            echo "å¤åˆ¶æ–‡ä»¶: $file"
            mkdir -p "$(dirname "$file")"
            git show "$COMMIT":"$file" > "$file" 2>/dev/null || echo "âš ï¸ æ–‡ä»¶ä¸å­˜åœ¨: $file"
          done
          
          # å¤„ç†åˆ é™¤çš„æ–‡ä»¶
          DELETED_FILES=$(git diff --name-only --diff-filter=D "$COMMIT"^.."$COMMIT" 2>/dev/null || true)
          if [ -n "$DELETED_FILES" ]; then
            echo "åˆ é™¤æ–‡ä»¶: $(echo "$DELETED_FILES" | wc -l) ä¸ª"
            for dfile in $DELETED_FILES; do
              rm -f "$dfile" 2>/dev/null || true
            done
          fi
          
          # æäº¤
          git add -A
          git commit -m "$CLEAN_MSG" --author="mozi9 <mozi9>" --date="$ORIG_DATE"
          
          # éªŒè¯æäº¤
          COMMIT_STATS=$(git log -1 --stat)
          echo "æäº¤ç»Ÿè®¡:"
          echo "$COMMIT_STATS"
          
          APPLIED_COUNT=$((APPLIED_COUNT + 1))
          echo "âœ… æäº¤åº”ç”¨å®Œæˆ"
        done
        
        echo "applied_count=$APPLIED_COUNT" >> $GITHUB_OUTPUT

    - name: Push to new branch
      run: |
        git push -u origin "${{ github.event.inputs.new_branch_name }}"
        echo "âœ… æ¨é€å®Œæˆ"

    - name: Final verification
      run: |
        echo ""
        echo "ğŸ‰ ç²¾ç¡®åŒæ­¥å®Œæˆ!"
        echo "=========================================="
        echo "ğŸ“Š æ–‡ä»¶éªŒè¯:"
        echo "  æºæäº¤æ–‡ä»¶æ•°: 13 ä¸ª"
        echo "  å®é™…æäº¤æ–‡ä»¶æ•°: $(git ls-tree -r --name-only HEAD | wc -l) ä¸ª"
        echo "  æäº¤ç»Ÿè®¡:"
        git log -1 --stat
        echo "=========================================="

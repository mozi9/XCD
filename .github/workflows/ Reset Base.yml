name: Source Commit Sync - Preserve History

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: 'æºä»“åº“åœ°å€'
        required: true
        default: 'owner/source-repo'
      source_branch:
        description: 'æºåˆ†æ”¯å'
        required: true
        default: 'susfs-2.0.0'
      target_repo:
        description: 'ç›®æ ‡ä»“åº“åœ°å€'
        required: true
        default: 'owner/target-repo'
      target_branch:
        description: 'ç›®æ ‡åˆ†æ”¯å'
        required: true
        default: 'main'
      commit_hashes:
        description: 'è¦åŒæ­¥çš„æäº¤å“ˆå¸Œ'
        required: true
        default: '32ac13d'
      new_branch_name:
        description: 'æ–°åˆ†æ”¯åï¼ˆå¿…éœ€ï¼‰'
        required: true
        default: 'sync-source-commits'

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  preserve-history-sync:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout target repository
      uses: actions/checkout@v4
      with:
        repository: ${{ github.event.inputs.target_repo }}
        token: ${{ secrets.Mozi9_PAT }}
        ref: ${{ github.event.inputs.target_branch }}
        fetch-depth: 0

    - name: Setup Git identity
      run: |
        git config user.name "mozi9"
        git config user.email "mozi9"

    - name: Add source repository
      run: |
        git remote add source https://github.com/${{ github.event.inputs.source_repo }}.git
        git fetch source ${{ github.event.inputs.source_branch }}

    - name: Create new branch from target
      id: create_branch
      run: |
        # åŸºäºç›®æ ‡åˆ†æ”¯åˆ›å»ºæ–°åˆ†æ”¯
        git checkout -b "${{ github.event.inputs.new_branch_name }}"
        echo "âœ… åˆ›å»ºæ–°åˆ†æ”¯: ${{ github.event.inputs.new_branch_name }}"
        echo "âœ… ç›®æ ‡åˆ†æ”¯ ${{ github.event.inputs.target_branch }} å†å²ä¿æŒä¸å˜"

    - name: Apply commits to new branch
      id: apply_commits
      run: |
        echo "åº”ç”¨æäº¤åˆ°æ–°åˆ†æ”¯..."
        COMMITS=$(echo '${{ github.event.inputs.commit_hashes }}' | tr ',' ' ')
        
        for COMMIT in $COMMITS; do
          echo "å¤„ç†æäº¤: $COMMIT"
          
          # è·å–æäº¤ä¿¡æ¯
          ORIG_MSG=$(git log -1 --format=%B "$COMMIT")
          ORIG_DATE=$(git log -1 --format="%ci" "$COMMIT")
          CLEAN_MSG=$(echo "$ORIG_MSG" | grep -v -E "(Co-authored-by|Reviewed-by|Signed-off-by):")
          
          # è·å–ä¿®æ”¹çš„æ–‡ä»¶
          MODIFIED_FILES=$(git show --name-only --format= "$COMMIT" | grep -v '^$')
          echo "ä¿®æ”¹æ–‡ä»¶: $(echo "$MODIFIED_FILES" | wc -l) ä¸ª"
          
          # å¤åˆ¶æ–‡ä»¶
          for file in $MODIFIED_FILES; do
            mkdir -p "$(dirname "$file")"
            git show "$COMMIT":"$file" > "$file" 2>/dev/null || true
          done
          
          # æäº¤åˆ°æ–°åˆ†æ”¯
          git add -A
          git commit -m "$CLEAN_MSG" --author="mozi9 <mozi9>" --date="$ORIG_DATE"
        done
        
        echo "âœ… æ‰€æœ‰æäº¤å·²åº”ç”¨åˆ°æ–°åˆ†æ”¯"

    - name: Push only new branch
      id: push_branch
      run: |
        # åªæ¨é€æ–°åˆ†æ”¯ï¼Œä¸ä¿®æ”¹ç›®æ ‡åˆ†æ”¯
        git push -u origin "${{ github.event.inputs.new_branch_name }}"
        echo "âœ… æ–°åˆ†æ”¯å·²æ¨é€"
        echo "âœ… ç›®æ ‡åˆ†æ”¯ ${{ github.event.inputs.target_branch }} ä¿æŒä¸å˜"

    - name: Create pull request (å¯é€‰)
      id: create_pr
      uses: actions/github-script@v6
      with:
        script: |
          await github.rest.pulls.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'sync: åŒæ­¥æºæäº¤',
            head: '${{ github.event.inputs.new_branch_name }}',
            base: '${{ github.event.inputs.target_branch }}',
            body: 'è‡ªåŠ¨åˆ›å»ºçš„åŒæ­¥è¯·æ±‚\n\næºæäº¤: ${{ github.event.inputs.commit_hashes }}'
          });

    - name: Final report
      run: |
        echo ""
        echo "ğŸ‰ åŒæ­¥å®Œæˆ!"
        echo "=========================================="
        echo "âœ… å†å²ä¿æŠ¤:"
        echo "  ç›®æ ‡åˆ†æ”¯: ${{ github.event.inputs.target_branch }} - æœªä¿®æ”¹"
        echo "  åˆ›å»ºæ–°åˆ†æ”¯: ${{ github.event.inputs.new_branch_name }}"
        echo "  æäº¤æ•°é‡: $(echo '${{ github.event.inputs.commit_hashes }}' | tr ',' ' ' | wc -w) ä¸ª"
        echo ""
        echo "ğŸ”— ä¸‹ä¸€æ­¥æ“ä½œ:"
        echo "  1. å®¡æŸ¥æ–°åˆ†æ”¯çš„æ›´æ”¹"
        echo "  2. æ‰‹åŠ¨åˆå¹¶åˆ°ç›®æ ‡åˆ†æ”¯ï¼ˆå¦‚éœ€ï¼‰"
        echo "  3. æˆ–ç­‰å¾…PRå®¡æŸ¥"
        echo ""
        echo "âš ï¸ é‡è¦: ç›®æ ‡ä»“åº“å†å²ä¿æŒä¸å˜"
        echo "=========================================="

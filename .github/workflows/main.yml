name: 仓库同步与合并

on:
  workflow_dispatch:
    inputs:
      operation_type:
        description: '选择操作类型'
        required: true
        type: choice
        options:
          - 拉取仓库分支
          - 合并特定提交
      source_repo_url:
        description: '源仓库链接 (支持带分支的链接)'
        required: true
        default: 'https://github.com/ApartTUSITU/kernel_xiaomi_sm8250_mod'
      target_repo_url:
        description: '目标仓库链接 (留空则使用当前仓库)'
        required: false
        default: ''
      new_branch_name:
        description: '新建分支名称 (仅在"拉取仓库分支"时使用)'
        required: false
        default: ''
      source_commit:
        description: '源提交哈希 (仅在"合并特定提交"时使用)'
        required: false
        default: ''
      target_branch:
        description: '目标分支 (仅在"合并特定提交"时使用)'
        required: false
        default: ''
      conflict_resolution:
        description: '冲突解决策略'
        required: false
        type: choice
        options:
          - 自动使用源版本
          - 自动使用目标版本
          - 手动解决（停止工作流）
        default: '手动解决（停止工作流）'

jobs:
  repository-operation:
    runs-on: ubuntu-latest
    steps:
      - name: 解析链接和分支信息
        id: parse_url
        run: |
          SOURCE_REPO_URL="${{ github.event.inputs.source_repo_url }}"
          
          if [[ $SOURCE_REPO_URL =~ https://github.com/([^/]+)/([^/]+)/tree/([^/]+) ]]; then
            SOURCE_OWNER="${BASH_REMATCH[1]}"
            SOURCE_REPO="${BASH_REMATCH[2]}"
            SOURCE_BRANCH="${BASH_REMATCH[3]}"
            echo "检测到带分支的链接，分支: $SOURCE_BRANCH"
          elif [[ $SOURCE_REPO_URL =~ https://github.com/([^/]+)/([^/]+)$ ]]; then
            SOURCE_OWNER="${BASH_REMATCH[1]}"
            SOURCE_REPO="${BASH_REMATCH[2]}"
            SOURCE_BRANCH=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/$SOURCE_OWNER/$SOURCE_REPO" | jq -r '.default_branch')
            echo "默认分支: $SOURCE_BRANCH"
          else
            echo "错误: 源仓库链接格式不正确"
            exit 1
          fi
          
          echo "source_owner=$SOURCE_OWNER" >> $GITHUB_OUTPUT
          echo "source_repo=$SOURCE_REPO" >> $GITHUB_OUTPUT
          echo "source_branch=$SOURCE_BRANCH" >> $GITHUB_OUTPUT
          echo "source_full_name=$SOURCE_OWNER/$SOURCE_REPO" >> $GITHUB_OUTPUT
          
          TARGET_REPO_URL="${{ github.event.inputs.target_repo_url }}"
          if [ -z "$TARGET_REPO_URL" ]; then
            echo "target_owner=${{ github.repository_owner }}" >> $GITHUB_OUTPUT
            echo "target_repo=${{ github.event.repository.name }}" >> $GITHUB_OUTPUT
            echo "target_full_name=${{ github.repository }}" >> $GITHUB_OUTPUT
          elif [[ $TARGET_REPO_URL =~ https://github.com/([^/]+)/([^/]+) ]]; then
            TARGET_OWNER="${BASH_REMATCH[1]}"
            TARGET_REPO="${BASH_REMATCH[2]}"
            echo "target_owner=$TARGET_OWNER" >> $GITHUB_OUTPUT
            echo "target_repo=$TARGET_REPO" >> $GITHUB_OUTPUT
            echo "target_full_name=$TARGET_OWNER/$TARGET_REPO" >> $GITHUB_OUTPUT
          else
            echo "错误: 目标仓库链接格式不正确"
            exit 1
          fi

      - name: 检出目标仓库
        uses: actions/checkout@v4
        with:
          repository: ${{ steps.parse_url.outputs.target_full_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: 配置Git身份信息
        run: |
          git config --global user.name "mozi9"
          git config --global user.email "mozi9"
          git config --global push.default simple

      - name: 添加源仓库远程并获取指定分支
        run: |
          git remote add source https://${{ secrets.GITHUB_TOKEN }}@github.com/${{ steps.parse_url.outputs.source_full_name }}.git
          git fetch source ${{ steps.parse_url.outputs.source_branch }}

      - name: 执行拉取仓库分支操作
        if: ${{ github.event.inputs.operation_type == '拉取仓库分支' }}
        run: |
          SOURCE_BRANCH="${{ steps.parse_url.outputs.source_branch }}"
          
          if [ -z "${{ github.event.inputs.new_branch_name }}" ]; then
            NEW_BRANCH="sync-$SOURCE_BRANCH"
          else
            NEW_BRANCH="${{ github.event.inputs.new_branch_name }}"
          fi
          
          if git show-ref --verify --quiet refs/heads/$NEW_BRANCH; then
            git branch -D $NEW_BRANCH || true
          fi
          
          git checkout -b $NEW_BRANCH source/$SOURCE_BRANCH
          
          git filter-branch -f --env-filter '
            export GIT_AUTHOR_NAME="mozi9"
            export GIT_AUTHOR_EMAIL="mozi9"
            export GIT_COMMITTER_NAME="mozi9"
            export GIT_COMMITTER_EMAIL="mozi9"
          ' -- --all
          
          git push -u origin $NEW_BRANCH --force

      - name: 执行合并特定提交操作
        if: ${{ github.event.inputs.operation_type == '合并特定提交' }}
        run: |
          if [ -z "${{ github.event.inputs.source_commit }}" ]; then
            echo "错误: 源提交哈希不能为空"
            exit 1
          fi
          
          if [ -z "${{ github.event.inputs.target_branch }}" ]; then
            TARGET_BRANCH="${{ github.ref_name }}"
          else
            TARGET_BRANCH="${{ github.event.inputs.target_branch }}"
          fi
          
          git checkout $TARGET_BRANCH
          git pull origin $TARGET_BRANCH
          
          COMMIT_HASH="${{ github.event.inputs.source_commit }}"
          if ! git cat-file -e $COMMIT_HASH^0; then
            git fetch source $COMMIT_HASH || exit 1
          fi
          
          if git merge-base --is-ancestor $COMMIT_HASH HEAD; then
            echo "提交已存在，跳过"
          else
            # 尝试cherry-pick
            if ! git cherry-pick $COMMIT_HASH; then
              echo "检测到合并冲突，尝试自动解决..."
              
              case "${{ github.event.inputs.conflict_resolution }}" in
                "自动使用源版本")
                  echo "使用源版本解决冲突..."
                  # 对于每个冲突文件，使用源版本
                  git status --porcelain | grep -E '^(AA|UU)' | cut -c4- | while read file; do
                    if [ -f "$file" ]; then
                      echo "使用源版本: $file"
                      git checkout --theirs -- "$file"
                      git add "$file"
                    fi
                  done
                  
                  # 处理删除冲突
                  git status --porcelain | grep -E '^UD' | cut -c4- | while read file; do
                    echo "删除文件: $file"
                    git rm "$file"
                  done
                  
                  git cherry-pick --continue
                  ;;
                  
                "自动使用目标版本")
                  echo "使用目标版本解决冲突..."
                  # 对于每个冲突文件，使用目标版本
                  git status --porcelain | grep -E '^(AA|UU)' | cut -c4- | while read file; do
                    if [ -f "$file" ]; then
                      echo "使用目标版本: $file"
                      git checkout --ours -- "$file"
                      git add "$file"
                    fi
                  done
                  
                  git cherry-pick --continue
                  ;;
                  
                *)
                  echo "冲突需要手动解决"
                  echo "冲突文件列表:"
                  git status --porcelain
                  echo "请手动解决冲突后，运行: git cherry-pick --continue"
                  exit 1
                  ;;
              esac
            fi
            
            # 重写作者信息
            git commit --amend --author="mozi9 <mozi9>" --no-edit
            git push origin $TARGET_BRANCH
          fi

      - name: 验证作者信息
        run: |
          if [ "${{ github.event.inputs.operation_type }}" == "拉取仓库分支" ]; then
            if [ -z "${{ github.event.inputs.new_branch_name }}" ]; then
              BRANCH_NAME="sync-${{ steps.parse_url.outputs.source_branch }}"
            else
              BRANCH_NAME="${{ github.event.inputs.new_branch_name }}"
            fi
          else
            if [ -z "${{ github.event.inputs.target_branch }}" ]; then
              BRANCH_NAME="${{ github.ref_name }}"
            else
              BRANCH_NAME="${{ github.event.inputs.target_branch }}"
            fi
          fi
          
          git checkout $BRANCH_NAME
          AUTHOR_NAME=$(git log -1 --format="%an")
          
          if [ "$AUTHOR_NAME" == "mozi9" ]; then
            echo "作者信息验证通过"
          else
            echo "作者信息验证失败"
            exit 1
          fi

      - name: 清理冲突文件
        if: always()
        run: |
          # 清理可能的冲突残留文件
          find . -name "*.orig" -delete
          find . -name "*.BACKUP" -delete
          find . -name "*.BASE" -delete
          find . -name "*.LOCAL" -delete
          find . -name "*.REMOTE" -delete
          git clean -fd || true

      - name: 生成操作摘要
        run: |
          echo "操作执行完成"
          echo "操作类型: ${{ github.event.inputs.operation_type }}"
          echo "源仓库: ${{ steps.parse_url.outputs.source_full_name }}"
          echo "源分支: ${{ steps.parse_url.outputs.source_branch }}"
          echo "目标仓库: ${{ steps.parse_url.outputs.target_full_name }}"

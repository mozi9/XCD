name: Sync Repository from Source

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: 'Ê∫ê‰ªìÂ∫ì (Ê†ºÂºè: owner/repo)'
        required: true
        type: string
        default: 'mozi9/MIUI'
      source_branch:
        description: 'Ê∫êÂàÜÊîØÂêçÁß∞ (ÁïôÁ©∫‰ΩøÁî®ÈªòËÆ§ÂàÜÊîØ)'
        required: false
        type: string
        default: ''
      target_branch:
        description: 'ÁõÆÊ†áÂàÜÊîØÂêçÁß∞'
        required: true
        type: string
        default: 'sync-from-source'
      force_push:
        description: 'ÊòØÂê¶Âº∫Âà∂Êé®ÈÄÅ'
        required: false
        type: choice
        options:
          - 'false'
          - 'true'
        default: 'false'

env:
  # ‰ΩøÁî®ÂΩìÂâçÂ∑•‰ΩúÊµÅÁ®ãÁöÑ‰ª§ÁâåÔºåÊàñËÄÖËá™ÂÆö‰πâ PAT
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  sync-repository:
    name: Sync from ${{ github.event.inputs.source_repo }}
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout target repository
      uses: actions/checkout@v4
      with:
        token: ${{ env.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Get source repository default branch
      id: get_source
      run: |
        SOURCE_REPO="${{ github.event.inputs.source_repo }}"
        
        # Â¶ÇÊûúÊú™ÊåáÂÆöÊ∫êÂàÜÊîØÔºåËá™Âä®Ëé∑ÂèñÈªòËÆ§ÂàÜÊîØ
        if [ -z "${{ github.event.inputs.source_branch }}" ]; then
          echo "Detecting default branch for $SOURCE_REPO..."
          
          # ‰ΩøÁî® GitHub API Ëé∑ÂèñÈªòËÆ§ÂàÜÊîØ
          DEFAULT_BRANCH=$(curl -s \
            -H "Authorization: token ${{ env.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$SOURCE_REPO" | \
            jq -r '.default_branch // "main"')
          
          # Â¶ÇÊûú API Ë∞ÉÁî®Â§±Ë¥•Ôºå‰ΩøÁî®ÈªòËÆ§ÂÄº
          if [ "$DEFAULT_BRANCH" = "null" ] || [ -z "$DEFAULT_BRANCH" ]; then
            DEFAULT_BRANCH="main"
          fi
          
          echo "source_branch=$DEFAULT_BRANCH" >> $GITHUB_OUTPUT
          echo "Using default branch: $DEFAULT_BRANCH"
        else
          echo "source_branch=${{ github.event.inputs.source_branch }}" >> $GITHUB_OUTPUT
          echo "Using specified branch: ${{ github.event.inputs.source_branch }}"
        fi

    - name: Add source repository as remote
      run: |
        SOURCE_REPO="${{ github.event.inputs.source_repo }}"
        SOURCE_BRANCH="${{ steps.get_source.outputs.source_branch }}"
        
        echo "Adding source remote: $SOURCE_REPO"
        git remote add source "https://github.com/$SOURCE_REPO.git"
        
        echo "Fetching source branch: $SOURCE_BRANCH"
        git fetch source "$SOURCE_BRANCH" --depth=1

    - name: Create or update target branch
      run: |
        TARGET_BRANCH="${{ github.event.inputs.target_branch }}"
        SOURCE_BRANCH="${{ steps.get_source.outputs.source_branch }}"
        
        # Ê£ÄÊü•ÁõÆÊ†áÂàÜÊîØÊòØÂê¶Â≠òÂú®
        if git show-ref --verify --quiet "refs/heads/$TARGET_BRANCH"; then
          echo "Target branch '$TARGET_BRANCH' exists, updating..."
          git checkout "$TARGET_BRANCH"
          git reset --hard "source/$SOURCE_BRANCH"
        else
          echo "Creating new target branch: $TARGET_BRANCH"
          git checkout -b "$TARGET_BRANCH" "source/$SOURCE_BRANCH"
        fi

    - name: Configure Git identity
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Push to target repository
      run: |
        TARGET_BRANCH="${{ github.event.inputs.target_branch }}"
        FORCE_PUSH="${{ github.event.inputs.force_push }}"
        
        if [ "$FORCE_PUSH" = "true" ]; then
          echo "Force pushing to $TARGET_BRANCH"
          git push origin "$TARGET_BRANCH" --force
        else
          echo "Pushing to $TARGET_BRANCH with lease"
          git push origin "$TARGET_BRANCH" --force-with-lease
        fi

    - name: Display sync summary
      run: |
        echo "‚úÖ Sync completed successfully!"
        echo "üì¶ Source: ${{ github.event.inputs.source_repo }}:${{ steps.get_source.outputs.source_branch }}"
        echo "üéØ Target: ${{ github.repository }}:${{ github.event.inputs.target_branch }}"
        echo "üìä Latest commit:"
        git log -1 --oneline
        echo ""
        echo "üîó Branch URL: https://github.com/${{ github.repository }}/tree/${{ github.event.inputs.target_branch }}"

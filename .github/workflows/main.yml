name: ä»“åº“åŒæ­¥ä¸åˆå¹¶

on:
  workflow_dispatch:
    inputs:
      operation_type:
        description: 'é€‰æ‹©æ“ä½œç±»å‹'
        required: true
        type: choice
        options:
          - æ‹‰å–ä»“åº“åˆ†æ”¯
          - åˆå¹¶ç‰¹å®šæäº¤
      source_repo:
        description: 'æºä»“åº“ (æ ¼å¼: ç”¨æˆ·å/ä»“åº“å)'
        required: true
        default: ''
      source_branch:
        description: 'æºåˆ†æ”¯'
        required: true
        default: ''
      source_commit:
        description: 'æºæäº¤å“ˆå¸Œ (ä»…åœ¨"åˆå¹¶ç‰¹å®šæäº¤"æ—¶ä½¿ç”¨)'
        required: false
        default: ''
      target_repo:
        description: 'ç›®æ ‡ä»“åº“ (æ ¼å¼: ç”¨æˆ·å/ä»“åº“åï¼Œç•™ç©ºåˆ™ä½¿ç”¨å½“å‰ä»“åº“)'
        required: false
        default: ''
      target_branch:
        description: 'ç›®æ ‡åˆ†æ”¯ (ä»…åœ¨"åˆå¹¶ç‰¹å®šæäº¤"æ—¶ä½¿ç”¨)'
        required: false
        default: ''
      new_branch_name:
        description: 'æ–°å»ºåˆ†æ”¯åç§° (ä»…åœ¨"æ‹‰å–ä»“åº“åˆ†æ”¯"æ—¶ä½¿ç”¨)'
        required: false
        default: ''

jobs:
  repository-operation:
    runs-on: ubuntu-latest
    steps:
      - name: éªŒè¯è¾“å…¥å‚æ•°
        id: validate
        run: |
          # è®¾ç½®ç›®æ ‡ä»“åº“ï¼Œå¦‚æœä¸ºç©ºåˆ™ä½¿ç”¨å½“å‰ä»“åº“
          if [ -z "${{ github.event.inputs.target_repo }}" ]; then
            echo "target_repo=${{ github.repository }}" >> $GITHUB_OUTPUT
          else
            echo "target_repo=${{ github.event.inputs.target_repo }}" >> $GITHUB_OUTPUT
          fi
          
          # éªŒè¯å¿…å¡«å‚æ•°
          if [ -z "${{ github.event.inputs.source_repo }}" ]; then
            echo "é”™è¯¯: æºä»“åº“ä¸èƒ½ä¸ºç©º"
            exit 1
          fi
          
          if [ -z "${{ github.event.inputs.source_branch }}" ]; then
            echo "é”™è¯¯: æºåˆ†æ”¯ä¸èƒ½ä¸ºç©º"
            exit 1
          fi

      - name: æ£€å‡ºç›®æ ‡ä»“åº“
        uses: actions/checkout@v4
        with:
          repository: ${{ steps.validate.outputs.target_repo }}
          token: ${{ secrets.Mozi9_PAT }}
          fetch-depth: 0

      - name: é…ç½®Gitèº«ä»½ä¿¡æ¯
        run: |
          git config --global user.name "mozi9"
          git config --global user.email "mozi9"
          git config --global push.default simple

      - name: æ·»åŠ æºä»“åº“è¿œç¨‹
        run: |
          echo "æ­£åœ¨æ·»åŠ æºä»“åº“è¿œç¨‹..."
          git remote add source https://${{ secrets.Mozi9_PAT }}@github.com/${{ github.event.inputs.source_repo }}.git
          git fetch source ${{ github.event.inputs.source_branch }} --depth=1

      - name: æ‰§è¡Œæ‹‰å–ä»“åº“åˆ†æ”¯æ“ä½œ
        if: ${{ github.event.inputs.operation_type == 'æ‹‰å–ä»“åº“åˆ†æ”¯' }}
        run: |
          echo "å¼€å§‹æ‰§è¡Œæ‹‰å–ä»“åº“åˆ†æ”¯æ“ä½œ..."
          
          # è®¾ç½®é»˜è®¤æ–°åˆ†æ”¯åç§°
          if [ -z "${{ github.event.inputs.new_branch_name }}" ]; then
            NEW_BRANCH="sync-${{ github.event.inputs.source_branch }}"
            echo "ä½¿ç”¨é»˜è®¤åˆ†æ”¯åç§°: $NEW_BRANCH"
          else
            NEW_BRANCH="${{ github.event.inputs.new_branch_name }}"
          fi
          
          # æ£€æŸ¥æ–°åˆ†æ”¯æ˜¯å¦å·²å­˜åœ¨
          if git show-ref --verify --quiet refs/heads/$NEW_BRANCH; then
            echo "åˆ†æ”¯ $NEW_BRANCH å·²å­˜åœ¨ï¼Œå°†è¦†ç›–"
            git branch -D $NEW_BRANCH || true
          fi
          
          # åˆ›å»ºæ–°åˆ†æ”¯å¹¶åˆ‡æ¢åˆ°æºåˆ†æ”¯å†…å®¹
          git checkout -b $NEW_BRANCH source/${{ github.event.inputs.source_branch }}
          
          echo "æ­£åœ¨é‡å†™æäº¤ä½œè€…ä¿¡æ¯..."
          # é‡å†™æ‰€æœ‰æäº¤çš„ä½œè€…ä¿¡æ¯
          git filter-branch --env-filter '
            export GIT_COMMITTER_NAME="mozi9"
            export GIT_COMMITTER_EMAIL="mozi9"
            export GIT_AUTHOR_NAME="mozi9" 
            export GIT_AUTHOR_EMAIL="mozi9"
          ' -- --all
          
          echo "æ­£åœ¨æ¨é€åˆ°è¿œç¨‹ä»“åº“..."
          git push origin $NEW_BRANCH --force
          echo "âœ… æ‹‰å–ä»“åº“åˆ†æ”¯æ“ä½œå®Œæˆ!"

      - name: æ‰§è¡Œåˆå¹¶ç‰¹å®šæäº¤æ“ä½œ
        if: ${{ github.event.inputs.operation_type == 'åˆå¹¶ç‰¹å®šæäº¤' }}
        run: |
          echo "å¼€å§‹æ‰§è¡Œåˆå¹¶ç‰¹å®šæäº¤æ“ä½œ..."
          
          # éªŒè¯æäº¤å‚æ•°
          if [ -z "${{ github.event.inputs.source_commit }}" ]; then
            echo "é”™è¯¯: æºæäº¤å“ˆå¸Œä¸èƒ½ä¸ºç©º"
            exit 1
          fi
          
          if [ -z "${{ github.event.inputs.target_branch }}" ]; then
            echo "é”™è¯¯: ç›®æ ‡åˆ†æ”¯ä¸èƒ½ä¸ºç©º"
            exit 1
          fi
          
          # åˆ‡æ¢åˆ°ç›®æ ‡åˆ†æ”¯
          git checkout ${{ github.event.inputs.target_branch }}
          git pull origin ${{ github.event.inputs.target_branch }}
          
          # éªŒè¯æäº¤æ˜¯å¦å­˜åœ¨
          if ! git cat-file -e ${{ github.event.inputs.source_commit }}; then
            echo "é”™è¯¯: æäº¤ ${{ github.event.inputs.source_commit }} ä¸å­˜åœ¨"
            exit 1
          fi
          
          # è·å–æäº¤ä¿¡æ¯
          git show --format=format:"%B" ${{ github.event.inputs.source_commit }} --quiet > commit_message.txt
          echo "æäº¤ä¿¡æ¯: $(cat commit_message.txt)"
          
          # æ£€æŸ¥æ˜¯å¦å·²ç»åŒ…å«è¯¥æäº¤
          if git merge-base --is-ancestor ${{ github.event.inputs.source_commit }} HEAD; then
            echo "âš ï¸ æäº¤å·²å­˜åœ¨äºç›®æ ‡åˆ†æ”¯ä¸­ï¼Œè·³è¿‡cherry-pick"
          else
            echo "æ­£åœ¨åº”ç”¨æäº¤æ›´æ”¹..."
            # åº”ç”¨æ›´æ”¹ä½†ä¸æäº¤
            git cherry-pick --no-commit ${{ github.event.inputs.source_commit }}
            
            # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹éœ€è¦æäº¤
            if git diff-index --quiet HEAD --; then
              echo "âš ï¸ æ²¡æœ‰æ›´æ”¹éœ€è¦æäº¤ï¼Œå¯èƒ½æäº¤å·²åº”ç”¨"
            else
              echo "æ­£åœ¨æäº¤æ›´æ”¹..."
              git add .
              git commit -m "$(cat commit_message.txt)" --author="mozi9 <mozi9>"
              
              echo "æ­£åœ¨æ¨é€åˆ°è¿œç¨‹ä»“åº“..."
              git push origin ${{ github.event.inputs.target_branch }}
              echo "âœ… åˆå¹¶ç‰¹å®šæäº¤æ“ä½œå®Œæˆ!"
            fi
          fi

      - name: æ¸…ç†å·¥ä½œ
        run: |
          git remote remove source || true
          rm -f commit_message.txt || true
          echo "æ¸…ç†å®Œæˆ"

      - name: ç”Ÿæˆæ“ä½œæ‘˜è¦
        run: |
          echo "ğŸ‰ æ“ä½œæ‰§è¡Œå®Œæˆ!"
          echo "================================"
          echo "æ“ä½œç±»å‹: ${{ github.event.inputs.operation_type }}"
          echo "æºä»“åº“: ${{ github.event.inputs.source_repo }}"
          echo "æºåˆ†æ”¯: ${{ github.event.inputs.source_branch }}"
          echo "ç›®æ ‡ä»“åº“: ${{ steps.validate.outputs.target_repo }}"
          
          if [ "${{ github.event.inputs.operation_type }}" == "æ‹‰å–ä»“åº“åˆ†æ”¯" ]; then
            if [ -z "${{ github.event.inputs.new_branch_name }}" ]; then
              echo "æ–°å»ºåˆ†æ”¯: sync-${{ github.event.inputs.source_branch }}"
            else
              echo "æ–°å»ºåˆ†æ”¯: ${{ github.event.inputs.new_branch_name }}"
            fi
          else
            echo "æºæäº¤: ${{ github.event.inputs.source_commit }}"
            echo "ç›®æ ‡åˆ†æ”¯: ${{ github.event.inputs.target_branch }}"
          fi
          echo "================================"

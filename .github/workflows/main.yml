name: Sync Repository Branch

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: '源仓库地址 (格式: owner/repo)'
        required: true
        type: string
      source_branch:
        description: '源分支名称 (留空使用默认分支)'
        required: false
        type: string
      target_repo:
        description: '目标仓库地址 (格式: owner/repo，留空使用当前仓库)'
        required: false
        type: string
        default: ''
      target_branch:
        description: '目标分支名称'
        required: true
        type: string
      source_path:
        description: '要同步的源仓库路径 (留空同步整个仓库)'
        required: false
        type: string
        default: ''

env:
  PAT_TOKEN: ${{ secrets.Mozi9_PAT }}

jobs:
  sync-repository:
    name: Sync Repository Branch
    runs-on: ubuntu-latest
    
    steps:
    - name: Determine target repository
      id: target_info
      run: |
        if [ -z "${{ github.event.inputs.target_repo }}" ]; then
          echo "target_repo=${{ github.repository }}" >> $GITHUB_OUTPUT
        else
          echo "target_repo=${{ github.event.inputs.target_repo }}" >> $GITHUB_OUTPUT
        fi

    - name: Checkout target repository
      uses: actions/checkout@v4
      with:
        token: ${{ env.PAT_TOKEN }}
        repository: ${{ steps.target_info.outputs.target_repo }}
        ref: ${{ github.event.inputs.target_branch }}
        fetch-depth: 0

    - name: Determine source default branch
      id: source_info
      if: inputs.source_branch == ''
      run: |
        # 获取源仓库的默认分支
        default_branch=$(curl -s -H "Authorization: token ${{ env.PAT_TOKEN }}" \
          "https://api.github.com/repos/${{ github.event.inputs.source_repo }}" | \
          jq -r .default_branch)
        echo "default_branch=$default_branch" >> $GITHUB_OUTPUT
        echo "Using default branch: $default_branch"

    - name: Set source branch
      id: set_branch
      run: |
        if [ -z "${{ github.event.inputs.source_branch }}" ]; then
          echo "source_branch=${{ steps.source_info.outputs.default_branch }}" >> $GITHUB_OUTPUT
        else
          echo "source_branch=${{ github.event.inputs.source_branch }}" >> $GITHUB_OUTPUT
        fi

    - name: Add source repository as remote
      run: |
        git remote add source https://${{ env.PAT_TOKEN }}@github.com/${{ github.event.inputs.source_repo }}.git
        git fetch source ${{ steps.set_branch.outputs.source_branch }} --depth=1

    - name: Create and checkout target branch
      run: |
        # 检查目标分支是否存在
        if git show-ref --verify --quiet refs/heads/${{ github.event.inputs.target_branch }}; then
          echo "Target branch exists, switching to it"
          git checkout ${{ github.event.inputs.target_branch }}
          git merge --ff-only source/${{ steps.set_branch.outputs.source_branch }} || \
            { echo "Fast-forward merge failed, performing regular merge"; git merge --no-edit source/${{ steps.set_branch.outputs.source_branch }}; }
        else
          echo "Creating new target branch"
          git checkout -b ${{ github.event.inputs.target_branch }} source/${{ steps.set_branch.outputs.source_branch }}
        fi

    - name: Sync specific path (if specified)
      if: github.event.inputs.source_path != ''
      run: |
        # 如果指定了路径，只同步特定路径
        git checkout source/${{ steps.set_branch.outputs.source_branch }} -- ${{ github.event.inputs.source_path }}
        git add ${{ github.event.inputs.source_path }}

    - name: Configure Git identity
      run: |
        git config user.name "mozi9"
        git config user.email "mozi9"

    - name: Commit changes
      run: |
        if git diff --cached --quiet; then
          echo "No changes to commit"
        else
          git commit -m "Sync from ${{ github.event.inputs.source_repo }}:${{ steps.set_branch.outputs.source_branch }} to ${{ steps.target_info.outputs.target_repo }}:${{ github.event.inputs.target_branch }}"
        fi

    - name: Push to target repository
      run: |
        git push https://${{ env.PAT_TOKEN }}@github.com/${{ steps.target_info.outputs.target_repo }}.git ${{ github.event.inputs.target_branch }} --force-with-lease

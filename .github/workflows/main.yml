name: Cross Repository Sync

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: 'æºä»“åº“é“¾æ¥ (æ ¼å¼: owner/repo)'
        required: true
        type: string
        default: 'mozi9/MIUI'
      source_branch:
        description: 'æºåˆ†æ”¯åç§° (ç•™ç©ºä½¿ç”¨é»˜è®¤åˆ†æ”¯)'
        required: false
        type: string
        default: ''
      target_repo:
        description: 'ç›®æ ‡ä»“åº“é“¾æ¥ (æ ¼å¼: owner/repo)'
        required: true
        type: string
        default: ''
      target_branch:
        description: 'ç›®æ ‡åˆ†æ”¯åç§° (æ–°å»ºåˆ†æ”¯)'
        required: true
        type: string
        default: 'sync-from-source'
      pat_token:
        description: 'PATä»¤ç‰Œ (éœ€è¦æœ‰ç›®æ ‡ä»“åº“å†™å…¥æƒé™)'
        required: true
        type: string
        default: ''

env:
  # ä½¿ç”¨æä¾›çš„ PAT ä»¤ç‰Œ
  CUSTOM_PAT: ${{ github.event.inputs.pat_token }}

jobs:
  cross-repo-sync:
    name: Sync ${{ github.event.inputs.source_repo }} â†’ ${{ github.event.inputs.target_repo }}
    runs-on: ubuntu-latest
    
    steps:
    - name: Validate inputs
      id: validate
      run: |
        if [ -z "${{ github.event.inputs.target_repo }}" ]; then
          echo "âŒ ç›®æ ‡ä»“åº“ä¸èƒ½ä¸ºç©º"
          exit 1
        fi
        
        if [ -z "${{ env.CUSTOM_PAT }}" ]; then
          echo "âŒ PATä»¤ç‰Œä¸èƒ½ä¸ºç©º"
          exit 1
        fi
        
        echo "âœ… è¾“å…¥éªŒè¯é€šè¿‡"

    - name: Get source repository info
      id: source_info
      run: |
        SOURCE_REPO="${{ github.event.inputs.source_repo }}"
        
        # è‡ªåŠ¨æ£€æµ‹æºä»“åº“é»˜è®¤åˆ†æ”¯
        if [ -z "${{ github.event.inputs.source_branch }}" ]; then
          echo "ğŸ” æ£€æµ‹æºä»“åº“é»˜è®¤åˆ†æ”¯..."
          DEFAULT_BRANCH=$(curl -s \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$SOURCE_REPO" | \
            jq -r '.default_branch // "main"')
          
          if [ "$DEFAULT_BRANCH" = "null" ] || [ -z "$DEFAULT_BRANCH" ]; then
            DEFAULT_BRANCH="main"
          fi
          
          echo "source_branch=$DEFAULT_BRANCH" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ ä½¿ç”¨é»˜è®¤åˆ†æ”¯: $DEFAULT_BRANCH"
        else
          echo "source_branch=${{ github.event.inputs.source_branch }}" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ ä½¿ç”¨æŒ‡å®šåˆ†æ”¯: ${{ github.event.inputs.source_branch }}"
        fi

    - name: Clone source repository
      run: |
        SOURCE_REPO="${{ github.event.inputs.source_repo }}"
        SOURCE_BRANCH="${{ steps.source_info.outputs.source_branch }}"
        
        echo "â¬‡ï¸ å…‹éš†æºä»“åº“: $SOURCE_REPO:$SOURCE_BRANCH"
        git clone \
          --branch "$SOURCE_BRANCH" \
          --depth 1 \
          "https://github.com/$SOURCE_REPO.git" \
          source-repo
        
        cd source-repo
        echo "ğŸ“Š æºä»“åº“ä¿¡æ¯:"
        git log -1 --oneline
        ls -la

    - name: Clone target repository
      run: |
        TARGET_REPO="${{ github.event.inputs.target_repo }}"
        TARGET_BRANCH="${{ github.event.inputs.target_branch }}"
        
        echo "â¬‡ï¸ å…‹éš†ç›®æ ‡ä»“åº“: $TARGET_REPO"
        git clone \
          --depth 1 \
          "https://${{ env.CUSTOM_PAT }}@github.com/$TARGET_REPO.git" \
          target-repo
        
        cd target-repo
        
        # æ£€æŸ¥ç›®æ ‡åˆ†æ”¯æ˜¯å¦å­˜åœ¨
        if git show-ref --verify --quiet "refs/heads/$TARGET_BRANCH"; then
          echo "ğŸ”„ ç›®æ ‡åˆ†æ”¯å·²å­˜åœ¨ï¼Œåˆ‡æ¢åˆ°: $TARGET_BRANCH"
          git checkout "$TARGET_BRANCH"
        else
          echo "ğŸ†• åˆ›å»ºæ–°ç›®æ ‡åˆ†æ”¯: $TARGET_BRANCH"
          git checkout -b "$TARGET_BRANCH"
        fi

    - name: Sync files from source to target
      run: |
        echo "ğŸ”„ åŒæ­¥æ–‡ä»¶..."
        
        # åˆ é™¤ç›®æ ‡ä»“åº“ç°æœ‰æ–‡ä»¶ï¼ˆä¿ç•™ .git ç›®å½•ï¼‰
        cd target-repo
        find . -maxdepth 1 ! -name '.git' ! -name '.' -exec rm -rf {} +
        
        # å¤åˆ¶æºä»“åº“æ–‡ä»¶åˆ°ç›®æ ‡ä»“åº“
        cd ..
        cp -r source-repo/* target-repo/
        cp source-repo/.* target-repo/ 2>/dev/null || true
        
        # æ˜¾ç¤ºåŒæ­¥ç»“æœ
        cd target-repo
        echo "ğŸ“ åŒæ­¥åçš„æ–‡ä»¶åˆ—è¡¨:"
        ls -la
        echo "ğŸ“Š æ–‡ä»¶æ•°é‡: $(find . -type f | wc -l)"

    - name: Configure Git for target repository
      run: |
        cd target-repo
        
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # æ·»åŠ æ‰€æœ‰æ›´æ”¹
        git add .
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
        if git diff --cached --quiet; then
          echo "â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶æ›´æ”¹"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "âœ… æ£€æµ‹åˆ°æ–‡ä»¶æ›´æ”¹ï¼Œå‡†å¤‡æäº¤"
          echo "has_changes=true" >> $GITHUB_OUTPUT
        fi

    - name: Commit and push changes
      if: steps.config.outputs.has_changes == 'true'
      run: |
        cd target-repo
        
        TARGET_BRANCH="${{ github.event.inputs.target_branch }}"
        SOURCE_REPO="${{ github.event.inputs.source_repo }}"
        SOURCE_BRANCH="${{ steps.source_info.outputs.source_branch }}"
        
        COMMIT_MSG="Sync from $SOURCE_REPO:$SOURCE_BRANCH - $(date +'%Y-%m-%d %H:%M:%S')"
        
        echo "ğŸ’¾ æäº¤æ›´æ”¹: $COMMIT_MSG"
        git commit -m "$COMMIT_MSG"
        
        echo "ğŸš€ æ¨é€åˆ°ç›®æ ‡ä»“åº“..."
        git push origin "$TARGET_BRANCH" --force-with-lease
        
        echo "âœ… æ¨é€å®Œæˆ"

    - name: Create summary
      run: |
        SOURCE_REPO="${{ github.event.inputs.source_repo }}"
        SOURCE_BRANCH="${{ steps.source_info.outputs.source_branch }}"
        TARGET_REPO="${{ github.event.inputs.target_repo }}"
        TARGET_BRANCH="${{ github.event.inputs.target_branch }}"
        
        echo "ğŸ‰ åŒæ­¥å®Œæˆæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
        echo "====" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**æºä»“åº“:** $SOURCE_REPO" >> $GITHUB_STEP_SUMMARY
        echo "**æºåˆ†æ”¯:** $SOURCE_BRANCH" >> $GITHUB_STEP_SUMMARY
        echo "**ç›®æ ‡ä»“åº“:** $TARGET_REPO" >> $GITHUB_STEP_SUMMARY
        echo "**ç›®æ ‡åˆ†æ”¯:** $TARGET_BRANCH" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ”— **åˆ†æ”¯é“¾æ¥:** https://github.com/$TARGET_REPO/tree/$TARGET_BRANCH" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.config.outputs.has_changes }}" = "true" ]; then
          echo "âœ… **çŠ¶æ€:** åŒæ­¥æˆåŠŸï¼Œå·²åˆ›å»ºæ–°åˆ†æ”¯" >> $GITHUB_STEP_SUMMARY
        else
          echo "â„¹ï¸ **çŠ¶æ€:** æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶æ›´æ”¹" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Show sync result
      run: |
        echo "=========================================="
        echo "ğŸ¯ åŒæ­¥ç»“æœ"
        echo "=========================================="
        echo "æºä»“åº“: ${{ github.event.inputs.source_repo }}"
        echo "æºåˆ†æ”¯: ${{ steps.source_info.outputs.source_branch }}"
        echo "ç›®æ ‡ä»“åº“: ${{ github.event.inputs.target_repo }}"
        echo "ç›®æ ‡åˆ†æ”¯: ${{ github.event.inputs.target_branch }}"
        echo "=========================================="
        echo "ğŸ“ è®¿é—®é“¾æ¥: https://github.com/${{ github.event.inputs.target_repo }}/tree/${{ github.event.inputs.target_branch }}"
        echo "=========================================="

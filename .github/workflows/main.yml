name: ğŸ”„ Cross-Repository Sync

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: 'æºä»“åº“åœ°å€ (https://github.com/owner/repo)'
        required: true
        default: 'https://github.com/example/source-repo'
        type: string
      source_branch:
        description: 'æºä»“åº“åˆ†æ”¯'
        required: true
        default: 'main'
        type: string
      target_repo:
        description: 'ç›®æ ‡ä»“åº“åœ°å€ (https://github.com/owner/repo)'
        required: true
        default: 'https://github.com/example/target-repo'
        type: string
      target_branch:
        description: 'ç›®æ ‡ä»“åº“æ–°åˆ†æ”¯åç§°'
        required: true
        default: 'sync-from-source-'
        type: string
      create_pr:
        description: 'æ˜¯å¦è‡ªåŠ¨åˆ›å»ºPull Request'
        required: false
        default: true
        type: boolean

env:
  PAT_TOKEN: ${{ secrets.Mozi9_PAT }}
  USER_NAME: 'mozi9'
  USER_EMAIL: 'mozi9'

jobs:
  sync-repositories:
    name: ğŸ”„ åŒæ­¥ä»“åº“ä»£ç 
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸš€ å¼€å§‹åŒæ­¥æµç¨‹
      run: |
        echo "å¼€å§‹è·¨ä»“åº“åŒæ­¥..."
        echo "æºä»“åº“: ${{ github.event.inputs.source_repo }}"
        echo "æºåˆ†æ”¯: ${{ github.event.inputs.source_branch }}"
        echo "ç›®æ ‡ä»“åº“: ${{ github.event.inputs.target_repo }}"
        echo "ç›®æ ‡åˆ†æ”¯: ${{ github.event.inputs.target_branch }}$(date +%Y%m%d%H%M%S)"

    - name: âš™ï¸ é…ç½®Gitèº«ä»½ä¿¡æ¯
      run: |
        git config --global user.name "${{ env.USER_NAME }}"
        git config --global user.email "${{ env.USER_EMAIL }}"
        git config --global pull.rebase false

    - name: ğŸ“¥ å…‹éš†æºä»“åº“
      run: |
        SOURCE_REPO="${{ github.event.inputs.source_repo }}"
        if [[ $SOURCE_REPO == https://github.com/* ]]; then
          REPO_PATH=$(echo $SOURCE_REPO | sed 's|https://github.com/||')
          CLONE_URL="https://${{ env.USER_NAME }}:${{ env.PAT_TOKEN }}@github.com/$REPO_PATH"
        else
          CLONE_URL="$SOURCE_REPO"
        fi
        echo "å…‹éš†æºä»“åº“: $CLONE_URL"
        git clone --depth 1 --branch "${{ github.event.inputs.source_branch }}" "$CLONE_URL" source-repo
        cd source-repo
        git fetch --depth 1 origin "${{ github.event.inputs.source_branch }}"

    - name: ğŸ”§ é…ç½®ç›®æ ‡ä»“åº“è¿œç¨‹åœ°å€
      run: |
        TARGET_REPO="${{ github.event.inputs.target_repo }}"
        if [[ $TARGET_REPO == https://github.com/* ]]; then
          REPO_PATH=$(echo $TARGET_REPO | sed 's|https://github.com/||')
          TARGET_URL="https://${{ env.USER_NAME }}:${{ env.PAT_TOKEN }}@github.com/$REPO_PATH"
        else
          TARGET_URL="$TARGET_REPO"
        fi
        echo "ç›®æ ‡ä»“åº“URL: $TARGET_URL"
        echo "TARGET_CLONE_URL=$TARGET_URL" >> $GITHUB_ENV

    - name: ğŸŒ¿ åˆ›å»ºå¹¶æ¨é€åˆ°ç›®æ ‡ä»“åº“
      run: |
        TIMESTAMP=$(date +%Y%m%d%H%M%S)
        NEW_BRANCH="${{ github.event.inputs.target_branch }}$TIMESTAMP"
        echo "æ–°åˆ†æ”¯åç§°: $NEW_BRANCH"
        
        # è¿›å…¥æºä»“åº“ç›®å½•
        cd source-repo
        
        # æ·»åŠ ç›®æ ‡ä»“åº“ä½œä¸ºè¿œç¨‹ä»“åº“
        git remote add target-repo $TARGET_CLONE_URL
        git remote -v
        
        # è·å–ç›®æ ‡ä»“åº“çš„é»˜è®¤åˆ†æ”¯
        echo "è·å–ç›®æ ‡ä»“åº“ä¿¡æ¯..."
        git fetch target-repo --depth=1
        
        # åˆ›å»ºæ–°åˆ†æ”¯å¹¶æ¨é€åˆ°ç›®æ ‡ä»“åº“
        echo "åˆ›å»ºå¹¶æ¨é€åˆ†æ”¯: $NEW_BRANCH"
        git push target-repo HEAD:refs/heads/$NEW_BRANCH
        
        echo "NEW_BRANCH_NAME=$NEW_BRANCH" >> $GITHUB_ENV
        echo "TARGET_REPO_FULL=$(echo ${{ github.event.inputs.target_repo }} | sed 's|https://github.com/||')" >> $GITHUB_ENV

    - name: ğŸ“Š æ˜¾ç¤ºåŒæ­¥ç»“æœ
      run: |
        echo "ğŸ‰ åŒæ­¥å®Œæˆï¼"
        echo "ğŸ“‹ åŒæ­¥è¯¦æƒ…ï¼š"
        echo "  æºä»“åº“: ${{ github.event.inputs.source_repo }}"
        echo "  æºåˆ†æ”¯: ${{ github.event.inputs.source_branch }}"
        echo "  ç›®æ ‡ä»“åº“: ${{ github.event.inputs.target_repo }}"
        echo "  æ–°åˆ†æ”¯: $NEW_BRANCH_NAME"
        echo ""
        echo "ğŸ”— åˆ›å»ºPRçš„é“¾æ¥ï¼š"
        echo "  https://github.com/$TARGET_REPO_FULL/compare/$NEW_BRANCH_NAME?expand=1"

    - name: ğŸ¯ åˆ›å»ºPull Requeståˆ°ç›®æ ‡ä»“åº“
      if: ${{ github.event.inputs.create_pr == 'true' }}
      uses: actions/github-script@v6
      env:
        TARGET_REPO_OWNER: ${{ fromJSON(format('"{0}"', split(github.event.inputs.target_repo, '/')[4])) }}
        TARGET_REPO_NAME: ${{ fromJSON(format('"{0}"', split(github.event.inputs.target_repo, '/')[5])) }}
      with:
        script: |
          try {
            // è§£æç›®æ ‡ä»“åº“ä¿¡æ¯
            const targetRepoUrl = '${{ github.event.inputs.target_repo }}';
            const repoPath = targetRepoUrl.replace('https://github.com/', '');
            const [owner, repo] = repoPath.split('/');
            
            const newBranch = '$NEW_BRANCH_NAME';
            const sourceRepo = '${{ github.event.inputs.source_repo }}';
            const sourceBranch = '${{ github.event.inputs.source_branch }}';
            
            console.log(`ç›®æ ‡ä»“åº“: ${owner}/${repo}`);
            console.log(`æ–°åˆ†æ”¯: ${newBranch}`);
            
            // è·å–ç›®æ ‡ä»“åº“çš„é»˜è®¤åˆ†æ”¯
            const targetRepo = await github.rest.repos.get({
              owner: owner,
              repo: repo
            });
            const baseBranch = targetRepo.data.default_branch;
            
            console.log(`ç›®æ ‡ä»“åº“é»˜è®¤åˆ†æ”¯: ${baseBranch}`);
            
            // åˆ›å»ºPull Request
            const pr = await github.rest.pulls.create({
              owner: owner,
              repo: repo,
              title: `ğŸ”€ åŒæ­¥æ›´æ–°: ${newBranch}`,
              body: `è¿™æ˜¯ä¸€ä¸ªè‡ªåŠ¨åˆ›å»ºçš„Pull Requestï¼Œç”¨äºåŒæ­¥æ¥è‡ª **${sourceRepo}** ä»“åº“çš„æ›´æ”¹ã€‚
              
              ## åŒæ­¥ä¿¡æ¯
              - **æºä»“åº“**: ${sourceRepo}
              - **æºåˆ†æ”¯**: ${sourceBranch}
              - **ç›®æ ‡åˆ†æ”¯**: ${newBranch}
              - **åŒæ­¥æ—¶é—´**: ${new Date().toISOString()}
              - **åŒæ­¥è§¦å‘**: ${{ github.repository }}
              
              ## æ“ä½œè¯´æ˜
              - æ£€æŸ¥æ›´æ”¹å†…å®¹
              - å¦‚æœ‰å†²çªéœ€è¦æ‰‹åŠ¨è§£å†³
              - åˆå¹¶åå¯ä»¥åˆ é™¤æºåˆ†æ”¯`,
              head: newBranch,
              base: baseBranch
            });
            
            console.log('âœ… PRåˆ›å»ºæˆåŠŸ:', pr.data.html_url);
            console.log('ğŸ”— PRé“¾æ¥:', pr.data.html_url);
            
          } catch (error) {
            if (error.status === 422 && error.message.includes('A pull request already exists')) {
              console.log('â„¹ï¸ PRå·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º');
            } else {
              console.log('âŒ PRåˆ›å»ºå¤±è´¥:', error.message);
              console.log('ä½†ä»£ç åŒæ­¥å·²å®Œæˆï¼Œå¯ä»¥æ‰‹åŠ¨åˆ›å»ºPR');
            }
          }

    - name: âœ… åŒæ­¥å®Œæˆæ€»ç»“
      run: |
        echo "ğŸŠ åŒæ­¥æµç¨‹å®Œæˆï¼"
        echo "=========================================="
        echo "ğŸ“¤ æºä»“åº“: ${{ github.event.inputs.source_repo }}"
        echo "ğŸ“¥ ç›®æ ‡ä»“åº“: ${{ github.event.inputs.target_repo }}"
        echo "ğŸŒ¿ æ–°åˆ†æ”¯: $NEW_BRANCH_NAME"
        echo "ğŸ”— æ‰‹åŠ¨åˆ›å»ºPRé“¾æ¥: https://github.com/$TARGET_REPO_FULL/compare/$NEW_BRANCH_NAME?expand=1"
        echo "=========================================="

name: ä»“åº“åŒæ­¥ä¸åˆå¹¶

on:
  workflow_dispatch:
    inputs:
      operation_type:
        description: 'é€‰æ‹©æ“ä½œç±»å‹'
        required: true
        type: choice
        options:
          - æ‹‰å–ä»“åº“åˆ†æ”¯
          - åˆå¹¶ç‰¹å®šæäº¤
      source_repo_url:
        description: 'æºä»“åº“é“¾æ¥ (æ”¯æŒå¸¦åˆ†æ”¯çš„é“¾æ¥)'
        required: true
        default: 'https://github.com/ApartTUSITU/kernel_xiaomi_sm8250_mod'
      target_repo_url:
        description: 'ç›®æ ‡ä»“åº“é“¾æ¥ (ç•™ç©ºåˆ™ä½¿ç”¨å½“å‰ä»“åº“)'
        required: false
        default: ''
      new_branch_name:
        description: 'æ–°å»ºåˆ†æ”¯åç§° (ä»…åœ¨"æ‹‰å–ä»“åº“åˆ†æ”¯"æ—¶ä½¿ç”¨)'
        required: false
        default: ''
      source_commit:
        description: 'æºæäº¤å“ˆå¸Œ (ä»…åœ¨"åˆå¹¶ç‰¹å®šæäº¤"æ—¶ä½¿ç”¨)'
        required: false
        default: ''
      target_branch:
        description: 'ç›®æ ‡åˆ†æ”¯ (ä»…åœ¨"åˆå¹¶ç‰¹å®šæäº¤"æ—¶ä½¿ç”¨)'
        required: false
        default: ''
      conflict_resolution:
        description: 'å†²çªè§£å†³ç­–ç•¥'
        required: false
        type: choice
        options:
          - è‡ªåŠ¨ä½¿ç”¨æºç‰ˆæœ¬
          - è‡ªåŠ¨ä½¿ç”¨ç›®æ ‡ç‰ˆæœ¬
          - æ‰‹åŠ¨è§£å†³ï¼ˆåœæ­¢å·¥ä½œæµï¼‰
        default: 'è‡ªåŠ¨ä½¿ç”¨æºç‰ˆæœ¬'

jobs:
  repository-operation:
    runs-on: ubuntu-latest

    steps:
      - name: è§£æé“¾æ¥å’Œåˆ†æ”¯ä¿¡æ¯
        id: parse_url
        run: |
          SOURCE_REPO_URL="${{ github.event.inputs.source_repo_url }}"
          
          if [[ $SOURCE_REPO_URL =~ https://github.com/([^/]+)/([^/]+)/tree/([^/]+) ]]; then
            SOURCE_OWNER="${BASH_REMATCH[1]}"
            SOURCE_REPO="${BASH_REMATCH[2]}"
            SOURCE_BRANCH="${BASH_REMATCH[3]}"
            echo "æ£€æµ‹åˆ°å¸¦åˆ†æ”¯çš„é“¾æ¥ï¼Œåˆ†æ”¯: $SOURCE_BRANCH"
          elif [[ $SOURCE_REPO_URL =~ https://github.com/([^/]+)/([^/]+)$ ]]; then
            SOURCE_OWNER="${BASH_REMATCH[1]}"
            SOURCE_REPO="${BASH_REMATCH[2]}"
            SOURCE_BRANCH=$(curl -s -H "Authorization: token ${{ secrets.Mozi9_PAT }}" \
              "https://api.github.com/repos/$SOURCE_OWNER/$SOURCE_REPO" | jq -r '.default_branch')
            echo "é»˜è®¤åˆ†æ”¯: $SOURCE_BRANCH"
          else
            echo "é”™è¯¯: æºä»“åº“é“¾æ¥æ ¼å¼ä¸æ­£ç¡®"
            exit 1
          fi
          
          echo "source_owner=$SOURCE_OWNER" >> $GITHUB_OUTPUT
          echo "source_repo=$SOURCE_REPO" >> $GITHUB_OUTPUT
          echo "source_branch=$SOURCE_BRANCH" >> $GITHUB_OUTPUT
          echo "source_full_name=$SOURCE_OWNER/$SOURCE_REPO" >> $GITHUB_OUTPUT
          
          TARGET_REPO_URL="${{ github.event.inputs.target_repo_url }}"
          if [ -z "$TARGET_REPO_URL" ]; then
            echo "target_owner=${{ github.repository_owner }}" >> $GITHUB_OUTPUT
            echo "target_repo=${{ github.event.repository.name }}" >> $GITHUB_OUTPUT
            echo "target_full_name=${{ github.repository }}" >> $GITHUB_OUTPUT
          elif [[ $TARGET_REPO_URL =~ https://github.com/([^/]+)/([^/]+) ]]; then
            TARGET_OWNER="${BASH_REMATCH[1]}"
            TARGET_REPO="${BASH_REMATCH[2]}"
            echo "target_owner=$TARGET_OWNER" >> $GITHUB_OUTPUT
            echo "target_repo=$TARGET_REPO" >> $GITHUB_OUTPUT
            echo "target_full_name=$TARGET_OWNER/$TARGET_REPO" >> $GITHUB_OUTPUT
          else
            echo "é”™è¯¯: ç›®æ ‡ä»“åº“é“¾æ¥æ ¼å¼ä¸æ­£ç¡®"
            exit 1
          fi

      - name: é…ç½®Gitèº«ä»½ä¿¡æ¯å’Œä»¤ç‰Œè®¤è¯
        run: |
          git config --global user.name "mozi9"
          git config --global user.email "mozi9@users.noreply.github.com"
          git config --global push.default simple
          
          # é…ç½®Gitä½¿ç”¨Mozi9_PATè¿›è¡Œè®¤è¯
          echo "https://mozi9:${{ secrets.Mozi9_PAT }}@github.com" > ~/.git-credentials
          git config --global credential.helper store

      - name: æ£€å‡ºç›®æ ‡ä»“åº“ï¼ˆä½¿ç”¨Mozi9_PATä»¤ç‰Œï¼‰
        uses: actions/checkout@v4
        with:
          repository: ${{ steps.parse_url.outputs.target_full_name }}
          token: ${{ secrets.Mozi9_PAT }}
          fetch-depth: 0

      - name: æ·»åŠ æºä»“åº“è¿œç¨‹å¹¶è·å–æŒ‡å®šåˆ†æ”¯
        run: |
          git remote add source https://mozi9:${{ secrets.Mozi9_PAT }}@github.com/${{ steps.parse_url.outputs.source_full_name }}.git
          git fetch source ${{ steps.parse_url.outputs.source_branch }}

      - name: æ‰§è¡Œæ‹‰å–ä»“åº“åˆ†æ”¯æ“ä½œ
        if: ${{ github.event.inputs.operation_type == 'æ‹‰å–ä»“åº“åˆ†æ”¯' }}
        run: |
          SOURCE_BRANCH="${{ steps.parse_url.outputs.source_branch }}"
          
          if [ -z "${{ github.event.inputs.new_branch_name }}" ]; then
            NEW_BRANCH="sync-$SOURCE_BRANCH"
          else
            NEW_BRANCH="${{ github.event.inputs.new_branch_name }}"
          fi
          
          if git show-ref --verify --quiet refs/heads/$NEW_BRANCH; then
            git branch -D $NEW_BRANCH || true
          fi
          
          git checkout -b $NEW_BRANCH source/$SOURCE_BRANCH
          
          # é‡å†™ä½œè€…ä¿¡æ¯ä¸ºmozi9
          git filter-branch -f --env-filter '
            export GIT_AUTHOR_NAME="mozi9"
            export GIT_AUTHOR_EMAIL="mozi9@users.noreply.github.com"
            export GIT_COMMITTER_NAME="mozi9"
            export GIT_COMMITTER_EMAIL="mozi9@users.noreply.github.com"
          ' HEAD
          
          # ä½¿ç”¨Mozi9_PATä»¤ç‰Œæ¨é€
          git push origin $NEW_BRANCH --force
          echo "âœ… åˆ†æ”¯æ‹‰å–å®Œæˆ: $NEW_BRANCH"

      - name: æ‰§è¡Œåˆå¹¶ç‰¹å®šæäº¤æ“ä½œ
        if: ${{ github.event.inputs.operation_type == 'åˆå¹¶ç‰¹å®šæäº¤' }}
        run: |
          if [ -z "${{ github.event.inputs.source_commit }}" ]; then
            echo "é”™è¯¯: æºæäº¤å“ˆå¸Œä¸èƒ½ä¸ºç©º"
            exit 1
          fi
          
          if [ -z "${{ github.event.inputs.target_branch }}" ]; then
            TARGET_BRANCH="${{ github.ref_name }}"
          else
            TARGET_BRANCH="${{ github.event.inputs.target_branch }}"
          fi
          
          git checkout $TARGET_BRANCH
          git pull origin $TARGET_BRANCH
          
          COMMIT_HASH="${{ github.event.inputs.source_commit }}"
          if ! git cat-file -e $COMMIT_HASH^0; then
            git fetch source $COMMIT_HASH || exit 1
          fi
          
          if git merge-base --is-ancestor $COMMIT_HASH HEAD; then
            echo "æäº¤å·²å­˜åœ¨ï¼Œè·³è¿‡"
          else
            # å°è¯•cherry-pick
            if ! git cherry-pick $COMMIT_HASH; then
              echo "æ£€æµ‹åˆ°åˆå¹¶å†²çªï¼Œå°è¯•è‡ªåŠ¨è§£å†³..."
              
              case "${{ github.event.inputs.conflict_resolution }}" in
                "è‡ªåŠ¨ä½¿ç”¨æºç‰ˆæœ¬")
                  echo "ä½¿ç”¨æºç‰ˆæœ¬è§£å†³å†²çª..."
                  
                  # æ¸…ç†æ‰€æœ‰å†²çªæ®‹ç•™æ–‡ä»¶
                  find . -name "*.orig" -delete 2>/dev/null || true
                  
                  # è·å–æ‰€æœ‰å†²çªæ–‡ä»¶
                  CONFLICT_FILES=$(git diff --name-only --diff-filter=U)
                  if [ -n "$CONFLICT_FILES" ]; then
                    echo "å†²çªæ–‡ä»¶åˆ—è¡¨:"
                    echo "$CONFLICT_FILES"
                    
                    # å¯¹æ¯ä¸ªå†²çªæ–‡ä»¶ä½¿ç”¨æºç‰ˆæœ¬
                    for file in $CONFLICT_FILES; do
                      if [ -f "$file" ]; then
                        echo "ä½¿ç”¨æºç‰ˆæœ¬è§£å†³: $file"
                        git checkout --theirs -- "$file"
                        git add "$file"
                      fi
                    done
                  fi
                  
                  # å¤„ç†åˆ é™¤/ä¿®æ”¹å†²çª
                  git status --porcelain | while read status file; do
                    case "$status" in
                      UD|DU)
                        echo "åˆ é™¤æ–‡ä»¶: $file"
                        git rm "$file" 2>/dev/null || true
                        ;;
                      DD)
                        echo "åŒæ–¹éƒ½åˆ é™¤çš„æ–‡ä»¶: $file"
                        ;;
                    esac
                  done
                  
                  # ç»§ç»­cherry-pick
                  git cherry-pick --continue
                  ;;
                  
                "è‡ªåŠ¨ä½¿ç”¨ç›®æ ‡ç‰ˆæœ¬")
                  echo "ä½¿ç”¨ç›®æ ‡ç‰ˆæœ¬è§£å†³å†²çª..."
                  
                  find . -name "*.orig" -delete 2>/dev/null || true
                  
                  CONFLICT_FILES=$(git diff --name-only --diff-filter=U)
                  if [ -n "$CONFLICT_FILES" ]; then
                    echo "å†²çªæ–‡ä»¶åˆ—è¡¨:"
                    echo "$CONFLICT_FILES"
                    
                    for file in $CONFLICT_FILES; do
                      if [ -f "$file" ]; then
                        echo "ä½¿ç”¨ç›®æ ‡ç‰ˆæœ¬è§£å†³: $file"
                        git checkout --ours -- "$file"
                        git add "$file"
                      fi
                    done
                  fi
                  
                  git cherry-pick --continue
                  ;;
                  
                *)
                  echo "å†²çªéœ€è¦æ‰‹åŠ¨è§£å†³"
                  git status --porcelain
                  exit 1
                  ;;
              esac
            fi
            
            # æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æœªè§£å†³çš„å†²çª
            if git diff --name-only --diff-filter=U | grep -q .; then
              echo "é”™è¯¯: ä»æœ‰æœªè§£å†³çš„å†²çª"
              git status
              exit 1
            fi
            
            # é‡å†™ä½œè€…ä¿¡æ¯ä¸ºmozi9
            git commit --amend --author="mozi9 <mozi9@users.noreply.github.com>" --no-edit
            
            # ä½¿ç”¨Mozi9_PATä»¤ç‰Œæ¨é€
            git push origin $TARGET_BRANCH
            echo "âœ… åˆå¹¶æäº¤æ“ä½œå®Œæˆ"
          fi

      - name: éªŒè¯ä½œè€…ä¿¡æ¯
        if: ${{ github.event.inputs.operation_type == 'åˆå¹¶ç‰¹å®šæäº¤' }}
        run: |
          if [ -z "${{ github.event.inputs.target_branch }}" ]; then
            BRANCH_NAME="${{ github.ref_name }}"
          else
            BRANCH_NAME="${{ github.event.inputs.target_branch }}"
          fi
          
          git checkout $BRANCH_NAME
          AUTHOR_NAME=$(git log -1 --format="%an")
          AUTHOR_EMAIL=$(git log -1 --format="%ae")
          
          echo "æœ€æ–°æäº¤ä½œè€…: $AUTHOR_NAME <$AUTHOR_EMAIL>"
          
          if [ "$AUTHOR_NAME" == "mozi9" ]; then
            echo "âœ… ä½œè€…ä¿¡æ¯éªŒè¯é€šè¿‡"
          else
            echo "âŒ ä½œè€…ä¿¡æ¯éªŒè¯å¤±è´¥"
            exit 1
          fi

      - name: æ¸…ç†å·¥ä½œ
        if: always()
        run: |
          git remote remove source || true
          find . -name "*.orig" -delete 2>/dev/null || true
          rm -f ~/.git-credentials || true

      - name: ç”Ÿæˆæ“ä½œæ‘˜è¦
        run: |
          echo "ğŸ‰ æ“ä½œæ‰§è¡Œå®Œæˆ"
          echo "================================"
          echo "æ“ä½œç±»å‹: ${{ github.event.inputs.operation_type }}"
          echo "æºä»“åº“: ${{ steps.parse_url.outputs.source_full_name }}"
          echo "æºåˆ†æ”¯: ${{ steps.parse_url.outputs.source_branch }}"
          echo "ç›®æ ‡ä»“åº“: ${{ steps.parse_url.outputs.target_full_name }}"
          echo "ä½¿ç”¨çš„ä»¤ç‰Œ: Mozi9_PAT"
          echo "æ“ä½œæ—¶é—´: $(date)"
          echo "================================"

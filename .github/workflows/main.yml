name: Repository Sync and Merge

on:
  workflow_dispatch:
    inputs:
      action_type:
        description: 'é€‰æ‹©æ“ä½œç±»å‹'
        required: true
        type: choice
        options:
          - pull_branch
          - merge_commit
      target_repo:
        description: 'ç›®æ ‡ä»“åº“ (æ ¼å¼: owner/repoï¼Œç•™ç©ºåˆ™ä½¿ç”¨å½“å‰ä»“åº“)'
        required: false
        default: ''
      source_repo:
        description: 'æºä»“åº“ (æ ¼å¼: owner/repo)'
        required: true
        default: 'ApartTUSITU/kernel_xiaomi_sm8250_mod'
      source_branch:
        description: 'æºåˆ†æ”¯'
        required: true
        default: 'android16-aptusitu-new'
      source_commit:
        description: 'æºæäº¤å“ˆå¸Œ (ä»…åœ¨merge_commitæ—¶ä½¿ç”¨)'
        required: false
        default: 'd54faa2'
      target_branch:
        description: 'ç›®æ ‡åˆ†æ”¯ (ä»…åœ¨merge_commitæ—¶ä½¿ç”¨)'
        required: false
        default: 'CI'
      new_branch_name:
        description: 'æ–°å»ºåˆ†æ”¯åç§° (ä»…åœ¨pull_branchæ—¶ä½¿ç”¨)'
        required: false
        default: 'sync-android16-aptusitu-new'

jobs:
  repository-operation:
    runs-on: ubuntu-latest
    steps:
      - name: Validate inputs
        id: validate
        run: |
          # è®¾ç½®ç›®æ ‡ä»“åº“ï¼Œå¦‚æœä¸ºç©ºåˆ™ä½¿ç”¨å½“å‰ä»“åº“
          if [ -z "${{ github.event.inputs.target_repo }}" ]; then
            echo "target_repo=${{ github.repository }}" >> $GITHUB_OUTPUT
          else
            echo "target_repo=${{ github.event.inputs.target_repo }}" >> $GITHUB_OUTPUT
          fi
          
          # éªŒè¯æ“ä½œç±»å‹å‚æ•°
          if [ "${{ github.event.inputs.action_type }}" != "pull_branch" ] && [ "${{ github.event.inputs.action_type }}" != "merge_commit" ]; then
            echo "é”™è¯¯: æ— æ•ˆçš„æ“ä½œç±»å‹"
            exit 1
          fi

      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          repository: ${{ steps.validate.outputs.target_repo }}
          token: ${{ secrets.Mozi9_PAT }}
          fetch-depth: 0

      - name: Configure Git identity
        run: |
          git config --global user.name "mozi9"
          git config --global user.email "mozi9"
          git config --global push.default simple

      - name: Add source repository as remote
        run: |
          echo "æ·»åŠ æºä»“åº“è¿œç¨‹: ${{ github.event.inputs.source_repo }}"
          git remote add source https://${{ secrets.Mozi9_PAT }}@github.com/${{ github.event.inputs.source_repo }}.git
          git fetch source ${{ github.event.inputs.source_branch }} --depth=1

      - name: Execute Pull Branch Operation
        if: ${{ github.event.inputs.action_type == 'pull_branch' }}
        run: |
          echo "å¼€å§‹æ‰§è¡Œæ‹‰å–åˆ†æ”¯æ“ä½œ..."
          echo "æºåˆ†æ”¯: ${{ github.event.inputs.source_branch }}"
          echo "æ–°åˆ†æ”¯: ${{ github.event.inputs.new_branch_name }}"
          
          # æ£€æŸ¥æ–°åˆ†æ”¯æ˜¯å¦å·²å­˜åœ¨
          if git show-ref --verify --quiet refs/heads/${{ github.event.inputs.new_branch_name }}; then
            echo "è­¦å‘Š: åˆ†æ”¯ ${{ github.event.inputs.new_branch_name }} å·²å­˜åœ¨ï¼Œå°†è¦†ç›–"
            git branch -D ${{ github.event.inputs.new_branch_name }} || true
          fi
          
          # åˆ›å»ºæ–°åˆ†æ”¯å¹¶åˆ‡æ¢åˆ°æºåˆ†æ”¯å†…å®¹
          git checkout -b ${{ github.event.inputs.new_branch_name }} source/${{ github.event.inputs.source_branch }}
          
          echo "é‡å†™æäº¤ä½œè€…ä¿¡æ¯..."
          # é‡å†™æ‰€æœ‰æäº¤çš„ä½œè€…ä¿¡æ¯
          git filter-branch --env-filter '
            export GIT_COMMITTER_NAME="mozi9"
            export GIT_COMMITTER_EMAIL="mozi9"
            export GIT_AUTHOR_NAME="mozi9" 
            export GIT_AUTHOR_EMAIL="mozi9"
          ' -- --all
          
          echo "æ¨é€åˆ°è¿œç¨‹ä»“åº“..."
          # æ¨é€åˆ°æ–°åˆ†æ”¯
          git push origin ${{ github.event.inputs.new_branch_name }} --force
          echo "âœ… æ‹‰å–åˆ†æ”¯æ“ä½œå®Œæˆ!"

      - name: Execute Merge Commit Operation
        if: ${{ github.event.inputs.action_type == 'merge_commit' }}
        run: |
          echo "å¼€å§‹æ‰§è¡Œåˆå¹¶æäº¤æ“ä½œ..."
          echo "ç›®æ ‡åˆ†æ”¯: ${{ github.event.inputs.target_branch }}"
          echo "æºæäº¤: ${{ github.event.inputs.source_commit }}"
          
          # åˆ‡æ¢åˆ°ç›®æ ‡åˆ†æ”¯
          git checkout ${{ github.event.inputs.target_branch }}
          git pull origin ${{ github.event.inputs.target_branch }}
          
          # éªŒè¯æäº¤æ˜¯å¦å­˜åœ¨
          if ! git cat-file -e ${{ github.event.inputs.source_commit }}; then
            echo "é”™è¯¯: æäº¤ ${{ github.event.inputs.source_commit }} ä¸å­˜åœ¨"
            exit 1
          fi
          
          # è·å–æäº¤ä¿¡æ¯
          git show --format=format:"%B" ${{ github.event.inputs.source_commit }} --quiet > commit_message.txt
          echo "æäº¤ä¿¡æ¯: $(cat commit_message.txt)"
          
          # æ£€æŸ¥æ˜¯å¦å·²ç»åŒ…å«è¯¥æäº¤
          if git merge-base --is-ancestor ${{ github.event.inputs.source_commit }} HEAD; then
            echo "âš ï¸ æäº¤å·²å­˜åœ¨äºç›®æ ‡åˆ†æ”¯ä¸­ï¼Œè·³è¿‡cherry-pick"
          else
            echo "åº”ç”¨æäº¤æ›´æ”¹..."
            # åº”ç”¨æ›´æ”¹ä½†ä¸æäº¤
            git cherry-pick --no-commit ${{ github.event.inputs.source_commit }}
            
            # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹éœ€è¦æäº¤
            if git diff-index --quiet HEAD --; then
              echo "âš ï¸ æ²¡æœ‰æ›´æ”¹éœ€è¦æäº¤ï¼Œå¯èƒ½æäº¤å·²åº”ç”¨"
            else
              echo "æäº¤æ›´æ”¹..."
              git add .
              git commit -m "$(cat commit_message.txt)" --author="mozi9 <mozi9>"
              
              echo "æ¨é€åˆ°è¿œç¨‹ä»“åº“..."
              git push origin ${{ github.event.inputs.target_branch }}
              echo "âœ… åˆå¹¶æäº¤æ“ä½œå®Œæˆ!"
            fi
          fi

      - name: Clean up
        run: |
          git remote remove source || true
          rm -f commit_message.txt || true
          echo "æ¸…ç†å®Œæˆ"

      - name: Create operation summary
        run: |
          echo "ğŸ‰ æ“ä½œæ‰§è¡Œå®Œæˆ!"
          echo "================================"
          echo "æ“ä½œç±»å‹: ${{ github.event.inputs.action_type }}"
          echo "ç›®æ ‡ä»“åº“: ${{ steps.validate.outputs.target_repo }}"
          echo "æºä»“åº“: ${{ github.event.inputs.source_repo }}"
          echo "æºåˆ†æ”¯: ${{ github.event.inputs.source_branch }}"
          
          if [ "${{ github.event.inputs.action_type }}" == "pull_branch" ]; then
            echo "æ–°å»ºåˆ†æ”¯: ${{ github.event.inputs.new_branch_name }}"
          else
            echo "æºæäº¤: ${{ github.event.inputs.source_commit }}"
            echo "ç›®æ ‡åˆ†æ”¯: ${{ github.event.inputs.target_branch }}"
          fi
          echo "================================"

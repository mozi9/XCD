name: Advanced File Extraction and Commit

on:
  workflow_dispatch:
    inputs:
      source_repo_url:
        description: "Source repository URL (GitHub URL)"
        required: true
        default: "https://github.com/ApartTUSITU/kernel_xiaomi_sm8250_mod"
      target_repo_url:
        description: "Target repository URL (GitHub URL)"
        required: true
        default: "https://github.com/mozi9/XCD"
      source_commits:
        description: "Source commit hashes (short or full, comma separated)"
        required: true
        default: "41273ce"
      source_branch:
        description: "Source branch to get commits from"
        required: true
        default: "android_kernel_common_android12-5.10"
      target_branch:
        description: "Target branch to push to"
        required: true
        default: "miuix"
      commit_title:
        description: "Commit title/message"
        required: true
        default: "fs: Bump SuSFS version to v2.0.0"
      commit_description:
        description: "Commit description (optional)"
        required: false
        default: "Co-authored-by: simonpunk <simonpunk2016@gmail.com>\nCo-authored-by: JackA1ltman <cs2dtzq@163.com>"
      file_operations:
        description: "File operations mode"
        required: false
        default: "all"
        type: choice
        options:
        - all
        - modified_only
        - specific_files
      specific_files:
        description: "Specific file patterns (comma separated, for specific_files mode)"
        required: false
        default: "fs/susfs/**,include/linux/susfs.h"
      backup_mode:
        description: "Backup mode before operations"
        required: false
        default: "create_backup"
        type: choice
        options:
        - create_backup
        - skip_backup
        - validate_only

jobs:
  extract-and-commit:
    runs-on: ubuntu-latest
    steps:
    - name: Parse repository URLs
      id: parse-urls
      run: |
        # Ëß£ÊûêÊ∫ê‰ªìÂ∫ìURL
        SOURCE_URL="${{ inputs.source_repo_url }}"
        if [[ "$SOURCE_URL" == https://github.com/* ]]; then
          SOURCE_REPO="${SOURCE_URL#https://github.com/}"
          SOURCE_REPO="${SOURCE_REPO%.git}"
        elif [[ "$SOURCE_URL" == git@github.com:* ]]; then
          SOURCE_REPO="${SOURCE_URL#git@github.com:}"
          SOURCE_REPO="${SOURCE_REPO%.git}"
        else
          echo "‚ùå Invalid source repository URL: $SOURCE_URL"
          exit 1
        fi
        
        # Ëß£ÊûêÁõÆÊ†á‰ªìÂ∫ìURL
        TARGET_URL="${{ inputs.target_repo_url }}"
        if [[ "$TARGET_URL" == https://github.com/* ]]; then
          TARGET_REPO="${TARGET_URL#https://github.com/}"
          TARGET_REPO="${TARGET_REPO%.git}"
        elif [[ "$TARGET_URL" == git@github.com:* ]]; then
          TARGET_REPO="${TARGET_URL#git@github.com:}"
          TARGET_REPO="${TARGET_REPO%.git}"
        else
          echo "‚ùå Invalid target repository URL: $TARGET_URL"
          exit 1
        fi
        
        echo "source_repo=$SOURCE_REPO" >> $GITHUB_OUTPUT
        echo "target_repo=$TARGET_REPO" >> $GITHUB_OUTPUT
        echo "‚úÖ Source repo: $SOURCE_REPO"
        echo "‚úÖ Target repo: $ARGET_REPO"

    - name: Checkout source repository
      uses: actions/checkout@v4
      with:
        repository: ${{ steps.parse-urls.outputs.source_repo }}
        ref: ${{ inputs.source_branch }}
        token: ${{ secrets.Mozi9_PAT }}
        path: source-repo
        fetch-depth: 0

    - name: Checkout target repository
      uses: actions/checkout@v4
      with:
        repository: ${{ steps.parse-urls.outputs.target_repo }}
        ref: ${{ inputs.target_branch }}
        token: ${{ secrets.Mozi9_PAT }}
        path: target-repo
        fetch-depth: 0

    - name: Setup Git identity
      run: |
        git config --global user.name "mozi9"
        git config --global user.email "mozi9@users.noreply.github.com"
        echo "Git configured: mozi9 <mozi9@users.noreply.github.com>"

    - name: Create backup if enabled
      if: inputs.backup_mode == 'create_backup'
      run: |
        cd target-repo
        TIMESTAMP=$(date +%Y%m%d_%H%M%S)
        BACKUP_DIR="../backup_$TIMESTAMP"
        mkdir -p "$BACKUP_DIR"
        
        # Â§á‰ªΩÊâÄÊúâÊñá‰ª∂
        echo "üìÇ Creating backup to $BACKUP_DIR"
        find . -type f -not -path '*/\.git/*' -exec cp --parents {} "$BACKUP_DIR" \; 2>/dev/null || true
        
        echo "backup_dir=$BACKUP_DIR" >> $GITHUB_OUTPUT
        echo "‚úÖ Backup created: $BACKUP_DIR"

    - name: Resolve commit hashes and analyze changes
      id: analyze-changes
      run: |
        cd source-repo
        
        # Ëß£ÊûêÊèê‰∫§ÂìàÂ∏å
        COMMITS=$(echo "${{ inputs.source_commits }}" | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | grep -v '^$')
        RESOLVED_COMMITS=""
        
        echo "üîç Resolving commits: $COMMITS"
        for commit in $COMMITS; do
          FULL_HASH=$(git rev-parse "$commit" 2>/dev/null || echo "")
          if [ -n "$FULL_HASH" ]; then
            RESOLVED_COMMITS="$RESOLVED_COMMITS$FULL_HASH"$'\n'
            echo "‚úÖ Resolved $commit -> $FULL_HASH"
          else
            echo "‚ùå Error: Cannot resolve commit $commit"
            exit 1
          fi
        done
        
        echo "$RESOLVED_COMMITS" | grep -v '^$' > ../resolved_commits.txt
        
        # ÂàÜÊûêÊñá‰ª∂ÂèòÊõ¥
        ALL_MODIFIED_FILES=""
        ALL_DELETED_FILES=""
        ALL_RENAMED_FILES=""
        COMMIT_DETAILS=""
        
        echo "=== Analyzing file changes ==="
        
        for commit in $(cat ../resolved_commits.txt); do
          echo "üìä Processing commit: $commit"
          COMMIT_INFO=$(git show --oneline -s $commit)
          COMMIT_DETAILS="$COMMIT_DETAILS$COMMIT_INFO"$'\n'
          
          # Ëé∑ÂèñÊâÄÊúâÂèòÊõ¥Á±ªÂûã
          MODIFIED_FILES=$(git show --name-status --format= $commit | awk '$1 == "A" || $1 == "M" {print $2}' | sort -u)
          DELETED_FILES=$(git show --name-status --format= $commit | awk '$1 == "D" {print $2}' | sort -u)
          RENAMED_FILES=$(git show --name-status --format= $commit | awk '$1 == "R" {print $3}' | sort -u)
          
          if [ -n "$MODIFIED_FILES" ]; then
            echo "  üìÑ Modified/Added: $(echo "$MODIFIED_FILES" | tr '\n' ' ')"
            ALL_MODIFIED_FILES="$ALL_MODIFIED_FILES"$'\n'"$MODIFIED_FILES"
          fi
          if [ -n "$DELETED_FILES" ]; then
            echo "  üóëÔ∏è Deleted: $(echo "$DELETED_FILES" | tr '\n' ' ')"
            ALL_DELETED_FILES="$ALL_DELETED_FILES"$'\n'"$DELETED_FILES"
          fi
          if [ -n "$RENAMED_FILES" ]; then
            echo "  üîÑ Renamed: $(echo "$RENAMED_FILES" | tr '\n' ' ')"
            ALL_RENAMED_FILES="$ALL_RENAMED_FILES"$'\n'"$RENAMED_FILES"
          fi
        done
        
        # ÂéªÈáçÊñá‰ª∂ÂàóË°®
        UNIQUE_MODIFIED=$(echo "$ALL_MODIFIED_FILES" | grep -v '^$' | sort -u)
        UNIQUE_DELETED=$(echo "$ALL_DELETED_FILES" | grep -v '^$' | sort -u)
        UNIQUE_RENAMED=$(echo "$ALL_RENAMED_FILES" | grep -v '^$' | sort -u)
        
        # Êñá‰ª∂ËøáÊª§ÈÄªËæë
        if [ "${{ inputs.file_operations }}" == "specific_files" ]; then
          PATTERNS=$(echo "${{ inputs.specific_files }}" | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
          FILTERED_MODIFIED=""
          FILTERED_DELETED=""
          
          echo "üîç Filtering files by patterns: $PATTERNS"
          
          for pattern in $PATTERNS; do
            # ‰ΩøÁî®findËøõË°åÊ®°ÂºèÂåπÈÖç
            while IFS= read -r file; do
              if [[ "$file" == $pattern ]] || [[ "$file" == */${pattern#*/} ]] || [[ "$pattern" == *"*"* && $(echo "$file" | grep -q "$(echo "$pattern" | sed 's/\*/.*/g')" && echo 1) ]]; then
                FILTERED_MODIFIED="$FILTERED_MODIFIED"$'\n'"$file"
                echo "  ‚úÖ Included: $file"
              fi
            done <<< "$UNIQUE_MODIFIED"
            
            while IFS= read -r file; do
              if [[ "$file" == $pattern ]] || [[ "$file" == */${pattern#*/} ]] || [[ "$pattern" == *"*"* && $(echo "$file" | grep -q "$(echo "$pattern" | sed 's/\*/.*/g')" && echo 1) ]]; then
                FILTERED_DELETED="$FILTERED_DELETED"$'\n'"$file"
                echo "  ‚úÖ Included: $file"
              fi
            done <<< "$UNIQUE_DELETED"
          done
          
          UNIQUE_MODIFIED=$(echo "$FILTERED_MODIFIED" | grep -v '^$' | sort -u)
          UNIQUE_DELETED=$(echo "$FILTERED_DELETED" | grep -v '^$' | sort -u)
        fi
        
        # ‰øùÂ≠òÊñá‰ª∂ÂàóË°®
        echo "$UNIQUE_MODIFIED" > ../modified_files.txt
        echo "$UNIQUE_DELETED" > ../deleted_files.txt
        echo "$UNIQUE_RENAMED" > ../renamed_files.txt
        echo "$COMMIT_DETAILS" > ../commit_details.txt
        
        MOD_COUNT=$(echo "$UNIQUE_MODIFIED" | grep -c . || echo 0)
        DEL_COUNT=$(echo "$UNIQUE_DELETED" | grep -c . || echo 0)
        REN_COUNT=$(echo "$UNIQUE_RENAMED" | grep -c . || echo 0)
        
        echo "modified_files_count=$MOD_COUNT" >> $GITHUB_OUTPUT
        echo "deleted_files_count=$DEL_COUNT" >> $GITHUB_OUTPUT
        echo "renamed_files_count=$REN_COUNT" >> $GITHUB_OUTPUT
        
        echo "‚úÖ Analysis complete:"
        echo "   Modified/Added: $MOD_COUNT files"
        echo "   Deleted: $DEL_COUNT files"
        echo "   Renamed: $REN_COUNT files"

    - name: Validate file operations
      if: inputs.backup_mode == 'validate_only'
      run: |
        echo "üîç Validation mode - checking file operations"
        echo "Modified files (${{ steps.analyze-changes.outputs.modified_files_count }}):"
        cat modified_files.txt | head -10
        echo "..."
        
        echo "Deleted files (${{ steps.analyze-changes.outputs.deleted_files_count }}):"
        cat deleted_files.txt | head -10
        echo "..."
        
        echo "‚úÖ Validation complete. No actual file operations performed."
        echo "validation_result=passed" >> $GITHUB_OUTPUT
      continue-on-error: true

    - name: Perform file operations
      if: inputs.backup_mode != 'validate_only'
      run: |
        echo "=== Performing File Operations ==="
        
        # Âà†Èô§Êìç‰Ωú
        if [ -s deleted_files.txt ]; then
          echo "üóëÔ∏è Deleting files..."
          DELETED_COUNT=0
          while IFS= read -r file; do
            if [ -n "$file" ] && [ -f "target-repo/$file" ]; then
              # ÂÆâÂÖ®Ê£ÄÊü•
              if [[ "$file" != / && "$file" != /* && "$file" != .git* && "$file" != "." && "$file" != ".." ]]; then
                echo "  Deleting: $file"
                rm -f "target-repo/$file"
                DELETED_COUNT=$((DELETED_COUNT + 1))
                
                # Âà†Èô§Á©∫ÁõÆÂΩï
                dir=$(dirname "target-repo/$file")
                if [ -d "$dir" ] && [ -z "$(ls -A "$dir")" ]; then
                  rmdir "$dir" 2>/dev/null || true
                fi
              else
                echo "  üö´ Skipped (safety): $file"
              fi
            fi
          done < deleted_files.txt
          echo "‚úÖ Deleted $DELETED_COUNT files"
        else
          echo "‚ÑπÔ∏è No files to delete"
          DELETED_COUNT=0
        fi
        
        # Â§çÂà∂Êìç‰Ωú
        if [ -s modified_files.txt ]; then
          echo "üìÑ Copying files..."
          COPIED_COUNT=0
          while IFS= read -r file; do
            if [ -n "$file" ] && [ -f "source-repo/$file" ]; then
              echo "  Copying: $file"
              mkdir -p "target-repo/$(dirname "$file")"
              cp "source-repo/$file" "target-repo/$file"
              COPIED_COUNT=$((COPIED_COUNT + 1))
            else
              echo "  ‚ö†Ô∏è Source file not found: $file"
            fi
          done < modified_files.txt
          echo "‚úÖ Copied $COPIED_COUNT files"
        else
          echo "‚ÑπÔ∏è No files to copy"
          COPIED_COUNT=0
        fi
        
        echo "actual_deleted_count=$DELETED_COUNT" >> $GITHUB_OUTPUT
        echo "actual_copied_count=$COPIED_COUNT" >> $GITHUB_OUTPUT

    - name: Verify file operations
      if: inputs.backup_mode != 'validate_only'
      id: verify-files
      run: |
        echo "=== Verification ==="
        cd target-repo
        
        echo "üìä File statistics:"
        echo "Total files: $(find . -type f -not -path '*/\.git/*' | wc -l)"
        echo "Total size: $(du -sh . | cut -f1)"
        
        echo "üîç Git status:"
        git status --short
        
        # Ê£ÄÊü•ÊòØÂê¶ÊúâÂÆûÈôÖÂèòÊõ¥
        if git diff --quiet; then
          echo "‚ÑπÔ∏è No changes detected"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "‚úÖ Changes detected"
          echo "has_changes=true" >> $GITHUB_OUTPUT
          
          # ÊòæÁ§∫ÂèòÊõ¥ÊëòË¶Å
          echo "üìã Change summary:"
          git diff --stat
        fi

    - name: Prepare commit message
      id: prepare-commit
      run: |
        # Â§ÑÁêÜÊèê‰∫§‰ø°ÊÅØ
        COMMIT_TITLE="${{ inputs.commit_title }}"
        COMMIT_DESC="${{ inputs.commit_description }}"
        
        # ÊûÑÂª∫ËØ¶ÁªÜÁöÑÊèê‰∫§ÊèèËø∞
        DETAILED_DESC=""
        if [ -s commit_details.txt ]; then
          DETAILED_DESC="Source commits:\n$(cat commit_details.txt | head -10)"
        fi
        
        if [ -z "$COMMIT_DESC" ] || [ "$COMMIT_DESC" == "null" ]; then
          COMMIT_DESC="Extracted files from ${{ inputs.source_repo_url }}"
        fi
        
        FULL_DESC="$COMMIT_DESC\n\n$DETAILED_DESC\n\nFile operations:\n- Modified/Added: ${{ steps.analyze-changes.outputs.modified_files_count }} files\n- Deleted: ${{ steps.analyze-changes.outputs.deleted_files_count }} files\n- Renamed: ${{ steps.analyze-changes.outputs.renamed_files_count }} files\n\nSource: ${{ inputs.source_repo_url }}\nCommits: ${{ inputs.source_commits }}\nBranch: ${{ inputs.source_branch }}\nMode: ${{ inputs.file_operations }}"
        
        echo "commit_title=$COMMIT_TITLE" >> $GITHUB_OUTPUT
        echo "commit_description=$FULL_DESC" >> $GITHUB_OUTPUT
        
        echo "=== Commit Message ==="
        echo "Title: $COMMIT_TITLE"
        echo "Description:"
        echo -e "$FULL_DESC"

    - name: Commit and push changes
      if: inputs.backup_mode != 'validate_only' && steps.verify-files.outputs.has_changes == 'true'
      run: |
        cd target-repo
        
        echo "üíæ Committing changes..."
        git add -A
        
        # ‰ΩøÁî®Â§öË°åÊèê‰∫§‰ø°ÊÅØ
        git commit -m "${{ steps.prepare-commit.outputs.commit_title }}" -m "${{ steps.prepare-commit.outputs.commit_description }}"
        
        echo "üöÄ Pushing to repository..."
        git push origin ${{ inputs.target_branch }}
        
        echo "‚úÖ Successfully committed and pushed changes"

    - name: Show final result
      run: |
        cat > $GITHUB_STEP_SUMMARY << EOF
        # Êñá‰ª∂Â§ÑÁêÜÁªìÊûú - ${{ inputs.backup_mode }}
        
        ## ‰ªìÂ∫ì‰ø°ÊÅØ
        - **Ê∫ê‰ªìÂ∫ì**: ${{ inputs.source_repo_url }}
        - **ÁõÆÊ†á‰ªìÂ∫ì**: ${{ inputs.target_repo_url }}
        - **Ê∫êÂàÜÊîØ**: ${{ inputs.source_branch }}
        - **ÁõÆÊ†áÂàÜÊîØ**: ${{ inputs.target_branch }}
        - **Êìç‰ΩúÊ®°Âºè**: ${{ inputs.file_operations }}
        - **Â§á‰ªΩÊ®°Âºè**: ${{ inputs.backup_mode }}
        
        ## ÂàÜÊûêÁªìÊûú
        - **Â§ÑÁêÜÁöÑÊèê‰∫§**: ${{ inputs.source_commits }}
        - **ÂàÜÊûêÂá∫ÁöÑ‰øÆÊîπÊñá‰ª∂**: ${{ steps.analyze-changes.outputs.modified_files_count }} ‰∏™
        - **ÂàÜÊûêÂá∫ÁöÑÂà†Èô§Êñá‰ª∂**: ${{ steps.analyze-changes.outputs.deleted_files_count }} ‰∏™
        - **ÂàÜÊûêÂá∫ÁöÑÈáçÂëΩÂêçÊñá‰ª∂**: ${{ steps.analyze-changes.outputs.renamed_files_count }} ‰∏™
        
        EOF
        
        if [ "${{ inputs.backup_mode }}" = "validate_only" ]; then
          echo "## üîç È™åËØÅÊ®°Âºè" >> $GITHUB_STEP_SUMMARY
          echo "‰ªÖËøõË°åÈ™åËØÅÔºåÊú™ÊâßË°åÂÆûÈôÖÊñá‰ª∂Êìç‰Ωú" >> $GITHUB_STEP_SUMMARY
          echo "**È™åËØÅÁªìÊûú**: ‚úÖ ÈÄöËøá" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ inputs.backup_mode }}" = "create_backup" ]; then
          echo "## üíæ Â§á‰ªΩ‰ø°ÊÅØ" >> $GITHUB_STEP_SUMMARY
          echo "Â§á‰ªΩÁõÆÂΩï: ${{ steps.create-backup.outputs.backup_dir }}" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ inputs.backup_mode }}" != "validate_only" ]; then
          cat >> $GITHUB_STEP_SUMMARY << EOF
        
        ## ÂÆûÈôÖÊìç‰ΩúÁªìÊûú
        - **ÂÆûÈôÖÂ§çÂà∂ÁöÑÊñá‰ª∂**: ${{ steps.perform-operations.outputs.actual_copied_count }} ‰∏™
        - **ÂÆûÈôÖÂà†Èô§ÁöÑÊñá‰ª∂**: ${{ steps.perform-operations.outputs.actual_deleted_count }} ‰∏™
        
        ## Êèê‰∫§‰ø°ÊÅØ
        - **Ê†áÈ¢ò**: ${{ steps.prepare-commit.outputs.commit_title }}
        
        EOF
        
          if [ "${{ steps.verify-files.outputs.has_changes }}" = "true" ]; then
            echo "‚úÖ **ÊàêÂäü**: ‰ªé ${{ steps.parse-urls.outputs.source_repo }} ÊèêÂèñÂπ∂Êèê‰∫§‰∫Ü ${{ steps.perform-operations.outputs.actual_copied_count }} ‰∏™Êñá‰ª∂" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ÑπÔ∏è **Êó†ÂèòÊõ¥**: Êú™Ê£ÄÊµãÂà∞Êñá‰ª∂ÂèòÊõ¥" >> $GITHUB_STEP_SUMMARY
          fi
        fi

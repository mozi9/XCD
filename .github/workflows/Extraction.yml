name: Direct Commit Override

on:
  workflow_dispatch:
    inputs:
      commit_urls:
        description: "GitHubæäº¤é“¾æ¥ï¼ˆå¤šä¸ªé“¾æ¥ç”¨é€—å·åˆ†éš”ï¼‰"
        required: true
        default: "https://github.com/android16-aptusit/kernel_xiaomi_sm8250_mod/commit/47b6de7"
      target_repo:
        description: "ç›®æ ‡ä»“åº“ï¼ˆæ ¼å¼ï¼šowner/repoï¼‰"
        required: true
        default: "mozi9/XCD"
      target_branch:
        description: "ç›®æ ‡åˆ†æ”¯"
        required: true
        default: "miuix"
      commit_title:
        description: "æäº¤æ ‡é¢˜"
        required: true
        default: "fs: Bump SuSFS version to v2.0.0"
      commit_description:
        description: "æäº¤æè¿°ï¼ˆå¯é€‰ï¼‰"
        required: false
        default: ""

env:
  GIT_USERNAME: "mozi9"
  GIT_EMAIL: "mozi9@users.noreply.github.com"

jobs:
  direct-override:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
    - name: âš™ï¸ é…ç½®Gitç¯å¢ƒ
      run: |
        git config --global user.name "mozi9"
        git config --global user.email "mozi9@users.noreply.github.com"
        git config --global core.autocrlf false

    - name: ğŸ“¥ æ£€å‡ºç›®æ ‡ä»“åº“
      uses: actions/checkout@v4
      with:
        repository: ${{ github.event.inputs.target_repo }}
        ref: ${{ github.event.inputs.target_branch }}
        token: ${{ secrets.Mozi9_PAT }}
        path: target-repo
        fetch-depth: 0  # è·å–å®Œæ•´å†å²

    - name: ğŸ” è§£ææäº¤é“¾æ¥
      id: parse-commit
      run: |
        echo "=== è§£ææäº¤é“¾æ¥ ==="
        
        COMMIT_URLS="${{ github.event.inputs.commit_urls }}"
        
        # æ¸…ç†å’Œåˆ†å‰²é“¾æ¥
        COMMIT_URLS_CLEAN=$(echo "$COMMIT_URLS" | tr ',' '\n' | tr ' ' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | grep -v '^$')
        
        # å­˜å‚¨æ‰€æœ‰æäº¤ä¿¡æ¯
        all_commits=()
        all_repos=()
        
        while IFS= read -r commit_url; do
          if [[ "$commit_url" =~ https://github.com/([^/]+)/([^/]+)/commit/([a-f0-9]+) ]]; then
            REPO_OWNER="${BASH_REMATCH[1]}"
            REPO_NAME="${BASH_REMATCH[2]}"
            COMMIT_HASH="${BASH_REMATCH[3]}"
            REPO="$REPO_OWNER/$REPO_NAME"
            
            echo "âœ… è§£ææˆåŠŸ: $REPO @ $COMMIT_HASH"
            all_commits+=("$COMMIT_HASH")
            all_repos+=("$REPO")
          else
            echo "âŒ é“¾æ¥æ ¼å¼é”™è¯¯: $commit_url"
            exit 1
          fi
        done <<< "$COMMIT_URLS_CLEAN"
        
        if [ ${#all_commits[@]} -eq 0 ]; then
          echo "âŒ æ²¡æœ‰æœ‰æ•ˆçš„æäº¤é“¾æ¥"
          exit 1
        fi
        
        # ä¿å­˜ç»“æœ
        printf "%s\n" "${all_commits[@]}" > commit_hashes.txt
        printf "%s\n" "${all_repos[@]}" > repo_names.txt
        
        echo "commits_count=${#all_commits[@]}" >> $GITHUB_OUTPUT

    - name: ğŸ”„ æ·»åŠ æºä»“åº“è¿œç¨‹
      id: add-remote
      run: |
        cd target-repo
        
        readarray -t COMMITS < ../commit_hashes.txt
        readarray -t REPOS < ../repo_names.txt
        
        if [ ${#COMMITS[@]} -eq 0 ]; then
          echo "âŒ æ²¡æœ‰æäº¤ä¿¡æ¯"
          exit 1
        fi
        
        # ä½¿ç”¨ç¬¬ä¸€ä¸ªä»“åº“
        SOURCE_REPO="${REPOS[0]}"
        COMMIT_HASH="${COMMITS[0]}"
        
        echo "æ·»åŠ è¿œç¨‹ä»“åº“: $SOURCE_REPO"
        echo "ç›®æ ‡æäº¤: $COMMIT_HASH"
        
        # æ·»åŠ æºä»“åº“ä¸ºè¿œç¨‹
        git remote add source-repo "https://github.com/$SOURCE_REPO.git"
        
        # è·å–æºä»“åº“æ•°æ®
        git fetch source-repo "$COMMIT_HASH"
        
        echo "source_repo=$SOURCE_REPO" >> $GITHUB_OUTPUT
        echo "commit_hash=$COMMIT_HASH" >> $GITHUB_OUTPUT

    - name: ğŸ“Š è·å–æäº¤æ–‡ä»¶å˜æ›´
      id: get-commit-files
      run: |
        cd target-repo
        
        SOURCE_REPO="${{ steps.add-remote.outputs.source_repo }}"
        COMMIT_HASH="${{ steps.add-remote.outputs.commit_hash }}"
        
        echo "=== è·å–æäº¤æ–‡ä»¶å˜æ›´ ==="
        echo "åˆ†ææäº¤: $COMMIT_HASH"
        
        # è·å–æäº¤ä¸­çš„æ–‡ä»¶å˜æ›´
        git diff --name-only "$COMMIT_HASH^" "$COMMIT_HASH" > ../changed_files.txt
        
        # è·å–æ–°å¢å’Œä¿®æ”¹çš„æ–‡ä»¶
        git diff --name-only --diff-filter=AM "$COMMIT_HASH^" "$COMMIT_HASH" > ../added_modified_files.txt
        
        # è·å–åˆ é™¤çš„æ–‡ä»¶
        git diff --name-only --diff-filter=D "$COMMIT_HASH^" "$COMMIT_HASH" > ../deleted_files.txt
        
        # è·å–æ‰€æœ‰å˜æ›´æ–‡ä»¶
        git show --name-only --pretty=format:"" "$COMMIT_HASH" | grep -v '^$' > ../all_files.txt
        
        echo "âœ… æ–‡ä»¶å˜æ›´åˆ†æå®Œæˆ"
        echo "æ‰€æœ‰æ–‡ä»¶: $(wc -l < ../all_files.txt) ä¸ª"
        echo "æ–°å¢/ä¿®æ”¹: $(wc -l < ../added_modified_files.txt) ä¸ª"
        echo "åˆ é™¤æ–‡ä»¶: $(wc -l < ../deleted_files.txt) ä¸ª"

    - name: ğŸ—‘ï¸ åˆ é™¤ç›®æ ‡ä»“åº“ä¸­çš„æ–‡ä»¶
      id: delete-files
      run: |
        cd target-repo
        
        echo "=== åˆ é™¤æäº¤ä¸­æ ‡è®°ä¸ºåˆ é™¤çš„æ–‡ä»¶ ==="
        
        deleted_count=0
        error_count=0
        
        if [ -s ../deleted_files.txt ]; then
          while IFS= read -r file; do
            [ -z "$file" ] && continue
            
            if [ -f "$file" ]; then
              if rm -f "$file"; then
                deleted_count=$((deleted_count + 1))
                echo "ğŸ—‘ï¸  åˆ é™¤: $file"
                
                # å°è¯•åˆ é™¤ç©ºç›®å½•
                dir=$(dirname "$file")
                while [ "$dir" != "." ] && [ -d "$dir" ]; do
                  if [ -z "$(ls -A "$dir")" ]; then
                    rmdir "$dir" 2>/dev/null && echo "ğŸ“ åˆ é™¤ç©ºç›®å½•: $dir" || break
                    dir=$(dirname "$dir")
                  else
                    break
                  fi
                done
              else
                error_count=$((error_count + 1))
                echo "âŒ åˆ é™¤å¤±è´¥: $file"
              fi
            else
              echo "â­ï¸  è·³è¿‡åˆ é™¤: $file (æ–‡ä»¶ä¸å­˜åœ¨)"
            fi
          done < ../deleted_files.txt
        fi
        
        echo "deleted_count=$deleted_count" >> $GITHUB_OUTPUT
        echo "âœ… åˆ é™¤å®Œæˆ: $deleted_count ä¸ªæ–‡ä»¶"

    - name: ğŸ“¥ æ£€å‡ºæäº¤æ–‡ä»¶åˆ°ç›®æ ‡ä»“åº“
      id: checkout-files
      run: |
        cd target-repo
        
        COMMIT_HASH="${{ steps.add-remote.outputs.commit_hash }}"
        
        echo "=== æ£€å‡ºæäº¤æ–‡ä»¶åˆ°å·¥ä½œåŒº ==="
        echo "æ£€å‡ºæäº¤: $COMMIT_HASH"
        
        added_count=0
        modified_count=0
        error_count=0
        
        if [ -s ../added_modified_files.txt ]; then
          while IFS= read -r file; do
            [ -z "$file" ] && continue
            
            echo "å¤„ç†æ–‡ä»¶: $file"
            
            # åˆ›å»ºç›®å½•
            mkdir -p "$(dirname "$file")"
            
            # ä»æäº¤ä¸­æ£€å‡ºæ–‡ä»¶
            if git show "$COMMIT_HASH:$file" > "$file" 2>/dev/null; then
              if [ -s "$file" ]; then
                if [ -f "$file" ]; then
                  modified_count=$((modified_count + 1))
                  echo "âœï¸  ä¿®æ”¹: $file"
                else
                  added_count=$((added_count + 1))
                  echo "â• æ–°å¢: $file"
                fi
              else
                error_count=$((error_count + 1))
                echo "âŒ æ–‡ä»¶ä¸ºç©º: $file"
                rm -f "$file"
              fi
            else
              error_count=$((error_count + 1))
              echo "âŒ æ£€å‡ºå¤±è´¥: $file"
            fi
          done < ../added_modified_files.txt
        fi
        
        echo "added_count=$added_count" >> $GITHUB_OUTPUT
        echo "modified_count=$modified_count" >> $GITHUB_OUTPUT
        echo "error_count=$error_count" >> $GITHUB_OUTPUT
        
        echo "âœ… æ£€å‡ºå®Œæˆ:"
        echo "   æ–°å¢æ–‡ä»¶: $added_count ä¸ª"
        echo "   ä¿®æ”¹æ–‡ä»¶: $modified_count ä¸ª"
        echo "   é”™è¯¯æ“ä½œ: $error_count ä¸ª"

    - name: ğŸ’¾ æäº¤å˜æ›´
      id: commit-changes
      run: |
        cd target-repo
        
        echo "=== æäº¤å˜æ›´ ==="
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
        if git diff-index --quiet HEAD --; then
          echo "â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "ğŸ“ å‘ç°å˜æ›´ï¼Œå‡†å¤‡æäº¤..."
          
          # æ˜¾ç¤ºå˜æ›´çŠ¶æ€
          echo "=== å˜æ›´çŠ¶æ€ ==="
          git status --porcelain
          
          # æ·»åŠ æ‰€æœ‰å˜æ›´
          git add -A
          
          # è·å–å˜æ›´ç»Ÿè®¡
          CHANGED_FILES=$(git diff --name-only --cached)
          CHANGED_COUNT=$(echo "$CHANGED_FILES" | wc -l)
          
          echo "å˜æ›´æ–‡ä»¶ ($CHANGED_COUNT ä¸ª):"
          echo "$CHANGED_FILES"
          
          # åˆ›å»ºæäº¤ä¿¡æ¯
          commit_msg="${{ github.event.inputs.commit_title }}"
          
          if [ -n "${{ github.event.inputs.commit_description }}" ]; then
            commit_msg="$commit_msg"$'\n'$'\n'"${{ github.event.inputs.commit_description }}"
          fi
          
          # æäº¤
          git commit -m "$commit_msg"
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "changed_files_count=$CHANGED_COUNT" >> $GITHUB_OUTPUT
          echo "âœ… æäº¤åˆ›å»ºæˆåŠŸ"
        fi

    - name: ğŸš€ æ¨é€æ›´æ”¹
      if: steps.commit-changes.outputs.has_changes == 'true'
      run: |
        cd target-repo
        
        echo "=== æ¨é€æ›´æ”¹ ==="
        
        git push origin "${{ github.event.inputs.target_branch }}"
        echo "âœ… æ¨é€æˆåŠŸ"

    - name: ğŸ“‹ ç”ŸæˆæŠ¥å‘Š
      if: always()
      run: |
        cat > "$GITHUB_STEP_SUMMARY" << EOF
        # ç›´æ¥æäº¤è¦†ç›–æŠ¥å‘Š
        
        ## æ€»ä½“ç»Ÿè®¡
        - **æºä»“åº“**: ${{ steps.add-remote.outputs.source_repo }}
        - **æºæäº¤**: ${{ steps.add-remote.outputs.commit_hash }}
        - **åˆ é™¤æ–‡ä»¶**: ${{ steps.delete-files.outputs.deleted_count }} ä¸ª
        - **æ–°å¢æ–‡ä»¶**: ${{ steps.checkout-files.outputs.added_count }} ä¸ª
        - **ä¿®æ”¹æ–‡ä»¶**: ${{ steps.checkout-files.outputs.modified_count }} ä¸ª
        - **æœ€ç»ˆæäº¤**: ${{ steps.commit-changes.outputs.changed_files_count || '0' }} ä¸ªæ–‡ä»¶
        - **æ“ä½œçŠ¶æ€**: ${{ steps.commit-changes.outputs.has_changes == 'true' && 'âœ… æˆåŠŸæäº¤' || 'â„¹ï¸ æ— å˜æ›´' }}
        
        ## è¯¦ç»†æ“ä½œ
        EOF
        
        # æ˜¾ç¤ºåˆ é™¤çš„æ–‡ä»¶
        if [ -s deleted_files.txt ]; then
          echo "### ğŸ—‘ï¸ åˆ é™¤çš„æ–‡ä»¶ (${{ steps.delete-files.outputs.deleted_count }} ä¸ª)" >> "$GITHUB_STEP_SUMMARY"
          while IFS= read -r file; do
            echo "- \`$file\`" >> "$GITHUB_STEP_SUMMARY"
          done < deleted_files.txt
          echo "" >> "$GITHUB_STEP_SUMMARY"
        fi
        
        # æ˜¾ç¤ºæ–°å¢/ä¿®æ”¹çš„æ–‡ä»¶
        if [ -s added_modified_files.txt ]; then
          echo "### ğŸ“„ æ–°å¢/ä¿®æ”¹çš„æ–‡ä»¶ ($(({{ steps.checkout-files.outputs.added_count }} + {{ steps.checkout-files.outputs.modified_count }})) ä¸ª)" >> "$GITHUB_STEP_SUMMARY"
          while IFS= read -r file; do
            echo "- \`$file\`" >> "$GITHUB_STEP_SUMMARY"
          done < added_modified_files.txt
          echo "" >> "$GITHUB_STEP_SUMMARY"
        fi
        
        cat >> "$GITHUB_STEP_SUMMARY" << EOF
        ## æ–¹æ³•è¯´æ˜
        - **ç›´æ¥æ£€å‡º**: ä½¿ç”¨git showä»æºæäº¤ç›´æ¥æ£€å‡ºæ–‡ä»¶
        - **å¼ºåˆ¶è¦†ç›–**: æ— è§†æ–‡ä»¶å†²çªï¼Œç›´æ¥è¦†ç›–
        - **ç²¾ç¡®åŒæ­¥**: åªå¤„ç†æäº¤ä¸­å®é™…å˜æ›´çš„æ–‡ä»¶
        
        **æ‰§è¡Œæ—¶é—´**: é¢„è®¡1-2åˆ†é’Ÿ
        EOF

    - name: ğŸ§¹ æ¸…ç†
      if: always()
      run: |
        cd target-repo
        git remote remove source-repo 2>/dev/null || true
        rm -f ../commit_hashes.txt ../repo_names.txt ../changed_files.txt ../added_modified_files.txt ../deleted_files.txt ../all_files.txt 2>/dev/null || true

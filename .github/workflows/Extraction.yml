name: Smart File Extraction and Commit

on:
  workflow_dispatch:
    inputs:
      commit_urls:
        description: "GitHubæäº¤é“¾æ¥ï¼ˆå¤šä¸ªé“¾æ¥ç”¨é€—å·åˆ†éš”ï¼‰"
        required: true
        default: "https://github.com/ApartTUSITU/kernel_xiaomi_sm8250_mod/commit/47b6de7"
      target_repo:
        description: "ç›®æ ‡ä»“åº“ï¼ˆæ ¼å¼ï¼šowner/repoï¼‰"
        required: true
        default: "mozi9/XCD"
      target_branch:
        description: "ç›®æ ‡åˆ†æ”¯"
        required: true
        default: "miuix"
      commit_title:
        description: "æäº¤æ ‡é¢˜"
        required: true
        default: "fs: Bump SuSFS version to v2.0.0"
      commit_description:
        description: "æäº¤æè¿°ï¼ˆå¯é€‰ï¼‰"
        required: false
        default: ""

env:
  GIT_USERNAME: "mozi9"
  GIT_EMAIL: "mozi9@users.noreply.github.com"

jobs:
  smart-file-extraction:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
    - name: ğŸ” éªŒè¯è¾“å…¥å‚æ•°
      id: validate-inputs
      run: |
        echo "=== æ™ºèƒ½æ–‡ä»¶æå– ==="
        
        if [[ -z "${{ github.event.inputs.commit_urls }}" ]]; then
          echo "âŒ æäº¤é“¾æ¥ä¸èƒ½ä¸ºç©º"
          exit 1
        fi
        
        echo "âœ… å‚æ•°éªŒè¯é€šè¿‡"

    - name: âš™ï¸ é…ç½®Gitç¯å¢ƒ
      run: |
        git config --global user.name "mozi9"
        git config --global user.email "mozi9@users.noreply.github.com"
        git config --global core.autocrlf false

    - name: ğŸ“¥ æ£€å‡ºç›®æ ‡ä»“åº“
      uses: actions/checkout@v4
      with:
        repository: ${{ github.event.inputs.target_repo }}
        ref: ${{ github.event.inputs.target_branch }}
        token: ${{ secrets.Mozi9_PAT }}
        path: target-repo
        fetch-depth: 1

    - name: ğŸ” è§£ææäº¤é“¾æ¥
      id: parse-commit-urls
      run: |
        echo "=== è§£ææäº¤é“¾æ¥ ==="
        
        COMMIT_URLS="${{ github.event.inputs.commit_urls }}"
        
        # æ¸…ç†å’Œåˆ†å‰²é“¾æ¥
        COMMIT_URLS_CLEAN=$(echo "$COMMIT_URLS" | tr ',' '\n' | tr ' ' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | grep -v '^$')
        
        # å­˜å‚¨æ‰€æœ‰æäº¤ä¿¡æ¯
        all_commits=()
        all_repos=()
        
        while IFS= read -r commit_url; do
          if [[ "$commit_url" =~ https://github.com/([^/]+)/([^/]+)/commit/([a-f0-9]+) ]]; then
            REPO_OWNER="${BASH_REMATCH[1]}"
            REPO_NAME="${BASH_REMATCH[2]}"
            COMMIT_HASH="${BASH_REMATCH[3]}"
            REPO="$REPO_OWNER/$REPO_NAME"
            
            echo "âœ… $REPO @ $COMMIT_HASH"
            all_commits+=("$COMMIT_HASH")
            all_repos+=("$REPO")
          else
            echo "âŒ é“¾æ¥æ ¼å¼é”™è¯¯: $commit_url"
            exit 1
          fi
        done <<< "$COMMIT_URLS_CLEAN"
        
        # ä¿å­˜ç»“æœ
        printf "%s\n" "${all_commits[@]}" > commit_hashes.txt
        printf "%s\n" "${all_repos[@]}" > repo_names.txt
        
        echo "commits_count=${#all_commits[@]}" >> $GITHUB_OUTPUT

    - name: ğŸ“„ åˆ†ææäº¤æ–‡ä»¶å˜æ›´
      id: analyze-commit-changes
      run: |
        echo "=== åˆ†ææäº¤æ–‡ä»¶å˜æ›´ ==="
        
        readarray -t COMMITS < commit_hashes.txt
        readarray -t REPOS < repo_names.txt
        
        # å­˜å‚¨æ–‡ä»¶å˜æ›´ä¿¡æ¯
        added_files=()
        modified_files=()
        deleted_files=()
        all_files_from_commit=()
        
        for i in "${!COMMITS[@]}"; do
          COMMIT="${COMMITS[$i]}"
          REPO="${REPOS[$i]}"
          
          echo "åˆ†ææäº¤: $REPO @ $COMMIT"
          
          # è·å–æäº¤çš„è¯¦ç»†å˜æ›´ä¿¡æ¯
          commit_url="https://api.github.com/repos/$REPO/commits/$COMMIT"
          commit_response=$(curl -s \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "$commit_url")
          
          # è§£ææ–‡ä»¶å˜æ›´çŠ¶æ€ (A=æ–°å¢, M=ä¿®æ”¹, D=åˆ é™¤, R=é‡å‘½åç­‰)
          files_info=$(echo "$commit_response" | grep -E '(filename|status)' | tr -d '",' | awk '{print $2}')
          
          filename=""
          while read -r line; do
            case $line in
              filename)
                continue
                ;;
              status)
                continue
                ;;
              *)
                if [ -z "$filename" ]; then
                  filename="$line"
                else
                  status="$line"
                  
                  case $status in
                    added|A)
                      if [[ ! " ${added_files[@]} " =~ " ${filename} " ]]; then
                        added_files+=("$filename")
                        all_files_from_commit+=("$filename")
                      fi
                      ;;
                    modified|M)
                      if [[ ! " ${modified_files[@]} " =~ " ${filename} " ]]; then
                        modified_files+=("$filename")
                        all_files_from_commit+=("$filename")
                      fi
                      ;;
                    removed|D)
                      if [[ ! " ${deleted_files[@]} " =~ " ${filename} " ]]; then
                        deleted_files+=("$filename")
                      fi
                      ;;
                    renamed|R)
                      # å¤„ç†é‡å‘½åæ–‡ä»¶
                      if [[ ! " ${modified_files[@]} " =~ " ${filename} " ]]; then
                        modified_files+=("$filename")
                        all_files_from_commit+=("$filename")
                      fi
                      ;;
                  esac
                  filename=""
                fi
            esac
          done <<< "$files_info"
        done
        
        # ä¿å­˜å˜æ›´ä¿¡æ¯
        printf "%s\n" "${added_files[@]}" > added_files.txt
        printf "%s\n" "${modified_files[@]}" > modified_files.txt
        printf "%s\n" "${deleted_files[@]}" > deleted_files.txt
        printf "%s\n" "${all_files_from_commit[@]}" > all_files_from_commit.txt
        
        echo "added_count=${#added_files[@]}" >> $GITHUB_OUTPUT
        echo "modified_count=${#modified_files[@]}" >> $GITHUB_OUTPUT
        echo "deleted_count=${#deleted_files[@]}" >> $GITHUB_OUTPUT
        echo "total_files_count=${#all_files_from_commit[@]}" >> $GITHUB_OUTPUT
        
        echo "âœ… åˆ†æå®Œæˆ:"
        echo "   æ–°å¢æ–‡ä»¶: ${#added_files[@]} ä¸ª"
        echo "   ä¿®æ”¹æ–‡ä»¶: ${#modified_files[@]} ä¸ª"
        echo "   åˆ é™¤æ–‡ä»¶: ${#deleted_files[@]} ä¸ª"
        echo "   æ€»æ–‡ä»¶æ•°: ${#all_files_from_commit[@]} ä¸ª"

    - name: ğŸ“¥ ä¸‹è½½éœ€è¦çš„æ–°å¢å’Œä¿®æ”¹æ–‡ä»¶
      id: download-files
      run: |
        echo "=== ä¸‹è½½æ–‡ä»¶ ==="
        
        readarray -t COMMITS < commit_hashes.txt
        readarray -t REPOS < repo_names.txt
        
        FIRST_REPO="${REPOS[0]}"
        FIRST_COMMIT="${COMMITS[0]}"
        
        mkdir -p source-files
        
        # ä¸‹è½½æ–°å¢å’Œä¿®æ”¹çš„æ–‡ä»¶
        downloaded_files=()
        
        # åˆå¹¶æ–°å¢å’Œä¿®æ”¹æ–‡ä»¶åˆ—è¡¨
        cat added_files.txt modified_files.txt > files_to_download.txt
        
        if [ -s files_to_download.txt ]; then
          echo "ä¸‹è½½æ–°å¢å’Œä¿®æ”¹çš„æ–‡ä»¶..."
          while IFS= read -r file; do
            [ -z "$file" ] && continue
            
            raw_url="https://raw.githubusercontent.com/$FIRST_REPO/$FIRST_COMMIT/$file"
            mkdir -p "source-files/$(dirname "$file")"
            
            if curl -s -f -L "$raw_url" -o "source-files/$file"; then
              downloaded_files+=("$file")
              echo "â¬‡ï¸ ä¸‹è½½: $file"
            else
              echo "âŒ ä¸‹è½½å¤±è´¥: $file"
            fi
          done < files_to_download.txt
        fi
        
        echo "downloaded_count=${#downloaded_files[@]}" >> $GITHUB_OUTPUT
        echo "âœ… æ–‡ä»¶ä¸‹è½½å®Œæˆ: ${#downloaded_files[@]} ä¸ªæ–‡ä»¶"

    - name: ğŸ”„ åŒæ­¥æ–‡ä»¶åˆ°ç›®æ ‡ä»“åº“
      id: sync-files
      run: |
        echo "=== åŒæ­¥æ–‡ä»¶åˆ°ç›®æ ‡ä»“åº“ ==="
        
        # å­˜å‚¨æ“ä½œç»“æœ
        actually_added=()
        actually_modified=()
        actually_deleted=()
        skipped_files=()
        error_files=()
        
        # 1. å¤„ç†æ–°å¢æ–‡ä»¶
        if [ -s added_files.txt ]; then
          echo "å¤„ç†æ–°å¢æ–‡ä»¶..."
          while IFS= read -r file; do
            [ -z "$file" ] && continue
            
            if [ -f "source-files/$file" ]; then
              mkdir -p "target-repo/$(dirname "$file")"
              if cp "source-files/$file" "target-repo/$file"; then
                actually_added+=("$file")
                echo "â• æ–°å¢: $file"
              else
                error_files+=("$file")
              fi
            fi
          done < added_files.txt
        fi
        
        # 2. å¤„ç†ä¿®æ”¹æ–‡ä»¶ï¼ˆæ£€æŸ¥å†…å®¹æ˜¯å¦çœŸçš„éœ€è¦ä¿®æ”¹ï¼‰
        if [ -s modified_files.txt ]; then
          echo "å¤„ç†ä¿®æ”¹æ–‡ä»¶..."
          while IFS= read -r file; do
            [ -z "$file" ] && continue
            
            if [ -f "source-files/$file" ]; then
              if [ -f "target-repo/$file" ]; then
                # æ£€æŸ¥æ–‡ä»¶å†…å®¹æ˜¯å¦ç›¸åŒ
                if diff -q "source-files/$file" "target-repo/$file" >/dev/null 2>&1; then
                  skipped_files+=("$file")
                  echo "â­ï¸  è·³è¿‡: $file (å†…å®¹ç›¸åŒ)"
                else
                  mkdir -p "target-repo/$(dirname "$file")"
                  if cp "source-files/$file" "target-repo/$file"; then
                    actually_modified+=("$file")
                    echo "âœï¸  ä¿®æ”¹: $file"
                  else
                    error_files+=("$file")
                  fi
                fi
              else
                # ç›®æ ‡æ–‡ä»¶ä¸å­˜åœ¨ï¼ŒæŒ‰æ–°å¢å¤„ç†
                mkdir -p "target-repo/$(dirname "$file")"
                if cp "source-files/$file" "target-repo/$file"; then
                  actually_added+=("$file")
                  echo "â• æ–°å¢(ä¿®æ”¹): $file"
                else
                  error_files+=("$file")
                fi
              fi
            fi
          done < modified_files.txt
        fi
        
        # 3. å¤„ç†åˆ é™¤æ–‡ä»¶
        if [ -s deleted_files.txt ]; then
          echo "å¤„ç†åˆ é™¤æ–‡ä»¶..."
          while IFS= read -r file; do
            [ -z "$file" ] && continue
            
            if [ -f "target-repo/$file" ]; then
              if rm "target-repo/$file"; then
                actually_deleted+=("$file")
                echo "ğŸ—‘ï¸  åˆ é™¤: $file"
                
                # å°è¯•åˆ é™¤ç©ºç›®å½•
                dir=$(dirname "$file")
                while [ "$dir" != "." ] && [ -d "target-repo/$dir" ]; do
                  if [ -z "$(ls -A "target-repo/$dir")" ]; then
                    rmdir "target-repo/$dir"
                    dir=$(dirname "$dir")
                  else
                    break
                  fi
                done
              else
                error_files+=("$file")
              fi
            else
              skipped_files+=("$file")
              echo "â­ï¸  è·³è¿‡åˆ é™¤: $file (æ–‡ä»¶ä¸å­˜åœ¨)"
            fi
          done < deleted_files.txt
        fi
        
        # ä¿å­˜æ“ä½œç»“æœ
        printf "%s\n" "${actually_added[@]}" > actually_added.txt
        printf "%s\n" "${actually_modified[@]}" > actually_modified.txt
        printf "%s\n" "${actually_deleted[@]}" > actually_deleted.txt
        printf "%s\n" "${skipped_files[@]}" > skipped_files.txt
        printf "%s\n" "${error_files[@]}" > error_files.txt
        
        echo "actually_added_count=${#actually_added[@]}" >> $GITHUB_OUTPUT
        echo "actually_modified_count=${#actually_modified[@]}" >> $GITHUB_OUTPUT
        echo "actually_deleted_count=${#actually_deleted[@]}" >> $GITHUB_OUTPUT
        echo "skipped_count=${#skipped_files[@]}" >> $GITHUB_OUTPUT
        echo "error_count=${#error_files[@]}" >> $GITHUB_OUTPUT
        
        echo "âœ… åŒæ­¥å®Œæˆ:"
        echo "   å®é™…æ–°å¢: ${#actually_added[@]} ä¸ªæ–‡ä»¶"
        echo "   å®é™…ä¿®æ”¹: ${#actually_modified[@]} ä¸ªæ–‡ä»¶"
        echo "   å®é™…åˆ é™¤: ${#actually_deleted[@]} ä¸ªæ–‡ä»¶"
        echo "   è·³è¿‡æ“ä½œ: ${#skipped_files[@]} ä¸ªæ–‡ä»¶"
        echo "   é”™è¯¯æ“ä½œ: ${#error_files[@]} ä¸ªæ–‡ä»¶"

    - name: ğŸ’¾ æäº¤å˜æ›´
      id: commit-changes
      run: |
        cd target-repo
        
        echo "=== æäº¤å˜æ›´ ==="
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
        if git diff-index --quiet HEAD --; then
          echo "â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "ğŸ“ å‘ç°å˜æ›´ï¼Œå‡†å¤‡æäº¤..."
          
          git add -A
          
          # è·å–å˜æ›´ç»Ÿè®¡
          CHANGED_FILES=$(git diff --name-only --cached)
          CHANGED_COUNT=$(echo "$CHANGED_FILES" | wc -l)
          
          echo "å˜æ›´æ–‡ä»¶ ($CHANGED_COUNT ä¸ª):"
          echo "$CHANGED_FILES"
          
          # åˆ›å»ºè¯¦ç»†çš„æäº¤ä¿¡æ¯
          readarray -t COMMITS < ../commit_hashes.txt
          COMMIT_COUNT=${#COMMITS[@]}
          
          commit_msg="${{ github.event.inputs.commit_title }}"
          commit_msg="$commit_msg"$'\n'$'\n'"æ¥è‡ª $COMMIT_COUNT ä¸ªæäº¤çš„å˜æ›´:"
          
          # æ·»åŠ å˜æ›´ç»Ÿè®¡
          commit_msg="$commit_msg"$'\n'"- æ–°å¢æ–‡ä»¶: ${{ steps.sync-files.outputs.actually_added_count }} ä¸ª"
          commit_msg="$commit_msg"$'\n'"- ä¿®æ”¹æ–‡ä»¶: ${{ steps.sync-files.outputs.actually_modified_count }} ä¸ª"
          commit_msg="$commit_msg"$'\n'"- åˆ é™¤æ–‡ä»¶: ${{ steps.sync-files.outputs.actually_deleted_count }} ä¸ª"
          
          if [ -n "${{ github.event.inputs.commit_description }}" ]; then
            commit_msg="$commit_msg"$'\n'$'\n'"${{ github.event.inputs.commit_description }}"
          fi
          
          git commit -m "$commit_msg"
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "changed_files_count=$CHANGED_COUNT" >> $GITHUB_OUTPUT
          echo "âœ… æäº¤åˆ›å»ºæˆåŠŸ"
        fi

    - name: ğŸš€ æ¨é€æ›´æ”¹
      if: steps.commit-changes.outputs.has_changes == 'true'
      run: |
        cd target-repo
        
        echo "=== æ¨é€æ›´æ”¹ ==="
        
        git push origin "${{ github.event.inputs.target_branch }}"
        echo "âœ… æ¨é€æˆåŠŸ"

    - name: ğŸ“‹ ç”Ÿæˆè¯¦ç»†æŠ¥å‘Š
      if: always()
      run: |
        cat > "$GITHUB_STEP_SUMMARY" << EOF
        # æ–‡ä»¶åŒæ­¥å®ŒæˆæŠ¥å‘Š
        
        ## å˜æ›´ç»Ÿè®¡
        - **åˆ†ææäº¤**: ${{ steps.parse-commit-urls.outputs.commits_count }} ä¸ª
        - **å‘ç°å˜æ›´**: ${{ steps.analyze-commit-changes.outputs.total_files_count }} ä¸ªæ–‡ä»¶
        - **å®é™…æ“ä½œ**: ${{ steps.sync-files.outputs.actually_added_count }} æ–°å¢, ${{ steps.sync-files.outputs.actually_modified_count }} ä¿®æ”¹, ${{ steps.sync-files.outputs.actually_deleted_count }} åˆ é™¤
        - **è·³è¿‡æ“ä½œ**: ${{ steps.sync-files.outputs.skipped_count }} ä¸ªæ–‡ä»¶
        - **æœ€ç»ˆæäº¤**: ${{ steps.commit-changes.outputs.changed_files_count || '0' }} ä¸ªæ–‡ä»¶
        
        ## è¯¦ç»†æ“ä½œè®°å½•
        EOF
        
        # æ–°å¢æ–‡ä»¶
        if [ -f actually_added.txt ] && [ -s actually_added.txt ]; then
          echo "### â• æ–°å¢æ–‡ä»¶ (${{ steps.sync-files.outputs.actually_added_count }} ä¸ª):" >> "$GITHUB_STEP_SUMMARY"
          while IFS= read -r file; do
            echo "- \`$file\`" >> "$GITHUB_STEP_SUMMARY"
          done < actually_added.txt
          echo "" >> "$GITHUB_STEP_SUMMARY"
        fi
        
        # ä¿®æ”¹æ–‡ä»¶
        if [ -f actually_modified.txt ] && [ -s actually_modified.txt ]; then
          echo "### âœï¸ ä¿®æ”¹æ–‡ä»¶ (${{ steps.sync-files.outputs.actually_modified_count }} ä¸ª):" >> "$GITHUB_STEP_SUMMARY"
          while IFS= read -r file; do
            echo "- \`$file\`" >> "$GITHUB_STEP_SUMMARY"
          done < actually_modified.txt
          echo "" >> "$GITHUB_STEP_SUMMARY"
        fi
        
        # åˆ é™¤æ–‡ä»¶
        if [ -f actually_deleted.txt ] && [ -s actually_deleted.txt ]; then
          echo "### ğŸ—‘ï¸ åˆ é™¤æ–‡ä»¶ (${{ steps.sync-files.outputs.actually_deleted_count }} ä¸ª):" >> "$GITHUB_STEP_SUMMARY"
          while IFS= read -r file; do
            echo "- \`$file\`" >> "$GITHUB_STEP_SUMMARY"
          done < actually_deleted.txt
          echo "" >> "$GITHUB_STEP_SUMMARY"
        fi
        
        # è·³è¿‡æ–‡ä»¶
        if [ -f skipped_files.txt ] && [ -s skipped_files.txt ]; then
          echo "### â­ï¸ è·³è¿‡æ–‡ä»¶ (${{ steps.sync-files.outputs.skipped_count }} ä¸ª):" >> "$GITHUB_STEP_SUMMARY"
          echo "ä»¥ä¸‹æ–‡ä»¶å†…å®¹ç›¸åŒæˆ–ä¸å­˜åœ¨ï¼Œè·³è¿‡æ“ä½œ:" >> "$GITHUB_STEP_SUMMARY"
          while IFS= read -r file; do
            echo "- \`$file\`" >> "$GITHUB_STEP_SUMMARY"
          done < skipped_files.txt
          echo "" >> "$GITHUB_STEP_SUMMARY"
        fi
        
        # çŠ¶æ€æ€»ç»“
        if [ "${{ steps.commit-changes.outputs.has_changes }}" = "true" ]; then
          echo "## âœ… æ“ä½œç»“æœ" >> "$GITHUB_STEP_SUMMARY"
          echo "æˆåŠŸåŒæ­¥å¹¶æäº¤äº† ${{ steps.commit-changes.outputs.changed_files_count }} ä¸ªæ–‡ä»¶çš„å˜æ›´ã€‚" >> "$GITHUB_STEP_SUMMARY"
        else
          echo "## â„¹ï¸ æ“ä½œç»“æœ" >> "$GITHUB_STEP_SUMMARY"
          echo "æ²¡æœ‰æ£€æµ‹åˆ°éœ€è¦æäº¤çš„å˜æ›´ï¼ˆæ‰€æœ‰æ–‡ä»¶å†…å®¹ç›¸åŒï¼‰ã€‚" >> "$GITHUB_STEP_SUMMARY"
        fi
        
        cat >> "$GITHUB_STEP_SUMMARY" << EOF
        
        ## æŠ€æœ¯è¯´æ˜
        - **æ–°å¢æ–‡ä»¶**: æºä»“åº“æœ‰ä½†ç›®æ ‡ä»“åº“æ²¡æœ‰çš„æ–‡ä»¶
        - **ä¿®æ”¹æ–‡ä»¶**: æºä»“åº“å’Œç›®æ ‡ä»“åº“éƒ½æœ‰ä½†å†…å®¹ä¸åŒçš„æ–‡ä»¶
        - **åˆ é™¤æ–‡ä»¶**: æºä»“åº“åˆ é™¤ä½†ç›®æ ‡ä»“åº“å­˜åœ¨çš„æ–‡ä»¶
        - **è·³è¿‡æ–‡ä»¶**: å†…å®¹ç›¸åŒçš„æ–‡ä»¶æˆ–ç›®æ ‡ä»“åº“ä¸å­˜åœ¨çš„åˆ é™¤æ–‡ä»¶
        
        **æ‰§è¡ŒçŠ¶æ€**: ${{ steps.commit-changes.outputs.has_changes == 'true' && 'âœ… æˆåŠŸæäº¤' || 'â„¹ï¸ æ— å˜æ›´' }}
        EOF

    - name: ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶
      if: always()
      run: |
        rm -rf source-files
        rm -f commit_hashes.txt repo_names.txt added_files.txt modified_files.txt deleted_files.txt
        rm -f all_files_from_commit.txt files_to_download.txt actually_added.txt actually_modified.txt
        rm -f actually_deleted.txt skipped_files.txt error_files.txt 2>/dev/null || true

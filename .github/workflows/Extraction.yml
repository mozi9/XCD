name: File Extraction and Commit

on:
  workflow_dispatch:
    inputs:
      source_repo_url:
        description: "æºä»“åº“URL"
        required: true
        default: "https://github.com/ApartTUSITU/kernel_xiaomi_sm8250_mod"
      target_repo_url:
        description: "ç›®æ ‡ä»“åº“URL"
        required: true
        default: "https://github.com/mozi9/XCD"
      source_commits:
        description: "æºä»“åº“æäº¤å“ˆå¸Œï¼ˆé€—å·åˆ†éš”ï¼Œæ”¯æŒçŸ­å“ˆå¸Œæˆ–å®Œæ•´å“ˆå¸Œï¼‰"
        required: true
        default: "47b6de7"
      source_branch:
        description: "æºåˆ†æ”¯"
        required: true
        default: "android_kernel_common_android12-5.10"
      target_branch:
        description: "ç›®æ ‡åˆ†æ”¯"
        required: true
        default: "miuix"
      commit_title:
        description: "æäº¤æ ‡é¢˜"
        required: true
        default: "fs: Bump SuSFS version to v2.0.0"
      commit_description:
        description: "æäº¤æè¿°ï¼ˆå¯é€‰ï¼‰"
        required: false
        default: ""

env:
  GIT_USERNAME: "mozi9"
  GIT_EMAIL: "mozi9@users.noreply.github.com"

jobs:
  file-extraction-commit:
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ” éªŒè¯è¾“å…¥å‚æ•°
      id: validate-inputs
      run: |
        echo "=== éªŒè¯è¾“å…¥å‚æ•° ==="
        
        if [[ ! "${{ github.event.inputs.source_repo_url }}" =~ ^https://github.com/ ]]; then
          echo "âŒ é”™è¯¯ï¼šæºä»“åº“URLæ ¼å¼ä¸æ­£ç¡®"
          exit 1
        fi
        
        if [[ ! "${{ github.event.inputs.target_repo_url }}" =~ ^https://github.com/ ]]; then
          echo "âŒ é”™è¯¯ï¼šç›®æ ‡ä»“åº“URLæ ¼å¼ä¸æ­£ç¡®"
          exit 1
        fi
        
        if [[ -z "${{ github.event.inputs.source_commits }}" ]]; then
          echo "âŒ é”™è¯¯ï¼šæäº¤å“ˆå¸Œä¸èƒ½ä¸ºç©º"
          exit 1
        fi
        
        echo "âœ… è¾“å…¥å‚æ•°éªŒè¯é€šè¿‡"

    - name: ğŸ“¥ æ£€å‡ºæºä»“åº“ï¼ˆä½¿ç”¨Mozi9_PATï¼‰
      uses: actions/checkout@v4
      with:
        repository: ${{ fromJSON(format('{{0}}', github.event.inputs.source_repo_url)) }}
        ref: ${{ github.event.inputs.source_branch }}
        token: ${{ secrets.Mozi9_PAT }}
        path: source-repo
        fetch-depth: 0

    - name: ğŸ“¥ æ£€å‡ºç›®æ ‡ä»“åº“ï¼ˆä½¿ç”¨Mozi9_PATï¼‰
      uses: actions/checkout@v4
      with:
        repository: ${{ fromJSON(format('{{0}}', github.event.inputs.target_repo_url)) }}
        ref: ${{ github.event.inputs.target_branch }}
        token: ${{ secrets.Mozi9_PAT }}
        path: target-repo
        fetch-depth: 0

    - name: âš™ï¸ é…ç½®Gitèº«ä»½ä¸ºmozi9
      run: |
        git config --global user.name "mozi9"
        git config --global user.email "mozi9@users.noreply.github.com"
        
        # é…ç½®Gitä½¿ç”¨Mozi9_PATè¿›è¡Œè®¤è¯
        git config --global credential.helper store
        echo "https://mozi9:${{ secrets.Mozi9_PAT }}@github.com" > ~/.git-credentials
        
        echo "âœ… Gitèº«ä»½å·²é…ç½®ä¸º: mozi9 <mozi9@users.noreply.github.com>"
        echo "âœ… å·²é…ç½®Mozi9_PATä»¤ç‰Œè®¤è¯"

    - name: ğŸ” è§£ææäº¤å“ˆå¸Œ
      id: resolve-commits
      run: |
        cd source-repo
        
        # é…ç½®å½“å‰ä»“åº“çš„Gitèº«ä»½ä¸ºmozi9
        git config user.name "mozi9"
        git config user.email "mozi9@users.noreply.github.com"
        
        COMMITS=$(echo "${{ github.event.inputs.source_commits }}" | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | grep -v '^$')
        
        if [ -z "$COMMITS" ]; then
          echo "âŒ é”™è¯¯ï¼šæœªæä¾›æœ‰æ•ˆçš„æäº¤å“ˆå¸Œ"
          exit 1
        fi
        
        echo "æ­£åœ¨è§£ææäº¤å“ˆå¸Œ..."
        resolved_commits=()
        
        for commit in $COMMITS; do
          echo "å°è¯•è§£æ: $commit"
          if full_hash=$(git rev-parse --verify "$commit" 2>/dev/null); then
            if git merge-base --is-ancestor "$full_hash" HEAD 2>/dev/null; then
              resolved_commits+=("$full_hash")
              echo "âœ… è§£ææˆåŠŸ: $commit -> $full_hash"
            else
              echo "âŒ é”™è¯¯: æäº¤ $commit ä¸åœ¨åˆ†æ”¯ ${{ github.event.inputs.source_branch }} çš„å†å²ä¸­"
              exit 1
            fi
          else
            echo "âŒ é”™è¯¯: æ— æ³•è§£ææäº¤ '$commit'"
            exit 1
          fi
        done
        
        printf "%s\n" "${resolved_commits[@]}" > ../resolved_commits.txt
        echo "commits_count=${#resolved_commits[@]}" >> $GITHUB_OUTPUT
        echo "âœ… æˆåŠŸè§£æ ${#resolved_commits[@]} ä¸ªæäº¤"

    - name: ğŸ“Š åˆ†ææ–‡ä»¶å˜æ›´
      id: analyze-files
      run: |
        cd source-repo
        
        # ç¡®ä¿Gitèº«ä»½ä¸ºmozi9
        git config user.name "mozi9"
        git config user.email "mozi9@users.noreply.github.com"
        
        if [ ! -f ../resolved_commits.txt ] || [ ! -s ../resolved_commits.txt ]; then
          echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°è§£æçš„æäº¤ä¿¡æ¯"
          exit 1
        fi
        
        echo "=== åˆ†ææ–‡ä»¶å˜æ›´ ==="
        
        modified_files=()
        deleted_files=()
        
        while IFS= read -r commit; do
          [ -z "$commit" ] && continue
          
          echo "åˆ†ææäº¤: $commit"
          
          git show --name-status --format= "$commit" | while IFS=$'\t' read -r status file; do
            [ -z "$file" ] && continue
            
            case "$status" in
              A|M|C|R)
                if [[ ! " ${modified_files[@]} " =~ " ${file} " ]]; then
                  modified_files+=("$file")
                fi
                ;;
              D)
                if [[ ! " ${deleted_files[@]} " =~ " ${file} " ]]; then
                  deleted_files+=("$file")
                fi
                ;;
            esac
          done
        done < ../resolved_commits.txt
        
        if [ ${#modified_files[@]} -gt 0 ]; then
          printf "%s\n" "${modified_files[@]}" | sort -u > ../modified_files.txt
        else
          touch ../modified_files.txt
        fi
        
        if [ ${#deleted_files[@]} -gt 0 ]; then
          printf "%s\n" "${deleted_files[@]}" | sort -u > ../deleted_files.txt
        else
          touch ../deleted_files.txt
        fi
        
        echo "modified_files_count=${#modified_files[@]}" >> $GITHUB_OUTPUT
        echo "deleted_files_count=${#deleted_files[@]}" >> $GITHUB_OUTPUT
        echo "âœ… åˆ†æå®Œæˆ: ä¿®æ”¹æ–‡ä»¶ ${#modified_files[@]} ä¸ª, åˆ é™¤æ–‡ä»¶ ${#deleted_files[@]} ä¸ª"

    - name: ğŸ’¾ åˆ›å»ºå¤‡ä»½
      id: create-backup
      run: |
        cd target-repo
        echo "=== åˆ›å»ºç›®æ ‡ä»“åº“å¤‡ä»½ ==="
        timestamp=$(date +%Y%m%d_%H%M%S)
        cp -r . "../target-backup-$timestamp"
        echo "âœ… å¤‡ä»½åˆ›å»ºå®Œæˆ: target-backup-$timestamp"

    - name: ğŸ—‘ï¸ å®‰å…¨åˆ é™¤æ–‡ä»¶
      id: delete-files
      run: |
        cd target-repo
        
        # é…ç½®ç›®æ ‡ä»“åº“çš„Gitèº«ä»½ä¸ºmozi9
        git config user.name "mozi9"
        git config user.email "mozi9@users.noreply.github.com"
        
        echo "=== å®‰å…¨åˆ é™¤æ–‡ä»¶ ==="
        deleted_count=0
        safe_deleted_files=()
        
        if [ -s ../deleted_files.txt ]; then
          while IFS= read -r file; do
            [ -z "$file" ] && continue
            
            if [[ "$file" == / || "$file" == /* || "$file" == .git* || "$file" == "." || "$file" == ".." || "$file" == */.git* ]]; then
              echo "âŒ å®‰å…¨é”™è¯¯: æ‹’ç»åˆ é™¤å—é™æ–‡ä»¶ '$file'"
              exit 1
            fi
            
            if [ -f "$file" ]; then
              echo "ğŸ—‘ï¸ åˆ é™¤: $file"
              rm -f -- "$file"
              deleted_count=$((deleted_count + 1))
              safe_deleted_files+=("$file")
            else
              echo "â„¹ï¸ æ–‡ä»¶ä¸å­˜åœ¨: $file"
            fi
          done < ../deleted_files.txt
        else
          echo "â„¹ï¸ æ²¡æœ‰éœ€è¦åˆ é™¤çš„æ–‡ä»¶"
        fi
        
        echo "actual_deleted_count=$deleted_count" >> $GITHUB_OUTPUT
        printf "%s\n" "${safe_deleted_files[@]}" > ../actual_deleted_files.txt
        echo "âœ… åˆ é™¤å®Œæˆ: $deleted_count ä¸ªæ–‡ä»¶"

    - name: ğŸ“„ å¤åˆ¶æ–‡ä»¶
      id: copy-files
      run: |
        cd source-repo
        
        echo "=== å¤åˆ¶æ–‡ä»¶åˆ°ç›®æ ‡ä»“åº“ ==="
        copied_count=0
        failed_files=()
        
        if [ -s ../modified_files.txt ]; then
          while IFS= read -r file; do
            [ -z "$file" ] && continue
            
            if [ -f "$file" ]; then
              echo "ğŸ“„ å¤åˆ¶: $file"
              
              mkdir -p "../target-repo/$(dirname "$file")"
              
              if cp --parents "$file" "../target-repo/"; then
                copied_count=$((copied_count + 1))
              else
                echo "âŒ å¤åˆ¶å¤±è´¥: $file"
                failed_files+=("$file")
              fi
            else
              echo "âš ï¸ æºæ–‡ä»¶ä¸å­˜åœ¨: $file"
              failed_files+=("$file")
            fi
          done < ../modified_files.txt
        else
          echo "â„¹ï¸ æ²¡æœ‰éœ€è¦å¤åˆ¶çš„æ–‡ä»¶"
        fi
        
        echo "actual_copied_count=$copied_count" >> $GITHUB_OUTPUT
        
        if [ ${#failed_files[@]} -gt 0 ]; then
          echo "failed_files_count=${#failed_files[@]}" >> $GITHUB_OUTPUT
          printf "%s\n" "${failed_files[@]}" > ../failed_files.txt
        fi
        
        echo "âœ… å¤åˆ¶å®Œæˆ: $copied_count ä¸ªæ–‡ä»¶"

    - name: âœ… éªŒè¯ç»“æœ
      id: verify-results
      run: |
        echo "=== æ“ä½œéªŒè¯ ==="
        echo "æäº¤æ•°é‡: ${{ steps.resolve-commits.outputs.commits_count }}"
        echo "ä¿®æ”¹æ–‡ä»¶: ${{ steps.analyze-files.outputs.modified_files_count }}"
        echo "åˆ é™¤æ–‡ä»¶: ${{ steps.analyze-files.outputs.deleted_files_count }}"
        echo "å®é™…å¤åˆ¶: ${{ steps.copy-files.outputs.actual_copied_count }}"
        echo "å®é™…åˆ é™¤: ${{ steps.delete-files.outputs.actual_deleted_count }}"
        
        if [ -n "${{ steps.copy-files.outputs.failed_files_count }}" ]; then
          echo "å¤±è´¥æ–‡ä»¶: ${{ steps.copy-files.outputs.failed_files_count }}"
        fi
        
        cd target-repo
        echo "ç›®æ ‡ä»“åº“æ–‡ä»¶æ•°: $(find . -type f -not -path '*/\.git/*' | wc -l)"
        
        # éªŒè¯Gitèº«ä»½é…ç½®
        echo "=== Gitèº«ä»½éªŒè¯ ==="
        echo "ç”¨æˆ·å: $(git config user.name)"
        echo "é‚®ç®±: $(git config user.email)"

    - name: ğŸ’¾ æäº¤å˜æ›´ï¼ˆä½¿ç”¨Mozi9_PATèº«ä»½ï¼‰
      id: commit-changes
      run: |
        cd target-repo
        
        # å¼ºåˆ¶é…ç½®Gitèº«ä»½ä¸ºmozi9
        git config user.name "mozi9"
        git config user.email "mozi9@users.noreply.github.com"
        
        echo "=== å‡†å¤‡æäº¤ï¼ˆä½¿ç”¨Mozi9_PATèº«ä»½ï¼‰ ==="
        
        if git diff-index --quiet HEAD --; then
          echo "â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "ğŸ“ æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
          echo "has_changes=true" >> $GITHUB_OUTPUT
          
          git add -A
          
          echo "=== å˜æ›´è¯¦æƒ… ==="
          git status --short
          
          # éªŒè¯æäº¤äººèº«ä»½
          echo "=== æäº¤äººèº«ä»½éªŒè¯ ==="
          echo "æäº¤äººå§“å: $(git config user.name)"
          echo "æäº¤äººé‚®ç®±: $(git config user.email)"
          
          # åˆ›å»ºæäº¤ä¿¡æ¯
          commit_msg="${{ github.event.inputs.commit_title }}"
          if [ -n "${{ github.event.inputs.commit_description }}" ]; then
            commit_msg="$commit_msg"$'\n'$'\n'"${{ github.event.inputs.commit_description }}"
          fi
          
          # ä½¿ç”¨ç¯å¢ƒå˜é‡å¼ºåˆ¶è®¾ç½®æäº¤è€…èº«ä»½
          GIT_AUTHOR_NAME="mozi9" GIT_AUTHOR_EMAIL="mozi9@users.noreply.github.com" \
          GIT_COMMITTER_NAME="mozi9" GIT_COMMITTER_EMAIL="mozi9@users.noreply.github.com" \
          git commit -m "$commit_msg"
          
          # éªŒè¯æäº¤çš„ä½œè€…ä¿¡æ¯
          echo "=== æäº¤ä¿¡æ¯éªŒè¯ ==="
          git log -1 --pretty=fuller
          
          echo "âœ… æäº¤åˆ›å»ºæˆåŠŸï¼ˆä½¿ç”¨Mozi9_PATèº«ä»½ï¼‰"
        fi

    - name: ğŸš€ æ¨é€æ›´æ”¹ï¼ˆä½¿ç”¨Mozi9_PATä»¤ç‰Œï¼‰
      if: steps.commit-changes.outputs.has_changes == 'true'
      run: |
        cd target-repo
        
        # é…ç½®æ¨é€èº«ä»½
        git config user.name "mozi9"
        git config user.email "mozi9@users.noreply.github.com"
        
        echo "=== ä½¿ç”¨Mozi9_PATæ¨é€åˆ°ç›®æ ‡ä»“åº“ ==="
        
        # é…ç½®è¿œç¨‹URLä½¿ç”¨ä»¤ç‰Œè®¤è¯
        git remote set-url origin https://mozi9:${{ secrets.Mozi9_PAT }}@github.com/${{ github.repository_owner }}/$(echo ${{ github.event.inputs.target_repo_url }} | sed 's|https://github.com/||')
        
        # å…ˆæ‹‰å–æœ€æ–°æ›´æ”¹é¿å…å†²çª
        echo "æ­£åœ¨æ‹‰å–æœ€æ–°æ›´æ”¹..."
        git pull origin ${{ github.event.inputs.target_branch }} --rebase --no-edit
        
        # ä½¿ç”¨Mozi9_PATæ¨é€
        echo "æ­£åœ¨æ¨é€æ›´æ”¹..."
        if git push origin ${{ github.event.inputs.target_branch }}; then
          echo "âœ… æ¨é€æˆåŠŸï¼ˆä½¿ç”¨Mozi9_PATï¼‰"
          
          # éªŒè¯è¿œç¨‹æäº¤çš„ä½œè€…ä¿¡æ¯
          echo "=== è¿œç¨‹æäº¤éªŒè¯ ==="
          git log -1 --pretty=fuller
          echo "=== æ¨é€èº«ä»½éªŒè¯ ==="
          git remote -v
        else
          echo "âŒ æ¨é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥Mozi9_PATæƒé™"
          exit 1
        fi

    - name: ğŸ” æ¸…ç†å‡­æ®
      if: always()
      run: |
        echo "=== æ¸…ç†Gitå‡­æ® ==="
        rm -f ~/.git-credentials
        git config --global --unset credential.helper
        echo "âœ… Gitå‡­æ®å·²æ¸…ç†"

    - name: ğŸ“‹ ç”ŸæˆæŠ¥å‘Š
      if: always()
      run: |
        cat > $GITHUB_STEP_SUMMARY << EOF
        # æ–‡ä»¶æå–å’Œæäº¤ç»“æœ
        
        ## ç»Ÿè®¡ä¿¡æ¯
        - **å¤„ç†çš„æäº¤**: ${{ steps.resolve-commits.outputs.commits_count || '0' }}
        - **ä¿®æ”¹æ–‡ä»¶**: ${{ steps.analyze-files.outputs.modified_files_count || '0' }}
        - **åˆ é™¤æ–‡ä»¶**: ${{ steps.analyze-files.outputs.deleted_files_count || '0' }}
        - **æˆåŠŸå¤åˆ¶**: ${{ steps.copy-files.outputs.actual_copied_count || '0' }}
        - **æˆåŠŸåˆ é™¤**: ${{ steps.delete-files.outputs.actual_deleted_count || '0' }}
        
        ## è®¤è¯ä¿¡æ¯
        - **ä½¿ç”¨çš„ä»¤ç‰Œ**: Mozi9_PAT
        - **æäº¤äººèº«ä»½**: mozi9
        - **æäº¤äººé‚®ç®±**: mozi9@users.noreply.github.com
        
        ## çŠ¶æ€
        EOF
        
        if [ "${{ steps.commit-changes.outputs.has_changes }}" = "true" ]; then
          echo "âœ… **æ“ä½œæˆåŠŸå®Œæˆ** - ä½¿ç”¨Mozi9_PATä»¤ç‰Œè®¤è¯ï¼Œæ‰€æœ‰æäº¤å‡ä»¥mozi9èº«ä»½è¿›è¡Œ" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ steps.commit-changes.outputs.has_changes }}" = "false" ]; then
          echo "âš ï¸ **æ²¡æœ‰æ£€æµ‹åˆ°å˜æ›´**" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **æ“ä½œæ‰§è¡Œå¤±è´¥**" >> $GITHUB_STEP_SUMMARY
        fi

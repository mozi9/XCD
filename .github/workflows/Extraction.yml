name: Manual Repository Sync - Cherry-pick with Mozi9 Identity

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: 'æºä»“åº“åœ°å€ (æ ¼å¼: owner/repo)'
        required: true
        default: 'owner/source-repo'
      target_repo:
        description: 'ç›®æ ‡ä»“åº“åœ°å€ (æ ¼å¼: owner/repo)'
        required: true
        default: 'owner/target-repo'
      source_branch:
        description: 'æºåˆ†æ”¯å'
        required: true
        default: 'main'
      target_branch:
        description: 'ç›®æ ‡åˆ†æ”¯å'
        required: true
        default: 'main'
      start_commit:
        description: 'å¼€å§‹åŒæ­¥çš„æäº¤å“ˆå¸Œ (å®Œæ•´å“ˆå¸Œ)'
        required: false
      max_commits:
        description: 'æœ€å¤§åŒæ­¥æäº¤æ•°é‡'
        required: true
        default: '10'

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  sync-repository:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout target repository
      uses: actions/checkout@v4
      with:
        repository: ${{ github.event.inputs.target_repo }}
        token: ${{ secrets.Mozi9_PAT }}
        ref: ${{ github.event.inputs.target_branch }}
        fetch-depth: 0

    - name: Add source repository as remote
      run: |
        git remote add source-repo https://github.com/${{ github.event.inputs.source_repo }}.git
        git fetch source-repo ${{ github.event.inputs.source_branch }} --depth=100

    - name: Setup Git config for Mozi9
      run: |
        git config --global user.name "mozi9"
        git config --global user.email "mozi9"

    - name: Get commit list to sync
      id: get_commits
      run: |
        # è·å–å®Œæ•´æäº¤å“ˆå¸Œåˆ—è¡¨
        if [ -n "${{ github.event.inputs.start_commit }}" ]; then
          # éªŒè¯start_commitæ˜¯å¦å­˜åœ¨
          if ! git rev-parse ${{ github.event.inputs.start_commit }} >/dev/null 2>&1; then
            echo "é”™è¯¯: æäº¤ ${{ github.event.inputs.start_commit }} ä¸å­˜åœ¨"
            exit 1
          fi
          # ä»æŒ‡å®šæäº¤å¼€å§‹ï¼Œè·å–ä¹‹åçš„æäº¤
          COMMITS=$(git log --reverse --format=%H ${{ github.event.inputs.start_commit }}..source-repo/${{ github.event.inputs.source_branch }} | head -n ${{ github.event.inputs.max_commits }})
        else
          # ä»æœ€æ–°æäº¤å¼€å§‹ï¼Œè·å–æŒ‡å®šæ•°é‡çš„æäº¤
          COMMITS=$(git log --reverse --format=%H -n ${{ github.event.inputs.max_commits }} source-repo/${{ github.event.inputs.source_branch }})
        fi
        
        # è®¡ç®—æäº¤æ•°é‡
        if [ -z "$COMMITS" ]; then
          COMMIT_COUNT=0
        else
          COMMIT_COUNT=$(echo "$COMMITS" | wc -l)
        fi
        
        if [ "$COMMIT_COUNT" -eq 0 ]; then
          echo "æ²¡æœ‰æ‰¾åˆ°éœ€è¦åŒæ­¥çš„æäº¤"
          exit 1
        fi
        
        echo "æ‰¾åˆ° $COMMIT_COUNT ä¸ªéœ€è¦åŒæ­¥çš„æäº¤"
        echo "æäº¤åˆ—è¡¨:"
        echo "$COMMITS" | while read commit; do
          git log -1 --oneline $commit
        done
        
        # ä¿å­˜å®Œæ•´å“ˆå¸Œåˆ—è¡¨åˆ°æ–‡ä»¶
        echo "$COMMITS" > /tmp/commit_list.txt
        echo "commit_count=$COMMIT_COUNT" >> $GITHUB_OUTPUT

    - name: Cherry-pick commits with Mozi9 identity
      run: |
        COMMITS=$(cat /tmp/commit_list.txt)
        I=1
        TOTAL=${{ steps.get_commits.outputs.commit_count }}
        
        for COMMIT in $COMMITS; do
          echo "================================================================="
          echo "æ­£åœ¨cherry-pickæäº¤ $I/$TOTAL: $COMMIT"
          
          # è·å–æäº¤ä¿¡æ¯ï¼ˆåªä¿ç•™æäº¤æ¶ˆæ¯ï¼‰
          COMMIT_MESSAGE=$(git log -1 --format=%s $COMMIT)
          echo "æäº¤ä¿¡æ¯: $COMMIT_MESSAGE"
          
          # å°è¯•cherry-pickï¼Œå†²çªæ—¶ç›´æ¥ä½¿ç”¨æºæäº¤çš„æ–‡ä»¶
          set +e  # å…è®¸é”™è¯¯ç»§ç»­æ‰§è¡Œ
          if git cherry-pick $COMMIT --strategy=recursive -X theirs --allow-empty --keep-redundant-commits; then
            echo "âœ… cherry-pickæˆåŠŸ"
          else
            echo "âš ï¸ æ£€æµ‹åˆ°å†²çªï¼Œä½¿ç”¨æºæäº¤æ–‡ä»¶è§£å†³..."
            
            # æ£€æŸ¥æ˜¯å¦æœ‰æœªè§£å†³çš„å†²çª
            CONFLICT_FILES=$(git diff --name-only --diff-filter=U)
            if [ -n "$CONFLICT_FILES" ]; then
              echo "å†²çªæ–‡ä»¶: $CONFLICT_FILES"
              
              # ä½¿ç”¨æºæäº¤çš„æ–‡ä»¶è¦†ç›–æ‰€æœ‰å†²çªæ–‡ä»¶
              for file in $CONFLICT_FILES; do
                echo "è§£å†³å†²çª: $file"
                # ä½¿ç”¨æºæäº¤çš„æ–‡ä»¶è¦†ç›–
                git show $COMMIT:"$file" > "$file" 2>/dev/null || echo "æ— æ³•æ¢å¤æ–‡ä»¶: $file"
              done
              
              # æ·»åŠ è§£å†³åçš„æ–‡ä»¶
              git add .
            fi
            
            # ç»§ç»­cherry-pick
            git cherry-pick --continue
            echo "âœ… å†²çªå·²è§£å†³ï¼Œcherry-pickå®Œæˆ"
          fi
          set -e  # æ¢å¤é”™è¯¯é€€å‡º
          
          # ä¿®æ”¹æäº¤ä½œè€…ä¿¡æ¯ä¸ºmozi9
          git commit --amend --author="mozi9 <mozi9>" -m "$COMMIT_MESSAGE" --allow-empty
          
          echo "âœ… å·²å®Œæˆcherry-pick $I/$TOTAL"
          I=$((I+1))
        done

    - name: Process file changes after cherry-pick
      run: |
        echo "å¤„ç†æ–‡ä»¶å˜æ›´..."
        LATEST_COMMIT=$(git log -1 --format=%H)
        
        # æ£€å‡ºæœ€æ–°æäº¤ä»¥è·å–æ‰€æœ‰æ–‡ä»¶
        git checkout $LATEST_COMMIT -- .
        
        # è·å–æºæäº¤ä¸­åˆ é™¤çš„æ–‡ä»¶åˆ—è¡¨
        COMMITS=$(cat /tmp/commit_list.txt)
        for COMMIT in $COMMITS; do
          echo "å¤„ç†æäº¤ $COMMIT çš„æ–‡ä»¶å˜æ›´..."
          
          # è·å–è¯¥æäº¤ä¸­åˆ é™¤çš„æ–‡ä»¶
          DELETED_FILES=$(git show $COMMIT --name-only --diff-filter=D --format= 2>/dev/null || true)
          if [ -n "$DELETED_FILES" ]; then
            echo "æäº¤ä¸­åˆ é™¤çš„æ–‡ä»¶: $DELETED_FILES"
            for file in $DELETED_FILES; do
              if [ -f "$file" ] || [ -d "$file" ]; then
                echo "åˆ é™¤æ–‡ä»¶: $file"
                rm -rf "$file"
                git add "$file"
              else
                echo "æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå¿½ç•¥åˆ é™¤: $file"
              fi
            done
          fi
          
          # è·å–è¯¥æäº¤ä¸­æ–°å¢/ä¿®æ”¹çš„æ–‡ä»¶
          ADDED_MODIFIED_FILES=$(git show $COMMIT --name-only --diff-filter=AM --format= 2>/dev/null || true)
          if [ -n "$ADDED_MODIFIED_FILES" ]; then
            echo "æäº¤ä¸­æ–°å¢/ä¿®æ”¹çš„æ–‡ä»¶: $ADDED_MODIFIED_FILES"
            for file in $ADDED_MODIFIED_FILES; do
              # ä»æºæäº¤æ¢å¤æ–‡ä»¶
              if git show $COMMIT:"$file" >/dev/null 2>&1; then
                echo "æ¢å¤æ–‡ä»¶: $file"
                git show $COMMIT:"$file" > "$file"
                git add "$file"
              fi
            done
          fi
        done
        
        # æäº¤æ‰€æœ‰æ–‡ä»¶å˜æ›´
        if ! git diff --cached --quiet; then
          git commit -m "mozi9: åŒæ­¥æ–‡ä»¶å˜æ›´" --author="mozi9 <mozi9>"
          echo "âœ… æ–‡ä»¶å˜æ›´å·²æäº¤"
        else
          echo "âœ… æ²¡æœ‰æ–‡ä»¶å˜æ›´éœ€è¦æäº¤"
        fi

    - name: Final cleanup and push
      run: |
        echo "æœ€ç»ˆæ¸…ç†å’Œæ¨é€..."
        
        # ç¡®ä¿å·¥ä½œåŒºå¹²å‡€
        git reset --hard
        git clean -fd
        
        # æ¨é€åˆ°ç›®æ ‡ä»“åº“
        echo "æ¨é€åˆ°ç›®æ ‡ä»“åº“..."
        git push https://mozi9:${{ secrets.Mozi9_PAT }}@github.com/${{ github.event.inputs.target_repo }}.git ${{ github.event.inputs.target_branch }}
        
        echo "âœ… æ¨é€å®Œæˆ"

    - name: Create final summary
      run: |
        echo "ğŸ‰ åŒæ­¥å®Œæˆï¼"
        echo "å…±åŒæ­¥äº† ${{ steps.get_commits.outputs.commit_count }} ä¸ªæäº¤"
        echo "ä½¿ç”¨çš„èº«ä»½: mozi9 <mozi9>"
        echo "ç›®æ ‡ä»“åº“: ${{ github.event.inputs.target_repo }}"
        echo "ç›®æ ‡åˆ†æ”¯: ${{ github.event.inputs.target_branch }}"
        echo ""
        echo "åŒæ­¥çš„æäº¤åˆ—è¡¨ï¼š"
        cat /tmp/commit_list.txt | while read commit; do
          git log -1 --oneline $commit
        done

name: Manual SusFS File Extraction and Commit

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: "Source repository (owner/repo)"
        required: true
        default: "sqldown/android_kernel_common_android12-5.10"
      source_branch:
        description: "Source branch to get commits from"
        required: true
        default: "android_kernel_common_android12-5.10"
      source_commits:
        description: "Source commit hashes (short or full, comma separated)"
        required: true
        default: "41273ce"
      target_repo:
        description: "Target repository (owner/repo)"
        required: true
        default: "mozi9/XCD"
      target_branch:
        description: "Target branch to push to"
        required: true
        default: "miuix"
      commit_message:
        description: "Commit message title"
        required: true
        default: "fs: Bump SuSFS version to v2.0.0"
      commit_description:
        description: "Commit description"
        required: false
        default: "Co-authored-by: simonpunk <simonpunk2016@gmail.com>\nCo-authored-by: JackA1ltman <cs2dtzq@163.com>"

jobs:
  extract-and-commit:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout source repository
      uses: actions/checkout@v4
      with:
        repository: ${{ inputs.source_repo }}
        ref: ${{ inputs.source_branch }}
        token: ${{ secrets.GITHUB_TOKEN }}
        path: source-repo
        fetch-depth: 0

    - name: Checkout target repository
      uses: actions/checkout@v4
      with:
        repository: ${{ inputs.target_repo }}
        ref: ${{ inputs.target_branch }}
        token: ${{ secrets.GITHUB_TOKEN }}
        path: target-repo
        fetch-depth: 0

    - name: Setup Git identity
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        echo "Git configured"

    - name: Resolve commit hashes
      id: resolve-commits
      run: |
        cd source-repo
        COMMITS=$(echo "${{ inputs.source_commits }}" | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | grep -v '^$')
        RESOLVED_COMMITS=""
        
        for commit in $COMMITS; do
          FULL_HASH=$(git rev-parse "$commit" 2>/dev/null || echo "")
          if [ -n "$FULL_HASH" ]; then
            RESOLVED_COMMITS="$RESOLVED_COMMITS$FULL_HASH"$'\n'
          else
            echo "‚ùå Error: Cannot resolve commit $commit"
            exit 1
          fi
        done
        
        echo "$RESOLVED_COMMITS" | grep -v '^$' > ../resolved_commits.txt
        echo "‚úÖ Resolved commits: $(cat ../resolved_commits.txt | tr '\n' ' ')"

    - name: Analyze file changes
      id: analyze-files
      run: |
        cd source-repo
        COMMITS=$(cat ../resolved_commits.txt)
        
        ALL_MODIFIED_FILES=""
        ALL_DELETED_FILES=""
        
        echo "=== Analyzing file changes ==="
        
        for commit in $COMMITS; do
          echo "Processing commit: $commit"
          
          MODIFIED_FILES=$(git show --name-status --format= $commit | awk '$1 == "A" || $1 == "M" {print $2}' | sort -u)
          DELETED_FILES=$(git show --name-status --format= $commit | awk '$1 == "D" {print $2}' | sort -u)
          
          if [ -n "$MODIFIED_FILES" ]; then
            ALL_MODIFIED_FILES="$ALL_MODIFIED_FILES"$'\n'"$MODIFIED_FILES"
          fi
          if [ -n "$DELETED_FILES" ]; then
            ALL_DELETED_FILES="$ALL_DELETED_FILES"$'\n'"$DELETED_FILES"
          fi
        done
        
        UNIQUE_MODIFIED=$(echo "$ALL_MODIFIED_FILES" | grep -v '^$' | sort -u)
        UNIQUE_DELETED=$(echo "$ALL_DELETED_FILES" | grep -v '^$' | sort -u)
        
        echo "$UNIQUE_MODIFIED" > ../modified_files.txt
        echo "$UNIQUE_DELETED" > ../deleted_files.txt
        
        MOD_COUNT=$(echo "$UNIQUE_MODIFIED" | grep -c . || echo 0)
        DEL_COUNT=$(echo "$UNIQUE_DELETED" | grep -c . || echo 0)
        
        echo "modified_files_count=$MOD_COUNT" >> $GITHUB_OUTPUT
        echo "deleted_files_count=$DEL_COUNT" >> $GITHUB_OUTPUT
        
        echo "‚úÖ Modified files: $MOD_COUNT"
        echo "‚úÖ Deleted files: $DEL_COUNT"

    - name: Delete target files first
      id: delete-files
      run: |
        cd target-repo
        
        echo "=== Deleting files from target ==="
        DELETED_COUNT=0
        
        if [ -s ../deleted_files.txt ]; then
          while IFS= read -r file; do
            if [ -n "$file" ] && [ -f "$file" ]; then
              if [[ "$file" != / && "$file" != /* && "$file" != .git* && "$file" != "." && "$file" != ".." ]]; then
                echo "üóëÔ∏è Deleting: $file"
                rm -f "$file"
                DELETED_COUNT=$((DELETED_COUNT + 1))
              else
                echo "üö´ Skipped (safety): $file"
              fi
            fi
          done < ../deleted_files.txt
        fi
        
        echo "actual_deleted_count=$DELETED_COUNT" >> $GITHUB_OUTPUT
        echo "‚úÖ Deleted $DELETED_COUNT files"

    - name: Copy modified files to target
      id: copy-files
      run: |
        cd source-repo
        git checkout ${{ inputs.source_branch }} --quiet
        
        echo "=== Copying modified files ==="
        COPIED_COUNT=0
        
        if [ -s ../modified_files.txt ]; then
          while IFS= read -r file; do
            if [ -n "$file" ] && [ -f "$file" ]; then
              echo "üìÑ Copying: $file"
              mkdir -p "../target-repo/$(dirname "$file")"
              cp "$file" "../target-repo/$file"
              COPIED_COUNT=$((COPIED_COUNT + 1))
            fi
          done < ../modified_files.txt
        fi
        
        echo "actual_copied_count=$COPIED_COUNT" >> $GITHUB_OUTPUT
        echo "‚úÖ Copied $COPIED_COUNT files"

    - name: Commit changes
      id: commit-changes
      run: |
        cd target-repo
        
        git add -A
        if git diff --cached --quiet; then
          echo "‚ùå No changes to commit"
          echo "has_changes=false" >> $GITHUB_OUTPUT
          exit 1
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "=== Files to commit ==="
          git diff --cached --name-only
          
          # ÊûÑÂª∫Êèê‰∫§‰ø°ÊÅØ
          git commit -m "${{ inputs.commit_message }}" -m "${{ inputs.commit_description }}"
          echo "‚úÖ Commit created"
        fi

    - name: Push to target repository
      if: steps.commit-changes.outputs.has_changes == 'true'
      run: |
        cd target-repo
        git push origin ${{ inputs.target_branch }}
        echo "‚úÖ Pushed to ${{ inputs.target_repo }}:${{ inputs.target_branch }}"

    - name: Show final result
      run: |
        cat > $GITHUB_STEP_SUMMARY << EOF
        # Êñá‰ª∂Â§ÑÁêÜÁªìÊûú
        
        ## ‰ªìÂ∫ìÈÖçÁΩÆ
        - **Ê∫ê‰ªìÂ∫ì**: ${{ inputs.source_repo }}
        - **Ê∫êÂàÜÊîØ**: ${{ inputs.source_branch }}
        - **ÁõÆÊ†á‰ªìÂ∫ì**: ${{ inputs.target_repo }}
        - **ÁõÆÊ†áÂàÜÊîØ**: ${{ inputs.target_branch }}
        
        ## Êìç‰ΩúÁªüËÆ°
        - **ÂàÜÊûêÂá∫ÁöÑ‰øÆÊîπÊñá‰ª∂**: ${{ steps.analyze-files.outputs.modified_files_count }} ‰∏™
        - **ÂàÜÊûêÂá∫ÁöÑÂà†Èô§Êñá‰ª∂**: ${{ steps.analyze-files.outputs.deleted_files_count }} ‰∏™
        - **ÂÆûÈôÖÂ§çÂà∂ÁöÑÊñá‰ª∂**: ${{ steps.copy-files.outputs.actual_copied_count }} ‰∏™
        - **ÂÆûÈôÖÂà†Èô§ÁöÑÊñá‰ª∂**: ${{ steps.delete-files.outputs.actual_deleted_count }} ‰∏™
        
        ## Êèê‰∫§‰ø°ÊÅØ
        - **Ê†áÈ¢ò**: ${{ inputs.commit_message }}
        - **ÊèèËø∞**: ${{ inputs.commit_description }}
        
        EOF
        
        if [ "${{ steps.commit-changes.outputs.has_changes }}" = "true" ]; then
          echo "‚úÖ **ÊàêÂäü**: Â∑≤Êèê‰∫§Êõ¥ÊîπÂπ∂Êé®ÈÄÅÂà∞ÁõÆÊ†á‰ªìÂ∫ì" >> $GITHUB_STEP_SUMMARY
        else
          echo "‚ùå **Â§±Ë¥•**: Ê≤°ÊúâÊ£ÄÊµãÂà∞Êñá‰ª∂ÂèòÊõ¥" >> $GITHUB_STEP_SUMMARY
        fi

name: Smart File Extraction and Commit

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: "æºä»“åº“ï¼ˆæ ¼å¼ï¼šowner/repoï¼‰"
        required: true
        default: "ApartTUSITU/kernel_xiaomi_sm8250_mod"
      target_repo:
        description: "ç›®æ ‡ä»“åº“ï¼ˆæ ¼å¼ï¼šowner/repoï¼‰"
        required: true
        default: "mozi9/XCD"
      source_commits:
        description: "æºä»“åº“æäº¤å“ˆå¸Œï¼ˆé€—å·åˆ†éš”ï¼‰"
        required: true
        default: "47b6de7"
      source_branch:
        description: "æºåˆ†æ”¯ï¼ˆå¯ä»¥æ˜¯main/master/å…·ä½“åˆ†æ”¯åï¼‰"
        required: true
        default: "main"
      target_branch:
        description: "ç›®æ ‡åˆ†æ”¯"
        required: true
        default: "miuix"
      commit_title:
        description: "æäº¤æ ‡é¢˜"
        required: true
        default: "fs: Bump SuSFS version to v2.0.0"
      commit_description:
        description: "æäº¤æè¿°ï¼ˆå¯é€‰ï¼‰"
        required: false
        default: ""

env:
  GIT_USERNAME: "mozi9"
  GIT_EMAIL: "mozi9@users.noreply.github.com"

jobs:
  smart-file-extraction:
    runs-on: ubuntu-latest
    timeout-minutes: 8
    steps:
    - name: ğŸ” éªŒè¯è¾“å…¥å‚æ•°
      id: validate-inputs
      run: |
        echo "=== æ™ºèƒ½æ–‡ä»¶æå– ==="
        echo "æºä»“åº“: ${{ github.event.inputs.source_repo }}"
        echo "ç›®æ ‡ä»“åº“: ${{ github.event.inputs.target_repo }}"
        echo "æäº¤å“ˆå¸Œ: ${{ github.event.inputs.source_commits }}"
        echo "æºåˆ†æ”¯: ${{ github.event.inputs.source_branch }}"
        
        # éªŒè¯å‚æ•°æ ¼å¼
        if [[ ! "${{ github.event.inputs.source_repo }}" =~ ^[a-zA-Z0-9_.-]+/[a-zA-Z0-9_.-]+$ ]]; then
          echo "âŒ æºä»“åº“æ ¼å¼é”™è¯¯"
          exit 1
        fi
        echo "âœ… å‚æ•°éªŒè¯é€šè¿‡"

    - name: âš™ï¸ é…ç½®Gitç¯å¢ƒ
      run: |
        git config --global user.name "mozi9"
        git config --global user.email "mozi9@users.noreply.github.com"
        git config --global core.autocrlf false

    - name: ğŸ“¥ å¿«é€Ÿæ£€å‡ºç›®æ ‡ä»“åº“
      uses: actions/checkout@v4
      with:
        repository: ${{ github.event.inputs.target_repo }}
        ref: ${{ github.event.inputs.target_branch }}
        token: ${{ secrets.Mozi9_PAT }}
        path: target-repo
        fetch-depth: 1

    - name: ğŸ” æ™ºèƒ½æŸ¥æ‰¾æäº¤ï¼ˆæ”¯æŒä¸»åˆ†æ”¯ï¼‰
      id: smart-search
      run: |
        echo "=== æ™ºèƒ½æŸ¥æ‰¾æäº¤ï¼ˆæ”¯æŒä¸»åˆ†æ”¯ï¼‰ ==="
        
        REPO="${{ github.event.inputs.source_repo }}"
        BRANCH="${{ github.event.inputs.source_branch }}"
        COMMIT_HASH="${{ github.event.inputs.source_commits }}"
        
        echo "æœç´¢æäº¤: $COMMIT_HASH"
        echo "åœ¨åˆ†æ”¯: $BRANCH"
        echo "ä»“åº“: $REPO"
        
        # å­˜å‚¨ç»“æœ
        all_files=()
        resolved_commits=()
        
        # 1. æ£€æµ‹é»˜è®¤åˆ†æ”¯ï¼ˆå¦‚æœæ˜¯main/masterï¼‰
        echo "1. æ£€æµ‹åˆ†æ”¯ä¿¡æ¯..."
        if [[ "$BRANCH" == "main" || "$BRANCH" == "master" ]]; then
          echo "   â„¹ï¸ æ£€æµ‹åˆ°ä¸»åˆ†æ”¯: $BRANCH"
          # è·å–ä»“åº“çš„é»˜è®¤åˆ†æ”¯
          repo_url="https://api.github.com/repos/$REPO"
          repo_response=$(curl -s \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "$repo_url")
          
          if echo "$repo_response" | grep -q '"default_branch"'; then
            default_branch=$(echo "$repo_response" | grep '"default_branch"' | cut -d'"' -f4)
            echo "   âœ… ä»“åº“é»˜è®¤åˆ†æ”¯: $default_branch"
            BRANCH="$default_branch"  # ä½¿ç”¨å®é™…çš„é»˜è®¤åˆ†æ”¯
          fi
        fi
        
        # 2. æ£€æŸ¥åˆ†æ”¯æ˜¯å¦å­˜åœ¨
        echo "2. æ£€æŸ¥åˆ†æ”¯ $BRANCH æ˜¯å¦å­˜åœ¨..."
        branch_url="https://api.github.com/repos/$REPO/branches/$BRANCH"
        branch_response=$(curl -s \
          -H "Accept: application/vnd.github.v3+json" \
          -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          "$branch_url")
        
        if echo "$branch_response" | grep -q '"name"'; then
          branch_sha=$(echo "$branch_response" | grep '"sha"' | head -1 | cut -d'"' -f4)
          echo "   âœ… åˆ†æ”¯ $BRANCH å­˜åœ¨ï¼Œæœ€æ–°æäº¤: ${branch_sha:0:8}"
        else
          echo "   âŒ åˆ†æ”¯ $BRANCH ä¸å­˜åœ¨"
          
          # åˆ—å‡ºå¯ç”¨çš„åˆ†æ”¯
          echo "   ğŸ“‹ å¯ç”¨çš„åˆ†æ”¯:"
          branches_url="https://api.github.com/repos/$REPO/branches?per_page=20"
          branches_response=$(curl -s \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "$branches_url")
          
          echo "$branches_response" | grep '"name"' | cut -d'"' -f4 | while read branch; do
            echo "     - $branch"
          done
          
          exit 1
        fi
        
        # 3. æŸ¥æ‰¾æäº¤ï¼ˆå¤šç§æ–¹æ³•ï¼‰
        echo "3. æŸ¥æ‰¾æäº¤ $COMMIT_HASH ..."
        found_commit=""
        
        # æ–¹æ³•A: ç›´æ¥æŸ¥è¯¢
        echo "   A. ç›´æ¥æŸ¥è¯¢æäº¤..."
        commit_url="https://api.github.com/repos/$REPO/commits/$COMMIT_HASH"
        commit_response=$(curl -s \
          -H "Accept: application/vnd.github.v3+json" \
          -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          "$commit_url")
        
        if echo "$commit_response" | grep -q '"sha"'; then
          sha=$(echo "$commit_response" | grep '"sha"' | head -1 | cut -d'"' -f4)
          echo "   âœ… ç›´æ¥æ‰¾åˆ°æäº¤: $COMMIT_HASH -> ${sha:0:8}"
          found_commit="$sha"
        else
          echo "   âŒ ç›´æ¥æŸ¥è¯¢å¤±è´¥"
          
          # æ–¹æ³•B: åœ¨åˆ†æ”¯ä¸­æœç´¢æäº¤
          echo "   B. åœ¨åˆ†æ”¯ $BRANCH ä¸­æœç´¢æäº¤..."
          commits_url="https://api.github.com/repos/$REPO/commits?sha=$BRANCH&per_page=100"
          commits_response=$(curl -s \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "$commits_url")
          
          # æŸ¥æ‰¾åŒ¹é…çš„æäº¤
          found_in_branch=$(echo "$commits_response" | grep -o "\"sha\":\"[^\"]*$COMMIT_HASH[^\"]*\"" | head -1 | cut -d'"' -f4)
          
          if [ -n "$found_in_branch" ]; then
            echo "   âœ… åœ¨åˆ†æ”¯ä¸­æ‰¾åˆ°æäº¤: $COMMIT_HASH -> ${found_in_branch:0:8}"
            found_commit="$found_in_branch"
          else
            echo "   âŒ åœ¨åˆ†æ”¯ä¸­æœªæ‰¾åˆ°æäº¤"
            
            # æ–¹æ³•C: å…¨å±€æœç´¢
            echo "   C. å…¨å±€æœç´¢æäº¤..."
            search_url="https://api.github.com/search/commits?q=repo:$REPO+$COMMIT_HASH&per_page=5"
            search_response=$(curl -s \
              -H "Accept: application/vnd.github.cloak-preview+json" \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "$search_url")
            
            if echo "$search_response" | grep -q '"total_count"'; then
              total_count=$(echo "$search_response" | grep '"total_count"' | cut -d':' -f2 | tr -d ' ,')
              if [ "$total_count" -gt 0 ]; then
                echo "   âœ… æœç´¢åˆ° $total_count ä¸ªåŒ¹é…çš„æäº¤"
                search_sha=$(echo "$search_response" | grep '"sha"' | head -1 | cut -d'"' -f4)
                echo "   âœ… ä½¿ç”¨æäº¤: ${search_sha:0:8}"
                found_commit="$search_sha"
              else
                echo "   âŒ æœç´¢æ— ç»“æœ"
              fi
            else
              echo "   âŒ æœç´¢å¤±è´¥"
            fi
          fi
        fi
        
        # 4. å¦‚æœæ²¡æœ‰æ‰¾åˆ°æäº¤ï¼Œä½¿ç”¨åˆ†æ”¯æœ€æ–°æäº¤
        if [ -z "$found_commit" ]; then
          echo "4. ä½¿ç”¨åˆ†æ”¯æœ€æ–°æäº¤ä½œä¸ºå¤‡é€‰..."
          found_commit="$branch_sha"
          echo "   âœ… ä½¿ç”¨åˆ†æ”¯æœ€æ–°æäº¤: ${found_commit:0:8}"
        fi
        
        resolved_commits+=("$found_commit")
        
        # 5. è·å–æäº¤çš„æ–‡ä»¶åˆ—è¡¨
        echo "5. è·å–æäº¤ ${found_commit:0:8} çš„æ–‡ä»¶åˆ—è¡¨..."
        final_commit_url="https://api.github.com/repos/$REPO/commits/$found_commit"
        final_response=$(curl -s \
          -H "Accept: application/vnd.github.v3+json" \
          -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          "$final_commit_url")
        
        if echo "$final_response" | grep -q '"filename"'; then
          files=$(echo "$final_response" | grep '"filename"' | cut -d'"' -f4 | sort -u)
          file_count=$(echo "$files" | wc -l)
          echo "   âœ… æ‰¾åˆ° $file_count ä¸ªæ–‡ä»¶"
          
          while IFS= read -r file; do
            if [ -n "$file" ] && [[ ! " ${all_files[@]} " =~ " ${file} " ]]; then
              all_files+=("$file")
              echo "     ğŸ“„ $file"
            fi
          done <<< "$files"
        else
          echo "   âŒ æ— æ³•è·å–æ–‡ä»¶åˆ—è¡¨"
        fi
        
        # 6. ä¿å­˜ç»“æœ
        if [ ${#all_files[@]} -eq 0 ]; then
          echo "âš ï¸ æœªå‘ç°å˜æ›´æ–‡ä»¶"
          touch file_list.txt
        else
          printf "%s\n" "${all_files[@]}" > file_list.txt
          echo "ğŸ“‹ æ€»å…±å‘ç° ${#all_files[@]} ä¸ªæ–‡ä»¶"
        fi
        
        if [ ${#resolved_commits[@]} -gt 0 ]; then
          printf "%s\n" "${resolved_commits[@]}" > commits.txt
          echo "âœ… ä½¿ç”¨çš„æäº¤: ${resolved_commits[0]:0:8}"
        fi
        
        echo "commits_count=${#resolved_commits[@]}" >> $GITHUB_OUTPUT
        echo "files_count=${#all_files[@]}" >> $GITHUB_OUTPUT
        echo "actual_commit=${resolved_commits[0]}" >> $GITHUB_OUTPUT
        echo "actual_branch=$BRANCH" >> $GITHUB_OUTPUT
        echo "âœ… åˆ†æå®Œæˆ"

    - name: ğŸ“¥ æŒ‰éœ€ä¸‹è½½æºæ–‡ä»¶
      id: download-files
      run: |
        echo "=== æŒ‰éœ€ä¸‹è½½æ–‡ä»¶ ==="
        
        if [ ! -s file_list.txt ]; then
          echo "âš ï¸ æ²¡æœ‰éœ€è¦ä¸‹è½½çš„æ–‡ä»¶"
          echo "actual_downloaded=0" >> $GITHUB_OUTPUT
          echo "download_errors=0" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        REPO="${{ github.event.inputs.source_repo }}"
        BRANCH="${{ steps.smart-search.outputs.actual_branch }}"
        
        echo "ä¸‹è½½æ–‡ä»¶ï¼Œåˆ†æ”¯: $BRANCH"
        
        # åˆ›å»ºæºæ–‡ä»¶ç›®å½•
        mkdir -p source-files
        
        # è®¡æ•°å™¨
        downloaded=0
        errors=0
        
        echo "å¼€å§‹ä¸‹è½½æ–‡ä»¶..."
        
        # ä¸‹è½½æ¯ä¸ªæ–‡ä»¶
        while IFS= read -r file; do
          [ -z "$file" ] && continue
          
          # æ„å»ºrawæ–‡ä»¶URL
          raw_url="https://raw.githubusercontent.com/$REPO/$BRANCH/$file"
          
          echo "â¬‡ï¸ ä¸‹è½½: $file"
          
          # åˆ›å»ºç›®å½•ç»“æ„
          mkdir -p "source-files/$(dirname "$file")"
          
          # ä¸‹è½½æ–‡ä»¶
          if curl -s -f -L "$raw_url" -o "source-files/$file"; then
            downloaded=$((downloaded + 1))
            echo "âœ… ä¸‹è½½æˆåŠŸ"
          else
            echo "âŒ ä¸‹è½½å¤±è´¥: $file"
            errors=$((errors + 1))
          fi
          
          # çŸ­æš‚å»¶è¿Ÿï¼Œé¿å…è¢«é™æµ
          sleep 0.05
          
        done < file_list.txt
        
        echo "actual_downloaded=$downloaded" >> $GITHUB_OUTPUT
        echo "download_errors=$errors" >> $GITHUB_OUTPUT
        echo "âœ… æ–‡ä»¶ä¸‹è½½å®Œæˆ: $downloaded æˆåŠŸ, $errors å¤±è´¥"

    - name: ğŸ”„ åŒæ­¥æ–‡ä»¶åˆ°ç›®æ ‡ä»“åº“
      id: sync-files
      run: |
        echo "=== åŒæ­¥æ–‡ä»¶åˆ°ç›®æ ‡ä»“åº“ ==="
        
        if [ ! -s file_list.txt ]; then
          echo "âš ï¸ æ²¡æœ‰éœ€è¦åŒæ­¥çš„æ–‡ä»¶"
          echo "actual_copied=0" >> $GITHUB_OUTPUT
          echo "sync_errors=0" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # è®¡æ•°å™¨
        copied=0
        errors=0
        
        echo "å¼€å§‹åŒæ­¥æ–‡ä»¶..."
        
        # åŒæ­¥æ¯ä¸ªæ–‡ä»¶
        while IFS= read -r file; do
          [ -z "$file" ] && continue
          
          if [ -f "source-files/$file" ]; then
            # åˆ›å»ºç›®æ ‡ç›®å½•
            mkdir -p "target-repo/$(dirname "$file")"
            
            # å¤åˆ¶æ–‡ä»¶
            if cp "source-files/$file" "target-repo/$file"; then
              copied=$((copied + 1))
              echo "ğŸ“„ åŒæ­¥: $file"
            else
              echo "âŒ å¤åˆ¶å¤±è´¥: $file"
              errors=$((errors + 1))
            fi
          else
            echo "âš ï¸ æºæ–‡ä»¶ä¸å­˜åœ¨: $file"
            errors=$((errors + 1))
          fi
        done < file_list.txt
        
        echo "actual_copied=$copied" >> $GITHUB_OUTPUT
        echo "sync_errors=$errors" >> $GITHUB_OUTPUT
        echo "âœ… æ–‡ä»¶åŒæ­¥å®Œæˆ: $copied æˆåŠŸ, $errors å¤±è´¥"

    - name: ğŸ’¾ åˆ›å»ºæäº¤
      id: create-commit
      run: |
        cd target-repo
        
        echo "=== æ£€æŸ¥å˜æ›´å¹¶æäº¤ ==="
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜æ›´
        if git diff-index --quiet HEAD --; then
          echo "â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "ğŸ“ å‘ç°å˜æ›´ï¼Œå‡†å¤‡æäº¤..."
          
          git add -A
          
          # æ˜¾ç¤ºå˜æ›´æ‘˜è¦
          echo "=== å˜æ›´æ‘˜è¦ ==="
          git status --short
          
          # åˆ›å»ºæäº¤ä¿¡æ¯
          original_commit="${{ github.event.inputs.source_commits }}"
          actual_commit="${{ steps.smart-search.outputs.actual_commit }}"
          actual_branch="${{ steps.smart-search.outputs.actual_branch }}"
          
          commit_msg="${{ github.event.inputs.commit_title }}"
          
          # æ·»åŠ æäº¤ä¿¡æ¯è¯¦æƒ…
          if [ "$original_commit" != "${actual_commit:0:${#original_commit}}" ]; then
            commit_msg="$commit_msg (åŸºäºæäº¤ ${actual_commit:0:8}ï¼Œåˆ†æ”¯: $actual_branch)"
          else
            commit_msg="$commit_msg (åˆ†æ”¯: $actual_branch)"
          fi
          
          if [ -n "${{ github.event.inputs.commit_description }}" ]; then
            commit_msg="$commit_msg"$'\n'$'\n'"${{ github.event.inputs.commit_description }}"
          fi
          
          # æäº¤
          git commit -m "$commit_msg"
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "âœ… æäº¤åˆ›å»ºæˆåŠŸ"
        fi

    - name: ğŸš€ æ¨é€æ›´æ”¹
      if: steps.create-commit.outputs.has_changes == 'true'
      run: |
        cd target-repo
        
        echo "=== æ¨é€æ›´æ”¹ ==="
        
        # é…ç½®è¿œç¨‹URL
        git remote set-url origin "https://mozi9:${{ secrets.Mozi9_PAT }}@github.com/${{ github.event.inputs.target_repo }}.git"
        
        # ç›´æ¥æ¨é€
        if git push origin "${{ github.event.inputs.target_branch }}"; then
          echo "âœ… æ¨é€æˆåŠŸ"
        else
          # å¦‚æœæ¨é€å¤±è´¥ï¼Œå°è¯•æ‹‰å–å¹¶é‡è¯•
          echo "æ¨é€å¤±è´¥ï¼Œå°è¯•è§£å†³å†²çª..."
          git pull origin "${{ github.event.inputs.target_branch }}" --rebase --no-edit
          git push origin "${{ github.event.inputs.target_branch }}"
          echo "âœ… å†²çªè§£å†³å¹¶æ¨é€æˆåŠŸ"
        fi

    - name: ğŸ“‹ ç”Ÿæˆè¯¦ç»†æŠ¥å‘Š
      if: always()
      run: |
        cat > "$GITHUB_STEP_SUMMARY" << EOF
        # æ–‡ä»¶æå–å®ŒæˆæŠ¥å‘Š
        
        ## æ‰§è¡Œæ‘˜è¦
        - **è¯·æ±‚çš„æäº¤**: ${{ github.event.inputs.source_commits }}
        - **å®é™…ä½¿ç”¨çš„æäº¤**: ${{ steps.smart-search.outputs.actual_commit || 'æœªæ‰¾åˆ°' }}
        - **å®é™…ä½¿ç”¨çš„åˆ†æ”¯**: ${{ steps.smart-search.outputs.actual_branch || 'æœªç¡®å®š' }}
        - **å‘ç°æ–‡ä»¶æ•°é‡**: ${{ steps.smart-search.outputs.files_count || '0' }}
        - **ä¸‹è½½æˆåŠŸæ–‡ä»¶**: ${{ steps.download-files.outputs.actual_downloaded || '0' }}
        - **åŒæ­¥æˆåŠŸæ–‡ä»¶**: ${{ steps.sync-files.outputs.actual_copied || '0' }}
        - **æäº¤çŠ¶æ€**: ${{ steps.create-commit.outputs.has_changes == 'true' && 'âœ… å·²æäº¤' || 'âš ï¸ æ— å˜æ›´' }}
        
        ## åˆ†æ”¯å¤„ç†
        EOF
        
        if [[ "${{ github.event.inputs.source_branch }}" == "main" || "${{ github.event.inputs.source_branch }}" == "master" ]]; then
          echo "âœ… **ä¸»åˆ†æ”¯å¤„ç†**: è‡ªåŠ¨æ£€æµ‹å¹¶ä½¿ç”¨ä»“åº“çš„é»˜è®¤åˆ†æ”¯" >> "$GITHUB_STEP_SUMMARY"
        fi
        
        if [ "${{ github.event.inputs.source_commits }}" != "${{ steps.smart-search.outputs.actual_commit }}" ]; then
          echo "âš ï¸ **æäº¤å“ˆå¸Œä¸åŒ¹é…**: è¯·æ±‚çš„æäº¤ '${{ github.event.inputs.source_commits }}' ä¸å­˜åœ¨ï¼Œä½¿ç”¨äº†å¤‡é€‰æäº¤ '${{ steps.smart-search.outputs.actual_commit }}'" >> "$GITHUB_STEP_SUMMARY"
        fi
        
        echo "" >> "$GITHUB_STEP_SUMMARY"
        echo "## å»ºè®®" >> "$GITHUB_STEP_SUMMARY"
        echo "1. æ£€æŸ¥æäº¤å“ˆå¸Œæ˜¯å¦æ­£ç¡®" >> "$GITHUB_STEP_SUMMARY"
        echo "2. ç¡®è®¤æäº¤å­˜åœ¨äºåˆ†æ”¯ ${{ steps.smart-search.outputs.actual_branch }} ä¸­" >> "$GITHUB_STEP_SUMMARY"
        echo "3. å¯ä»¥å°è¯•ä½¿ç”¨å®Œæ•´çš„40å­—ç¬¦æäº¤å“ˆå¸Œ" >> "$GITHUB_STEP_SUMMARY"
        
        echo "" >> "$GITHUB_STEP_SUMMARY"
        echo "**æ‰§è¡Œæ—¶é—´**: é¢„è®¡1-2åˆ†é’Ÿ" >> "$GITHUB_STEP_SUMMARY"

    - name: ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶
      if: always()
      run: |
        echo "=== æ¸…ç†ä¸´æ—¶æ–‡ä»¶ ==="
        rm -rf source-files
        rm -f file_list.txt commits.txt
        echo "âœ… æ¸…ç†å®Œæˆ"

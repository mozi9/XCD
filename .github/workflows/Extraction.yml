name: Complete Commit Sync Workflow

on:
  workflow_dispatch:
    inputs:
      source_commit_url:
        description: "源提交链接"
        required: true
        default: "https://github.com/android16-aptusit/kernel_xiaomi_sm8250_mod/commit/47b6de7"
      target_repo:
        description: "目标仓库"
        required: true
        default: "mozi9/XCD"
      target_branch:
        description: "目标分支"
        required: true
        default: "miuix"
      commit_message:
        description: "提交信息"
        required: true
        default: "fs: Bump SuSFS version to v2.0.0"

env:
  GIT_USERNAME: "mozi9"

jobs:
  step1-push-commit:
    runs-on: ubuntu-latest
    outputs:
      commit_hash: ${{ steps.parse-commit.outputs.commit_hash }}
      source_repo: ${{ steps.parse-commit.outputs.source_repo }}
    
    steps:
    - name: 配置Git
      run: |
        git config --global user.name "mozi9"
        git config --global user.email "mozi9@users.noreply.github.com"

    - name: 克隆目标仓库
      uses: actions/checkout@v4
      with:
        repository: ${{ github.event.inputs.target_repo }}
        ref: ${{ github.event.inputs.target_branch }}
        token: ${{ secrets.Mozi9_PAT }}
        fetch-depth: 0

    - name: 解析提交链接
      id: parse-commit
      run: |
        COMMIT_URL="${{ github.event.inputs.source_commit_url }}"
        if [[ "$COMMIT_URL" =~ github.com/([^/]+)/([^/]+)/commit/([a-f0-9]+) ]]; then
          echo "commit_hash=${BASH_REMATCH[3]}" >> $GITHUB_OUTPUT
          echo "source_repo=${BASH_REMATCH[1]}/${BASH_REMATCH[2]}" >> $GITHUB_OUTPUT
        fi

    - name: 添加源仓库远程
      run: |
        git remote add source-repo https://${{ env.GIT_USERNAME }}:${{ secrets.Mozi9_PAT }}@github.com/${{ steps.parse-commit.outputs.source_repo }}.git
        git fetch source-repo ${{ steps.parse-commit.outputs.commit_hash }}

    - name: 强制推送提交到目标仓库
      run: |
        COMMIT_HASH="${{ steps.parse-commit.outputs.commit_hash }}"
        git reset --hard $COMMIT_HASH
        git push --force origin ${{ github.event.inputs.target_branch }}
        echo "✅ 提交已推送到目标仓库"

  step2-get-commit-files:
    runs-on: ubuntu-latest
    needs: step1-push-commit
    outputs:
      added_files: ${{ steps.analyze-files.outputs.added_files }}
      modified_files: ${{ steps.analyze-files.outputs.modified_files }}
      deleted_files: ${{ steps.analyze-files.outputs.deleted_files }}
    
    steps:
    - name: 配置Git
      run: |
        git config --global user.name "mozi9"
        git config --global user.email "mozi9@users.noreply.github.com"

    - name: 克隆目标仓库
      uses: actions/checkout@v4
      with:
        repository: ${{ github.event.inputs.target_repo }}
        ref: ${{ github.event.inputs.target_branch }}
        token: ${{ secrets.Mozi9_PAT }}
        fetch-depth: 0

    - name: 分析提交文件变更
      id: analyze-files
      run: |
        COMMIT_HASH="${{ needs.step1-push-commit.outputs.commit_hash }}"
        
        # 获取父提交
        PARENT_COMMIT=$(git log --pretty=%P -n 1 $COMMIT_HASH | awk '{print $1}')
        
        if [ -n "$PARENT_COMMIT" ]; then
          # 新增和修改的文件
          git diff --name-only --diff-filter=AM $PARENT_COMMIT $COMMIT_HASH > added_files.txt
          # 删除的文件
          git diff --name-only --diff-filter=D $PARENT_COMMIT $COMMIT_HASH > deleted_files.txt
          
          echo "added_files=added_files.txt" >> $GITHUB_OUTPUT
          echo "deleted_files=deleted_files.txt" >> $GITHUB_OUTPUT
          echo "新增/修改文件: $(wc -l < added_files.txt)"
          echo "删除文件: $(wc -l < deleted_files.txt)"
        else
          # 初始提交
          git ls-tree -r --name-only $COMMIT_HASH > added_files.txt
          touch deleted_files.txt
          echo "added_files=added_files.txt" >> $GITHUB_OUTPUT
          echo "deleted_files=deleted_files.txt" >> $GITHUB_OUTPUT
          echo "初始提交，所有文件为新增: $(wc -l < added_files.txt)"
        fi

  step3-process-target-files:
    runs-on: ubuntu-latest
    needs: step2-get-commit-files
    steps:
    - name: 配置Git
      run: |
        git config --global user.name "mozi9"
        git config --global user.email "mozi9@users.noreply.github.com"

    - name: 检出目标仓库
      uses: actions/checkout@v4
      with:
        repository: ${{ github.event.inputs.target_repo }}
        ref: ${{ github.event.inputs.target_branch }}
        token: ${{ secrets.Mozi9_PAT }}
        fetch-depth: 0

    - name: 在目标仓库中删除文件
      run: |
        if [ -f "${{ needs.step2-get-commit-files.outputs.deleted_files }}" ]; then
          while IFS= read -r file; do
            if [ -n "$file" ] && [ -f "$file" ]; then
              rm -f "$file"
              echo "删除: $file"
            fi
          done < "${{ needs.step2-get-commit-files.outputs.deleted_files }}"
        fi

    - name: 在目标仓库中检出文件
      run: |
        COMMIT_HASH="${{ needs.step1-push-commit.outputs.commit_hash }}"
        if [ -f "${{ needs.step2-get-commit-files.outputs.added_files }}" ]; then
          while IFS= read -r file; do
            if [ -n "$file" ]; then
              mkdir -p "$(dirname "$file")"
              git show $COMMIT_HASH:"$file" > "$file"
              echo "检出: $file"
            fi
          done < "${{ needs.step2-get-commit-files.outputs.added_files }}"
        fi

    - name: 提交目标仓库处理结果
      run: |
        git add -A
        if ! git diff-index --quiet HEAD --; then
          git commit -m "目标仓库文件处理: ${{ github.event.inputs.commit_message }}"
          git push origin ${{ github.event.inputs.target_branch }}
          echo "✅ 目标仓库文件处理完成"
        fi

  step4-generate-report:
    runs-on: ubuntu-latest
    needs: [step1-push-commit, step3-process-target-files]
    steps:
    - name: 生成报告
      run: |
        echo "# 完整工作流程报告" > $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## 步骤1: 推送提交 ✅ 完成" >> $GITHUB_STEP_SUMMARY
        echo "- 提交哈希: ${{ needs.step1-push-commit.outputs.commit_hash }}" >> $GITHUB_STEP_SUMMARY
        echo "- 源仓库: ${{ needs.step1-push-commit.outputs.source_repo }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## 步骤2: 分析文件变更 ✅ 完成" >> $GITHUB_STEP_SUMMARY
        echo "- 新增/修改文件: $(cat ${{ needs.step2-get-commit-files.outputs.added_files }} 2>/dev/null | wc -l || echo 0)" >> $GITHUB_STEP_SUMMARY
        echo "- 删除文件: $(cat ${{ needs.step2-get-commit-files.outputs.deleted_files }} 2>/dev/null | wc -l || echo 0)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## 步骤3: 目标仓库文件处理 ✅ 完成" >> $GITHUB_STEP_SUMMARY
        echo "- 状态: 文件处理已完成" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## 工作流程执行完成" >> $GITHUB_STEP_SUMMARY

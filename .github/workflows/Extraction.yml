name: Two-Step Commit Processing with PAT

on:
  workflow_dispatch:
    inputs:
      commit_urls:
        description: "GitHubæäº¤é“¾æ¥"
        required: true
        default: "https://github.com/android16-aptusit/kernel_xiaomi_sm8250_mod/commit/47b6de7"
      target_repo:
        description: "ç›®æ ‡ä»“åº“"
        required: true
        default: "mozi9/XCD"
      target_branch:
        description: "ç›®æ ‡åˆ†æ”¯"
        required: true
        default: "miuix"
      commit_title:
        description: "æäº¤æ ‡é¢˜"
        required: true
        default: "fs: Bump SuSFS version to v2.0.0"

env:
  GIT_USERNAME: "mozi9"
  GIT_EMAIL: "mozi9@users.noreply.github.com"

jobs:
  step1-push-commit-to-target:
    runs-on: ubuntu-latest
    name: "æ­¥éª¤1: æ¨é€æºæäº¤åˆ°ç›®æ ‡ä»“åº“"
    outputs:
      commit_hash: ${{ steps.parse-commit.outputs.commit_hash }}
      source_repo: ${{ steps.parse-commit.outputs.source_repo }}
      push_success: ${{ steps.push-commit.outputs.push_success }}
    
    steps:
    - name: âš™ï¸ é…ç½®Git
      run: |
        git config --global user.name "${{ env.GIT_USERNAME }}"
        git config --global user.email "${{ env.GIT_EMAIL }}"

    - name: ğŸ” è§£ææäº¤é“¾æ¥
      id: parse-commit
      run: |
        echo "=== æ­¥éª¤1: è§£ææäº¤é“¾æ¥ ==="
        
        COMMIT_URL="${{ github.event.inputs.commit_urls }}"
        
        if [[ "$COMMIT_URL" =~ https://github.com/([^/]+)/([^/]+)/commit/([a-f0-9]+) ]]; then
          REPO_OWNER="${BASH_REMATCH[1]}"
          REPO_NAME="${BASH_REMATCH[2]}"
          COMMIT_HASH="${BASH_REMATCH[3]}"
          SOURCE_REPO="$REPO_OWNER/$REPO_NAME"
          
          echo "âœ… è§£ææˆåŠŸ: $SOURCE_REPO @ $COMMIT_HASH"
          echo "commit_hash=$COMMIT_HASH" >> $GITHUB_OUTPUT
          echo "source_repo=$SOURCE_REPO" >> $GITHUB_OUTPUT
        else
          echo "âŒ é“¾æ¥æ ¼å¼é”™è¯¯: $COMMIT_URL"
          exit 1
        fi

    - name: ğŸ“¥ å…‹éš†ç›®æ ‡ä»“åº“ï¼ˆä½¿ç”¨PATï¼‰
      uses: actions/checkout@v4
      with:
        repository: ${{ github.event.inputs.target_repo }}
        ref: ${{ github.event.inputs.target_branch }}
        token: ${{ secrets.Mozi9_PAT }}
        fetch-depth: 0

    - name: ğŸ”— æ·»åŠ æºä»“åº“è¿œç¨‹ï¼ˆä½¿ç”¨PATè®¤è¯ï¼‰
      id: add-source-remote
      run: |
        SOURCE_REPO="${{ steps.parse-commit.outputs.source_repo }}"
        COMMIT_HASH="${{ steps.parse-commit.outputs.commit_hash }}"
        
        echo "æ·»åŠ æºä»“åº“è¿œç¨‹: $SOURCE_REPO"
        # ä½¿ç”¨PATè®¤è¯æ·»åŠ è¿œç¨‹ä»“åº“
        git remote add source-repo "https://${{ env.GIT_USERNAME }}:${{ secrets.Mozi9_PAT }}@github.com/$SOURCE_REPO.git"
        
        echo "è·å–æºä»“åº“æäº¤..."
        git fetch source-repo "$COMMIT_HASH"
        
        echo "âœ… æºä»“åº“æäº¤è·å–å®Œæˆ"

    - name: ğŸ”„ åˆå¹¶æºæäº¤åˆ°ç›®æ ‡ä»“åº“
      id: merge-commit
      run: |
        COMMIT_HASH="${{ steps.parse-commit.outputs.commit_hash }}"
        
        echo "=== åˆå¹¶æºæäº¤åˆ°ç›®æ ‡ä»“åº“ ==="
        echo "åˆå¹¶æäº¤: $COMMIT_HASH"
        
        # å°è¯•åˆå¹¶
        if git merge --no-commit --no-ff "$COMMIT_HASH"; then
          echo "âœ… åˆå¹¶æˆåŠŸ"
          echo "merge_success=true" >> $GITHUB_OUTPUT
        else
          echo "âš ï¸ åˆå¹¶å†²çªï¼Œä½¿ç”¨å¼ºåˆ¶è¦†ç›–"
          echo "merge_success=false" >> $GITHUB_OUTPUT
        fi

    - name: ğŸ’¥ å¼ºåˆ¶è¦†ç›–åˆå¹¶å†²çª
      if: steps.merge-commit.outputs.merge_success == 'false'
      id: force-override
      run: |
        COMMIT_HASH="${{ steps.parse-commit.outputs.commit_hash }}"
        
        echo "=== å¼ºåˆ¶è¦†ç›–åˆå¹¶å†²çª ==="
        
        # é‡ç½®åˆå¹¶çŠ¶æ€
        git merge --abort 2>/dev/null || true
        
        # è·å–æäº¤ä¸­çš„æ‰€æœ‰æ–‡ä»¶
        git ls-tree -r --name-only "$COMMIT_HASH" > all_files.txt
        
        # å¼ºåˆ¶æ£€å‡ºæäº¤ä¸­çš„æ‰€æœ‰æ–‡ä»¶
        echo "å¼ºåˆ¶è¦†ç›–æ‰€æœ‰æ–‡ä»¶..."
        file_count=0
        while IFS= read -r file; do
          if [ -n "$file" ]; then
            # åˆ›å»ºç›®å½•
            mkdir -p "$(dirname "$file")"
            # å¼ºåˆ¶æ£€å‡ºæ–‡ä»¶
            if git show "$COMMIT_HASH:$file" > "$file" 2>/dev/null; then
              file_count=$((file_count + 1))
              echo "âœ… è¦†ç›–: $file"
            else
              echo "âŒ è¦†ç›–å¤±è´¥: $file"
            fi
          fi
        done < all_files.txt
        
        echo "âœ… å¼ºåˆ¶è¦†ç›–å®Œæˆ: $file_count ä¸ªæ–‡ä»¶"

    - name: ğŸ’¾ æäº¤åˆå¹¶ç»“æœ
      id: commit-merge
      run: |
        echo "=== æäº¤åˆå¹¶ç»“æœ ==="
        
        git add -A
        
        if git diff-index --quiet HEAD --; then
          echo "â„¹ï¸ æ— å˜æ›´éœ€è¦æäº¤"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          COMMIT_TITLE="${{ github.event.inputs.commit_title }}"
          COMMIT_HASH="${{ steps.parse-commit.outputs.commit_hash }}"
          SOURCE_REPO="${{ steps.parse-commit.outputs.source_repo }}"
          
          COMMIT_MESSAGE="$COMMIT_TITLE
          
          Merged from $SOURCE_REPO@$COMMIT_HASH
          Step 1: Direct commit push to target repository"
          
          git commit -m "$COMMIT_MESSAGE"
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "âœ… åˆå¹¶æäº¤å®Œæˆ"
        fi

    - name: ğŸš€ æ¨é€åˆ°ç›®æ ‡ä»“åº“ï¼ˆä½¿ç”¨PATï¼‰
      id: push-commit
      run: |
        echo "=== æ¨é€åˆ°ç›®æ ‡ä»“åº“ ==="
        
        # ä½¿ç”¨PATè®¤è¯æ¨é€
        git push "https://${{ env.GIT_USERNAME }}:${{ secrets.Mozi9_PAT }}@github.com/${{ github.event.inputs.target_repo }}.git" "${{ github.event.inputs.target_branch }}"
        echo "âœ… æ¨é€æˆåŠŸ"
        echo "push_success=true" >> $GITHUB_OUTPUT

  step2-process-files-in-target:
    runs-on: ubuntu-latest
    name: "æ­¥éª¤2: åœ¨ç›®æ ‡ä»“åº“ä¸­å¤„ç†æ–‡ä»¶"
    needs: step1-push-commit-to-target
    if: needs.step1-push-commit-to-target.result == 'success'
    
    steps:
    - name: âš™ï¸ é…ç½®Git
      run: |
        git config --global user.name "${{ env.GIT_USERNAME }}"
        git config --global user.email "${{ env.GIT_EMAIL }}"

    - name: ğŸ“¥ æ£€å‡ºç›®æ ‡ä»“åº“ï¼ˆä½¿ç”¨PATï¼ŒåŒ…å«æ–°æäº¤ï¼‰
      uses: actions/checkout@v4
      with:
        repository: ${{ github.event.inputs.target_repo }}
        ref: ${{ github.event.inputs.target_branch }}
        token: ${{ secrets.Mozi9_PAT }}
        fetch-depth: 0

    - name: ğŸ” åˆ†ææœ€æ–°æäº¤çš„æ–‡ä»¶å˜æ›´
      id: analyze-latest-commit
      run: |
        COMMIT_HASH="${{ needs.step1-push-commit-to-target.outputs.commit_hash }}"
        
        echo "=== åˆ†ææœ€æ–°æäº¤çš„æ–‡ä»¶å˜æ›´ ==="
        echo "åˆ†ææäº¤: $COMMIT_HASH"
        
        # è·å–æäº¤çš„çˆ¶æäº¤ï¼ˆç”¨äºæ¯”è¾ƒï¼‰
        PARENT_COMMIT=$(git log --pretty=%P -n 1 "$COMMIT_HASH" | cut -d' ' -f1)
        
        if [ -n "$PARENT_COMMIT" ]; then
          echo "çˆ¶æäº¤: $PARENT_COMMIT"
          
          # åˆ†ææ–‡ä»¶å˜æ›´
          git diff --name-only --diff-filter=A "$PARENT_COMMIT" "$COMMIT_HASH" > added_files.txt
          git diff --name-only --diff-filter=M "$PARENT_COMMIT" "$COMMIT_HASH" > modified_files.txt
          git diff --name-only --diff-filter=D "$PARENT_COMMIT" "$COMMIT_HASH" > deleted_files.txt
          git diff --name-only --diff-filter=R "$PARENT_COMMIT" "$COMMIT_HASH" > renamed_files.txt
          
          echo "ğŸ“Š å˜æ›´ç»Ÿè®¡:"
          echo "  - æ–°å¢æ–‡ä»¶: $(wc -l < added_files.txt || echo 0)"
          echo "  - ä¿®æ”¹æ–‡ä»¶: $(wc -l < modified_files.txt || echo 0)"
          echo "  - åˆ é™¤æ–‡ä»¶: $(wc -l < deleted_files.txt || echo 0)"
          echo "  - é‡å‘½åæ–‡ä»¶: $(wc -l < renamed_files.txt || echo 0)"
        else
          echo "âš ï¸ æ— æ³•è·å–çˆ¶æäº¤ï¼Œå¯èƒ½æ˜¯åˆå§‹æäº¤"
          # å¦‚æœæ˜¯åˆå§‹æäº¤ï¼Œè·å–æ‰€æœ‰æ–‡ä»¶
          git ls-tree -r --name-only "$COMMIT_HASH" > added_files.txt
          echo "ğŸ“Š åˆå§‹æäº¤ï¼Œæ‰€æœ‰æ–‡ä»¶ä¸ºæ–°å¢: $(wc -l < added_files.txt || echo 0)"
        fi

    - name: ğŸ—‘ï¸ åˆ é™¤ç›®æ ‡ä»“åº“ä¸­åº”åˆ é™¤çš„æ–‡ä»¶
      id: delete-files
      run: |
        echo "=== åˆ é™¤ç›®æ ‡ä»“åº“ä¸­åº”åˆ é™¤çš„æ–‡ä»¶ ==="
        
        deleted_count=0
        
        if [ -s deleted_files.txt ]; then
          while IFS= read -r file; do
            [ -z "$file" ] && continue
            
            if [ -f "$file" ]; then
              if rm -f "$file"; then
                deleted_count=$((deleted_count + 1))
                echo "ğŸ—‘ï¸  åˆ é™¤: $file"
                
                # åˆ é™¤ç©ºç›®å½•
                dir=$(dirname "$file")
                while [ "$dir" != "." ] && [ -d "$dir" ]; do
                  if [ -z "$(ls -A "$dir")" ]; then
                    rmdir "$dir" 2>/dev/null && echo "ğŸ“ åˆ é™¤ç©ºç›®å½•: $dir" || break
                    dir=$(dirname "$dir")
                  else
                    break
                  fi
                done
              else
                echo "âŒ åˆ é™¤å¤±è´¥: $file"
              fi
            else
              echo "â­ï¸  è·³è¿‡: $file (æ–‡ä»¶ä¸å­˜åœ¨)"
            fi
          done < deleted_files.txt
        fi
        
        echo "deleted_count=$deleted_count" >> $GITHUB_OUTPUT
        echo "âœ… åˆ é™¤å®Œæˆ: $deleted_count ä¸ªæ–‡ä»¶"

    - name: ğŸ“ ç¡®ä¿ç›®å½•ç»“æ„
      id: ensure-directories
      run: |
        echo "=== ç¡®ä¿ç›®å½•ç»“æ„ ==="
        
        created_dirs=0
        
        # ä¸ºæ–°å¢æ–‡ä»¶åˆ›å»ºç›®å½•
        if [ -s added_files.txt ]; then
          while IFS= read -r file; do
            [ -z "$file" ] && continue
            
            dir=$(dirname "$file")
            if [ "$dir" != "." ] && [ ! -d "$dir" ]; then
              mkdir -p "$dir"
              created_dirs=$((created_dirs + 1))
              echo "ğŸ“ åˆ›å»ºç›®å½•: $dir"
            fi
          done < added_files.txt
        fi
        
        echo "created_dirs_count=$created_dirs" >> $GITHUB_OUTPUT
        echo "âœ… ç›®å½•åˆ›å»ºå®Œæˆ: $created_dirs ä¸ªç›®å½•"

    - name: ğŸ“„ æ£€å‡ºæ–‡ä»¶åˆ°æ­£ç¡®ä½ç½®
      id: checkout-files
      run: |
        COMMIT_HASH="${{ needs.step1-push-commit-to-target.outputs.commit_hash }}"
        
        echo "=== æ£€å‡ºæ–‡ä»¶åˆ°æ­£ç¡®ä½ç½® ==="
        
        added_count=0
        modified_count=0
        
        # æ£€å‡ºæ–°å¢æ–‡ä»¶
        if [ -s added_files.txt ]; then
          while IFS= read -r file; do
            [ -z "$file" ] && continue
            
            if git show "$COMMIT_HASH:$file" > "$file" 2>/dev/null; then
              added_count=$((added_count + 1))
              echo "â• æ–°å¢: $file"
            else
              echo "âŒ æ–°å¢å¤±è´¥: $file"
            fi
          done < added_files.txt
        fi
        
        # æ£€å‡ºä¿®æ”¹æ–‡ä»¶
        if [ -s modified_files.txt ]; then
          while IFS= read -r file; do
            [ -z "$file" ] && continue
            
            if git show "$COMMIT_HASH:$file" > "$file" 2>/dev/null; then
              modified_count=$((modified_count + 1))
              echo "âœï¸  ä¿®æ”¹: $file"
            else
              echo "âŒ ä¿®æ”¹å¤±è´¥: $file"
            fi
          done < modified_files.txt
        fi
        
        echo "added_count=$added_count" >> $GITHUB_OUTPUT
        echo "modified_count=$modified_count" >> $GITHUB_OUTPUT
        echo "âœ… æ–‡ä»¶æ£€å‡ºå®Œæˆ: æ–°å¢ $added_count ä¸ª, ä¿®æ”¹ $modified_count ä¸ª"

    - name: ğŸ’¾ æäº¤æ–‡ä»¶å¤„ç†ç»“æœ
      id: commit-file-processing
      run: |
        echo "=== æäº¤æ–‡ä»¶å¤„ç†ç»“æœ ==="
        
        git add -A
        
        if git diff-index --quiet HEAD --; then
          echo "â„¹ï¸ æ— æ–‡ä»¶å¤„ç†å˜æ›´"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          COMMIT_TITLE="${{ github.event.inputs.commit_title }}"
          
          COMMIT_MESSAGE="$COMMIT_TITLE - File Processing
          
          Step 2: Process files in target repository
          - Deleted files: ${{ steps.delete-files.outputs.deleted_count }}
          - Added files: ${{ steps.checkout-files.outputs.added_count }}
          - Modified files: ${{ steps.checkout-files.outputs.modified_count }}
          - Directories created: ${{ steps.ensure-directories.outputs.created_dirs_count }}"
          
          git commit -m "$COMMIT_MESSAGE"
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "âœ… æ–‡ä»¶å¤„ç†æäº¤å®Œæˆ"
        fi

    - name: ğŸš€ æ¨é€æ–‡ä»¶å¤„ç†ç»“æœï¼ˆä½¿ç”¨PATï¼‰
      if: steps.commit-file-processing.outputs.has_changes == 'true'
      run: |
        echo "=== æ¨é€æ–‡ä»¶å¤„ç†ç»“æœ ==="
        
        # ä½¿ç”¨PATè®¤è¯æ¨é€
        git push "https://${{ env.GIT_USERNAME }}:${{ secrets.Mozi9_PAT }}@github.com/${{ github.event.inputs.target_repo }}.git" "${{ github.event.inputs.target_branch }}"
        echo "âœ… æ–‡ä»¶å¤„ç†ç»“æœæ¨é€æˆåŠŸ"

    - name: ğŸ“‹ ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š
      if: always()
      run: |
        cat > "$GITHUB_STEP_SUMMARY" << EOF
        # ä¸¤æ­¥æ³•æäº¤å¤„ç†æŠ¥å‘Šï¼ˆä½¿ç”¨PATè®¤è¯ï¼‰
        
        ## æ­¥éª¤1: æ¨é€æºæäº¤åˆ°ç›®æ ‡ä»“åº“
        - **çŠ¶æ€**: ${{ needs.step1-push-commit-to-target.result == 'success' && 'âœ… å®Œæˆ' : 'âŒ å¤±è´¥' }}
        - **æºæäº¤**: ${{ needs.step1-push-commit-to-target.outputs.commit_hash }}
        - **æ¨é€ç»“æœ**: ${{ needs.step1-push-commit-to-target.outputs.push_success == 'true' && 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥' }}
        
        ## æ­¥éª¤2: åœ¨ç›®æ ‡ä»“åº“ä¸­å¤„ç†æ–‡ä»¶
        - **åˆ é™¤æ–‡ä»¶**: ${{ steps.delete-files.outputs.deleted_count }} ä¸ª
        - **æ–°å¢æ–‡ä»¶**: ${{ steps.checkout-files.outputs.added_count }} ä¸ª
        - **ä¿®æ”¹æ–‡ä»¶**: ${{ steps.checkout-files.outputs.modified_count }} ä¸ª
        - **åˆ›å»ºç›®å½•**: ${{ steps.ensure-directories.outputs.created_dirs_count }} ä¸ª
        - **æœ€ç»ˆçŠ¶æ€**: ${{ steps.commit-file-processing.outputs.has_changes == 'true' && 'âœ… å·²æäº¤' : 'â„¹ï¸ æ— å˜æ›´' }}
        
        ## è®¤è¯ä¿¡æ¯
        - **ä½¿ç”¨ä»¤ç‰Œ**: Mozi9_PAT
        - **è®¤è¯ç”¨æˆ·**: ${{ env.GIT_USERNAME }}
        - **ç›®æ ‡ä»“åº“**: ${{ github.event.inputs.target_repo }}
        
        ## å®Œæ•´å·¥ä½œæµç¨‹
        1. âœ… ä½¿ç”¨PATå…‹éš†ç›®æ ‡ä»“åº“
        2. âœ… ä½¿ç”¨PATæ·»åŠ æºä»“åº“è¿œç¨‹
        3. âœ… åˆå¹¶æºæäº¤åˆ°ç›®æ ‡ä»“åº“
        4. âœ… ä½¿ç”¨PATæ¨é€åˆ°ç›®æ ‡ä»“åº“
        5. âœ… åœ¨ç›®æ ‡ä»“åº“ä¸­åˆ†ææ–‡ä»¶å˜æ›´
        6. âœ… å¤„ç†æ–‡ä»¶åˆ é™¤å’Œæ–°å¢
        7. âœ… ä½¿ç”¨PATæ¨é€å¤„ç†ç»“æœ
        EOF

    - name: ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶
      if: always()
      run: |
        rm -f added_files.txt modified_files.txt deleted_files.txt renamed_files.txt all_files.txt 2>/dev/null || true

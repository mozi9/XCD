name: Complete Commit File Sync Workflow

on:
  workflow_dispatch:
    inputs:
      source_commit_url:
        description: "æºæäº¤é“¾æ¥"
        required: true
        default: "https://github.com/android16-aptusit/kernel_xiaomi_sm8250_mod/commit/47b6de7"
      target_repo:
        description: "ç›®æ ‡ä»“åº“"
        required: true
        default: "mozi9/XCD"
      target_branch:
        description: "ç›®æ ‡åˆ†æ”¯"
        required: true
        default: "miuix"
      commit_message:
        description: "æäº¤ä¿¡æ¯"
        required: true
        default: "fs: Bump SuSFS version to v2.0.0"

env:
  GIT_USERNAME: "mozi9"

jobs:
  step1-push-commit-files:
    runs-on: ubuntu-latest
    outputs:
      commit_hash: ${{ steps.parse-commit.outputs.commit_hash }}
      source_repo: ${{ steps.parse-commit.outputs.source_repo }}
    
    steps:
    - name: é…ç½®Git
      run: |
        git config --global user.name "mozi9"
        git config --global user.email "mozi9@users.noreply.github.com"

    - name: å…‹éš†ç›®æ ‡ä»“åº“
      uses: actions/checkout@v4
      with:
        repository: ${{ github.event.inputs.target_repo }}
        ref: ${{ github.event.inputs.target_branch }}
        token: ${{ secrets.Mozi9_PAT }}

    - name: è§£ææäº¤é“¾æ¥
      id: parse-commit
      run: |
        COMMIT_URL="${{ github.event.inputs.source_commit_url }}"
        if [[ "$COMMIT_URL" =~ github.com/([^/]+)/([^/]+)/commit/([a-f0-9]+) ]]; then
          echo "commit_hash=${BASH_REMATCH[3]}" >> $GITHUB_OUTPUT
          echo "source_repo=${BASH_REMATCH[1]}/${BASH_REMATCH[2]}" >> $GITHUB_OUTPUT
        fi

    - name: æ·»åŠ æºä»“åº“è¿œç¨‹
      run: |
        git remote add source-repo https://${{ env.GIT_USERNAME }}:${{ secrets.Mozi9_PAT }}@github.com/${{ steps.parse-commit.outputs.source_repo }}.git
        git fetch source-repo ${{ steps.parse-commit.outputs.commit_hash }}

    - name: æ£€å‡ºæäº¤æ–‡ä»¶åˆ°ç›®æ ‡ä»“åº“
      run: |
        COMMIT_HASH="${{ steps.parse-commit.outputs.commit_hash }}"
        # åªæ£€å‡ºæäº¤ä¸­çš„æ–‡ä»¶ï¼Œè¦†ç›–ç›®æ ‡ä»“åº“
        git checkout $COMMIT_HASH -- .

    - name: æäº¤åˆ°ç›®æ ‡ä»“åº“
      run: |
        git add -A
        git commit -m "${{ github.event.inputs.commit_message }}"
        git push origin ${{ github.event.inputs.target_branch }}

  step2-process-target-files:
    runs-on: ubuntu-latest
    needs: step1-push-commit-files
    outputs:
      processed_files: ${{ steps.process-files.outputs.file_count }}
    
    steps:
    - name: é…ç½®Git
      run: |
        git config --global user.name "mozi9"
        git config --global user.email "mozi9@users.noreply.github.com"

    - name: æ£€å‡ºç›®æ ‡ä»“åº“
      uses: actions/checkout@v4
      with:
        repository: ${{ github.event.inputs.target_repo }}
        ref: ${{ github.event.inputs.target_branch }}
        token: ${{ secrets.Mozi9_PAT }}
        fetch-depth: 0

    - name: è·å–æäº¤æ–‡ä»¶å˜æ›´ä¿¡æ¯
      id: get-changes
      run: |
        COMMIT_HASH="${{ needs.step1-push-commit-files.outputs.commit_hash }}"
        
        # è·å–çˆ¶æäº¤
        PARENT_COMMIT=$(git log --pretty=%P -n 1 $COMMIT_HASH | awk '{print $1}')
        
        if [ -n "$PARENT_COMMIT" ]; then
          echo "åˆ†ææäº¤å˜æ›´: $PARENT_COMMIT -> $COMMIT_HASH"
          # æ–°å¢/ä¿®æ”¹çš„æ–‡ä»¶
          git diff --name-only --diff-filter=AM $PARENT_COMMIT $COMMIT_HASH > added_files.txt
          # åˆ é™¤çš„æ–‡ä»¶
          git diff --name-only --diff-filter=D $PARENT_COMMIT $COMMIT_HASH > deleted_files.txt
        else
          echo "åˆå§‹æäº¤ï¼Œæ‰€æœ‰æ–‡ä»¶ä¸ºæ–°å¢"
          git ls-tree -r --name-only $COMMIT_HASH > added_files.txt
          touch deleted_files.txt
        fi
        
        echo "æ–°å¢/ä¿®æ”¹æ–‡ä»¶æ•°: $(wc -l < added_files.txt)"
        echo "åˆ é™¤æ–‡ä»¶æ•°: $(wc -l < deleted_files.txt)"

    - name: åœ¨ç›®æ ‡ä»“åº“ä¸­å¤„ç†æ–‡ä»¶
      id: process-files
      run: |
        COMMIT_HASH="${{ needs.step1-push-commit-files.outputs.commit_hash }}"
        
        # 1. åˆ é™¤ç›®æ ‡ä»“åº“ä¸­åº”è¯¥åˆ é™¤çš„æ–‡ä»¶
        delete_count=0
        if [ -s deleted_files.txt ]; then
          while IFS= read -r file; do
            if [ -n "$file" ] && [ -e "$file" ]; then
              rm -rf "$file"
              delete_count=$((delete_count + 1))
              echo "åˆ é™¤: $file"
            fi
          done < deleted_files.txt
        fi
        
        # 2. ç¡®ä¿ç›®æ ‡ä»“åº“ä¸­çš„æ–‡ä»¶ä¸æäº¤ä¸€è‡´
        add_count=0
        if [ -s added_files.txt ]; then
          while IFS= read -r file; do
            if [ -n "$file" ]; then
              mkdir -p "$(dirname "$file")"
              if git show $COMMIT_HASH:"$file" > "$file" 2>/dev/null; then
                add_count=$((add_count + 1))
                echo "ç¡®ä¿æ–‡ä»¶: $file"
              fi
            fi
          done < added_files.txt
        fi
        
        total_processed=$((delete_count + add_count))
        echo "å¤„ç†å®Œæˆ: åˆ é™¤ $delete_count ä¸ªæ–‡ä»¶, å¤„ç† $add_count ä¸ªæ–‡ä»¶"
        echo "file_count=$total_processed" >> $GITHUB_OUTPUT

    - name: æäº¤ç›®æ ‡ä»“åº“å¤„ç†ç»“æœ
      run: |
        git add -A
        if git diff-index --quiet HEAD --; then
          echo "ç›®æ ‡ä»“åº“æ–‡ä»¶çŠ¶æ€å·²æ˜¯æœ€æ–°ï¼Œæ— éœ€æäº¤"
        else
          git commit -m "ç›®æ ‡ä»“åº“æ–‡ä»¶å¤„ç†: ${{ github.event.inputs.commit_message }}"
          git push origin ${{ github.event.inputs.target_branch }}
          echo "ç›®æ ‡ä»“åº“æ–‡ä»¶å¤„ç†ç»“æœå·²æäº¤"
        fi

  step3-generate-report:
    runs-on: ubuntu-latest
    needs: [step1-push-commit-files, step2-process-target-files]
    
    steps:
    - name: ç”Ÿæˆå·¥ä½œæŠ¥å‘Š
      run: |
        cat << EOF > $GITHUB_STEP_SUMMARY
        # æ–‡ä»¶åŒæ­¥å·¥ä½œæŠ¥å‘Š
        
        ## æ‰§è¡Œç»“æœ
        - âœ… æ­¥éª¤1: æäº¤æ–‡ä»¶æ¨é€å®Œæˆ
        - âœ… æ­¥éª¤2: ç›®æ ‡ä»“åº“æ–‡ä»¶å¤„ç†å®Œæˆ
        - ğŸ“Š å¤„ç†æ–‡ä»¶æ•°: ${{ needs.step2-process-target-files.outputs.processed_files || 0 }}
        
        ## è¯¦ç»†ä¿¡æ¯
        - **æºæäº¤**: ${{ needs.step1-push-commit-files.outputs.commit_hash }}
        - **ç›®æ ‡ä»“åº“**: ${{ github.event.inputs.target_repo }}
        - **ç›®æ ‡åˆ†æ”¯**: ${{ github.event.inputs.target_branch }}
        - **æäº¤ä¿¡æ¯**: ${{ github.event.inputs.commit_message }}
        
        ## æ‰§è¡Œæ—¶é—´
        - å¼€å§‹æ—¶é—´: $(date)
        - å·¥ä½œæµ: ${{ github.workflow }}
        - è¿è¡ŒID: ${{ github.run_id }}
        EOF

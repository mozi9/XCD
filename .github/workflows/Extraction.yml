name: Smart File Extraction and Commit

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: "æºä»“åº“ï¼ˆæ ¼å¼ï¼šowner/repoï¼‰"
        required: true
        default: "ApartTUSITU/kernel_xiaomi_sm8250_mod"
      target_repo:
        description: "ç›®æ ‡ä»“åº“ï¼ˆæ ¼å¼ï¼šowner/repoï¼‰"
        required: true
        default: "mozi9/XCD"
      source_commits:
        description: "æºä»“åº“æäº¤å“ˆå¸Œï¼ˆé€—å·åˆ†éš”ï¼‰"
        required: true
        default: "47b6de7"
      source_branch:
        description: "æºåˆ†æ”¯"
        required: true
        default: "android16-aptusitu-new"
      target_branch:
        description: "ç›®æ ‡åˆ†æ”¯"
        required: true
        default: "miuix"
      commit_title:
        description: "æäº¤æ ‡é¢˜"
        required: true
        default: "fs: Bump SuSFS version to v2.0.0"
      commit_description:
        description: "æäº¤æè¿°ï¼ˆå¯é€‰ï¼‰"
        required: false
        default: ""

env:
  GIT_USERNAME: "mozi9"
  GIT_EMAIL: "mozi9@users.noreply.github.com"

jobs:
  smart-file-extraction:
    runs-on: ubuntu-latest
    timeout-minutes: 8
    steps:
    - name: ğŸ” éªŒè¯è¾“å…¥å‚æ•°
      id: validate-inputs
      run: |
        echo "=== æ™ºèƒ½æ–‡ä»¶æå– ==="
        echo "æºä»“åº“: ${{ github.event.inputs.source_repo }}"
        echo "ç›®æ ‡ä»“åº“: ${{ github.event.inputs.target_repo }}"
        echo "æäº¤å“ˆå¸Œ: ${{ github.event.inputs.source_commits }}"
        echo "æºåˆ†æ”¯: ${{ github.event.inputs.source_branch }}"
        
        # éªŒè¯å‚æ•°æ ¼å¼
        if [[ ! "${{ github.event.inputs.source_repo }}" =~ ^[a-zA-Z0-9_.-]+/[a-zA-Z0-9_.-]+$ ]]; then
          echo "âŒ æºä»“åº“æ ¼å¼é”™è¯¯"
          exit 1
        fi
        echo "âœ… å‚æ•°éªŒè¯é€šè¿‡"

    - name: âš™ï¸ é…ç½®Gitç¯å¢ƒ
      run: |
        git config --global user.name "mozi9"
        git config --global user.email "mozi9@users.noreply.github.com"
        git config --global core.autocrlf false

    - name: ğŸ“¥ å¿«é€Ÿæ£€å‡ºç›®æ ‡ä»“åº“
      uses: actions/checkout@v4
      with:
        repository: ${{ github.event.inputs.target_repo }}
        ref: ${{ github.event.inputs.target_branch }}
        token: ${{ secrets.Mozi9_PAT }}
        path: target-repo
        fetch-depth: 1

    - name: ğŸ” æ™ºèƒ½æŸ¥æ‰¾æäº¤å’Œæ–‡ä»¶
      id: smart-analyze
      run: |
        echo "=== æ™ºèƒ½æŸ¥æ‰¾æäº¤å’Œæ–‡ä»¶ ==="
        
        REPO="${{ github.event.inputs.source_repo }}"
        BRANCH="${{ github.event.inputs.source_branch }}"
        COMMITS=$(echo "${{ github.event.inputs.source_commits }}" | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | grep -v '^$')
        
        echo "æŸ¥æ‰¾æäº¤: $COMMITS"
        echo "åœ¨åˆ†æ”¯: $BRANCH"
        
        # å­˜å‚¨ç»“æœ
        all_files=()
        resolved_commits=()
        error_count=0
        
        # é¦–å…ˆè·å–åˆ†æ”¯çš„æœ€æ–°æäº¤
        echo "è·å–åˆ†æ”¯ $BRANCH çš„ä¿¡æ¯..."
        branch_url="https://api.github.com/repos/$REPO/branches/$BRANCH"
        branch_response=$(curl -s \
          -H "Accept: application/vnd.github.v3+json" \
          -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          "$branch_url")
        
        if echo "$branch_response" | grep -q '"name"'; then
          branch_sha=$(echo "$branch_response" | grep '"sha"' | head -1 | cut -d'"' -f4)
          echo "âœ… åˆ†æ”¯ $BRANCH æœ€æ–°æäº¤: ${branch_sha:0:8}"
        else
          echo "âŒ æ— æ³•è·å–åˆ†æ”¯ $BRANCH ä¿¡æ¯"
          echo "å“åº”: $branch_response"
          exit 1
        fi
        
        # æœç´¢æäº¤
        for commit in $COMMITS; do
          echo "æœç´¢æäº¤: $commit"
          
          # æ–¹æ³•1: ç›´æ¥é€šè¿‡APIè·å–æäº¤
          api_url="https://api.github.com/repos/$REPO/commits/$commit"
          response=$(curl -s \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "$api_url")
          
          if echo "$response" | grep -q '"sha"'; then
            # æäº¤å­˜åœ¨
            sha=$(echo "$response" | grep '"sha"' | head -1 | cut -d'"' -f4)
            echo "âœ… æ‰¾åˆ°æäº¤: $commit -> ${sha:0:8}"
            resolved_commits+=("$sha")
            
            # æå–æ–‡ä»¶
            files=$(echo "$response" | grep '"filename"' | cut -d'"' -f4)
            if [ -n "$files" ]; then
              while IFS= read -r file; do
                if [ -n "$file" ] && [[ ! " ${all_files[@]} " =~ " ${file} " ]]; then
                  all_files+=("$file")
                  echo "ğŸ“„ $file"
                fi
              done <<< "$files"
            fi
          else
            # æ–¹æ³•2: æœç´¢æäº¤
            echo "å°è¯•æœç´¢æäº¤ $commit..."
            search_url="https://api.github.com/search/commits?q=repo:$REPO+$commit"
            search_response=$(curl -s \
              -H "Accept: application/vnd.github.cloak-preview+json" \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "$search_url")
            
            if echo "$search_response" | grep -q '"total_count"' && echo "$search_response" | grep -q '"sha"'; then
              search_sha=$(echo "$search_response" | grep '"sha"' | head -1 | cut -d'"' -f4)
              echo "âœ… æœç´¢åˆ°æäº¤: $commit -> ${search_sha:0:8}"
              resolved_commits+=("$search_sha")
              
              # è·å–æäº¤è¯¦æƒ…
              commit_url="https://api.github.com/repos/$REPO/commits/$search_sha"
              commit_response=$(curl -s \
                -H "Accept: application/vnd.github.v3+json" \
                -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                "$commit_url")
              
              files=$(echo "$commit_response" | grep '"filename"' | cut -d'"' -f4)
              if [ -n "$files" ]; then
                while IFS= read -r file; do
                  if [ -n "$file" ] && [[ ! " ${all_files[@]} " =~ " ${file} " ]]; then
                    all_files+=("$file")
                    echo "ğŸ“„ $file"
                  fi
                done <<< "$files"
              fi
            else
              # æ–¹æ³•3: è·å–åˆ†æ”¯æäº¤å†å²ï¼ŒæŸ¥æ‰¾åŒ¹é…çš„æäº¤
              echo "åœ¨åˆ†æ”¯å†å²ä¸­æŸ¥æ‰¾æäº¤ $commit..."
              commits_url="https://api.github.com/repos/$REPO/commits?sha=$BRANCH&per_page=100"
              commits_response=$(curl -s \
                -H "Accept: application/vnd.github.v3+json" \
                -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                "$commits_url")
              
              # åœ¨æäº¤å†å²ä¸­æŸ¥æ‰¾åŒ¹é…çš„çŸ­å“ˆå¸Œ
              found_commit=$(echo "$commits_response" | grep -o "\"sha\":\"[^\"]*$commit[^\"]*\"" | head -1 | cut -d'"' -f4)
              
              if [ -n "$found_commit" ]; then
                echo "âœ… åœ¨å†å²ä¸­æ‰¾åˆ°æäº¤: $commit -> ${found_commit:0:8}"
                resolved_commits+=("$found_commit")
                
                # è·å–æäº¤è¯¦æƒ…
                commit_url="https://api.github.com/repos/$REPO/commits/$found_commit"
                commit_response=$(curl -s \
                  -H "Accept: application/vnd.github.v3+json" \
                  -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                  "$commit_url")
                
                files=$(echo "$commit_response" | grep '"filename"' | cut -d'"' -f4)
                if [ -n "$files" ]; then
                  while IFS= read -r file; do
                    if [ -n "$file" ] && [[ ! " ${all_files[@]} " =~ " ${file} " ]]; then
                      all_files+=("$file")
                      echo "ğŸ“„ $file"
                    fi
                  done <<< "$files"
                fi
              else
                echo "âŒ æ— æ³•æ‰¾åˆ°æäº¤: $commit"
                error_count=$((error_count + 1))
              fi
            fi
          fi
        done
        
        if [ $error_count -gt 0 ]; then
          echo "âŒ å…±å‘ç° $error_count ä¸ªé”™è¯¯ï¼Œæ— æ³•ç»§ç»­"
          exit 1
        fi
        
        if [ ${#all_files[@]} -eq 0 ]; then
          echo "âš ï¸ æœªå‘ç°å˜æ›´æ–‡ä»¶"
          touch file_list.txt
        else
          printf "%s\n" "${all_files[@]}" > file_list.txt
          echo "ğŸ“‹ æ€»å…±å‘ç° ${#all_files[@]} ä¸ªæ–‡ä»¶"
        fi
        
        if [ ${#resolved_commits[@]} -gt 0 ]; then
          printf "%s\n" "${resolved_commits[@]}" > commits.txt
        fi
        
        echo "commits_count=${#resolved_commits[@]}" >> $GITHUB_OUTPUT
        echo "files_count=${#all_files[@]}" >> $GITHUB_OUTPUT
        echo "âœ… åˆ†æå®Œæˆ"

    - name: ğŸ“¥ æŒ‰éœ€ä¸‹è½½æºæ–‡ä»¶
      id: download-files
      run: |
        echo "=== æŒ‰éœ€ä¸‹è½½æ–‡ä»¶ ==="
        
        if [ ! -s file_list.txt ]; then
          echo "âš ï¸ æ²¡æœ‰éœ€è¦ä¸‹è½½çš„æ–‡ä»¶"
          echo "actual_downloaded=0" >> $GITHUB_OUTPUT
          echo "download_errors=0" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        REPO="${{ github.event.inputs.source_repo }}"
        BRANCH="${{ github.event.inputs.source_branch }}"
        
        # åˆ›å»ºæºæ–‡ä»¶ç›®å½•
        mkdir -p source-files
        
        # è®¡æ•°å™¨
        downloaded=0
        errors=0
        
        echo "å¼€å§‹ä¸‹è½½æ–‡ä»¶..."
        
        # ä¸‹è½½æ¯ä¸ªæ–‡ä»¶
        while IFS= read -r file; do
          [ -z "$file" ] && continue
          
          # æ„å»ºrawæ–‡ä»¶URL
          raw_url="https://raw.githubusercontent.com/$REPO/$BRANCH/$file"
          
          echo "â¬‡ï¸ ä¸‹è½½: $file"
          
          # åˆ›å»ºç›®å½•ç»“æ„
          mkdir -p "source-files/$(dirname "$file")"
          
          # ä¸‹è½½æ–‡ä»¶
          if curl -s -f -L "$raw_url" -o "source-files/$file"; then
            downloaded=$((downloaded + 1))
            echo "âœ… ä¸‹è½½æˆåŠŸ"
          else
            echo "âŒ ä¸‹è½½å¤±è´¥: $file"
            errors=$((errors + 1))
          fi
          
          # çŸ­æš‚å»¶è¿Ÿï¼Œé¿å…è¢«é™æµ
          sleep 0.05
          
        done < file_list.txt
        
        echo "actual_downloaded=$downloaded" >> $GITHUB_OUTPUT
        echo "download_errors=$errors" >> $GITHUB_OUTPUT
        echo "âœ… æ–‡ä»¶ä¸‹è½½å®Œæˆ: $downloaded æˆåŠŸ, $errors å¤±è´¥"

    - name: ğŸ”„ åŒæ­¥æ–‡ä»¶åˆ°ç›®æ ‡ä»“åº“
      id: sync-files
      run: |
        echo "=== åŒæ­¥æ–‡ä»¶åˆ°ç›®æ ‡ä»“åº“ ==="
        
        if [ ! -s file_list.txt ]; then
          echo "âš ï¸ æ²¡æœ‰éœ€è¦åŒæ­¥çš„æ–‡ä»¶"
          echo "actual_copied=0" >> $GITHUB_OUTPUT
          echo "sync_errors=0" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # è®¡æ•°å™¨
        copied=0
        errors=0
        
        echo "å¼€å§‹åŒæ­¥æ–‡ä»¶..."
        
        # åŒæ­¥æ¯ä¸ªæ–‡ä»¶
        while IFS= read -r file; do
          [ -z "$file" ] && continue
          
          if [ -f "source-files/$file" ]; then
            # åˆ›å»ºç›®æ ‡ç›®å½•
            mkdir -p "target-repo/$(dirname "$file")"
            
            # å¤åˆ¶æ–‡ä»¶
            if cp "source-files/$file" "target-repo/$file"; then
              copied=$((copied + 1))
              echo "ğŸ“„ åŒæ­¥: $file"
            else
              echo "âŒ å¤åˆ¶å¤±è´¥: $file"
              errors=$((errors + 1))
            fi
          else
            echo "âš ï¸ æºæ–‡ä»¶ä¸å­˜åœ¨: $file"
            errors=$((errors + 1))
          fi
        done < file_list.txt
        
        echo "actual_copied=$copied" >> $GITHUB_OUTPUT
        echo "sync_errors=$errors" >> $GITHUB_OUTPUT
        echo "âœ… æ–‡ä»¶åŒæ­¥å®Œæˆ: $copied æˆåŠŸ, $errors å¤±è´¥"

    - name: ğŸ’¾ åˆ›å»ºæäº¤
      id: create-commit
      run: |
        cd target-repo
        
        echo "=== æ£€æŸ¥å˜æ›´å¹¶æäº¤ ==="
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜æ›´
        if git diff-index --quiet HEAD --; then
          echo "â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "ğŸ“ å‘ç°å˜æ›´ï¼Œå‡†å¤‡æäº¤..."
          
          git add -A
          
          # æ˜¾ç¤ºå˜æ›´æ‘˜è¦
          echo "=== å˜æ›´æ‘˜è¦ ==="
          git status --short
          
          # åˆ›å»ºæäº¤ä¿¡æ¯
          commit_msg="${{ github.event.inputs.commit_title }}"
          if [ -n "${{ github.event.inputs.commit_description }}" ]; then
            commit_msg="$commit_msg"$'\n'$'\n'"${{ github.event.inputs.commit_description }}"
          fi
          
          # æäº¤
          git commit -m "$commit_msg"
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "âœ… æäº¤åˆ›å»ºæˆåŠŸ"
        fi

    - name: ğŸš€ æ¨é€æ›´æ”¹
      if: steps.create-commit.outputs.has_changes == 'true'
      run: |
        cd target-repo
        
        echo "=== æ¨é€æ›´æ”¹ ==="
        
        # é…ç½®è¿œç¨‹URL
        git remote set-url origin "https://mozi9:${{ secrets.Mozi9_PAT }}@github.com/${{ github.event.inputs.target_repo }}.git"
        
        # ç›´æ¥æ¨é€
        if git push origin "${{ github.event.inputs.target_branch }}"; then
          echo "âœ… æ¨é€æˆåŠŸ"
        else
          # å¦‚æœæ¨é€å¤±è´¥ï¼Œå°è¯•æ‹‰å–å¹¶é‡è¯•
          echo "æ¨é€å¤±è´¥ï¼Œå°è¯•è§£å†³å†²çª..."
          git pull origin "${{ github.event.inputs.target_branch }}" --rebase --no-edit
          git push origin "${{ github.event.inputs.target_branch }}"
          echo "âœ… å†²çªè§£å†³å¹¶æ¨é€æˆåŠŸ"
        fi

    - name: ğŸ“‹ ç”ŸæˆæŠ¥å‘Š
      if: always()
      run: |
        cat > "$GITHUB_STEP_SUMMARY" << EOF
        # æ™ºèƒ½æ–‡ä»¶æå–å®Œæˆ
        
        ## æ‰§è¡Œç»Ÿè®¡
        - **å¤„ç†æäº¤**: ${{ steps.smart-analyze.outputs.commits_count || '0' }}
        - **å‘ç°æ–‡ä»¶**: ${{ steps.smart-analyze.outputs.files_count || '0' }}
        - **ä¸‹è½½æ–‡ä»¶**: ${{ steps.download-files.outputs.actual_downloaded || '0' }} (${{ steps.download-files.outputs.download_errors || '0' }} å¤±è´¥)
        - **åŒæ­¥æ–‡ä»¶**: ${{ steps.sync-files.outputs.actual_copied || '0' }} (${{ steps.sync-files.outputs.sync_errors || '0' }} å¤±è´¥)
        - **æäº¤çŠ¶æ€**: ${{ steps.create-commit.outputs.has_changes == 'true' && 'âœ… å·²æäº¤' || 'âš ï¸ æ— å˜æ›´' }}
        
        ## æŠ€æœ¯è¯´æ˜
        æœ¬æ–¹æ¡ˆä½¿ç”¨æ™ºèƒ½æœç´¢ç­–ç•¥æŸ¥æ‰¾æäº¤ï¼š
        1. ç›´æ¥APIæŸ¥è¯¢
        2. å…¨å±€æœç´¢
        3. åˆ†æ”¯å†å²æœç´¢
        
        **é¢„è®¡æ‰§è¡Œæ—¶é—´**: 1-3åˆ†é’Ÿ
        EOF

    - name: ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶
      if: always()
      run: |
        echo "=== æ¸…ç†ä¸´æ—¶æ–‡ä»¶ ==="
        rm -rf source-files
        rm -f file_list.txt commits.txt
        echo "âœ… æ¸…ç†å®Œæˆ"

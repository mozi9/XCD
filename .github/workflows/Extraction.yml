name: File Extraction and Commit

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: "æºä»“åº“ï¼ˆæ ¼å¼ï¼šowner/repoï¼‰"
        required: true
        default: "ApartTUSITU/kernel_xiaomi_sm8250_mod"
      target_repo:
        description: "ç›®æ ‡ä»“åº“ï¼ˆæ ¼å¼ï¼šowner/repoï¼‰"
        required: true
        default: "mozi9/XCD"
      source_commits:
        description: "æºä»“åº“æäº¤å“ˆå¸Œï¼ˆé€—å·åˆ†éš”ï¼Œæ”¯æŒçŸ­å“ˆå¸Œæˆ–å®Œæ•´å“ˆå¸Œï¼‰"
        required: true
        default: "47b6de7"
      source_branch:
        description: "æºåˆ†æ”¯"
        required: true
        default: "android16-aptusitu-new"
      target_branch:
        description: "ç›®æ ‡åˆ†æ”¯"
        required: true
        default: "miuix"
      commit_title:
        description: "æäº¤æ ‡é¢˜"
        required: true
        default: "fs: Bump SuSFS version to v2.0.0"
      commit_description:
        description: "æäº¤æè¿°ï¼ˆå¯é€‰ï¼‰"
        required: false
        default: ""

env:
  GIT_USERNAME: "mozi9"
  GIT_EMAIL: "mozi9@users.noreply.github.com"

jobs:
  file-extraction-commit:
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ” éªŒè¯è¾“å…¥å‚æ•°
      id: validate-inputs
      run: |
        echo "=== éªŒè¯è¾“å…¥å‚æ•° ==="
        echo "æºä»“åº“: ${{ github.event.inputs.source_repo }}"
        echo "ç›®æ ‡ä»“åº“: ${{ github.event.inputs.target_repo }}"
        echo "æºåˆ†æ”¯: ${{ github.event.inputs.source_branch }}"
        echo "ç›®æ ‡åˆ†æ”¯: ${{ github.event.inputs.target_branch }}"
        echo "æäº¤å“ˆå¸Œ: ${{ github.event.inputs.source_commits }}"
        
        # éªŒè¯ä»“åº“æ ¼å¼
        if [[ ! "${{ github.event.inputs.source_repo }}" =~ ^[a-zA-Z0-9_.-]+/[a-zA-Z0-9_.-]+$ ]]; then
          echo "âŒ é”™è¯¯ï¼šæºä»“åº“æ ¼å¼ä¸æ­£ç¡®ï¼Œåº”ä¸º owner/repo æ ¼å¼"
          exit 1
        fi
        
        if [[ ! "${{ github.event.inputs.target_repo }}" =~ ^[a-zA-Z0-9_.-]+/[a-zA-Z0-9_.-]+$ ]]; then
          echo "âŒ é”™è¯¯ï¼šç›®æ ‡ä»“åº“æ ¼å¼ä¸æ­£ç¡®ï¼Œåº”ä¸º owner/repo æ ¼å¼"
          exit 1
        fi
        
        if [[ -z "${{ github.event.inputs.source_commits }}" ]]; then
          echo "âŒ é”™è¯¯ï¼šæäº¤å“ˆå¸Œä¸èƒ½ä¸ºç©º"
          exit 1
        fi
        
        if [[ -z "${{ github.event.inputs.source_branch }}" ]]; then
          echo "âŒ é”™è¯¯ï¼šæºåˆ†æ”¯ä¸èƒ½ä¸ºç©º"
          exit 1
        fi
        
        if [[ -z "${{ github.event.inputs.target_branch }}" ]]; then
          echo "âŒ é”™è¯¯ï¼šç›®æ ‡åˆ†æ”¯ä¸èƒ½ä¸ºç©º"
          exit 1
        fi
        
        echo "âœ… è¾“å…¥å‚æ•°éªŒè¯é€šè¿‡"

    - name: ğŸ“¥ æ£€å‡ºæºä»“åº“ï¼ˆä½¿ç”¨Mozi9_PATï¼‰
      uses: actions/checkout@v4
      with:
        repository: ${{ github.event.inputs.source_repo }}
        ref: ${{ github.event.inputs.source_branch }}
        token: ${{ secrets.Mozi9_PAT }}
        path: source-repo
        fetch-depth: 0

    - name: ğŸ“¥ æ£€å‡ºç›®æ ‡ä»“åº“ï¼ˆä½¿ç”¨Mozi9_PATï¼‰
      uses: actions/checkout@v4
      with:
        repository: ${{ github.event.inputs.target_repo }}
        ref: ${{ github.event.inputs.target_branch }}
        token: ${{ secrets.Mozi9_PAT }}
        path: target-repo
        fetch-depth: 0

    - name: âš™ï¸ é…ç½®Gitèº«ä»½ä¸ºmozi9
      run: |
        git config --global user.name "mozi9"
        git config --global user.email "mozi9@users.noreply.github.com"
        echo "âœ… Gitèº«ä»½å·²é…ç½®ä¸º: mozi9 <mozi9@users.noreply.github.com>"

    - name: ğŸ” è§£ææäº¤å“ˆå¸Œ
      id: resolve-commits
      run: |
        cd source-repo
        
        # é…ç½®å½“å‰ä»“åº“çš„Gitèº«ä»½ä¸ºmozi9
        git config user.name "mozi9"
        git config user.email "mozi9@users.noreply.github.com"
        
        COMMITS=$(echo "${{ github.event.inputs.source_commits }}" | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | grep -v '^$')
        
        if [ -z "$COMMITS" ]; then
          echo "âŒ é”™è¯¯ï¼šæœªæä¾›æœ‰æ•ˆçš„æäº¤å“ˆå¸Œ"
          exit 1
        fi
        
        echo "æ­£åœ¨è§£æ $(( $(echo "$COMMITS" | wc -l) )) ä¸ªæäº¤å“ˆå¸Œ..."
        resolved_commits=()
        error_count=0
        
        for commit in $COMMITS; do
          echo "å°è¯•è§£æ: $commit"
          if full_hash=$(git rev-parse --verify "$commit" 2>/dev/null); then
            # æ£€æŸ¥æäº¤æ˜¯å¦å­˜åœ¨äºå½“å‰åˆ†æ”¯
            if git show --quiet "$full_hash" >/dev/null 2>&1; then
              resolved_commits+=("$full_hash")
              echo "âœ… è§£ææˆåŠŸ: $commit -> $full_hash"
            else
              echo "âŒ é”™è¯¯: æäº¤ $commit ä¸å­˜åœ¨äºä»“åº“ä¸­"
              error_count=$((error_count + 1))
            fi
          else
            echo "âŒ é”™è¯¯: æ— æ³•è§£ææäº¤ '$commit'"
            error_count=$((error_count + 1))
          fi
        done
        
        if [ $error_count -gt 0 ]; then
          echo "âŒ å…±å‘ç° $error_count ä¸ªé”™è¯¯ï¼Œæ— æ³•ç»§ç»­"
          exit 1
        fi
        
        if [ ${#resolved_commits[@]} -eq 0 ]; then
          echo "âŒ é”™è¯¯ï¼šæ²¡æœ‰æˆåŠŸè§£æä»»ä½•æäº¤"
          exit 1
        fi
        
        printf "%s\n" "${resolved_commits[@]}" > ../resolved_commits.txt
        echo "commits_count=${#resolved_commits[@]}" >> $GITHUB_OUTPUT
        echo "âœ… æˆåŠŸè§£æ ${#resolved_commits[@]} ä¸ªæäº¤"

    - name: ğŸ“Š åˆ†ææ–‡ä»¶å˜æ›´
      id: analyze-files
      run: |
        cd source-repo
        
        # ç¡®ä¿Gitèº«ä»½ä¸ºmozi9
        git config user.name "mozi9"
        git config user.email "mozi9@users.noreply.github.com"
        
        if [ ! -f ../resolved_commits.txt ] || [ ! -s ../resolved_commits.txt ]; then
          echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°è§£æçš„æäº¤ä¿¡æ¯"
          exit 1
        fi
        
        echo "=== åˆ†ææ–‡ä»¶å˜æ›´ ==="
        
        modified_files=()
        deleted_files=()
        
        while IFS= read -r commit; do
          [ -z "$commit" ] && continue
          
          echo "åˆ†ææäº¤: ${commit:0:8}"
          
          # ä½¿ç”¨æ›´å®‰å…¨çš„æ–¹å¼è·å–æ–‡ä»¶å˜æ›´
          git show --name-status --format= "$commit" 2>/dev/null | while IFS=$'\t' read -r status file; do
            [ -z "$file" ] && continue
            
            # å®‰å…¨æ£€æŸ¥ï¼šç¡®ä¿æ–‡ä»¶è·¯å¾„å®‰å…¨
            if [[ "$file" == / || "$file" == /* || "$file" == .git* ]]; then
              echo "âš ï¸ è·³è¿‡ä¸å®‰å…¨æ–‡ä»¶è·¯å¾„: $file"
              continue
            fi
            
            case "$status" in
              A|M|C|R*)
                # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨åˆ—è¡¨ä¸­
                found=0
                for existing_file in "${modified_files[@]}"; do
                  if [ "$existing_file" = "$file" ]; then
                    found=1
                    break
                  fi
                done
                if [ $found -eq 0 ]; then
                  modified_files+=("$file")
                fi
                ;;
              D)
                found=0
                for existing_file in "${deleted_files[@]}"; do
                  if [ "$existing_file" = "$file" ]; then
                    found=1
                    break
                  fi
                done
                if [ $found -eq 0 ]; then
                  deleted_files+=("$file")
                fi
                ;;
            esac
          done
        done < ../resolved_commits.txt
        
        # ä¿å­˜æ–‡ä»¶åˆ—è¡¨
        if [ ${#modified_files[@]} -gt 0 ]; then
          printf "%s\n" "${modified_files[@]}" | sort -u > ../modified_files.txt
          echo "ğŸ“„ å‘ç° ${#modified_files[@]} ä¸ªä¿®æ”¹/æ–°å¢æ–‡ä»¶"
        else
          touch ../modified_files.txt
          echo "â„¹ï¸ æ²¡æœ‰å‘ç°ä¿®æ”¹/æ–°å¢æ–‡ä»¶"
        fi
        
        if [ ${#deleted_files[@]} -gt 0 ]; then
          printf "%s\n" "${deleted_files[@]}" | sort -u > ../deleted_files.txt
          echo "ğŸ—‘ï¸ å‘ç° ${#deleted_files[@]} ä¸ªåˆ é™¤æ–‡ä»¶"
        else
          touch ../deleted_files.txt
          echo "â„¹ï¸ æ²¡æœ‰å‘ç°åˆ é™¤æ–‡ä»¶"
        fi
        
        echo "modified_files_count=${#modified_files[@]}" >> $GITHUB_OUTPUT
        echo "deleted_files_count=${#deleted_files[@]}" >> $GITHUB_OUTPUT
        echo "âœ… æ–‡ä»¶å˜æ›´åˆ†æå®Œæˆ"

    - name: ğŸ’¾ åˆ›å»ºå¤‡ä»½
      id: create-backup
      run: |
        cd target-repo
        echo "=== åˆ›å»ºç›®æ ‡ä»“åº“å¤‡ä»½ ==="
        timestamp=$(date +%Y%m%d_%H%M%S)
        backup_dir="../target-backup-$timestamp"
        
        # åˆ›å»ºå¤‡ä»½ï¼Œæ’é™¤.gitç›®å½•
        mkdir -p "$backup_dir"
        find . -maxdepth 1 -not -name '.' -not -name '.git' -exec cp -r {} "$backup_dir/" \;
        
        echo "âœ… å¤‡ä»½åˆ›å»ºå®Œæˆ: $(basename "$backup_dir")"

    - name: ğŸ—‘ï¸ å®‰å…¨åˆ é™¤æ–‡ä»¶
      id: delete-files
      run: |
        cd target-repo
        
        # é…ç½®ç›®æ ‡ä»“åº“çš„Gitèº«ä»½ä¸ºmozi9
        git config user.name "mozi9"
        git config user.email "mozi9@users.noreply.github.com"
        
        echo "=== å®‰å…¨åˆ é™¤æ–‡ä»¶ ==="
        deleted_count=0
        error_count=0
        
        if [ -s ../deleted_files.txt ]; then
          while IFS= read -r file; do
            [ -z "$file" ] && continue
            
            # ä¸¥æ ¼çš„å®‰å…¨æ£€æŸ¥
            if [[ "$file" == / || "$file" == /* || "$file" == .git* || "$file" == "." || "$file" == ".." || "$file" == */.git* ]]; then
              echo "âŒ å®‰å…¨é”™è¯¯: æ‹’ç»åˆ é™¤å—é™æ–‡ä»¶ '$file'"
              error_count=$((error_count + 1))
              continue
            fi
            
            if [ -f "$file" ]; then
              echo "ğŸ—‘ï¸ åˆ é™¤: $file"
              if rm -f -- "$file"; then
                deleted_count=$((deleted_count + 1))
                
                # å°è¯•åˆ é™¤ç©ºç›®å½•
                dir=$(dirname "$file")
                while [ "$dir" != "." ] && [ -d "$dir" ]; do
                  if [ -z "$(find "$dir" -mindepth 1 -maxdepth 1)" ]; then
                    rmdir "$dir" 2>/dev/null && echo "ğŸ“ åˆ é™¤ç©ºç›®å½•: $dir" || break
                    dir=$(dirname "$dir")
                  else
                    break
                  fi
                done
              else
                echo "âŒ åˆ é™¤å¤±è´¥: $file"
                error_count=$((error_count + 1))
              fi
            else
              echo "â„¹ï¸ æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡åˆ é™¤: $file"
            fi
          done < ../deleted_files.txt
        else
          echo "â„¹ï¸ æ²¡æœ‰éœ€è¦åˆ é™¤çš„æ–‡ä»¶"
        fi
        
        echo "actual_deleted_count=$deleted_count" >> $GITHUB_OUTPUT
        echo "delete_errors=$error_count" >> $GITHUB_OUTPUT
        
        if [ $error_count -gt 0 ]; then
          echo "âš ï¸ åˆ é™¤å®Œæˆ: $deleted_count ä¸ªæ–‡ä»¶æˆåŠŸï¼Œ$error_count ä¸ªé”™è¯¯"
        else
          echo "âœ… åˆ é™¤å®Œæˆ: $deleted_count ä¸ªæ–‡ä»¶"
        fi

    - name: ğŸ“„ å¤åˆ¶æ–‡ä»¶
      id: copy-files
      run: |
        cd source-repo
        
        echo "=== å¤åˆ¶æ–‡ä»¶åˆ°ç›®æ ‡ä»“åº“ ==="
        copied_count=0
        error_count=0
        
        if [ -s ../modified_files.txt ]; then
          while IFS= read -r file; do
            [ -z "$file" ] && continue
            
            # å®‰å…¨æ£€æŸ¥
            if [[ "$file" == / || "$file" == /* || "$file" == .git* ]]; then
              echo "âŒ å®‰å…¨é”™è¯¯: æ‹’ç»å¤åˆ¶ä¸å®‰å…¨æ–‡ä»¶ '$file'"
              error_count=$((error_count + 1))
              continue
            fi
            
            if [ -f "$file" ]; then
              echo "ğŸ“„ å¤åˆ¶: $file"
              
              # åˆ›å»ºç›®æ ‡ç›®å½•
              mkdir -p "../target-repo/$(dirname "$file")"
              
              if cp --parents "$file" "../target-repo/"; then
                copied_count=$((copied_count + 1))
              else
                echo "âŒ å¤åˆ¶å¤±è´¥: $file"
                error_count=$((error_count + 1))
              fi
            else
              echo "âš ï¸ æºæ–‡ä»¶ä¸å­˜åœ¨: $file"
              error_count=$((error_count + 1))
            fi
          done < ../modified_files.txt
        else
          echo "â„¹ï¸ æ²¡æœ‰éœ€è¦å¤åˆ¶çš„æ–‡ä»¶"
        fi
        
        echo "actual_copied_count=$copied_count" >> $GITHUB_OUTPUT
        echo "copy_errors=$error_count" >> $GITHUB_OUTPUT
        
        if [ $error_count -gt 0 ]; then
          echo "âš ï¸ å¤åˆ¶å®Œæˆ: $copied_count ä¸ªæ–‡ä»¶æˆåŠŸï¼Œ$error_count ä¸ªé”™è¯¯"
        else
          echo "âœ… å¤åˆ¶å®Œæˆ: $copied_count ä¸ªæ–‡ä»¶"
        fi

    - name: âœ… éªŒè¯ç»“æœ
      id: verify-results
      run: |
        echo "=== æ“ä½œéªŒè¯ ==="
        echo "æäº¤æ•°é‡: ${{ steps.resolve-commits.outputs.commits_count }}"
        echo "ä¿®æ”¹æ–‡ä»¶: ${{ steps.analyze-files.outputs.modified_files_count }}"
        echo "åˆ é™¤æ–‡ä»¶: ${{ steps.analyze-files.outputs.deleted_files_count }}"
        echo "å®é™…å¤åˆ¶: ${{ steps.copy-files.outputs.actual_copied_count }} (é”™è¯¯: ${{ steps.copy-files.outputs.copy_errors }})"
        echo "å®é™…åˆ é™¤: ${{ steps.delete-files.outputs.actual_deleted_count }} (é”™è¯¯: ${{ steps.delete-files.outputs.delete_errors }})"
        
        cd target-repo
        echo "ç›®æ ‡ä»“åº“æ–‡ä»¶æ•°: $(find . -type f -not -path '*/\.git/*' | wc -l)"
        
        # éªŒè¯GitçŠ¶æ€
        echo "=== GitçŠ¶æ€ ==="
        git status --short || echo "æ— æ³•è·å–GitçŠ¶æ€"

    - name: ğŸ’¾ æäº¤å˜æ›´
      id: commit-changes
      run: |
        cd target-repo
        
        # å¼ºåˆ¶é…ç½®Gitèº«ä»½ä¸ºmozi9
        git config user.name "mozi9"
        git config user.email "mozi9@users.noreply.github.com"
        
        echo "=== å‡†å¤‡æäº¤ ==="
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
        if git diff-index --quiet HEAD --; then
          echo "â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "ğŸ“ æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
          echo "has_changes=true" >> $GITHUB_OUTPUT
          
          git add -A
          
          echo "=== å˜æ›´è¯¦æƒ… ==="
          git status --short
          
          # åˆ›å»ºæäº¤ä¿¡æ¯
          commit_msg="${{ github.event.inputs.commit_title }}"
          if [ -n "${{ github.event.inputs.commit_description }}" ]; then
            commit_msg="$commit_msg"$'\n'$'\n'"${{ github.event.inputs.commit_description }}"
          fi
          
          # ä½¿ç”¨ç¯å¢ƒå˜é‡å¼ºåˆ¶è®¾ç½®æäº¤è€…èº«ä»½
          export GIT_AUTHOR_NAME="mozi9"
          export GIT_AUTHOR_EMAIL="mozi9@users.noreply.github.com"
          export GIT_COMMITTER_NAME="mozi9"
          export GIT_COMMITTER_EMAIL="mozi9@users.noreply.github.com"
          
          git commit -m "$commit_msg"
          
          echo "âœ… æäº¤åˆ›å»ºæˆåŠŸ"
        fi

    - name: ğŸš€ æ¨é€æ›´æ”¹
      if: steps.commit-changes.outputs.has_changes == 'true'
      run: |
        cd target-repo
        
        echo "=== æ¨é€åˆ°ç›®æ ‡ä»“åº“ ==="
        
        # é…ç½®è¿œç¨‹URLï¼ˆå®‰å…¨å¤„ç†ç‰¹æ®Šå­—ç¬¦ï¼‰
        target_repo_encoded="${{ github.event.inputs.target_repo }}"
        git remote set-url origin "https://mozi9:${{ secrets.Mozi9_PAT }}@github.com/${target_repo_encoded}.git"
        
        # å…ˆæ‹‰å–æœ€æ–°æ›´æ”¹é¿å…å†²çª
        echo "æ­£åœ¨æ‹‰å–æœ€æ–°æ›´æ”¹..."
        git pull origin "${{ github.event.inputs.target_branch }}" --rebase --no-edit
        
        echo "æ­£åœ¨æ¨é€æ›´æ”¹..."
        if git push origin "${{ github.event.inputs.target_branch }}"; then
          echo "âœ… æ¨é€æˆåŠŸ"
        else
          echo "âŒ æ¨é€å¤±è´¥"
          exit 1
        fi

    - name: ğŸ“‹ ç”ŸæˆæŠ¥å‘Š
      if: always()
      run: |
        summary_file="$GITHUB_STEP_SUMMARY"
        
        cat > "$summary_file" << EOF
        # æ–‡ä»¶æå–å’Œæäº¤ç»“æœ
        
        ## ç»Ÿè®¡ä¿¡æ¯
        - **å¤„ç†çš„æäº¤**: ${{ steps.resolve-commits.outputs.commits_count || '0' }}
        - **ä¿®æ”¹æ–‡ä»¶**: ${{ steps.analyze-files.outputs.modified_files_count || '0' }}
        - **åˆ é™¤æ–‡ä»¶**: ${{ steps.analyze-files.outputs.deleted_files_count || '0' }}
        - **æˆåŠŸå¤åˆ¶**: ${{ steps.copy-files.outputs.actual_copied_count || '0' }}
        - **æˆåŠŸåˆ é™¤**: ${{ steps.delete-files.outputs.actual_deleted_count || '0' }}
        
        ## é”™è¯¯ç»Ÿè®¡
        - **å¤åˆ¶é”™è¯¯**: ${{ steps.copy-files.outputs.copy_errors || '0' }}
        - **åˆ é™¤é”™è¯¯**: ${{ steps.delete-files.outputs.delete_errors || '0' }}
        
        ## ä»“åº“ä¿¡æ¯
        - **æºä»“åº“**: ${{ github.event.inputs.source_repo }}
        - **æºåˆ†æ”¯**: ${{ github.event.inputs.source_branch }}
        - **ç›®æ ‡ä»“åº“**: ${{ github.event.inputs.target_repo }}
        - **ç›®æ ‡åˆ†æ”¯**: ${{ github.event.inputs.target_branch }}
        
        ## æäº¤ä¿¡æ¯
        - **æ ‡é¢˜**: ${{ github.event.inputs.commit_title }}
        EOF
        
        if [ -n "${{ github.event.inputs.commit_description }}" ]; then
          echo "        - **æè¿°**: ${{ github.event.inputs.commit_description }}" >> "$summary_file"
        fi
        
        echo "        " >> "$summary_file"
        echo "## æ“ä½œç»“æœ" >> "$summary_file"
        
        if [ "${{ steps.commit-changes.outputs.has_changes }}" = "true" ]; then
          echo "âœ… **æ“ä½œæˆåŠŸå®Œæˆ** - æ–‡ä»¶å·²æäº¤å¹¶æ¨é€åˆ°ç›®æ ‡ä»“åº“" >> "$summary_file"
        elif [ "${{ steps.commit-changes.outputs.has_changes }}" = "false" ]; then
          echo "âš ï¸ **æ²¡æœ‰æ£€æµ‹åˆ°å˜æ›´** - æœªåˆ›å»ºæäº¤" >> "$summary_file"
        else
          echo "âŒ **æ“ä½œæ‰§è¡Œå¤±è´¥** - å·¥ä½œæµæ‰§è¡Œè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯" >> "$summary_file"
        fi

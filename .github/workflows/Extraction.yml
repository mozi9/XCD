name: æ‰‹åŠ¨æ–‡ä»¶æå–å’Œæäº¤

on:
  workflow_dispatch:
    inputs:
      æºä»“åº“:
        description: "æºä»“åº“åœ°å€ï¼ˆæ‰€æœ‰è€…/ä»“åº“åï¼‰"
        required: true
        default: "sqldown/android_kernel_common_android12-5.10"
      æºåˆ†æ”¯:
        description: "ä»ä¸­è·å–æäº¤çš„æºåˆ†æ”¯"
        required: true
        default: "android_kernel_common_android12-5.10"
      æäº¤å“ˆå¸Œ:
        description: "æºæäº¤å“ˆå¸Œï¼ˆçŸ­å“ˆå¸Œæˆ–å®Œæ•´å“ˆå¸Œï¼Œå¤šä¸ªç”¨é€—å·åˆ†éš”ï¼‰"
        required: true
        default: "41273ce"
      ç›®æ ‡ä»“åº“:
        description: "ç›®æ ‡ä»“åº“åœ°å€ï¼ˆæ‰€æœ‰è€…/ä»“åº“åï¼‰"
        required: true
        default: "mozi9/XCD"
      ç›®æ ‡åˆ†æ”¯:
        description: "è¦æ¨é€åˆ°çš„ç›®æ ‡åˆ†æ”¯"
        required: true
        default: "miuix"
      æäº¤æ ‡é¢˜:
        description: "æäº¤ä¿¡æ¯çš„æ ‡é¢˜"
        required: true
        default: "fs: å‡çº§ SuSFS ç‰ˆæœ¬åˆ° v2.0.0"
      æäº¤æè¿°:
        description: "æäº¤ä¿¡æ¯çš„è¯¦ç»†æè¿°ï¼ˆå¯é€‰ï¼‰"
        required: false
        default: "ååŒä½œè€…: simonpunk <simonpunk2016@gmail.com>\nååŒä½œè€…: JackA1ltman <cs2dtzq@163.com>"

env:
  GIT_USERNAME: "github-actions[bot]"
  GIT_EMAIL: "github-actions[bot]@users.noreply.github.com"

jobs:
  æ–‡ä»¶æå–å’Œæäº¤:
    runs-on: ubuntu-latest
    steps:
    - name: æ£€å‡ºæºä»“åº“
      uses: actions/checkout@v4
      with:
        repository: ${{ inputs.æºä»“åº“ }}
        ref: ${{ inputs.æºåˆ†æ”¯ }}
        token: ${{ secrets.GITHUB_TOKEN }}
        path: source-repo
        fetch-depth: 0

    - name: æ£€å‡ºç›®æ ‡ä»“åº“
      uses: actions/checkout@v4
      with:
        repository: ${{ inputs.ç›®æ ‡ä»“åº“ }}
        ref: ${{ inputs.ç›®æ ‡åˆ†æ”¯ }}
        token: ${{ secrets.GITHUB_TOKEN }}
        path: target-repo
        fetch-depth: 0

    - name: é…ç½®Gitèº«ä»½
      run: |
        git config --global user.name "${{ env.GIT_USERNAME }}"
        git config --global user.email "${{ env.GIT_EMAIL }}"
        echo "Gitèº«ä»½å·²é…ç½®"

    - name: è§£ææäº¤å“ˆå¸Œ
      id: è§£ææäº¤
      run: |
        cd source-repo
        # å¤„ç†è¾“å…¥çš„æäº¤å“ˆå¸Œ
        æäº¤åˆ—è¡¨=$(echo "${{ inputs.æäº¤å“ˆå¸Œ }}" | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | grep -v '^$')
        è§£æåçš„æäº¤=""
        
        for å•ä¸ªæäº¤ in $æäº¤åˆ—è¡¨; do
          å®Œæ•´å“ˆå¸Œ=$(git rev-parse "$å•ä¸ªæäº¤" 2>/dev/null || echo "")
          if [ -n "$å®Œæ•´å“ˆå¸Œ" ]; then
            è§£æåçš„æäº¤="$è§£æåçš„æäº¤$å®Œæ•´å“ˆå¸Œ"$'\n'
            echo "âœ… è§£ææäº¤: $å•ä¸ªæäº¤ -> $å®Œæ•´å“ˆå¸Œ"
          else
            echo "âŒ é”™è¯¯: æ— æ³•è§£ææäº¤ $å•ä¸ªæäº¤"
            exit 1
          fi
        done
        
        echo "$è§£æåçš„æäº¤" | grep -v '^$' > ../è§£æåçš„æäº¤.txt
        echo "âœ… æ‰€æœ‰æäº¤è§£æå®Œæˆ"

    - name: åˆ†ææ–‡ä»¶å˜æ›´
      id: åˆ†ææ–‡ä»¶
      run: |
        cd source-repo
        æäº¤åˆ—è¡¨=$(cat ../è§£æåçš„æäº¤.txt)
        
        æ‰€æœ‰ä¿®æ”¹æ–‡ä»¶=""
        æ‰€æœ‰åˆ é™¤æ–‡ä»¶=""
        
        echo "=== å¼€å§‹åˆ†ææ–‡ä»¶å˜æ›´ ==="
        
        for æäº¤ in $æäº¤åˆ—è¡¨; do
          echo "æ­£åœ¨å¤„ç†æäº¤: $æäº¤"
          
          ä¿®æ”¹çš„æ–‡ä»¶=$(git show --name-status --format= $æäº¤ | awk '$1 == "A" || $1 == "M" {print $2}' | sort -u)
          åˆ é™¤çš„æ–‡ä»¶=$(git show --name-status --format= $æäº¤ | awk '$1 == "D" {print $2}' | sort -u)
          
          if [ -n "$ä¿®æ”¹çš„æ–‡ä»¶" ]; then
            æ‰€æœ‰ä¿®æ”¹æ–‡ä»¶="$æ‰€æœ‰ä¿®æ”¹æ–‡ä»¶"$'\n'"$ä¿®æ”¹çš„æ–‡ä»¶"
          fi
          if [ -n "$åˆ é™¤çš„æ–‡ä»¶" ]; then
            æ‰€æœ‰åˆ é™¤æ–‡ä»¶="$æ‰€æœ‰åˆ é™¤æ–‡ä»¶"$'\n'"$åˆ é™¤çš„æ–‡ä»¶"
          fi
        done
        
        # å»é‡æ–‡ä»¶åˆ—è¡¨
        å”¯ä¸€ä¿®æ”¹æ–‡ä»¶=$(echo "$æ‰€æœ‰ä¿®æ”¹æ–‡ä»¶" | grep -v '^$' | sort -u)
        å”¯ä¸€åˆ é™¤æ–‡ä»¶=$(echo "$æ‰€æœ‰åˆ é™¤æ–‡ä»¶" | grep -v '^$' | sort -u)
        
        echo "$å”¯ä¸€ä¿®æ”¹æ–‡ä»¶" > ../ä¿®æ”¹çš„æ–‡ä»¶.txt
        echo "$å”¯ä¸€åˆ é™¤æ–‡ä»¶" > ../åˆ é™¤çš„æ–‡ä»¶.txt
        
        ä¿®æ”¹æ•°é‡=$(echo "$å”¯ä¸€ä¿®æ”¹æ–‡ä»¶" | grep -c . || echo 0)
        åˆ é™¤æ•°é‡=$(echo "$å”¯ä¸€åˆ é™¤æ–‡ä»¶" | grep -c . || echo 0)
        
        echo "ä¿®æ”¹æ–‡ä»¶æ•°é‡=$ä¿®æ”¹æ•°é‡" >> $GITHUB_OUTPUT
        echo "åˆ é™¤æ–‡ä»¶æ•°é‡=$åˆ é™¤æ•°é‡" >> $GITHUB_OUTPUT
        
        echo "âœ… åˆ†æå®Œæˆ: ä¿®æ”¹æ–‡ä»¶ $ä¿®æ”¹æ•°é‡ ä¸ª, åˆ é™¤æ–‡ä»¶ $åˆ é™¤æ•°é‡ ä¸ª"

    - name: åˆ é™¤ç›®æ ‡æ–‡ä»¶
      id: åˆ é™¤æ–‡ä»¶
      run: |
        cd target-repo
        
        echo "=== å¼€å§‹åˆ é™¤ç›®æ ‡æ–‡ä»¶ ==="
        å®é™…åˆ é™¤æ•°é‡=0
        
        if [ -s ../åˆ é™¤çš„æ–‡ä»¶.txt ]; then
          while IFS= read -r æ–‡ä»¶è·¯å¾„; do
            if [ -n "$æ–‡ä»¶è·¯å¾„" ] && [ -f "$æ–‡ä»¶è·¯å¾„" ]; then
              # å®‰å…¨æ£€æŸ¥
              if [[ "$æ–‡ä»¶è·¯å¾„" != / && "$æ–‡ä»¶è·¯å¾„" != /* && "$æ–‡ä»¶è·¯å¾„" != .git* && "$æ–‡ä»¶è·¯å¾„" != "." && "$æ–‡ä»¶è·¯å¾„" != ".." ]]; then
                echo "ğŸ—‘ï¸ åˆ é™¤æ–‡ä»¶: $æ–‡ä»¶è·¯å¾„"
                rm -f "$æ–‡ä»¶è·¯å¾„"
                å®é™…åˆ é™¤æ•°é‡=$((å®é™…åˆ é™¤æ•°é‡ + 1))
              else
                echo "ğŸš« è·³è¿‡ï¼ˆå®‰å…¨é™åˆ¶ï¼‰: $æ–‡ä»¶è·¯å¾„"
              fi
            fi
          done < ../åˆ é™¤çš„æ–‡ä»¶.txt
        fi
        
        echo "å®é™…åˆ é™¤æ•°é‡=$å®é™…åˆ é™¤æ•°é‡" >> $GITHUB_OUTPUT
        echo "âœ… åˆ é™¤å®Œæˆ: $å®é™…åˆ é™¤æ•°é‡ ä¸ªæ–‡ä»¶"

    - name: å¤åˆ¶ä¿®æ”¹æ–‡ä»¶åˆ°ç›®æ ‡
      id: å¤åˆ¶æ–‡ä»¶
      run: |
        cd source-repo
        git checkout ${{ inputs.æºåˆ†æ”¯ }} --quiet
        
        echo "=== å¼€å§‹å¤åˆ¶ä¿®æ”¹æ–‡ä»¶ ==="
        å®é™…å¤åˆ¶æ•°é‡=0
        
        if [ -s ../ä¿®æ”¹çš„æ–‡ä»¶.txt ]; then
          while IFS= read -r æ–‡ä»¶è·¯å¾„; do
            if [ -n "$æ–‡ä»¶è·¯å¾„" ] && [ -f "$æ–‡ä»¶è·¯å¾„" ]; then
              echo "ğŸ“„ å¤åˆ¶æ–‡ä»¶: $æ–‡ä»¶è·¯å¾„"
              # åˆ›å»ºç›®æ ‡ç›®å½•
              mkdir -p "../target-repo/$(dirname "$æ–‡ä»¶è·¯å¾„")"
              cp "$æ–‡ä»¶è·¯å¾„" "../target-repo/$æ–‡ä»¶è·¯å¾„"
              å®é™…å¤åˆ¶æ•°é‡=$((å®é™…å¤åˆ¶æ•°é‡ + 1))
            fi
          done < ../ä¿®æ”¹çš„æ–‡ä»¶.txt
        fi
        
        echo "å®é™…å¤åˆ¶æ•°é‡=$å®é™…å¤åˆ¶æ•°é‡" >> $GITHUB_OUTPUT
        echo "âœ… å¤åˆ¶å®Œæˆ: $å®é™…å¤åˆ¶æ•°é‡ ä¸ªæ–‡ä»¶"

    - name: éªŒè¯æ–‡ä»¶æ“ä½œ
      id: éªŒè¯æ–‡ä»¶
      run: |
        echo "=== æ–‡ä»¶æ“ä½œéªŒè¯ ==="
        echo "é¢„æœŸå¤åˆ¶æ–‡ä»¶: $(cat ä¿®æ”¹çš„æ–‡ä»¶.txt | wc -l) ä¸ª"
        echo "é¢„æœŸåˆ é™¤æ–‡ä»¶: $(cat åˆ é™¤çš„æ–‡ä»¶.txt | wc -l) ä¸ª"
        echo "å®é™…å¤åˆ¶æ–‡ä»¶: ${{ steps.å¤åˆ¶æ–‡ä»¶.outputs.å®é™…å¤åˆ¶æ•°é‡ }} ä¸ª"
        echo "å®é™…åˆ é™¤æ–‡ä»¶: ${{ steps.åˆ é™¤æ–‡ä»¶.outputs.å®é™…åˆ é™¤æ•°é‡ }} ä¸ª"
        
        cd target-repo
        echo "ç›®æ ‡ä»“åº“æ–‡ä»¶æ€»æ•°: $(find . -type f -not -path '*/\.git/*' | wc -l)"
        echo "GitçŠ¶æ€:"
        git status --short

    - name: æäº¤å˜æ›´
      id: æäº¤å˜æ›´
      run: |
        cd target-repo
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
        git add -A
        if git diff --cached --quiet; then
          echo "âŒ æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
          echo "æ˜¯å¦æœ‰å˜æ›´=false" >> $GITHUB_OUTPUT
          # è°ƒè¯•ä¿¡æ¯
          echo "=== è°ƒè¯•ä¿¡æ¯ ==="
          git status
          find . -type f -not -path '*/\.git/*' | head -10
          exit 1
        else
          echo "æ˜¯å¦æœ‰å˜æ›´=true" >> $GITHUB_OUTPUT
          echo "=== å°†è¦æäº¤çš„æ–‡ä»¶ ==="
          git diff --cached --name-only
          
          # æäº¤å˜æ›´
          git commit -m "${{ inputs.æäº¤æ ‡é¢˜ }}" -m "${{ inputs.æäº¤æè¿° }}"
          echo "âœ… æäº¤åˆ›å»ºæˆåŠŸ"
        fi

    - name: æ¨é€åˆ°ç›®æ ‡ä»“åº“
      if: steps.æäº¤å˜æ›´.outputs.æ˜¯å¦æœ‰å˜æ›´ == 'true'
      run: |
        cd target-repo
        git push origin ${{ inputs.ç›®æ ‡åˆ†æ”¯ }}
        echo "âœ… å·²æ¨é€åˆ° ${{ inputs.ç›®æ ‡ä»“åº“ }}:${{ inputs.ç›®æ ‡åˆ†æ”¯ }}"

    - name: æ˜¾ç¤ºæœ€ç»ˆç»“æœ
      run: |
        cat > $GITHUB_STEP_SUMMARY << EOF
        # ğŸ‰ æ–‡ä»¶å¤„ç†å®Œæˆ
        
        ## ğŸ“Š æ“ä½œç»Ÿè®¡
        - **åˆ†æçš„ä¿®æ”¹æ–‡ä»¶**: ${{ steps.åˆ†ææ–‡ä»¶.outputs.ä¿®æ”¹æ–‡ä»¶æ•°é‡ }} ä¸ª
        - **åˆ†æçš„åˆ é™¤æ–‡ä»¶**: ${{ steps.åˆ†ææ–‡ä»¶.outputs.åˆ é™¤æ–‡ä»¶æ•°é‡ }} ä¸ª
        - **å®é™…å¤åˆ¶çš„æ–‡ä»¶**: ${{ steps.å¤åˆ¶æ–‡ä»¶.outputs.å®é™…å¤åˆ¶æ•°é‡ }} ä¸ª
        - **å®é™…åˆ é™¤çš„æ–‡ä»¶**: ${{ steps.åˆ é™¤æ–‡ä»¶.outputs.å®é™…åˆ é™¤æ•°é‡ }} ä¸ª
        
        ## ğŸ”§ ä»“åº“é…ç½®
        - **æºä»“åº“**: ${{ inputs.æºä»“åº“ }}
        - **æºåˆ†æ”¯**: ${{ inputs.æºåˆ†æ”¯ }}
        - **ç›®æ ‡ä»“åº“**: ${{ inputs.ç›®æ ‡ä»“åº“ }}
        - **ç›®æ ‡åˆ†æ”¯**: ${{ inputs.ç›®æ ‡åˆ†æ”¯ }}
        
        ## ğŸ“ æäº¤ä¿¡æ¯
        - **æ ‡é¢˜**: ${{ inputs.æäº¤æ ‡é¢˜ }}
        - **æè¿°**: ${{ inputs.æäº¤æè¿° }}
        
        EOF
        
        if [ "${{ steps.æäº¤å˜æ›´.outputs.æ˜¯å¦æœ‰å˜æ›´ }}" = "true" ]; then
          echo "âœ… **æ“ä½œæˆåŠŸ**: å·²æˆåŠŸå¤„ç† ${{ steps.å¤åˆ¶æ–‡ä»¶.outputs.å®é™…å¤åˆ¶æ•°é‡ }} ä¸ªæ–‡ä»¶å¹¶æ¨é€åˆ°ç›®æ ‡ä»“åº“" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **æ“ä½œå¤±è´¥**: æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´" >> $GITHUB_STEP_SUMMARY
        fi

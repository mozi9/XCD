name: File Extraction and Commit

on:
  workflow_dispatch:
    inputs:
      source_repo_url:
        description: "æºä»“åº“URL"
        required: true
        default: "https://github.com/ApartTUSITU/kernel_xiaomi_sm8250_mod"
      target_repo_url:
        description: "ç›®æ ‡ä»“åº“URL"
        required: true
        default: "https://github.com/mozi9/XCD"
      source_commits:
        description: "æºä»“åº“æäº¤å“ˆå¸Œï¼ˆé€—å·åˆ†éš”ï¼Œæ”¯æŒçŸ­å“ˆå¸Œæˆ–å®Œæ•´å“ˆå¸Œï¼‰"
        required: true
        default: "47b6de7"
      source_branch:
        description: "æºåˆ†æ”¯"
        required: true
        default: "android_kernel_common_android12-5.10"
      target_branch:
        description: "ç›®æ ‡åˆ†æ”¯"
        required: true
        default: "miuix"
      commit_title:
        description: "æäº¤æ ‡é¢˜"
        required: true
        default: "fs: Bump SuSFS version to v2.0.0"
      commit_description:
        description: "æäº¤æè¿°ï¼ˆå¯é€‰ï¼‰"
        required: false
        default: ""

env:
  GIT_USERNAME: "github-actions[bot]"
  GIT_EMAIL: "github-actions[bot]@users.noreply.github.com"

jobs:
  file-extraction-commit:
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ“¥ æ£€å‡ºæºä»“åº“
      uses: actions/checkout@v4
      with:
        repository: ${{ inputs.source_repo }}
        ref: ${{ inputs.source_branch }}
        token: ${{ secrets.GITHUB_TOKEN }}
        path: source-repo
        fetch-depth: 0

    - name: ğŸ“¥ æ£€å‡ºç›®æ ‡ä»“åº“
      uses: actions/checkout@v4
      with:
        repository: ${{ inputs.target_repo }}
        ref: ${{ inputs.target_branch }}
        token: ${{ secrets.GITHUB_TOKEN }}
        path: target-repo
        fetch-depth: 0

    - name: âš™ï¸ é…ç½®Gitèº«ä»½
      run: |
        git config --global user.name "${{ env.GIT_USERNAME }}"
        git config --global user.email "${{ env.GIT_EMAIL }}"
        echo "Gitèº«ä»½å·²é…ç½®"

    - name: ğŸ” è§£ææäº¤å“ˆå¸Œ
      id: resolve-commits
      run: |
        cd source-repo
        echo "æ­£åœ¨è§£ææäº¤å“ˆå¸Œ..."
        COMMITS=$(echo "${{ inputs.source_commits }}" | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | grep -v '^$')
        RESOLVED_COMMITS=""
        
        for commit in $COMMITS; do
          FULL_HASH=$(git rev-parse "$commit" 2>/dev/null || echo "")
          if [ -n "$FULL_HASH" ]; then
            RESOLVED_COMMITS="$RESOLVED_COMMITS$FULL_HASH"$'\n'
            echo "âœ… è§£ææäº¤: $commit -> $FULL_HASH"
          else
            echo "âŒ é”™è¯¯: æ— æ³•è§£ææäº¤ $commit"
            exit 1
          fi
        done
        
        echo "$RESOLVED_COMMITS" | grep -v '^$' > ../resolved_commits.txt
        echo "âœ… æ‰€æœ‰æäº¤è§£æå®Œæˆ"

    - name: ğŸ“Š åˆ†ææ–‡ä»¶å˜æ›´
      id: analyze-files
      run: |
        cd source-repo
        COMMITS=$(cat ../resolved_commits.txt)
        
        ALL_MODIFIED_FILES=""
        ALL_DELETED_FILES=""
        
        echo "=== å¼€å§‹åˆ†ææ–‡ä»¶å˜æ›´ ==="
        
        for commit in $COMMITS; do
          echo "æ­£åœ¨å¤„ç†æäº¤: $commit"
          
          MODIFIED_FILES=$(git show --name-status --format= $commit | awk '$1 == "A" || $1 == "M" {print $2}' | sort -u)
          DELETED_FILES=$(git show --name-status --format= $commit | awk '$1 == "D" {print $2}' | sort -u)
          
          if [ -n "$MODIFIED_FILES" ]; then
            ALL_MODIFIED_FILES="$ALL_MODIFIED_FILES"$'\n'"$MODIFIED_FILES"
          fi
          if [ -n "$DELETED_FILES" ]; then
            ALL_DELETED_FILES="$ALL_DELETED_FILES"$'\n'"$DELETED_FILES"
          fi
        done
        
        UNIQUE_MODIFIED=$(echo "$ALL_MODIFIED_FILES" | grep -v '^$' | sort -u)
        UNIQUE_DELETED=$(echo "$ALL_DELETED_FILES" | grep -v '^$' | sort -u)
        
        echo "$UNIQUE_MODIFIED" > ../modified_files.txt
        echo "$UNIQUE_DELETED" > ../deleted_files.txt
        
        MOD_COUNT=$(echo "$UNIQUE_MODIFIED" | grep -c . || echo 0)
        DEL_COUNT=$(echo "$UNIQUE_DELETED" | grep -c . || echo 0)
        
        echo "modified_files_count=$MOD_COUNT" >> $GITHUB_OUTPUT
        echo "deleted_files_count=$DEL_COUNT" >> $GITHUB_OUTPUT
        
        echo "âœ… åˆ†æå®Œæˆ: ä¿®æ”¹æ–‡ä»¶ $MOD_COUNT ä¸ª, åˆ é™¤æ–‡ä»¶ $DEL_COUNT ä¸ª"

    - name: ğŸ—‘ï¸ åˆ é™¤ç›®æ ‡æ–‡ä»¶
      id: delete-files
      run: |
        cd target-repo
        
        echo "=== å¼€å§‹åˆ é™¤ç›®æ ‡æ–‡ä»¶ ==="
        DELETED_COUNT=0
        
        if [ -s ../deleted_files.txt ]; then
          while IFS= read -r file; do
            if [ -n "$file" ] && [ -f "$file" ]; then
              if [[ "$file" != / && "$file" != /* && "$file" != .git* && "$file" != "." && "$file" != ".." ]]; then
                echo "ğŸ—‘ï¸ åˆ é™¤æ–‡ä»¶: $file"
                rm -f "$file"
                DELETED_COUNT=$((DELETED_COUNT + 1))
              else
                echo "ğŸš« è·³è¿‡ï¼ˆå®‰å…¨é™åˆ¶ï¼‰: $file"
              fi
            fi
          done < ../deleted_files.txt
        fi
        
        echo "actual_deleted_count=$DELETED_COUNT" >> $GITHUB_OUTPUT
        echo "âœ… åˆ é™¤å®Œæˆ: $DELETED_COUNT ä¸ªæ–‡ä»¶"

    - name: ğŸ“„ å¤åˆ¶ä¿®æ”¹æ–‡ä»¶åˆ°ç›®æ ‡
      id: copy-files
      run: |
        cd source-repo
        git checkout ${{ inputs.source_branch }} --quiet
        
        echo "=== å¼€å§‹å¤åˆ¶ä¿®æ”¹æ–‡ä»¶ ==="
        COPIED_COUNT=0
        
        if [ -s ../modified_files.txt ]; then
          while IFS= read -r file; do
            if [ -n "$file" ] && [ -f "$file" ]; then
              echo "ğŸ“„ å¤åˆ¶æ–‡ä»¶: $file"
              mkdir -p "../target-repo/$(dirname "$file")"
              cp "$file" "../target-repo/$file"
              COPIED_COUNT=$((COPIED_COUNT + 1))
            fi
          done < ../modified_files.txt
        fi
        
        echo "actual_copied_count=$COPIED_COUNT" >> $GITHUB_OUTPUT
        echo "âœ… å¤åˆ¶å®Œæˆ: $COPIED_COUNT ä¸ªæ–‡ä»¶"

    - name: âœ… éªŒè¯æ–‡ä»¶æ“ä½œ
      id: verify-files
      run: |
        echo "=== æ–‡ä»¶æ“ä½œéªŒè¯ ==="
        echo "é¢„æœŸå¤åˆ¶æ–‡ä»¶: $(cat modified_files.txt | wc -l) ä¸ª"
        echo "é¢„æœŸåˆ é™¤æ–‡ä»¶: $(cat deleted_files.txt | wc -l) ä¸ª"
        echo "å®é™…å¤åˆ¶æ–‡ä»¶: ${{ steps.copy-files.outputs.actual_copied_count }} ä¸ª"
        echo "å®é™…åˆ é™¤æ–‡ä»¶: ${{ steps.delete-files.outputs.actual_deleted_count }} ä¸ª"
        
        cd target-repo
        echo "ç›®æ ‡ä»“åº“æ–‡ä»¶æ€»æ•°: $(find . -type f -not -path '*/\.git/*' | wc -l)"
        echo "GitçŠ¶æ€:"
        git status --short

    - name: ğŸ’¾ æäº¤å˜æ›´
      id: commit-changes
      run: |
        cd target-repo
        
        git add -A
        if git diff --cached --quiet; then
          echo "âŒ æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
          echo "has_changes=false" >> $GITHUB_OUTPUT
          exit 1
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "=== å°†è¦æäº¤çš„æ–‡ä»¶ ==="
          git diff --cached --name-only
          
          git commit -m "${{ inputs.commit_title }}" -m "${{ inputs.commit_description }}"
          echo "âœ… æäº¤åˆ›å»ºæˆåŠŸ"
        fi

    - name: ğŸš€ æ¨é€åˆ°ç›®æ ‡ä»“åº“
      if: steps.commit-changes.outputs.has_changes == 'true'
      run: |
        cd target-repo
        git push origin ${{ inputs.target_branch }}
        echo "âœ… å·²æ¨é€åˆ° ${{ inputs.target_repo }}:${{ inputs.target_branch }}"

    - name: ğŸ“‹ æ˜¾ç¤ºæœ€ç»ˆç»“æœ
      run: |
        cat > $GITHUB_STEP_SUMMARY << 'EOF'
        # ğŸ‰ æ–‡ä»¶å¤„ç†å®Œæˆ
        
        ## ğŸ“Š æ“ä½œç»Ÿè®¡
        - **åˆ†æçš„ä¿®æ”¹æ–‡ä»¶**: ${{ steps.analyze-files.outputs.modified_files_count }} ä¸ª
        - **åˆ†æçš„åˆ é™¤æ–‡ä»¶**: ${{ steps.analyze-files.outputs.deleted_files_count }} ä¸ª
        - **å®é™…å¤åˆ¶çš„æ–‡ä»¶**: ${{ steps.copy-files.outputs.actual_copied_count }} ä¸ª
        - **å®é™…åˆ é™¤çš„æ–‡ä»¶**: ${{ steps.delete-files.outputs.actual_deleted_count }} ä¸ª
        
        ## ğŸ”§ ä»“åº“é…ç½®
        - **æºä»“åº“**: ${{ inputs.source_repo }}
        - **æºåˆ†æ”¯**: ${{ inputs.source_branch }}
        - **ç›®æ ‡ä»“åº“**: ${{ inputs.target_repo }}
        - **ç›®æ ‡åˆ†æ”¯**: ${{ inputs.target_branch }}
        
        ## ğŸ“ æäº¤ä¿¡æ¯
        - **æ ‡é¢˜**: ${{ inputs.commit_title }}
        - **æè¿°**: ${{ inputs.commit_description }}
        EOF
        
        if [ "${{ steps.commit-changes.outputs.has_changes }}" = "true" ]; then
          echo "âœ… **æ“ä½œæˆåŠŸ**: å·²æˆåŠŸå¤„ç† ${{ steps.copy-files.outputs.actual_copied_count }} ä¸ªæ–‡ä»¶å¹¶æ¨é€åˆ°ç›®æ ‡ä»“åº“" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **æ“ä½œå¤±è´¥**: æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´" >> $GITHUB_STEP_SUMMARY
        fi

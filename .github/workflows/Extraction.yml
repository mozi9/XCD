name: File Extraction and Commit

on:
  workflow_dispatch:
    inputs:
      source_repo_url:
        description: "æºä»“åº“URL"
        required: true
        default: "https://github.com/ApartTUSITU/kernel_xiaomi_sm8250_mod"
      target_repo_url:
        description: "ç›®æ ‡ä»“åº“URL"
        required: true
        default: "https://github.com/mozi9/XCD"
      source_commits:
        description: "æºä»“åº“æäº¤å“ˆå¸Œï¼ˆé€—å·åˆ†éš”ï¼Œæ”¯æŒçŸ­å“ˆå¸Œæˆ–å®Œæ•´å“ˆå¸Œï¼‰"
        required: true
        default: "47b6de7"
      source_branch:
        description: "æºåˆ†æ”¯"
        required: true
        default: "android_kernel_common_android12-5.10"
      target_branch:
        description: "ç›®æ ‡åˆ†æ”¯"
        required: true
        default: "miuix"
      commit_title:
        description: "æäº¤æ ‡é¢˜"
        required: true
        default: "fs: Bump SuSFS version to v2.0.0"
      commit_description:
        description: "æäº¤æè¿°ï¼ˆå¯é€‰ï¼‰"
        required: false
        default: ""

jobs:
  extract-and-commit:
    runs-on: ubuntu-latest
    steps:
    - name: Parse repository URLs
      id: parse-urls
      run: |
        # è§£ææºä»“åº“URL
        SOURCE_URL="${{ inputs.source_repo_url }}"
        if [[ "$SOURCE_URL" == https://github.com/* ]]; then
          SOURCE_REPO="${SOURCE_URL#https://github.com/}"
          SOURCE_REPO="${SOURCE_REPO%.git}"
        elif [[ "$SOURCE_URL" == git@github.com:* ]]; then
          SOURCE_REPO="${SOURCE_URL#git@github.com:}"
          SOURCE_REPO="${SOURCE_REPO%.git}"
        else
          echo "âŒ Invalid source repository URL: $SOURCE_URL"
          exit 1
        fi
        
        # è§£æç›®æ ‡ä»“åº“URL
        TARGET_URL="${{ inputs.target_repo_url }}"
        if [[ "$TARGET_URL" == https://github.com/* ]]; then
          TARGET_REPO="${TARGET_URL#https://github.com/}"
          TARGET_REPO="${TARGET_REPO%.git}"
        elif [[ "$TARGET_URL" == git@github.com:* ]]; then
          TARGET_REPO="${TARGET_URL#git@github.com:}"
          TARGET_REPO="${TARGET_REPO%.git}"
        else
          echo "âŒ Invalid target repository URL: $TARGET_URL"
          exit 1
        fi
        
        echo "source_repo=$SOURCE_REPO" >> $GITHUB_OUTPUT
        echo "target_repo=$TARGET_REPO" >> $GITHUB_OUTPUT
        echo "âœ… Source repo: $SOURCE_REPO"
        echo "âœ… Target repo: $TARGET_REPO"

    - name: Checkout source repository
      uses: actions/checkout@v4
      with:
        repository: ${{ steps.parse-urls.outputs.source_repo }}
        ref: ${{ inputs.source_branch }}
        token: ${{ secrets.Mozi9_PAT }}
        path: source-repo
        fetch-depth: 0

    - name: Checkout target repository (create branch if needed)
      id: checkout-target
      run: |
        # å…ˆå…‹éš†ç›®æ ‡ä»“åº“
        git clone https://${{ secrets.Mozi9_PAT }}@github.com/${{ steps.parse-urls.outputs.target_repo }}.git target-repo
        cd target-repo
        
        # æ£€æŸ¥ç›®æ ‡åˆ†æ”¯æ˜¯å¦å­˜åœ¨
        if git show-ref --verify --quiet refs/heads/${{ inputs.target_branch }}; then
          echo "âœ… Target branch ${{ inputs.target_branch }} exists"
          git checkout ${{ inputs.target_branch }}
        else
          echo "âš ï¸ Target branch ${{ inputs.target_branch }} does not exist, creating new branch"
          # åˆ›å»ºæ–°åˆ†æ”¯ï¼ˆåŸºäºå½“å‰é»˜è®¤åˆ†æ”¯æˆ–ä»å¤´åˆ›å»ºï¼‰
          if git show-ref --verify --quiet refs/heads/main; then
            git checkout -b ${{ inputs.target_branch }} main
          elif git show-ref --verify --quiet refs/heads/master; then
            git checkout -b ${{ inputs.target_branch }} master
          else
            # å¦‚æœæ²¡æœ‰é»˜è®¤åˆ†æ”¯ï¼Œåˆ›å»ºç©ºåˆ†æ”¯
            git checkout --orphan ${{ inputs.target_branch }}
            git rm -rf .
          fi
        fi
        
        echo "âœ… Checked out to target branch: ${{ inputs.target_branch }}"

    - name: Setup Git identity
      run: |
        git config --global user.name "mozi9"
        git config --global user.email "mozi9@users.noreply.github.com"
        echo "Git configured: mozi9 <mozi9@users.noreply.github.com>"

    - name: Resolve short hashes to full hashes
      id: resolve-hashes
      run: |
        cd source-repo
        
        # è§£ææäº¤å“ˆå¸Œ - å¤„ç†çŸ­å“ˆå¸Œå’Œå®Œæ•´å“ˆå¸Œ
        COMMITS=$(echo "${{ inputs.source_commits }}" | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | grep -v '^$')
        RESOLVED_COMMITS=""
        COMMIT_DETAILS=""
        
        echo "ğŸ” Resolving commits: $COMMITS"
        
        for commit in $COMMITS; do
          echo "Processing: $commit"
          
          # è·å–æ‰€æœ‰åŒ¹é…çš„æäº¤å¯¹è±¡
          MATCHING_COMMITS=$(git rev-list --all | grep "^$commit" || echo "")
          MATCH_COUNT=$(echo "$MATCHING_COMMITS" | grep -c . || echo 0)
          
          if [ $MATCH_COUNT -eq 1 ]; then
            # å”¯ä¸€åŒ¹é…ï¼Œä½¿ç”¨è¿™ä¸ªå®Œæ•´å“ˆå¸Œ
            FULL_HASH=$(echo "$MATCHING_COMMITS")
            COMMIT_INFO=$(git show --oneline -s "$FULL_HASH" 2>/dev/null || echo "Unknown commit")
            
            RESOLVED_COMMITS="$RESOLVED_COMMITS$FULL_HASH"$'\n'
            COMMIT_DETAILS="$COMMIT_DETAILS$COMMIT_INFO"$'\n'
            
            echo "âœ… Resolved $commit -> $FULL_HASH"
            echo "   $COMMIT_INFO"
            
          elif [ $MATCH_COUNT -gt 1 ]; then
            # å¤šä¸ªåŒ¹é…ï¼Œæ˜¾ç¤ºé”™è¯¯
            echo "âŒ Error: Short commit ID '$commit' is ambiguous. Matching commits:"
            echo "$MATCHING_COMMITS" | while read hash; do
              git show --oneline -s "$hash" 2>/dev/null || echo "  $hash - Unknown"
            done
            echo "Please use a longer prefix to disambiguate."
            exit 1
          else
            # æ²¡æœ‰åŒ¹é…
            echo "âŒ Error: Cannot resolve commit '$commit'"
            exit 1
          fi
        done
        
        if [ -z "$RESOLVED_COMMITS" ]; then
          echo "âŒ No valid commits found"
          exit 1
        fi
        
        echo "$RESOLVED_COMMITS" | grep -v '^$' > ../resolved_commits.txt
        echo "$COMMIT_DETAILS" | grep -v '^$' > ../commit_details.txt
        
        echo "âœ… Successfully resolved all commits:"
        cat ../commit_details.txt

    - name: Analyze commit changes
      id: analyze-changes
      run: |
        cd source-repo
        
        # åˆ†ææ–‡ä»¶å˜æ›´
        ALL_MODIFIED_FILES=""
        ALL_DELETED_FILES=""
        
        echo "=== Analyzing file changes ==="
        
        for commit in $(cat ../resolved_commits.txt); do
          COMMIT_INFO=$(git show --oneline -s "$commit")
          echo "ğŸ“Š Processing commit: $COMMIT_INFO"
          
          # ä½¿ç”¨å®Œæ•´å“ˆå¸Œåˆ†ææ–‡ä»¶å˜æ›´
          MODIFIED_FILES=$(git show --name-status --format= "$commit" -- | awk '$1 == "A" || $1 == "M" {print $2}' | sort -u)
          DELETED_FILES=$(git show --name-status --format= "$commit" -- | awk '$1 == "D" {print $2}' | sort -u)
          
          if [ -n "$MODIFIED_FILES" ]; then
            FILE_COUNT=$(echo "$MODIFIED_FILES" | wc -l)
            echo "  ğŸ“„ Modified/Added: $FILE_COUNT files"
            ALL_MODIFIED_FILES="$ALL_MODIFIED_FILES"$'\n'"$MODIFIED_FILES"
          fi
          if [ -n "$DELETED_FILES" ]; then
            FILE_COUNT=$(echo "$DELETED_FILES" | wc -l)
            echo "  ğŸ—‘ï¸ Deleted: $FILE_COUNT files"
            ALL_DELETED_FILES="$ALL_DELETED_FILES"$'\n'"$DELETED_FILES"
          fi
        done
        
        # å»é‡æ–‡ä»¶åˆ—è¡¨
        UNIQUE_MODIFIED=$(echo "$ALL_MODIFIED_FILES" | grep -v '^$' | sort -u)
        UNIQUE_DELETED=$(echo "$ALL_DELETED_FILES" | grep -v '^$' | sort -u)
        
        # ä¿å­˜æ–‡ä»¶åˆ—è¡¨
        echo "$UNIQUE_MODIFIED" > ../modified_files.txt
        echo "$UNIQUE_DELETED" > ../deleted_files.txt
        
        # ä¿®å¤ï¼šä½¿ç”¨æ›´å®‰å…¨çš„æ–¹æ³•è®¡ç®—æ–‡ä»¶æ•°é‡
        MOD_COUNT=0
        DEL_COUNT=0
        
        if [ -s ../modified_files.txt ]; then
          MOD_COUNT=$(wc -l < ../modified_files.txt | tr -d ' ')
        fi
        
        if [ -s ../deleted_files.txt ]; then
          DEL_COUNT=$(wc -l < ../deleted_files.txt | tr -d ' ')
        fi
        
        # è®¾ç½®è¾“å‡ºå˜é‡
        echo "modified_files_count=${MOD_COUNT}" >> $GITHUB_OUTPUT
        echo "deleted_files_count=${DEL_COUNT}" >> $GITHUB_OUTPUT
        
        echo "âœ… Analysis complete:"
        echo "   Modified/Added: $MOD_COUNT files"
        echo "   Deleted: $DEL_COUNT files"
        
        # æ˜¾ç¤ºæ‰¾åˆ°çš„æ–‡ä»¶ï¼ˆå‰10ä¸ªï¼‰
        if [ $MOD_COUNT -gt 0 ]; then
          echo "Modified files (first 10):"
          head -10 ../modified_files.txt | while read file; do echo "  - $file"; done
        else
          echo "âš ï¸ No modified files found"
        fi
        if [ $DEL_COUNT -gt 0 ]; then
          echo "Deleted files (first 10):"
          head -10 ../deleted_files.txt | while read file; do echo "  - $file"; done
        else
          echo "â„¹ï¸ No deleted files found"
        fi

    - name: Delete files from target
      id: delete-files
      run: |
        cd target-repo
        
        echo "ğŸ—‘ï¸ Deleting files..."
        DELETED_COUNT=0
        
        if [ -s ../deleted_files.txt ]; then
          while IFS= read -r file; do
            if [ -n "$file" ] && [ -f "$file" ]; then
              # å®‰å…¨æ£€æŸ¥
              if [[ "$file" != / && "$file" != /* && "$file" != .git* && "$file" != "." && "$file" != ".." ]]; then
                echo "  Deleting: $file"
                rm -f "$file"
                DELETED_COUNT=$((DELETED_COUNT + 1))
                
                # å°è¯•åˆ é™¤ç©ºç›®å½•
                dir=$(dirname "$file")
                if [ -d "$dir" ] && [ -z "$(ls -A "$dir" 2>/dev/null)" ]; then
                  rmdir "$dir" 2>/dev/null || true
                fi
              else
                echo "  ğŸš« Skipped (safety): $file"
              fi
            fi
          done < ../deleted_files.txt
        fi
        
        echo "actual_deleted_count=${DELETED_COUNT}" >> $GITHUB_OUTPUT
        echo "âœ… Deleted $DELETED_COUNT files"

    - name: Copy files to target
      id: copy-files
      run: |
        cd source-repo
        
        echo "ğŸ“„ Copying files..."
        COPIED_COUNT=0
        
        if [ -s ../modified_files.txt ]; then
          while IFS= read -r file; do
            if [ -n "$file" ] && [ -f "$file" ]; then
              echo "  Copying: $file"
              mkdir -p "../target-repo/$(dirname "$file")"
              cp "$file" "../target-repo/$file"
              COPIED_COUNT=$((COPIED_COUNT + 1))
            else
              echo "  âš ï¸ Source file not found: $file"
            fi
          done < ../modified_files.txt
        fi
        
        echo "actual_copied_count=${COPIED_COUNT}" >> $GITHUB_OUTPUT
        echo "âœ… Copied $COPIED_COUNT files"

    - name: Prepare commit message
      id: prepare-commit
      run: |
        # å¤„ç†æäº¤ä¿¡æ¯
        COMMIT_TITLE="${{ inputs.commit_title }}"
        COMMIT_DESC="${{ inputs.commit_description }}"
        
        # è·å–æäº¤è¯¦æƒ…
        COMMIT_DETAILS=""
        if [ -s commit_details.txt ]; then
          COMMIT_DETAILS=$(cat commit_details.txt | head -5)
        fi
        
        # å¦‚æœæ²¡æœ‰æä¾›æè¿°ï¼Œç”Ÿæˆé»˜è®¤æè¿°
        if [ -z "$COMMIT_DESC" ] || [ "$COMMIT_DESC" == "null" ]; then
          COMMIT_DESC="Extracted files from ${{ inputs.source_repo_url }}"
        fi
        
        # æ·»åŠ æ–‡ä»¶ç»Ÿè®¡ä¿¡æ¯å’Œæäº¤è¯¦æƒ…
        FULL_DESC="$COMMIT_DESC\n\nSource commits:\n$COMMIT_DETAILS\n\nFile operations:\n- Copied: ${{ steps.analyze-changes.outputs.modified_files_count }} files\n- Deleted: ${{ steps.analyze-changes.outputs.deleted_files_count }} files\n\nSource: ${{ inputs.source_repo_url }}\nBranch: ${{ inputs.source_branch }}"
        
        echo "commit_title=${COMMIT_TITLE}" >> $GITHUB_OUTPUT
        echo "commit_description=${FULL_DESC}" >> $GITHUB_OUTPUT
        
        echo "=== Commit Message ==="
        echo "Title: $COMMIT_TITLE"
        echo "Description:"
        echo -e "$FULL_DESC"

    - name: Commit and push changes
      id: commit-push
      run: |
        cd target-repo
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
        git add -A
        if git diff --cached --quiet; then
          echo "âŒ No changes to commit"
          echo "has_changes=false" >> $GITHUB_OUTPUT
          exit 1
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "ğŸ’¾ Committing changes..."
          
          # æ˜¾ç¤ºå˜æ›´æ–‡ä»¶
          echo "ğŸ“‹ Changed files:"
          git diff --cached --name-only | while read file; do echo "  - $file"; done
          
          # æäº¤æ›´æ”¹
          git commit -m "${{ steps.prepare-commit.outputs.commit_title }}" -m "${{ steps.prepare-commit.outputs.commit_description }}"
          
          echo "ğŸš€ Pushing to repository..."
          # ä½¿ç”¨å¼ºåˆ¶æ¨é€è¦†ç›–è¿œç¨‹åˆ†æ”¯
          git push -f origin ${{ inputs.target_branch }}
          
          echo "âœ… Successfully committed and pushed changes"
        fi

    - name: Show final result
      run: |
        cat > $GITHUB_STEP_SUMMARY << EOF
        # æ–‡ä»¶å¤„ç†å®Œæˆ
        
        ## ä»“åº“ä¿¡æ¯
        - **æºä»“åº“**: ${{ inputs.source_repo_url }}
        - **ç›®æ ‡ä»“åº“**: ${{ inputs.target_repo_url }}
        - **æºåˆ†æ”¯**: ${{ inputs.source_branch }}
        - **ç›®æ ‡åˆ†æ”¯**: ${{ inputs.target_branch }}
        - **å¤„ç†çš„æäº¤**: ${{ inputs.source_commits }}
        
        ## æ–‡ä»¶æ“ä½œç»Ÿè®¡
        - **åˆ†æå‡ºçš„ä¿®æ”¹æ–‡ä»¶**: ${{ steps.analyze-changes.outputs.modified_files_count }} ä¸ª
        - **åˆ†æå‡ºçš„åˆ é™¤æ–‡ä»¶**: ${{ steps.analyze-changes.outputs.deleted_files_count }} ä¸ª
        - **å®é™…å¤åˆ¶çš„æ–‡ä»¶**: ${{ steps.copy-files.outputs.actual_copied_count }} ä¸ª
        - **å®é™…åˆ é™¤çš„æ–‡ä»¶**: ${{ steps.delete-files.outputs.actual_deleted_count }} ä¸ª
        
        ## æäº¤ä¿¡æ¯
        - **æ ‡é¢˜**: ${{ steps.prepare-commit.outputs.commit_title }}
        
        EOF
        
        if [ "${{ steps.commit-push.outputs.has_changes }}" = "true" ]; then
          echo "âœ… **æ“ä½œæˆåŠŸ**: å·²æäº¤å¹¶æ¨é€æ›´æ”¹åˆ° ${{ inputs.target_branch }}" >> $GITHUB_STEP_SUMMARY
        else
          echo "â„¹ï¸ **æ— å˜æ›´**: æœªæ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´ï¼Œæ— éœ€æäº¤" >> $GITHUB_STEP_SUMMARY
        fi

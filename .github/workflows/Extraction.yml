name: Manual SusFS File Extraction and Commit

on:
  workflow_dispatch:
    inputs:
      source_commits:
        description: "Source commit hashes (short or full, comma separated)"
        required: true
        default: "a5e7449c5f31d4f01377a4ce4e324bec57053e6e"
      source_branch:
        description: "Source branch to get commits from"
        required: true
        default: "susfs-2.0.0"
      target_branch:
        description: "Target branch to push to"
        required: true
        default: "susfs"

env:
  SOURCE_REPO: "YangQi0408/kernel_xiaomi_sm8250_mod"
  TARGET_REPO: "mozi9/XCD"
  COMMIT_AUTHOR: "mozi9"
  COMMIT_EMAIL: "mozi9"
  COMMIT_MESSAGE: "fs: Bump SuSFS version to v2.0.0"
  COMMIT_DESCRIPTION: "https://gitlab.com/simonpunk/susfs4ksu/-/commit/a5e7449c5f31d4f01377a4ce4e324bec57053e6e"

jobs:
  extract-and-commit:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout source repository
      uses: actions/checkout@v4
      with:
        repository: ${{ env.SOURCE_REPO }}
        ref: ${{ inputs.source_branch }}
        token: ${{ secrets.Mozi9_PAT }}
        path: source-repo
        fetch-depth: 0

    - name: Checkout target repository
      uses: actions/checkout@v4
      with:
        repository: ${{ env.TARGET_REPO }}
        ref: ${{ inputs.target_branch }}
        token: ${{ secrets.Mozi9_PAT }}
        path: target-repo
        fetch-depth: 0

    - name: Setup Git identity
      run: |
        git config --global user.name "${{ env.COMMIT_AUTHOR }}"
        git config --global user.email "${{ env.COMMIT_EMAIL }}"

    - name: Resolve commit hashes
      id: resolve-commits
      run: |
        cd source-repo
        
        # æ¸…ç†è¾“å…¥ï¼Œåˆ†å‰²å¤šä¸ªæäº¤å“ˆå¸Œ
        COMMITS=$(echo "${{ inputs.source_commits }}" | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | grep -v '^$')
        
        FULL_HASHES=""
        RESOLVED_COMMITS=""
        
        echo "Input commits: $COMMITS"
        
        # è§£ææ¯ä¸ªæäº¤å“ˆå¸Œ
        for commit in $COMMITS; do
          echo "Processing commit: $commit"
          
          # å°è¯•è·å–å®Œæ•´å“ˆå¸Œ
          FULL_HASH=$(git rev-parse "$commit" 2>/dev/null || echo "")
          
          if [ -n "$FULL_HASH" ]; then
            echo "Resolved $commit -> $FULL_HASH"
            FULL_HASHES="$FULL_HASHES $FULL_HASH"
            RESOLVED_COMMITS="$RESOLVED_COMMITS$FULL_HASH"$'\n'
            
            # è·å–æäº¤ä¿¡æ¯ç”¨äºéªŒè¯
            COMMIT_SUBJECT=$(git show -s --format="%s" $FULL_HASH 2>/dev/null || echo "Unknown commit")
            echo "Commit subject: $COMMIT_SUBJECT"
          else
            echo "âŒ Error: Cannot resolve commit $commit"
            exit 1
          fi
          echo "---"
        done
        
        # ä¿å­˜è§£æåçš„æäº¤å“ˆå¸Œ
        FULL_HASHES=$(echo $FULL_HASHES | sed 's/^ *//;s/ *$//')
        echo "full_hashes=$FULL_HASHES" >> $GITHUB_OUTPUT
        
        # ä¿å­˜åˆ°æ–‡ä»¶ä¾›åç»­æ­¥éª¤ä½¿ç”¨
        echo "$RESOLVED_COMMITS" | grep -v '^$' > ../resolved_commits.txt
        
        echo "âœ… Resolved commits: $FULL_HASHES"

    - name: Analyze file changes from commits
      id: analyze-files
      run: |
        cd source-repo
        
        # è¯»å–è§£æåçš„æäº¤åˆ—è¡¨
        COMMITS=$(cat ../resolved_commits.txt)
        
        ALL_MODIFIED_FILES=""
        ALL_DELETED_FILES=""
        COMMIT_INFO=""
        
        # ç»Ÿè®¡å˜é‡
        TOTAL_FILES_FOUND=0
        DUPLICATE_COUNT=0
        UNIQUE_FILE_COUNT=0
        
        echo "=== Analyzing file changes from commits ==="
        
        # å¤„ç†æ¯ä¸ªæäº¤ï¼Œåªåˆ†ææ–‡ä»¶ä¿¡æ¯ï¼Œä¸å¤åˆ¶æ–‡ä»¶
        for commit in $COMMITS; do
          echo "=== Analyzing commit: $commit ==="
          
          # è·å–æäº¤ä¿¡æ¯
          COMMIT_SUBJECT=$(git show -s --format="%s" $commit)
          COMMIT_DATE=$(git show -s --format="%ci" $commit)
          echo "Subject: $COMMIT_SUBJECT"
          echo "Date: $COMMIT_DATE"
          
          # è·å–è¯¥æäº¤ä¸­çš„æ–‡ä»¶å˜æ›´
          MODIFIED_FILES=$(git show --name-status --format= $commit | awk '$1 == "A" || $1 == "M" {print $2}' | sort -u)
          DELETED_FILES=$(git show --name-status --format= $commit | awk '$1 == "D" {print $2}' | sort -u)
          
          # ç»Ÿè®¡æ–‡ä»¶æ•°é‡
          MOD_COUNT=$(echo "$MODIFIED_FILES" | grep -c . || true)
          DEL_COUNT=$(echo "$DELETED_FILES" | grep -c . || true)
          TOTAL_FILES_FOUND=$((TOTAL_FILES_FOUND + MOD_COUNT))
          
          echo "Modified/Added files: $MOD_COUNT"
          echo "Deleted files: $DEL_COUNT"
          echo "Files: $(echo $MODIFIED_FILES | tr '\n' ' ')"
          
          # ç´¯ç§¯æ–‡ä»¶åˆ—è¡¨
          if [ -n "$MODIFIED_FILES" ]; then
            ALL_MODIFIED_FILES="$ALL_MODIFIED_FILES"$'\n'"$MODIFIED_FILES"
          fi
          
          if [ -n "$DELETED_FILES" ]; then
            ALL_DELETED_FILES="$ALL_DELETED_FILES"$'\n'"$DELETED_FILES"
          fi
          
          # è®°å½•æäº¤ä¿¡æ¯
          COMMIT_INFO="${COMMIT_INFO}Commit: $commit"$'\n'
          COMMIT_INFO="${COMMIT_INFO}Subject: $COMMIT_SUBJECT"$'\n'
          COMMIT_INFO="${COMMIT_INFO}Date: $COMMIT_DATE"$'\n'
          COMMIT_INFO="${COMMIT_INFO}Modified: $MOD_COUNT files"$'\n'
          COMMIT_INFO="${COMMIT_INFO}Deleted: $DEL_COUNT files"$'\n'$'\n'
          
          echo "---"
        done
        
        # å»é‡æ–‡ä»¶åˆ—è¡¨å¹¶ç»Ÿè®¡
        UNIQUE_MODIFIED=$(echo "$ALL_MODIFIED_FILES" | grep -v '^$' | sort -u)
        UNIQUE_DELETED=$(echo "$ALL_DELETED_FILES" | grep -v '^$' | sort -u)
        
        UNIQUE_FILE_COUNT=$(echo "$UNIQUE_MODIFIED" | grep -c . || true)
        DELETED_FILE_COUNT=$(echo "$UNIQUE_DELETED" | grep -c . || true)
        DUPLICATE_COUNT=$((TOTAL_FILES_FOUND - UNIQUE_FILE_COUNT))
        
        # è¾“å‡ºç»Ÿè®¡ä¿¡æ¯
        echo "=== File Analysis Summary ==="
        echo "ğŸ“Š Total files found in commits: $TOTAL_FILES_FOUND"
        echo "ğŸ”„ Duplicate files removed: $DUPLICATE_COUNT"
        echo "âœ… Unique files to process: $UNIQUE_FILE_COUNT"
        echo "ğŸ—‘ï¸ Deleted files recorded: $DELETED_FILE_COUNT"
        echo "ğŸ“ Final files to copy: $UNIQUE_FILE_COUNT"
        
        # ä¿å­˜åˆ°è¾“å‡ºå˜é‡
        echo "total_files=$TOTAL_FILES_FOUND" >> $GITHUB_OUTPUT
        echo "duplicate_files=$DUPLICATE_COUNT" >> $GITHUB_OUTPUT
        echo "unique_files=$UNIQUE_FILE_COUNT" >> $GITHUB_OUTPUT
        echo "deleted_files_count=$DELETED_FILE_COUNT" >> $GITHUB_OUTPUT
        echo "modified_files=$(echo "$UNIQUE_MODIFIED" | tr '\n' ' ')" >> $GITHUB_OUTPUT
        echo "deleted_files=$(echo "$UNIQUE_DELETED" | tr '\n' ' ')" >> $GITHUB_OUTPUT
        
        # ä¿å­˜æ–‡ä»¶åˆ—è¡¨
        echo "$UNIQUE_MODIFIED" > ../modified_files.txt
        echo "$UNIQUE_DELETED" > ../deleted_files.txt
        echo "$COMMIT_INFO" > ../commit_info.txt
        
        # ä¿å­˜æ¯ä¸ªæäº¤çš„åˆ é™¤æ–‡ä»¶ä¿¡æ¯
        for commit in $COMMITS; do
          COMMIT_SUBJECT=$(git show -s --format="%s" $commit)
          COMMIT_DELETED=$(git show --name-status --format= $commit 2>/dev/null | awk '$1 == "D" {print $2}' | sort -u | tr '\n' ' ')
          if [ -n "$COMMIT_DELETED" ]; then
            echo "COMMIT:$commit" >> ../deleted_files_by_commit.txt
            echo "SUBJECT:$COMMIT_SUBJECT" >> ../deleted_files_by_commit.txt
            echo "FILES:$COMMIT_DELETED" >> ../deleted_files_by_commit.txt
            echo "---" >> ../deleted_files_by_commit.txt
          fi
        done

    - name: Copy files from source repository (latest state)
      id: copy-files
      run: |
        cd source-repo
        
        # ç¡®ä¿åœ¨æœ€æ–°çŠ¶æ€ï¼ˆå½“å‰åˆ†æ”¯çš„æœ€æ–°æäº¤ï¼‰
        git checkout ${{ inputs.source_branch }} --quiet
        echo "Using latest state of branch: ${{ inputs.source_branch }}"
        
        # åˆ›å»ºä¸´æ—¶ç›®å½•ç”¨äºæ‰“åŒ…æ–‡ä»¶
        mkdir -p ../file-package
        
        # ä»æœ€æ–°æºä»“åº“å¤åˆ¶æ–‡ä»¶
        if [ -s ../modified_files.txt ]; then
          echo "=== Copying files from latest source repository ==="
          COPIED_COUNT=0
          MISSING_COUNT=0
          
          while IFS= read -r file; do
            if [ -n "$file" ] && [ -f "$file" ]; then
              echo "ğŸ“„ Copying: $file"
              mkdir -p "../file-package/$(dirname "$file")"
              cp "$file" "../file-package/$file"
              COPIED_COUNT=$((COPIED_COUNT + 1))
            elif [ -n "$file" ] && [ ! -f "$file" ]; then
              echo "âš ï¸ Warning: File not found in latest source: $file"
              MISSING_COUNT=$((MISSING_COUNT + 1))
            fi
          done < ../modified_files.txt
          
          echo "=== Copy Summary ==="
          echo "âœ… Successfully copied: $COPIED_COUNT files"
          echo "âŒ Files not found: $MISSING_COUNT files"
          echo "ğŸ“Š Expected total: ${{ steps.analyze-files.outputs.unique_files }} files"
        else
          echo "No files to copy"
        fi
        
        # åˆ›å»ºåˆ é™¤æ–‡ä»¶è®°å½•
        if [ -s ../deleted_files_by_commit.txt ]; then
          echo "=== Creating deleted files record ==="
          echo "# Deleted Files Record" > ../file-package/DELETED_FILES.md
          echo "" >> ../file-package/DELETED_FILES.md
          echo "The following files were deleted in the analyzed commits:" >> ../file-package/DELETED_FILES.md
          echo "" >> ../file-package/DELETED_FILES.md
          
          CURRENT_COMMIT=""
          CURRENT_SUBJECT=""
          
          while IFS= read -r line; do
            if [[ "$line" == COMMIT:* ]]; then
              CURRENT_COMMIT="${line#COMMIT:}"
            elif [[ "$line" == SUBJECT:* ]]; then
              CURRENT_SUBJECT="${line#SUBJECT:}"
            elif [[ "$line" == FILES:* ]]; then
              FILES="${line#FILES:}"
              if [ -n "$CURRENT_COMMIT" ] && [ -n "$FILES" ]; then
                echo "## $CURRENT_COMMIT ($CURRENT_SUBJECT)" >> ../file-package/DELETED_FILES.md
                echo "$FILES" | tr ' ' '\n' | grep -v '^$' | sed 's/^/- /' >> ../file-package/DELETED_FILES.md
                echo "" >> ../file-package/DELETED_FILES.md
              fi
            fi
          done < ../deleted_files_by_commit.txt
        fi
        
        # åˆ›å»ºæäº¤ä¿¡æ¯æ–‡ä»¶
        cat > ../file-package/COMMIT_INFO.md << EOF
        # File Extraction Information
        
        ## Source Commits Analyzed
        - Repository: ${{ env.SOURCE_REPO }}
        - Branch: ${{ inputs.source_branch }}
        - Commits processed: $(cat ../resolved_commits.txt | wc -l)
        
        ## File Statistics
        - Total files found in commits: ${{ steps.analyze-files.outputs.total_files }}
        - Duplicate files removed: ${{ steps.analyze-files.outputs.duplicate_files }}
        - Unique files processed: ${{ steps.analyze-files.outputs.unique_files }}
        - Deleted files recorded: ${{ steps.analyze-files.outputs.deleted_files_count }}
        
        ## Extraction Details
        - Extraction date: $(date)
        - Target commit message: ${{ env.COMMIT_MESSAGE }}
        EOF

    - name: Copy package to target repository
      run: |
        # å¤åˆ¶æ‰“åŒ…çš„æ–‡ä»¶åˆ°ç›®æ ‡ä»“åº“
        if [ -d "../file-package" ] && [ -n "$(ls -A ../file-package 2>/dev/null)" ]; then
          echo "Copying files to target repository..."
          cp -r ../file-package/* target-repo/
          
          echo "=== Files structure in target repo ==="
          find target-repo -type f -not -path '*/\.git/*' | while read file; do
            echo "  ğŸ“„ $file"
          done | head -20
        else
          echo "No files to copy"
        fi

    - name: Delete files from target repository based on deletion info
      id: delete-files
      run: |
        cd target-repo
        
        echo "=== Processing file deletions from source commits ==="
        
        DELETED_COUNT=0
        NOT_FOUND_COUNT=0
        SKIPPED_COUNT=0
        
        # æ£€æŸ¥æ˜¯å¦æœ‰åˆ é™¤æ–‡ä»¶éœ€è¦å¤„ç†
        if [ -s ../deleted_files.txt ]; then
          echo "Files marked for deletion in source commits:"
          cat ../deleted_files.txt
          echo ""
          
          # å¤„ç†æ¯ä¸ªè¦åˆ é™¤çš„æ–‡ä»¶
          while IFS= read -r file; do
            if [ -n "$file" ]; then
              if [ -f "$file" ]; then
                # å®‰å…¨åˆ é™¤ï¼šå…ˆæ£€æŸ¥æ–‡ä»¶æ˜¯å¦åœ¨ç›®æ ‡ä»“åº“ä¸­å­˜åœ¨ä¸”ä¸æ˜¯å…³é”®æ–‡ä»¶
                if [[ "$file" == / || "$file" == /* || "$file" == .* || "$file" == "." || "$file" == ".." ]]; then
                  echo "ğŸš« SKIPPED: Safety check failed for '$file' - potentially dangerous path"
                  SKIPPED_COUNT=$((SKIPPED_COUNT + 1))
                elif [[ "$file" == *.git* ]]; then
                  echo "ğŸš« SKIPPED: Skipping Git directory/file '$file'"
                  SKIPPED_COUNT=$((SKIPPED_COUNT + 1))
                else
                  echo "ğŸ—‘ï¸ DELETING: $file"
                  rm -f "$file"
                  DELETED_COUNT=$((DELETED_COUNT + 1))
                  
                  # å°è¯•åˆ é™¤ç©ºç›®å½•
                  dir=$(dirname "$file")
                  if [ -d "$dir" ] && [ -z "$(ls -A "$dir" 2>/dev/null)" ]; then
                    rmdir "$dir" 2>/dev/null && echo "  ğŸ“ Removed empty directory: $dir" || true
                  fi
                fi
              else
                echo "â„¹ï¸ NOT FOUND: $file (not in target repository)"
                NOT_FOUND_COUNT=$((NOT_FOUND_COUNT + 1))
              fi
            fi
          done < ../deleted_files.txt
        else
          echo "No files to delete (empty deletion list)"
        fi
        
        echo "=== Deletion Summary ==="
        echo "âœ… Successfully deleted: $DELETED_COUNT files"
        echo "â„¹ï¸ Not found in target: $NOT_FOUND_COUNT files"
        echo "ğŸš« Skipped (safety): $SKIPPED_COUNT files"
        echo "ğŸ“Š Total processed: $((DELETED_COUNT + NOT_FOUND_COUNT + SKIPPED_COUNT)) files"
        
        # ä¿å­˜ç»Ÿè®¡ä¿¡æ¯
        echo "deleted_count=$DELETED_COUNT" >> $GITHUB_OUTPUT
        echo "not_found_count=$NOT_FOUND_COUNT" >> $GITHUB_OUTPUT
        echo "skipped_count=$SKIPPED_COUNT" >> $GITHUB_OUTPUT

    - name: Commit package to target repository
      id: commit-package
      run: |
        cd target-repo
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜æ›´ï¼ˆåŒ…æ‹¬åˆ é™¤ï¼‰
        if git diff --quiet && git diff --cached --quiet; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "No changes to commit"
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
          
          # æ·»åŠ æ‰€æœ‰å˜æ›´ï¼ˆåŒ…æ‹¬åˆ é™¤çš„æ–‡ä»¶ï¼‰
          git add -A -f
          
          # åˆ›å»ºè¯¦ç»†çš„æäº¤ä¿¡æ¯
          COMMIT_LIST=$(cat ../resolved_commits.txt | tr '\n' ' ')
          
          git commit -m "${{ env.COMMIT_MESSAGE }}" \
            -m "${{ env.COMMIT_DESCRIPTION }}" \
            -m "" \
            -m "Files analyzed from commits: $COMMIT_LIST" \
            -m "Source repository: ${{ env.SOURCE_REPO }}@${{ inputs.source_branch }}" \
            -m "File statistics:" \
            -m "- Total found: ${{ steps.analyze-files.outputs.total_files }} files" \
            -m "- Duplicates removed: ${{ steps.analyze-files.outputs.duplicate_files }} files" \
            -m "- Files added/modified: ${{ steps.analyze-files.outputs.unique_files }} files" \
            -m "- Files deleted from target: ${{ steps.delete-files.outputs.deleted_count }} files" \
            -m "- Files not found for deletion: ${{ steps.delete-files.outputs.not_found_count }} files" \
            -m "- Files skipped (safety): ${{ steps.delete-files.outputs.skipped_count }} files" \
            -m "" \
            -m "Note: File operations based on source commit analysis."
          
          echo "âœ… Commit created successfully"
        fi

    - name: Force push to target repository (overwrite conflicts)
      if: steps.commit-package.outputs.has_changes == 'true'
      run: |
        cd target-repo
        
        # å¼ºåˆ¶æ¨é€ï¼Œç”¨æºæ–‡ä»¶è¦†ç›–ä»»ä½•å†²çª
        echo "Pushing changes to target repository (force if necessary)..."
        
        # å…ˆå°è¯•æ­£å¸¸æ¨é€
        if git push origin ${{ inputs.target_branch }}; then
          echo "âœ… Changes pushed successfully"
        else
          echo "âš ï¸ Normal push failed, attempting force push..."
          # å¦‚æœæ­£å¸¸æ¨é€å¤±è´¥ï¼Œå¼ºåˆ¶æ¨é€ï¼ˆç”¨æºæ–‡ä»¶è¦†ç›–ï¼‰
          git push --force-with-lease origin ${{ inputs.target_branch }}
          echo "âœ… Changes force-pushed successfully (source files overwrote conflicts)"
        fi

    - name: Generate workflow summary
      run: |
        COMMIT_COUNT=$(cat ../resolved_commits.txt | wc -l)
        MODIFIED_COUNT=${{ steps.analyze-files.outputs.unique_files }}
        DELETED_COUNT=${{ steps.delete-files.outputs.deleted_count }}
        NOT_FOUND_COUNT=${{ steps.delete-files.outputs.not_found_count }}
        SKIPPED_COUNT=${{ steps.delete-files.outputs.skipped_count }}
        TOTAL_FOUND=${{ steps.analyze-files.outputs.total_files }}
        DUPLICATES=${{ steps.analyze-files.outputs.duplicate_files }}
        
        cat > $GITHUB_STEP_SUMMARY << EOF
        # File Extraction and Deletion Summary
        
        ## ğŸ“Š File Statistics
        | Metric | Count |
        |--------|-------|
        | Commits analyzed | $COMMIT_COUNT |
        | Total files found | $TOTAL_FOUND |
        | Duplicate files removed | $DUPLICATES |
        | Unique files processed | $MODIFIED_COUNT |
        | Files deleted from target | $DELETED_COUNT |
        | Files not found for deletion | $NOT_FOUND_COUNT |
        | Files skipped (safety) | $SKIPPED_COUNT |
        
        ## ğŸ”„ Processing Summary
        - **Files found in commits**: $TOTAL_FOUND
        - **After deduplication**: $MODIFIED_COUNT files copied
        - **Files deleted from target**: $DELETED_COUNT
        - **Safety checks**: $SKIPPED_COUNT files skipped
        
        ## âš¡ File Operations
        ### âœ… Added/Modified
        - Copied $MODIFIED_COUNT files from source repository
        - Source files overwrite target files in case of conflicts
        
        ### ğŸ—‘ï¸ Deleted (Safe Deletion)
        - Deleted $DELETED_COUNT files that were removed in source commits
        - $NOT_FOUND_COUNT files not found in target (safe to ignore)
        - $SKIPPED_COUNT files skipped due to safety checks
        - **No recursive directory deletion** - only specific files
        
        ## ğŸ“‹ Processed Commits
        \`\`\`
        $(cat ../resolved_commits.txt | sed 's/^/â€¢ /')
        \`\`\`
        
        ## ğŸ”’ Safety Features
        - Path safety checks prevent accidental deletion
        - Git directories and system paths are protected
        - Only specific files are deleted, not entire directories
        - Empty directories are cleaned up after file deletion
        
        ## Result
        EOF
        
        if [ "${{ steps.commit-package.outputs.has_changes }}" = "true" ]; then
          echo "âœ… **SUCCESS**: Processed $COMMIT_COUNT commit(s)" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“¥ Added/Modified: $MODIFIED_COUNT files" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“¤ Deleted: $DELETED_COUNT files" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ”’ Safe operation: No recursive deletion" >> $GITHUB_STEP_SUMMARY
        else
          echo "â„¹ï¸ No changes were made (files already exist)" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Archive artifacts
      uses: actions/upload-artifact@v4
      with:
        name: extraction-artifacts-${{ github.run_id }}
        path: |
          file-package/
          resolved_commits.txt
          modified_files.txt
          deleted_files.txt
          deleted_files_by_commit.txt
          commit_info.txt
        retention-days: 7

name: Correct File Sync

on:
  workflow_dispatch:
    inputs:
      commit_urls:
        description: "GitHubæäº¤é“¾æ¥"
        required: true
        default: "https://github.com/android16-aptusit/kernel_xiaomi_sm8250_mod/commit/47b6de7"
      target_repo:
        description: "ç›®æ ‡ä»“åº“"
        required: true
        default: "mozi9/XCD"
      target_branch:
        description: "ç›®æ ‡åˆ†æ”¯"
        required: true
        default: "miuix"
      commit_title:
        description: "æäº¤æ ‡é¢˜"
        required: true
        default: "fs: Bump SuSFS version to v2.0.0"

env:
  GIT_USERNAME: "mozi9"
  GIT_EMAIL: "mozi9@users.noreply.github.com"

jobs:
  correct-file-sync:
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ”§ å®‰è£…å·¥å…·
      run: sudo apt-get install -y jq

    - name: âš™ï¸ é…ç½®Git
      run: |
        git config --global user.name "mozi9"
        git config --global user.email "mozi9@users.noreply.github.com"

    - name: ğŸ“¥ æ£€å‡ºç›®æ ‡ä»“åº“
      uses: actions/checkout@v4
      with:
        repository: ${{ github.event.inputs.target_repo }}
        ref: ${{ github.event.inputs.target_branch }}
        token: ${{ secrets.Mozi9_PAT }}
        path: target-repo

    - name: ğŸ” è§£ææ­£ç¡®çš„ä»“åº“ä¿¡æ¯
      id: parse-repo
      run: |
        echo "=== ä½¿ç”¨æ­£ç¡®çš„ä»“åº“ä¿¡æ¯ ==="
        
        # ä»å›¾ç‰‡ä¸­è·å–æ­£ç¡®çš„ä»“åº“ä¿¡æ¯
        SOURCE_REPO="android16-aptusit/kernel_xiaomi_sm8250_mod"
        COMMIT_HASH="47b6de7"  # æˆ–å…¶ä»–æ­£ç¡®çš„æäº¤å“ˆå¸Œ
        
        echo "æºä»“åº“: $SOURCE_REPO"
        echo "æäº¤: $COMMIT_HASH"
        
        echo "source_repo=$SOURCE_REPO" >> $GITHUB_OUTPUT
        echo "commit_hash=$COMMIT_HASH" >> $GITHUB_OUTPUT

    - name: ğŸ“¥ å…‹éš†æ­£ç¡®çš„æºä»“åº“
      id: clone-source
      run: |
        SOURCE_REPO="${{ steps.parse-repo.outputs.source_repo }}"
        COMMIT_HASH="${{ steps.parse-repo.outputs.commit_hash }}"
        
        echo "å…‹éš†ä»“åº“: $SOURCE_REPO"
        echo "æ£€å‡ºæäº¤: $COMMIT_HASH"
        
        # å…‹éš†æºä»“åº“
        git clone --depth 1 "https://github.com/$SOURCE_REPO.git" source-repo
        cd source-repo
        git checkout "$COMMIT_HASH"
        
        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        echo "=== æ£€æŸ¥æ–‡ä»¶å­˜åœ¨æ€§ ==="
        
        # æ£€æŸ¥å·²çŸ¥å­˜åœ¨çš„æ–‡ä»¶
        CHECK_FILES=(
          "include/linux/sched.h.orig"
          "fs/dcache.c.orig"
          "fs/namei.c.orig"
          "fs/namespace.c.orig"
          "fs/proc/base.c.orig"
          "fs/proc/fd.c.orig"
          "fs/proc/task_mmu.c.orig"
          "fs/sus_su.c"
          "fs/susfs.c"
          "include/linux/sus_su.h"
          "include/linux/susfs.h"
          "include/linux/susfs_def.h"
          "kernel/kallsyms.c.orig"
          "kernel/sys.c.orig"
        )
        
        for file in "${CHECK_FILES[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… æ–‡ä»¶å­˜åœ¨: $file"
            echo "$file" >> existing_files.txt
          else
            echo "âŒ æ–‡ä»¶ä¸å­˜åœ¨: $file"
            echo "$file" >> missing_files.txt
          fi
        done

    - name: ğŸ“‹ è·å–æäº¤ä¸­çš„æ–‡ä»¶åˆ—è¡¨
      id: get-commit-files
      run: |
        SOURCE_REPO="${{ steps.parse-repo.outputs.source_repo }}"
        COMMIT_HASH="${{ steps.parse-repo.outputs.commit_hash }}"
        
        echo "è·å–æäº¤ $COMMIT_HASH çš„æ–‡ä»¶å˜æ›´..."
        
        # è·å–æäº¤è¯¦æƒ…
        commit_url="https://api.github.com/repos/$SOURCE_REPO/commits/$COMMIT_HASH"
        commit_response=$(curl -s -H "Accept: application/vnd.github.v3+json" "$commit_url")
        
        # æå–æ‰€æœ‰æ–‡ä»¶
        echo "$commit_response" | jq -r '.files[].filename' > all_commit_files.txt
        
        echo "æäº¤ä¸­çš„æ–‡ä»¶:"
        cat all_commit_files.txt

    - name: ğŸ”„ åŒæ­¥æ‰€æœ‰æ–‡ä»¶
      id: sync-all-files
      run: |
        echo "=== åŒæ­¥æ–‡ä»¶ ==="
        
        # å¤åˆ¶æ‰€æœ‰åœ¨æºä»“åº“ä¸­å­˜åœ¨çš„æ–‡ä»¶
        copied_count=0
        missing_count=0
        
        if [ -s all_commit_files.txt ]; then
          while IFS= read -r file; do
            if [ -f "source-repo/$file" ]; then
              # åˆ›å»ºç›®å½•å¹¶å¤åˆ¶æ–‡ä»¶
              mkdir -p "target-repo/$(dirname "$file")"
              cp "source-repo/$file" "target-repo/$file"
              copied_count=$((copied_count + 1))
              echo "âœ… å¤åˆ¶: $file"
            else
              missing_count=$((missing_count + 1))
              echo "âŒ æºæ–‡ä»¶ä¸å­˜åœ¨: $file"
            fi
          done < all_commit_files.txt
        fi
        
        echo "copied_count=$copied_count" >> $GITHUB_OUTPUT
        echo "missing_count=$missing_count" >> $GITHUB_OUTPUT

    - name: ğŸ’¾ æäº¤å˜æ›´
      run: |
        cd target-repo
        
        if ! git diff-index --quiet HEAD --; then
          git add -A
          git commit -m "${{ github.event.inputs.commit_title }}"
          git push origin "${{ github.event.inputs.target_branch }}"
          echo "âœ… å˜æ›´å·²æäº¤"
        else
          echo "â„¹ï¸ æ— å˜æ›´å¯æäº¤"
        fi

    - name: ğŸ“Š ç”Ÿæˆå‡†ç¡®æŠ¥å‘Š
      run: |
        cat > "$GITHUB_STEP_SUMMARY" << EOF
        # å‡†ç¡®æ–‡ä»¶åŒæ­¥æŠ¥å‘Š
        
        ## æ–‡ä»¶å­˜åœ¨æ€§æ£€æŸ¥
        EOF
        
        if [ -f existing_files.txt ]; then
          echo "### âœ… å®é™…å­˜åœ¨çš„æ–‡ä»¶ ($(wc -l < existing_files.txt) ä¸ª)" >> "$GITHUB_STEP_SUMMARY"
          cat existing_files.txt >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
        fi
        
        if [ -f missing_files.txt ]; then
          echo "### âŒ ä¸å­˜åœ¨çš„æ–‡ä»¶ ($(wc -l < missing_files.txt) ä¸ª)" >> "$GITHUB_STEP_SUMMARY"
          cat missing_files.txt >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
        fi
        
        cat >> "$GITHUB_STEP_SUMMARY" << EOF
        ## åŒæ­¥ç»“æœ
        - **æˆåŠŸå¤åˆ¶**: ${{ steps.sync-all-files.outputs.copied_count }} ä¸ªæ–‡ä»¶
        - **ç¼ºå¤±æ–‡ä»¶**: ${{ steps.sync-all-files.outputs.missing_count }} ä¸ªæ–‡ä»¶
        
        ## é—®é¢˜è§£å†³
        ä½¿ç”¨æ­£ç¡®çš„ä»“åº“è·¯å¾„: \`android16-aptusit/kernel_xiaomi_sm8250_mod\`
        EOF

name: Manual Repository Sync - Cherry-pick with Mozi9 Identity

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: 'æºä»“åº“åœ°å€ (æ ¼å¼: owner/repo)'
        required: true
        default: 'owner/source-repo'
      target_repo:
        description: 'ç›®æ ‡ä»“åº“åœ°å€ (æ ¼å¼: owner/repo)'
        required: true
        default: 'owner/target-repo'
      source_branch:
        description: 'æºåˆ†æ”¯å'
        required: true
        default: 'main'
      target_branch:
        description: 'ç›®æ ‡åˆ†æ”¯å'
        required: true
        default: 'main'
      commit_hashes:
        description: 'è¦åŒæ­¥çš„æäº¤å“ˆå¸Œï¼ˆå¤šä¸ªç”¨é€—å·åˆ†éš”ï¼‰'
        required: true
        default: '75fef37dde7c3cbcde63ae7542f115fb04d9ee70,fa957cbe93c6260f4968cf3d01ec3974bcd49ff8,5a3d762db366d870e8959c143dc7037c51450675'
      max_commits:
        description: 'æœ€å¤§åŒæ­¥æäº¤æ•°é‡'
        required: true
        default: '50'

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  sync-repository:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout target repository
      uses: actions/checkout@v4
      with:
        repository: ${{ github.event.inputs.target_repo }}
        token: ${{ secrets.Mozi9_PAT }}
        ref: ${{ github.event.inputs.target_branch }}
        fetch-depth: 0

    - name: Add source repository as remote
      run: |
        git remote add source-repo https://github.com/${{ github.event.inputs.source_repo }}.git
        git fetch source-repo ${{ github.event.inputs.source_branch }} --depth=100

    - name: Setup Git config for Mozi9
      run: |
        git config --global user.name "mozi9"
        git config --global user.email "mozi9"

    - name: Parse and validate commit hashes
      id: parse_commits
      run: |
          # æ¸…ç†è¾“å…¥ï¼Œç§»é™¤ç©ºæ ¼å’Œæ¢è¡Œ
          CLEAN_HASHES=$(echo '${{ github.event.inputs.commit_hashes }}' | tr -d '[:space:]' | tr ',' '\n' | grep -v '^$')
          
          # éªŒè¯æ¯ä¸ªæäº¤å“ˆå¸Œæ˜¯å¦å­˜åœ¨
          VALID_COMMITS=""
          INVALID_COMMITS=""
          COMMIT_COUNT=0
          
          for hash in $CLEAN_HASHES; do
            if git rev-parse $hash >/dev/null 2>&1; then
              VALID_COMMITS="$VALID_COMMITS$hash"$'\n'
              COMMIT_COUNT=$((COMMIT_COUNT + 1))
              echo "âœ… æäº¤æœ‰æ•ˆ: $hash - $(git log -1 --format="%s" $hash 2>/dev/null || echo 'æ— æ³•è·å–æäº¤ä¿¡æ¯')"
            else
              INVALID_COMMITS="$INVALID_COMMITS$hash"$'\n'
              echo "âŒ æäº¤æ— æ•ˆ: $hash"
            fi
          done
          
          if [ $COMMIT_COUNT -eq 0 ]; then
            echo "é”™è¯¯: æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„æäº¤å“ˆå¸Œ"
            exit 1
          fi
          
          # é™åˆ¶æäº¤æ•°é‡
          MAX_COMMITS=${{ github.event.inputs.max_commits }}
          if [ $COMMIT_COUNT -gt $MAX_COMMITS ]; then
            echo "è­¦å‘Š: æäº¤æ•°é‡ $COMMIT_COUNT è¶…è¿‡æœ€å¤§é™åˆ¶ $MAX_COMMITSï¼Œå°†åªå¤„ç†å‰ $MAX_COMMITS ä¸ªæäº¤"
            VALID_COMMITS=$(echo "$VALID_COMMITS" | head -n $MAX_COMMITS)
            COMMIT_COUNT=$MAX_COMMITS
          fi
          
          # ä¿å­˜æœ‰æ•ˆæäº¤åˆ°æ–‡ä»¶
          echo "$VALID_COMMITS" > /tmp/valid_commits.txt
          echo "æ‰¾åˆ° $COMMIT_COUNT ä¸ªæœ‰æ•ˆæäº¤"
          
          # è¾“å‡ºæ— æ•ˆæäº¤ï¼ˆå¦‚æœæœ‰ï¼‰
          if [ -n "$INVALID_COMMITS" ]; then
            echo "æ— æ•ˆçš„æäº¤å“ˆå¸Œ:"
            echo "$INVALID_COMMITS"
          fi
          
          echo "commit_count=$COMMIT_COUNT" >> $GITHUB_OUTPUT

    - name: Cherry-pick commits with Mozi9 identity
      run: |
        COMMITS=$(cat /tmp/valid_commits.txt)
        I=1
        TOTAL=${{ steps.parse_commits.outputs.commit_count }}
        
        for COMMIT in $COMMITS; do
          echo "================================================================="
          echo "æ­£åœ¨cherry-pickæäº¤ $I/$TOTAL: $COMMIT"
          
          # è·å–æäº¤ä¿¡æ¯ï¼ˆåªä¿ç•™æäº¤æ¶ˆæ¯ï¼‰
          COMMIT_MESSAGE=$(git log -1 --format=%s $COMMIT 2>/dev/null || echo "mozi9: åŒæ­¥æäº¤")
          echo "æäº¤ä¿¡æ¯: $COMMIT_MESSAGE"
          
          # æ£€æŸ¥æ˜¯å¦å·²ç»cherry-pickè¿‡
          if git log --oneline | grep -q "$COMMIT"; then
            echo "âš ï¸ æäº¤å·²å­˜åœ¨ï¼Œè·³è¿‡"
            I=$((I+1))
            continue
          fi
          
          # å°è¯•cherry-pickï¼Œå†²çªæ—¶ç›´æ¥ä½¿ç”¨æºæäº¤çš„æ–‡ä»¶
          set +e  # å…è®¸é”™è¯¯ç»§ç»­æ‰§è¡Œ
          if git cherry-pick $COMMIT --strategy=recursive -X theirs --allow-empty --keep-redundant-commits; then
            echo "âœ… cherry-pickæˆåŠŸ"
          else
            echo "âš ï¸ æ£€æµ‹åˆ°å†²çªï¼Œä½¿ç”¨æºæäº¤æ–‡ä»¶è§£å†³..."
            
            # æ£€æŸ¥æ˜¯å¦æœ‰æœªè§£å†³çš„å†²çª
            CONFLICT_FILES=$(git diff --name-only --diff-filter=U 2>/dev/null || true)
            if [ -n "$CONFLICT_FILES" ]; then
              echo "å†²çªæ–‡ä»¶: $CONFLICT_FILES"
              
              # ä½¿ç”¨æºæäº¤çš„æ–‡ä»¶è¦†ç›–æ‰€æœ‰å†²çªæ–‡ä»¶
              for file in $CONFLICT_FILES; do
                echo "è§£å†³å†²çª: $file"
                # ä½¿ç”¨æºæäº¤çš„æ–‡ä»¶è¦†ç›–
                git show $COMMIT:"$file" > "$file" 2>/dev/null || echo "æ— æ³•æ¢å¤æ–‡ä»¶: $file"
              done
              
              # æ·»åŠ è§£å†³åçš„æ–‡ä»¶
              git add .
            fi
            
            # ç»§ç»­cherry-pick
            git cherry-pick --continue
            echo "âœ… å†²çªå·²è§£å†³ï¼Œcherry-pickå®Œæˆ"
          fi
          set -e  # æ¢å¤é”™è¯¯é€€å‡º
          
          # ä¿®æ”¹æäº¤ä½œè€…ä¿¡æ¯ä¸ºmozi9
          git commit --amend --author="mozi9 <mozi9>" -m "$COMMIT_MESSAGE" --allow-empty
          
          echo "âœ… å·²å®Œæˆcherry-pick $I/$TOTAL"
          I=$((I+1))
        done

    - name: Process file changes
      run: |
        echo "å¤„ç†æ–‡ä»¶å˜æ›´..."
        COMMITS=$(cat /tmp/valid_commits.txt)
        
        # å¤„ç†æ¯ä¸ªæäº¤çš„æ–‡ä»¶å˜æ›´
        for COMMIT in $COMMITS; do
          echo "å¤„ç†æäº¤ $COMMIT çš„æ–‡ä»¶å˜æ›´..."
          
          # è·å–è¯¥æäº¤ä¸­åˆ é™¤çš„æ–‡ä»¶
          DELETED_FILES=$(git show $COMMIT --name-only --diff-filter=D --format= 2>/dev/null || true)
          if [ -n "$DELETED_FILES" ]; then
            echo "æäº¤ä¸­åˆ é™¤çš„æ–‡ä»¶:"
            echo "$DELETED_FILES"
            for file in $DELETED_FILES; do
              if [ -f "$file" ] || [ -d "$file" ]; then
                echo "åˆ é™¤æ–‡ä»¶: $file"
                rm -rf "$file"
                git add "$file" 2>/dev/null || true
              else
                echo "æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå¿½ç•¥åˆ é™¤: $file"
              fi
            done
          fi
          
          # è·å–è¯¥æäº¤ä¸­æ–°å¢/ä¿®æ”¹çš„æ–‡ä»¶å¹¶ç¡®ä¿å­˜åœ¨
          ADDED_MODIFIED_FILES=$(git show $COMMIT --name-only --diff-filter=AM --format= 2>/dev/null || true)
          if [ -n "$ADDED_MODIFIED_FILES" ]; then
            echo "æäº¤ä¸­æ–°å¢/ä¿®æ”¹çš„æ–‡ä»¶:"
            echo "$ADDED_MODIFIED_FILES"
            for file in $ADDED_MODIFIED_FILES; do
              # ä»æºæäº¤æ¢å¤æ–‡ä»¶
              if git show $COMMIT:"$file" >/dev/null 2>&1; then
                echo "ç¡®ä¿æ–‡ä»¶å­˜åœ¨: $file"
                mkdir -p "$(dirname "$file")"
                git show $COMMIT:"$file" > "$file" 2>/dev/null || echo "æ— æ³•æ¢å¤æ–‡ä»¶: $file"
                git add "$file" 2>/dev/null || true
              fi
            done
          fi
        done
        
        # æäº¤æ‰€æœ‰æ–‡ä»¶å˜æ›´ï¼ˆå¦‚æœæœ‰å˜åŒ–ï¼‰
        if ! git diff --cached --quiet; then
          git commit -m "mozi9: åŒæ­¥æ–‡ä»¶å˜æ›´" --author="mozi9 <mozi9>"
          echo "âœ… æ–‡ä»¶å˜æ›´å·²æäº¤"
        else
          echo "âœ… æ²¡æœ‰æ–‡ä»¶å˜æ›´éœ€è¦æäº¤"
        fi

    - name: Final push to target repository
      run: |
        echo "æ¨é€åˆ°ç›®æ ‡ä»“åº“..."
        git push https://mozi9:${{ secrets.Mozi9_PAT }}@github.com/${{ github.event.inputs.target_repo }}.git ${{ github.event.inputs.target_branch }}
        echo "âœ… æ¨é€å®Œæˆ"

    - name: Create final summary
      run: |
        echo "ğŸ‰ åŒæ­¥å®Œæˆï¼"
        echo "å…±åŒæ­¥äº† ${{ steps.parse_commits.outputs.commit_count }} ä¸ªæäº¤"
        echo "ä½¿ç”¨çš„èº«ä»½: mozi9 <mozi9>"
        echo "ç›®æ ‡ä»“åº“: ${{ github.event.inputs.target_repo }}"
        echo "ç›®æ ‡åˆ†æ”¯: ${{ github.event.inputs.target_branch }}"
        echo ""
        echo "åŒæ­¥çš„æäº¤åˆ—è¡¨ï¼š"
        cat /tmp/valid_commits.txt | while read commit; do
          if [ -n "$commit" ]; then
            git log -1 --oneline $commit 2>/dev/null || echo "$commit - å·²åŒæ­¥"
          fi
        done

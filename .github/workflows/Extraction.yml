name: Smart File Extraction and Commit

on:
  workflow_dispatch:
    inputs:
      source_type:
        description: "æºç±»å‹"
        required: true
        type: choice
        options:
          - commit_url
          - repo_branch
        default: commit_url
      commit_urls:
        description: "GitHubæäº¤é“¾æ¥ï¼ˆå¤šä¸ªé“¾æ¥ç”¨é€—å·æˆ–æ¢è¡Œåˆ†éš”ï¼‰"
        required: false
        default: ""
      source_repo:
        description: "æºä»“åº“ï¼ˆæ ¼å¼ï¼šowner/repoï¼‰"
        required: false
        default: "ApartTUSITU/kernel_xiaomi_sm8250_mod"
      source_commits:
        description: "æºä»“åº“æäº¤å“ˆå¸Œï¼ˆå¤šä¸ªç”¨é€—å·åˆ†éš”ï¼‰"
        required: false
        default: "47b6de7"
      source_branch:
        description: "æºåˆ†æ”¯"
        required: false
        default: "android16-aptusitu-new"
      target_repo:
        description: "ç›®æ ‡ä»“åº“ï¼ˆæ ¼å¼ï¼šowner/repoï¼‰"
        required: true
        default: "mozi9/XCD"
      target_branch:
        description: "ç›®æ ‡åˆ†æ”¯"
        required: true
        default: "miuix"
      commit_title:
        description: "æäº¤æ ‡é¢˜"
        required: true
        default: "fs: Bump SuSFS version to v2.0.0"
      commit_description:
        description: "æäº¤æè¿°ï¼ˆå¯é€‰ï¼‰"
        required: false
        default: ""

env:
  GIT_USERNAME: "mozi9"
  GIT_EMAIL: "mozi9@users.noreply.github.com"

jobs:
  smart-file-extraction:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
    - name: ğŸ” éªŒè¯è¾“å…¥å‚æ•°
      id: validate-inputs
      run: |
        echo "=== æ–‡ä»¶æå– ==="
        echo "æºç±»å‹: ${{ github.event.inputs.source_type }}"
        
        if [ "${{ github.event.inputs.source_type }}" = "commit_url" ]; then
          echo "æäº¤é“¾æ¥: ${{ github.event.inputs.commit_urls }}"
          if [[ -z "${{ github.event.inputs.commit_urls }}" ]]; then
            echo "âŒ æäº¤é“¾æ¥ä¸èƒ½ä¸ºç©º"
            exit 1
          fi
        else
          echo "æºä»“åº“: ${{ github.event.inputs.source_repo }}"
          echo "æäº¤å“ˆå¸Œ: ${{ github.event.inputs.source_commits }}"
          echo "æºåˆ†æ”¯: ${{ github.event.inputs.source_branch }}"
          
          if [[ -z "${{ github.event.inputs.source_repo }}" ]]; then
            echo "âŒ æºä»“åº“ä¸èƒ½ä¸ºç©º"
            exit 1
          fi
          if [[ -z "${{ github.event.inputs.source_commits }}" ]]; then
            echo "âŒ æäº¤å“ˆå¸Œä¸èƒ½ä¸ºç©º"
            exit 1
          fi
        fi
        
        echo "âœ… å‚æ•°éªŒè¯é€šè¿‡"

    - name: âš™ï¸ é…ç½®Gitç¯å¢ƒ
      run: |
        git config --global user.name "mozi9"
        git config --global user.email "mozi9@users.noreply.github.com"
        git config --global core.autocrlf false

    - name: ğŸ“¥ å¿«é€Ÿæ£€å‡ºç›®æ ‡ä»“åº“
      uses: actions/checkout@v4
      with:
        repository: ${{ github.event.inputs.target_repo }}
        ref: ${{ github.event.inputs.target_branch }}
        token: ${{ secrets.Mozi9_PAT }}
        path: target-repo
        fetch-depth: 1

    - name: ğŸ” è§£ææäº¤ä¿¡æ¯
      id: parse-commits
      run: |
        echo "=== è§£ææäº¤ä¿¡æ¯ ==="
        
        if [ "${{ github.event.inputs.source_type }}" = "commit_url" ]; then
          # å¤„ç†å¤šä¸ªæäº¤é“¾æ¥
          COMMIT_URLS="${{ github.event.inputs.commit_urls }}"
          echo "è§£ææäº¤é“¾æ¥: $COMMIT_URLS"
          
          # æ¸…ç†å’Œåˆ†å‰²é“¾æ¥ï¼ˆæ”¯æŒé€—å·ã€ç©ºæ ¼ã€æ¢è¡Œåˆ†éš”ï¼‰
          COMMIT_URLS_CLEAN=$(echo "$COMMIT_URLS" | tr ',' '\n' | tr ' ' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | grep -v '^$')
          URL_COUNT=$(echo "$COMMIT_URLS_CLEAN" | wc -l)
          
          echo "å‘ç° $URL_COUNT ä¸ªæäº¤é“¾æ¥"
          
          # å­˜å‚¨æ‰€æœ‰æäº¤ä¿¡æ¯
          all_commits=()
          all_repos=()
          
          url_index=0
          while IFS= read -r commit_url; do
            url_index=$((url_index + 1))
            echo "å¤„ç†é“¾æ¥ $url_index/$URL_COUNT: $commit_url"
            
            # æå–ä»“åº“å’Œæäº¤å“ˆå¸Œ
            if [[ "$commit_url" =~ https://github.com/([^/]+)/([^/]+)/commit/([a-f0-9]+) ]]; then
              REPO_OWNER="${BASH_REMATCH[1]}"
              REPO_NAME="${BASH_REMATCH[2]}"
              COMMIT_HASH="${BASH_REMATCH[3]}"
              REPO="$REPO_OWNER/$REPO_NAME"
              
              echo "âœ… è§£ææˆåŠŸ: $REPO @ $COMMIT_HASH"
              
              # æ·»åŠ åˆ°æ•°ç»„
              all_commits+=("$COMMIT_HASH")
              all_repos+=("$REPO")
            else
              echo "âŒ é“¾æ¥æ ¼å¼é”™è¯¯: $commit_url"
              exit 1
            fi
          done <<< "$COMMIT_URLS_CLEAN"
          
          if [ ${#all_commits[@]} -eq 0 ]; then
            echo "âŒ æ²¡æœ‰æœ‰æ•ˆçš„æäº¤é“¾æ¥"
            exit 1
          fi
          
          # ä¿å­˜ç»“æœ
          printf "%s\n" "${all_commits[@]}" > commit_hashes.txt
          printf "%s\n" "${all_repos[@]}" > repo_names.txt
          
          echo "commits_count=${#all_commits[@]}" >> $GITHUB_OUTPUT
          echo "âœ… è§£æå®Œæˆ: ${#all_commits[@]} ä¸ªæäº¤"
          
        else
          # å¤„ç†å¤šä¸ªæäº¤å“ˆå¸Œï¼ˆä»“åº“åˆ†æ”¯æ–¹å¼ï¼‰
          REPO="${{ github.event.inputs.source_repo }}"
          COMMITS="${{ github.event.inputs.source_commits }}"
          BRANCH="${{ github.event.inputs.source_branch }}"
          
          echo "å¤„ç†å¤šä¸ªæäº¤å“ˆå¸Œ: $COMMITS"
          
          # æ¸…ç†å’Œåˆ†å‰²æäº¤å“ˆå¸Œ
          COMMITS_CLEAN=$(echo "$COMMITS" | tr ',' '\n' | tr ' ' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | grep -v '^$')
          COMMIT_COUNT=$(echo "$COMMITS_CLEAN" | wc -l)
          
          echo "å‘ç° $COMMIT_COUNT ä¸ªæäº¤å“ˆå¸Œ"
          
          # å­˜å‚¨æ‰€æœ‰æäº¤ä¿¡æ¯
          all_commits=()
          all_repos=()
          
          while IFS= read -r commit_hash; do
            echo "å¤„ç†æäº¤: $commit_hash"
            all_commits+=("$commit_hash")
            all_repos+=("$REPO")
          done <<< "$COMMITS_CLEAN"
          
          if [ ${#all_commits[@]} -eq 0 ]; then
            echo "âŒ æ²¡æœ‰æœ‰æ•ˆçš„æäº¤å“ˆå¸Œ"
            exit 1
          fi
          
          # ä¿å­˜ç»“æœ
          printf "%s\n" "${all_commits[@]}" > commit_hashes.txt
          printf "%s\n" "${all_repos[@]}" > repo_names.txt
          
          echo "commits_count=${#all_commits[@]}" >> $GITHUB_OUTPUT
          echo "source_repo=$REPO" >> $GITHUB_OUTPUT
          echo "source_branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "âœ… è§£æå®Œæˆ: ${#all_commits[@]} ä¸ªæäº¤"
        fi

    - name: ğŸ“„ è·å–æ‰€æœ‰æäº¤çš„æ–‡ä»¶åˆ—è¡¨
      id: get-all-files
      run: |
        echo "=== è·å–æ‰€æœ‰æäº¤çš„æ–‡ä»¶åˆ—è¡¨ ==="
        
        # è¯»å–æäº¤å’Œä»“åº“ä¿¡æ¯
        readarray -t COMMITS < commit_hashes.txt
        readarray -t REPOS < repo_names.txt
        
        if [ ${#COMMITS[@]} -eq 0 ]; then
          echo "âŒ æ²¡æœ‰æäº¤ä¿¡æ¯"
          exit 1
        fi
        
        echo "å¤„ç† ${#COMMITS[@]} ä¸ªæäº¤..."
        
        # å­˜å‚¨æ‰€æœ‰æ–‡ä»¶ï¼ˆå»é‡ï¼‰
        all_files=()
        processed_commits=()
        
        for i in "${!COMMITS[@]}"; do
          COMMIT="${COMMITS[$i]}"
          REPO="${REPOS[$i]}"
          
          echo "å¤„ç†æäº¤ $((i+1))/${#COMMITS[@]}: $REPO @ $COMMIT"
          
          # è·å–æäº¤è¯¦æƒ…
          commit_url="https://api.github.com/repos/$REPO/commits/$COMMIT"
          commit_response=$(curl -s \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "$commit_url")
          
          # æ£€æŸ¥æäº¤æ˜¯å¦å­˜åœ¨
          if echo "$commit_response" | grep -q '"message":"Not Found"'; then
            echo "âŒ æäº¤ä¸å­˜åœ¨: $COMMIT"
            exit 1
          fi
          
          if echo "$commit_response" | grep -q '"sha"'; then
            sha=$(echo "$commit_response" | grep '"sha"' | head -1 | cut -d'"' -f4)
            echo "âœ… æäº¤å­˜åœ¨: $COMMIT -> $sha"
            processed_commits+=("$sha")
            
            # æå–æ–‡ä»¶åˆ—è¡¨
            files=$(echo "$commit_response" | grep '"filename"' | cut -d'"' -f4 | sort -u)
            file_count=$(echo "$files" | wc -l)
            
            if [ $file_count -eq 0 ]; then
              echo "âš ï¸ æäº¤ä¸­æ²¡æœ‰æ–‡ä»¶å˜æ›´"
              continue
            fi
            
            echo "ğŸ“„ æ‰¾åˆ° $file_count ä¸ªæ–‡ä»¶"
            
            # æ·»åŠ æ–‡ä»¶åˆ°æ€»åˆ—è¡¨ï¼ˆå»é‡ï¼‰
            while IFS= read -r file; do
              if [ -n "$file" ]; then
                # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
                found=0
                for existing_file in "${all_files[@]}"; do
                  if [ "$existing_file" = "$file" ]; then
                    found=1
                    break
                  fi
                done
                if [ $found -eq 0 ]; then
                  all_files+=("$file")
                fi
              fi
            done <<< "$files"
            
          else
            echo "âŒ æ— æ³•è·å–æäº¤ä¿¡æ¯: $COMMIT"
            exit 1
          fi
        done
        
        if [ ${#all_files[@]} -eq 0 ]; then
          echo "âŒ æ‰€æœ‰æäº¤ä¸­éƒ½æ²¡æœ‰æ–‡ä»¶å˜æ›´"
          exit 1
        fi
        
        # ä¿å­˜æ–‡ä»¶åˆ—è¡¨
        printf "%s\n" "${all_files[@]}" > all_files.txt
        printf "%s\n" "${processed_commits[@]}" > processed_commits.txt
        
        echo "files_count=${#all_files[@]}" >> $GITHUB_OUTPUT
        echo "processed_commits_count=${#processed_commits[@]}" >> $GITHUB_OUTPUT
        echo "âœ… æ€»å…±å‘ç° ${#all_files[@]} ä¸ªå”¯ä¸€æ–‡ä»¶"

    - name: ğŸ“¥ ä¸‹è½½æ‰€æœ‰æ–‡ä»¶
      id: download-all-files
      run: |
        echo "=== ä¸‹è½½æ‰€æœ‰æ–‡ä»¶ ==="
        
        if [ ! -s all_files.txt ]; then
          echo "âŒ æ²¡æœ‰éœ€è¦ä¸‹è½½çš„æ–‡ä»¶"
          exit 1
        fi
        
        # è¯»å–æäº¤å’Œä»“åº“ä¿¡æ¯ï¼ˆä½¿ç”¨ç¬¬ä¸€ä¸ªæäº¤çš„ä»“åº“ï¼‰
        readarray -t COMMITS < commit_hashes.txt
        readarray -t REPOS < repo_names.txt
        
        if [ ${#COMMITS[@]} -eq 0 ]; then
          echo "âŒ æ²¡æœ‰æäº¤ä¿¡æ¯"
          exit 1
        fi
        
        # ä½¿ç”¨ç¬¬ä¸€ä¸ªæäº¤çš„ä»“åº“ä¿¡æ¯
        FIRST_REPO="${REPOS[0]}"
        echo "ä½¿ç”¨ä»“åº“: $FIRST_REPO"
        
        # åˆ›å»ºæºæ–‡ä»¶ç›®å½•
        mkdir -p source-files
        
        # è®¡æ•°å™¨
        downloaded=0
        errors=0
        
        echo "å¼€å§‹ä¸‹è½½ ${#all_files[@]} ä¸ªæ–‡ä»¶..."
        
        # ä¸‹è½½æ¯ä¸ªæ–‡ä»¶ï¼ˆä½¿ç”¨ç¬¬ä¸€ä¸ªæäº¤çš„ç‰ˆæœ¬ï¼‰
        while IFS= read -r file; do
          [ -z "$file" ] && continue
          
          # ä½¿ç”¨ç¬¬ä¸€ä¸ªæäº¤çš„å“ˆå¸Œ
          COMMIT="${COMMITS[0]}"
          raw_url="https://raw.githubusercontent.com/$FIRST_REPO/$COMMIT/$file"
          
          echo "â¬‡ï¸ ä¸‹è½½ ($((downloaded + 1))/${#all_files[@]}): $file"
          
          # åˆ›å»ºç›®å½•ç»“æ„
          mkdir -p "source-files/$(dirname "$file")"
          
          # ä¸‹è½½æ–‡ä»¶
          if curl -s -f -L "$raw_url" -o "source-files/$file"; then
            downloaded=$((downloaded + 1))
          else
            echo "âŒ ä¸‹è½½å¤±è´¥: $file"
            errors=$((errors + 1))
          fi
          
        done < all_files.txt
        
        echo "actual_downloaded=$downloaded" >> $GITHUB_OUTPUT
        echo "download_errors=$errors" >> $GITHUB_OUTPUT
        
        if [ $errors -gt 0 ]; then
          echo "âŒ æ–‡ä»¶ä¸‹è½½å®Œæˆ: $downloaded æˆåŠŸ, $errors å¤±è´¥"
          exit 1
        else
          echo "âœ… æ–‡ä»¶ä¸‹è½½å®Œæˆ: $downloaded ä¸ªæ–‡ä»¶"
        fi

    - name: ğŸ”„ åŒæ­¥æ–‡ä»¶åˆ°ç›®æ ‡ä»“åº“
      id: sync-files
      run: |
        echo "=== åŒæ­¥æ–‡ä»¶åˆ°ç›®æ ‡ä»“åº“ ==="
        
        if [ ! -s all_files.txt ]; then
          echo "âŒ æ²¡æœ‰éœ€è¦åŒæ­¥çš„æ–‡ä»¶"
          exit 1
        fi
        
        # è®¡æ•°å™¨
        copied=0
        errors=0
        
        echo "å¼€å§‹åŒæ­¥ ${#all_files[@]} ä¸ªæ–‡ä»¶..."
        
        # åŒæ­¥æ¯ä¸ªæ–‡ä»¶
        while IFS= read -r file; do
          [ -z "$file" ] && continue
          
          if [ -f "source-files/$file" ]; then
            # åˆ›å»ºç›®æ ‡ç›®å½•
            mkdir -p "target-repo/$(dirname "$file")"
            
            # å¤åˆ¶æ–‡ä»¶
            if cp "source-files/$file" "target-repo/$file"; then
              copied=$((copied + 1))
              if [ $((copied % 10)) -eq 0 ]; then
                echo "ğŸ“„ å·²å¤åˆ¶ $copied/${#all_files[@]} ä¸ªæ–‡ä»¶"
              fi
            else
              echo "âŒ å¤åˆ¶å¤±è´¥: $file"
              errors=$((errors + 1))
            fi
          else
            echo "âŒ æºæ–‡ä»¶ä¸å­˜åœ¨: $file"
            errors=$((errors + 1))
          fi
        done < all_files.txt
        
        echo "actual_copied=$copied" >> $GITHUB_OUTPUT
        echo "sync_errors=$errors" >> $GITHUB_OUTPUT
        
        if [ $errors -gt 0 ]; then
          echo "âŒ æ–‡ä»¶åŒæ­¥å®Œæˆ: $copied æˆåŠŸ, $errors å¤±è´¥"
          exit 1
        else
          echo "âœ… æ–‡ä»¶åŒæ­¥å®Œæˆ: $copied ä¸ªæ–‡ä»¶"
        fi

    - name: ğŸ’¾ åˆ›å»ºæäº¤
      id: create-commit
      run: |
        cd target-repo
        
        echo "=== æ£€æŸ¥å˜æ›´å¹¶æäº¤ ==="
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜æ›´
        if git diff-index --quiet HEAD --; then
          echo "âŒ æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
          exit 1
        else
          echo "ğŸ“ å‘ç°å˜æ›´ï¼Œå‡†å¤‡æäº¤..."
          
          git add -A
          
          # æ˜¾ç¤ºå˜æ›´æ‘˜è¦
          echo "=== å˜æ›´æ‘˜è¦ ==="
          git status --short | head -20
          echo "... (æ›´å¤šæ–‡ä»¶)"
          
          # åˆ›å»ºæäº¤ä¿¡æ¯
          readarray -t PROCESSED_COMMITS < processed_commits.txt
          COMMIT_COUNT=${#PROCESSED_COMMITS[@]}
          
          commit_msg="${{ github.event.inputs.commit_title }}"
          commit_msg="$commit_msg"$'\n'$'\n'"æ¥è‡ª $COMMIT_COUNT ä¸ªæäº¤:"
          
          for commit in "${PROCESSED_COMMITS[@]}"; do
            commit_msg="$commit_msg"$'\n'"- ${commit:0:8}"
          done
          
          if [ -n "${{ github.event.inputs.commit_description }}" ]; then
            commit_msg="$commit_msg"$'\n'$'\n'"${{ github.event.inputs.commit_description }}"
          fi
          
          # æäº¤
          git commit -m "$commit_msg"
          echo "âœ… æäº¤åˆ›å»ºæˆåŠŸ"
        fi

    - name: ğŸš€ æ¨é€æ›´æ”¹
      run: |
        cd target-repo
        
        echo "=== æ¨é€æ›´æ”¹ ==="
        
        # é…ç½®è¿œç¨‹URL
        git remote set-url origin "https://mozi9:${{ secrets.Mozi9_PAT }}@github.com/${{ github.event.inputs.target_repo }}.git"
        
        # ç›´æ¥æ¨é€
        if git push origin "${{ github.event.inputs.target_branch }}"; then
          echo "âœ… æ¨é€æˆåŠŸ"
        else
          echo "âŒ æ¨é€å¤±è´¥"
          exit 1
        fi

    - name: ğŸ“‹ ç”ŸæˆæŠ¥å‘Š
      if: always()
      run: |
        cat > "$GITHUB_STEP_SUMMARY" << EOF
        # å¤šæäº¤æ–‡ä»¶æå–ç»“æœ
        
        ## æ‰§è¡Œæ‘˜è¦
        - **æºç±»å‹**: ${{ github.event.inputs.source_type }}
        - **å¤„ç†æäº¤æ•°é‡**: ${{ steps.parse-commits.outputs.commits_count }}
        - **å‘ç°å”¯ä¸€æ–‡ä»¶æ•°é‡**: ${{ steps.get-all-files.outputs.files_count }}
        - **ä¸‹è½½æˆåŠŸæ–‡ä»¶**: ${{ steps.download-all-files.outputs.actual_downloaded }}
        - **åŒæ­¥æˆåŠŸæ–‡ä»¶**: ${{ steps.sync-files.outputs.actual_copied }}
        - **çŠ¶æ€**: âœ… æˆåŠŸ
        
        ## æäº¤ä¿¡æ¯
        EOF
        
        # æ·»åŠ æäº¤åˆ—è¡¨åˆ°æŠ¥å‘Š
        if [ -f processed_commits.txt ]; then
          while IFS= read -r commit; do
            echo "- \`${commit:0:8}\`" >> "$GITHUB_STEP_SUMMARY"
          done < processed_commits.txt
        fi
        
        cat >> "$GITHUB_STEP_SUMMARY" << EOF
        
        ## ä½¿ç”¨æ–¹æ³•
        **æäº¤é“¾æ¥æ–¹å¼**ï¼ˆå¤šä¸ªé“¾æ¥ç”¨é€—å·åˆ†éš”ï¼‰:
        \`\`\`
        https://github.com/owner1/repo1/commit/abc123
        https://github.com/owner2/repo2/commit/def456
        \`\`\`
        
        **ä»“åº“åˆ†æ”¯æ–¹å¼**ï¼ˆå¤šä¸ªæäº¤ç”¨é€—å·åˆ†éš”ï¼‰:
        \`\`\`
        ä»“åº“: owner/repo
        æäº¤: abc123,def456,ghi789
        åˆ†æ”¯: main
        \`\`\`
        
        **æ‰§è¡Œæ—¶é—´**: é¢„è®¡2-3åˆ†é’Ÿ
        EOF

    - name: ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶
      if: always()
      run: |
        echo "=== æ¸…ç†ä¸´æ—¶æ–‡ä»¶ ==="
        rm -rf source-files
        rm -f commit_hashes.txt repo_names.txt all_files.txt processed_commits.txt
        echo "âœ… æ¸…ç†å®Œæˆ"

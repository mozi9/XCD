name: Manual File Extraction with URL Support

on:
  workflow_dispatch:
    inputs:
      source_repo_url:
        description: "Source repository URL (format: owner/repo:branch or https://github.com/owner/repo/tree/branch)"
        required: true
        default: "ApartTUSITU/kernel_xiaomi_sm8250_mod:android16-aptusitu"
      target_repo_url:
        description: "Target repository URL (format: owner/repo:branch or https://github.com/owner/repo/tree/branch)"
        required: true
        default: "‰Ω†ÁöÑÁî®Êà∑Âêç/‰Ω†ÁöÑÁõÆÊ†á‰ªìÂ∫ì:main"
      source_commits:
        description: "Source commit hashes (short or full, comma separated)"
        required: true
        default: "41273ce"
      enable_deletion:
        description: "Enable file deletion from target repository"
        required: true
        type: boolean
        default: true

env:
  COMMIT_MESSAGE: "fs: Bump SuSFS version to v2.0.0"
  COMMIT_DESCRIPTION: "Co-authored-by: simonpunk <simonpunk2016@gmail.com> o-authored-by: JackA1ltman <cs2dtzq@163.com>"

jobs:
  extract-and-commit:
    runs-on: ubuntu-latest
    steps:
    - name: Parse repository URLs
      id: parse-urls
      run: |
        echo "=== Parsing repository URLs ==="
        
        # Ëß£ÊûêÊ∫ê‰ªìÂ∫ì
        SOURCE_INPUT="${{ inputs.source_repo_url }}"
        echo "Source input: $SOURCE_INPUT"
        
        if [[ "$SOURCE_INPUT" =~ ^https://github.com/([^/]+)/([^/]+)/tree/(.+)$ ]]; then
          SOURCE_OWNER="${BASH_REMATCH[1]}"
          SOURCE_REPO="${BASH_REMATCH[2]}"
          SOURCE_BRANCH="${BASH_REMATCH[3]}"
        elif [[ "$SOURCE_INPUT" =~ ^https://github.com/([^/]+)/([^/]+)$ ]]; then
          SOURCE_OWNER="${BASH_REMATCH[1]}"
          SOURCE_REPO="${BASH_REMATCH[2]}"
          SOURCE_BRANCH="main"
        elif [[ "$SOURCE_INPUT" =~ ^([^/]+)/([^:]+)(:(.+))?$ ]]; then
          SOURCE_OWNER="${BASH_REMATCH[1]}"
          SOURCE_REPO="${BASH_REMATCH[2]}"
          SOURCE_BRANCH="${BASH_REMATCH[4]:-main}"
        else
          echo "‚ùå Invalid source repository format: $SOURCE_INPUT"
          echo "Expected format: owner/repo:branch or https://github.com/owner/repo/tree/branch"
          exit 1
        fi
        
        # Ëß£ÊûêÁõÆÊ†á‰ªìÂ∫ì
        TARGET_INPUT="${{ inputs.target_repo_url }}"
        echo "Target input: $TARGET_INPUT"
        
        if [[ "$TARGET_INPUT" =~ ^https://github.com/([^/]+)/([^/]+)/tree/(.+)$ ]]; then
          TARGET_OWNER="${BASH_REMATCH[1]}"
          TARGET_REPO="${BASH_REMATCH[2]}"
          TARGET_BRANCH="${BASH_REMATCH[3]}"
        elif [[ "$TARGET_INPUT" =~ ^https://github.com/([^/]+)/([^/]+)$ ]]; then
          TARGET_OWNER="${BASH_REMATCH[1]}"
          TARGET_REPO="${BASH_REMATCH[2]}"
          TARGET_BRANCH="main"
        elif [[ "$TARGET_INPUT" =~ ^([^/]+)/([^:]+)(:(.+))?$ ]]; then
          TARGET_OWNER="${BASH_REMATCH[1]}"
          TARGET_REPO="${BASH_REMATCH[2]}"
          TARGET_BRANCH="${BASH_REMATCH[4]:-main}"
        else
          echo "‚ùå Invalid target repository format: $TARGET_INPUT"
          echo "Expected format: owner/repo:branch or https://github.com/owner/repo/tree/branch"
          exit 1
        fi
        
        echo "‚úÖ Source: $SOURCE_OWNER/$SOURCE_REPO (branch: $SOURCE_BRANCH)"
        echo "‚úÖ Target: $TARGET_OWNER/$TARGET_REPO (branch: $TARGET_BRANCH)"
        
        echo "source_owner=$SOURCE_OWNER" >> $GITHUB_OUTPUT
        echo "source_repo=$SOURCE_REPO" >> $GITHUB_OUTPUT
        echo "source_branch=$SOURCE_BRANCH" >> $GITHUB_OUTPUT
        echo "target_owner=$TARGET_OWNER" >> $GITHUB_OUTPUT
        echo "target_repo=$TARGET_REPO" >> $GITHUB_OUTPUT
        echo "target_branch=$TARGET_BRANCH" >> $GITHUB_OUTPUT

    - name: Checkout source repository
      uses: actions/checkout@v4
      with:
        repository: ${{ steps.parse-urls.outputs.source_owner }}/${{ steps.parse-urls.outputs.source_repo }}
        ref: ${{ steps.parse-urls.outputs.source_branch }}
        token: ${{ secrets.PAT_TOKEN }}
        path: source-repo
        fetch-depth: 0

    - name: Checkout target repository
      uses: actions/checkout@v4
      with:
        repository: ${{ steps.parse-urls.outputs.target_owner }}/${{ steps.parse-urls.outputs.target_repo }}
        ref: ${{ steps.parse-urls.outputs.target_branch }}
        token: ${{ secrets.PAT_TOKEN }}
        path: target-repo
        fetch-depth: 0

    - name: Setup Git identity
      run: |
        git config --global user.name "mozi9"
        git config --global user.email "mozi9"

    - name: Resolve commit hashes
      id: resolve-commits
      run: |
        cd source-repo
        COMMITS=$(echo "${{ inputs.source_commits }}" | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | grep -v '^$')
        RESOLVED_COMMITS=""
        
        for commit in $COMMITS; do
          FULL_HASH=$(git rev-parse "$commit" 2>/dev/null || echo "")
          if [ -n "$FULL_HASH" ]; then
            RESOLVED_COMMITS="$RESOLVED_COMMITS$FULL_HASH"$'\n'
            echo "‚úÖ Resolved $commit -> $FULL_HASH"
          else
            echo "‚ùå Error: Cannot resolve commit $commit"
            exit 1
          fi
        done
        
        echo "$RESOLVED_COMMITS" | grep -v '^$' > ../resolved_commits.txt
        echo "Total resolved commits: $(cat ../resolved_commits.txt | wc -l)"

    - name: Analyze file changes including deletions
      id: analyze-files
      run: |
        cd source-repo
        COMMITS=$(cat ../resolved_commits.txt)
        
        echo "=== Analyzing file changes from commits ==="
        echo "Source branch: ${{ steps.parse-urls.outputs.source_branch }}"
        echo "Commits to analyze:"
        echo "$COMMITS"
        
        ALL_MODIFIED_FILES=""
        ALL_DELETED_FILES=""
        
        for commit in $COMMITS; do
          echo "üìä Processing commit: $commit"
          
          # Ëé∑ÂèñËØ•commitÁöÑÊñá‰ª∂ÂèòÊõ¥
          MODIFIED_FILES=$(git show --name-status --format= $commit | awk '$1 == "A" || $1 == "M" || $1 == "R100" {print $NF}' | sort -u)
          DELETED_FILES=$(git show --name-status --format= $commit | awk '$1 == "D" {print $2}' | sort -u)
          
          echo "Modified/Added: $(echo "$MODIFIED_FILES" | tr '\n' ' ')"
          echo "Deleted: $(echo "$DELETED_FILES" | tr '\n' ' ')"
          
          if [ -n "$MODIFIED_FILES" ]; then
            ALL_MODIFIED_FILES="$ALL_MODIFIED_FILES"$'\n'"$MODIFIED_FILES"
          fi
          if [ -n "$DELETED_FILES" ]; then
            ALL_DELETED_FILES="$ALL_DELETED_FILES"$'\n'"$DELETED_FILES"
          fi
        done
        
        # ÂéªÈáçÂíåÊ∏ÖÁêÜ
        UNIQUE_MODIFIED=$(echo "$ALL_MODIFIED_FILES" | grep -v '^$' | sort -u)
        UNIQUE_DELETED=$(echo "$ALL_DELETED_FILES" | grep -v '^$' | sort -u)
        
        # ‰øùÂ≠òÂà∞Êñá‰ª∂
        echo "$UNIQUE_MODIFIED" > ../modified_files.txt
        echo "$UNIQUE_DELETED" > ../deleted_files.txt
        
        MOD_COUNT=$(echo "$UNIQUE_MODIFIED" | grep -c . || echo 0)
        DEL_COUNT=$(echo "$UNIQUE_DELETED" | grep -c . || echo 0)
        
        echo "modified_files_count=$MOD_COUNT" >> $GITHUB_OUTPUT
        echo "deleted_files_count=$DEL_COUNT" >> $GITHUB_OUTPUT
        
        echo "‚úÖ Analysis completed:"
        echo "   Modified/Added files: $MOD_COUNT"
        echo "   Deleted files: $DEL_COUNT"

    - name: Delete files from target repository
      if: inputs.enable_deletion == true
      id: delete-files
      run: |
        cd target-repo
        
        echo "=== Processing file deletions ==="
        DELETED_COUNT=0
        SKIPPED_COUNT=0
        
        if [ -s ../deleted_files.txt ]; then
          while IFS= read -r file; do
            if [ -n "$file" ]; then
              if [[ "$file" =~ ^[a-zA-Z0-9_./-]+$ ]] && [[ "$file" != .git* ]] && [[ "$file" != "/"* ]]; then
                if [ -e "$file" ]; then
                  echo "üóëÔ∏è Deleting: $file"
                  rm -rf "$file"
                  DELETED_COUNT=$((DELETED_COUNT + 1))
                  
                  # Ê∏ÖÁêÜÁ©∫ÁõÆÂΩï
                  dir=$(dirname "$file")
                  while [ "$dir" != "." ] && [ -d "$dir" ]; do
                    if [ -z "$(ls -A "$dir" 2>/dev/null)" ]; then
                      rmdir "$dir" 2>/dev/null && echo "  üìÅ Removed empty directory: $dir" || break
                      dir=$(dirname "$dir")
                    else
                      break
                    fi
                  done
                else
                  echo "‚ö†Ô∏è Target not found: $file"
                  SKIPPED_COUNT=$((SKIPPED_COUNT + 1))
                fi
              else
                echo "üö´ Invalid path: $file"
                SKIPPED_COUNT=$((SKIPPED_COUNT + 1))
              fi
            fi
          done < ../deleted_files.txt
        else
          echo "‚ÑπÔ∏è No files to delete"
        fi
        
        echo "actual_deleted_count=$DELETED_COUNT" >> $GITHUB_OUTPUT
        echo "skipped_deletion_count=$SKIPPED_COUNT" >> $GITHUB_OUTPUT
        echo "‚úÖ Deletion completed: $DELETED_COUNT deleted, $SKIPPED_COUNT skipped"

    - name: Copy modified files to target
      id: copy-files
      run: |
        cd source-repo
        
        echo "=== Copying modified/added files ==="
        COPIED_COUNT=0
        FAILED_COUNT=0
        
        if [ -s ../modified_files.txt ]; then
          while IFS= read -r file; do
            if [ -n "$file" ] && [ -e "$file" ]; then
              if [[ "$file" =~ ^[a-zA-Z0-9_./-]+$ ]] && [[ "$file" != .git* ]] && [[ "$file" != "/"* ]]; then
                echo "üìÑ Copying: $file"
                mkdir -p "../target-repo/$(dirname "$file")"
                if cp -r "$file" "../target-repo/$file" 2>/dev/null; then
                  COPIED_COUNT=$((COPIED_COUNT + 1))
                else
                  echo "‚ùå Failed to copy: $file"
                  FAILED_COUNT=$((FAILED_COUNT + 1))
                fi
              else
                echo "üö´ Invalid path: $file"
                FAILED_COUNT=$((FAILED_COUNT + 1))
              fi
            else
              echo "‚ö†Ô∏è Source not found: $file"
              FAILED_COUNT=$((FAILED_COUNT + 1))
            fi
          done < ../modified_files.txt
        else
          echo "‚ÑπÔ∏è No files to copy"
        fi
        
        echo "actual_copied_count=$COPIED_COUNT" >> $GITHUB_OUTPUT
        echo "failed_copy_count=$FAILED_COUNT" >> $GITHUB_OUTPUT
        echo "‚úÖ Copy completed: $COPIED_COUNT copied, $FAILED_COUNT failed"

    - name: Commit and push changes
      id: commit-push
      run: |
        cd target-repo
        
        # Ê∑ªÂä†ÊâÄÊúâÂèòÊõ¥
        git add -A
        
        if git diff --cached --quiet; then
          echo "‚ùå No changes to commit"
          echo "has_changes=false" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        echo "‚úÖ Changes to be committed:"
        git diff --cached --name-status
        
        # ÂàõÂª∫Êèê‰∫§
        COMMIT_TITLE="${{ env.COMMIT_MESSAGE }}"
        COMMIT_BODY="${{ env.COMMIT_DESCRIPTION }}"
        COMMIT_BODY+=$'\n\n'"## File Operations Summary"
        COMMIT_BODY+=$'\n'"- üìÑ Copied/Modified: ${{ steps.copy-files.outputs.actual_copied_count }} files"
        COMMIT_BODY+=$'\n'"- üóëÔ∏è Deleted: ${{ steps.delete-files.outputs.actual_deleted_count }} files"
        COMMIT_BODY+=$'\n'"- Source: ${{ steps.parse-urls.outputs.source_owner }}/${{ steps.parse-urls.outputs.source_repo }}@${{ steps.parse-urls.outputs.source_branch }}"
        COMMIT_BODY+=$'\n'"- Commits: ${{ inputs.source_commits }}"
        
        git commit -m "$COMMIT_TITLE" -m "$COMMIT_BODY"
        git push origin ${{ steps.parse-urls.outputs.target_branch }}
        
        echo "has_changes=true" >> $GITHUB_OUTPUT
        echo "commit_sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
        echo "‚úÖ Changes committed and pushed successfully"

    - name: Create summary report
      run: |
        cat > $GITHUB_STEP_SUMMARY << EOF
        # Êñá‰ª∂ÂêåÊ≠•ÂÆåÊàêÊä•Âëä
        
        ## ‰ªìÂ∫ì‰ø°ÊÅØ
        - **Ê∫ê‰ªìÂ∫ì**: ${{ inputs.source_repo_url }}
        - **ÁõÆÊ†á‰ªìÂ∫ì**: ${{ inputs.target_repo_url }}
        - **Ê∫êÊèê‰∫§**: ${{ inputs.source_commits }}
        
        ## Êìç‰ΩúÁªüËÆ°
        - **‰øÆÊîπ/Êñ∞Â¢ûÊñá‰ª∂**: ${{ steps.analyze-files.outputs.modified_files_count }} ‰∏™
        - **Âà†Èô§Êñá‰ª∂**: ${{ steps.analyze-files.outputs.deleted_files_count }} ‰∏™
        - **ÂÆûÈôÖÂ§çÂà∂**: ${{ steps.copy-files.outputs.actual_copied_count }} ‰∏™
        - **ÂÆûÈôÖÂà†Èô§**: ${{ steps.delete-files.outputs.actual_deleted_count }} ‰∏™
        - **Â§çÂà∂Â§±Ë¥•**: ${{ steps.copy-files.outputs.failed_copy_count }} ‰∏™
        
        ## ÂàÜÊîØ‰ø°ÊÅØ
        - **Ê∫êÂàÜÊîØ**: ${{ steps.parse-urls.outputs.source_branch }}
        - **ÁõÆÊ†áÂàÜÊîØ**: ${{ steps.parse-urls.outputs.target_branch }}
        
        EOF
        
        if [ "${{ steps.commit-push.outputs.has_changes }}" = "true" ]; then
          echo "‚úÖ **ÂêåÊ≠•ÊàêÂäü**: Êñá‰ª∂Ë¶ÜÁõñÂêàÂπ∂ÂÆåÊàê" >> $GITHUB_STEP_SUMMARY
          echo "üîó **Êèê‰∫§SHA**: ${{ steps.commit-push.outputs.commit_sha }}" >> $GITHUB_STEP_SUMMARY
        else
          echo "‚ùå **ÂêåÊ≠•Â§±Ë¥•**: Êú™Ê£ÄÊµãÂà∞Êñá‰ª∂ÂèòÊõ¥" >> $GITHUB_STEP_SUMMARY
        fi

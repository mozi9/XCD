name: Commit File Synchronization

on:
  workflow_dispatch:
    inputs:
      commit_urls:
        description: "GitHubæäº¤é“¾æ¥ï¼ˆå¤šä¸ªé“¾æ¥ç”¨é€—å·åˆ†éš”ï¼‰"
        required: true
        default: "https://github.com/ApartTUSITU/kernel_xiaomi_sm8250_mod/commit/47b6de7"
      target_repo:
        description: "ç›®æ ‡ä»“åº“ï¼ˆæ ¼å¼ï¼šowner/repoï¼‰"
        required: true
        default: "mozi9/XCD"
      target_branch:
        description: "ç›®æ ‡åˆ†æ”¯"
        required: true
        default: "miuix"
      commit_title:
        description: "æäº¤æ ‡é¢˜"
        required: true
        default: "fs: Bump SuSFS version to v2.0.0"
      commit_description:
        description: "æäº¤æè¿°ï¼ˆå¯é€‰ï¼‰"
        required: false
        default: ""

env:
  GIT_USERNAME: "mozi9"
  GIT_EMAIL: "mozi9@users.noreply.github.com"

jobs:
  commit-file-sync:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
    - name: ğŸ”§ å®‰è£…å¿…è¦å·¥å…·
      run: |
        sudo apt-get update
        sudo apt-get install -y jq curl

    - name: ğŸ” éªŒè¯è¾“å…¥å‚æ•°
      id: validate-inputs
      run: |
        echo "=== æäº¤æ–‡ä»¶åŒæ­¥ ==="
        echo "æäº¤é“¾æ¥: ${{ github.event.inputs.commit_urls }}"
        
        if [[ -z "${{ github.event.inputs.commit_urls }}" ]]; then
          echo "âŒ æäº¤é“¾æ¥ä¸èƒ½ä¸ºç©º"
          exit 1
        fi
        echo "âœ… å‚æ•°éªŒè¯é€šè¿‡"

    - name: âš™ï¸ é…ç½®Gitç¯å¢ƒ
      run: |
        git config --global user.name "mozi9"
        git config --global user.email "mozi9@users.noreply.github.com"
        git config --global core.autocrlf false

    - name: ğŸ“¥ æ£€å‡ºç›®æ ‡ä»“åº“
      uses: actions/checkout@v4
      with:
        repository: ${{ github.event.inputs.target_repo }}
        ref: ${{ github.event.inputs.target_branch }}
        token: ${{ secrets.Mozi9_PAT }}
        path: target-repo
        fetch-depth: 1

    - name: ğŸ” è§£ææäº¤é“¾æ¥
      id: parse-commit-urls
      run: |
        echo "=== è§£ææäº¤é“¾æ¥ ==="
        
        COMMIT_URLS="${{ github.event.inputs.commit_urls }}"
        
        # æ¸…ç†å’Œåˆ†å‰²é“¾æ¥
        COMMIT_URLS_CLEAN=$(echo "$COMMIT_URLS" | tr ',' '\n' | tr ' ' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | grep -v '^$')
        
        # å­˜å‚¨æ‰€æœ‰æäº¤ä¿¡æ¯
        all_commits=()
        all_repos=()
        
        while IFS= read -r commit_url; do
          if [[ "$commit_url" =~ https://github.com/([^/]+)/([^/]+)/commit/([a-f0-9]+) ]]; then
            REPO_OWNER="${BASH_REMATCH[1]}"
            REPO_NAME="${BASH_REMATCH[2]}"
            COMMIT_HASH="${BASH_REMATCH[3]}"
            REPO="$REPO_OWNER/$REPO_NAME"
            
            echo "âœ… è§£ææˆåŠŸ: $REPO @ $COMMIT_HASH"
            all_commits+=("$COMMIT_HASH")
            all_repos+=("$REPO")
          else
            echo "âŒ é“¾æ¥æ ¼å¼é”™è¯¯: $commit_url"
            exit 1
          fi
        done <<< "$COMMIT_URLS_CLEAN"
        
        if [ ${#all_commits[@]} -eq 0 ]; then
          echo "âŒ æ²¡æœ‰æœ‰æ•ˆçš„æäº¤é“¾æ¥"
          exit 1
        fi
        
        # ä¿å­˜ç»“æœ
        printf "%s\n" "${all_commits[@]}" > commit_hashes.txt
        printf "%s\n" "${all_repos[@]}" > repo_names.txt
        
        echo "commits_count=${#all_commits[@]}" >> $GITHUB_OUTPUT
        echo "âœ… è§£æå®Œæˆ: ${#all_commits[@]} ä¸ªæäº¤"

    - name: ğŸ“Š è·å–æäº¤ä¸­å®é™…å˜æ›´çš„æ–‡ä»¶
      id: get-commit-files
      run: |
        echo "=== è·å–æäº¤ä¸­å®é™…å˜æ›´çš„æ–‡ä»¶ ==="
        
        readarray -t COMMITS < commit_hashes.txt
        readarray -t REPOS < repo_names.txt
        
        # å­˜å‚¨æ–‡ä»¶ä¿¡æ¯
        all_commit_files=()        # æäº¤ä¸­æ‰€æœ‰å˜æ›´çš„æ–‡ä»¶
        files_to_add=()            # æ–°å¢æ–‡ä»¶
        files_to_modify=()         # ä¿®æ”¹æ–‡ä»¶
        files_to_delete=()         # åˆ é™¤æ–‡ä»¶
        
        for i in "${!COMMITS[@]}"; do
          COMMIT="${COMMITS[$i]}"
          REPO="${REPOS[$i]}"
          
          echo "è·å–æäº¤ $((i+1))/${#COMMITS[@]}: $REPO @ $COMMIT çš„å˜æ›´æ–‡ä»¶"
          
          # è·å–æäº¤è¯¦æƒ…
          commit_url="https://api.github.com/repos/$REPO/commits/$COMMIT"
          commit_response=$(curl -s \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "$commit_url")
          
          # æ£€æŸ¥APIå“åº”
          if echo "$commit_response" | grep -q '"sha"'; then
            # ä½¿ç”¨jqæå–æ–‡ä»¶ä¿¡æ¯
            files_json=$(echo "$commit_response" | jq -r '.files[]? | "\(.filename)|\(.status)"' 2>/dev/null || echo "")
            
            if [ -n "$files_json" ]; then
              while IFS= read -r file_info; do
                if [ -n "$file_info" ]; then
                  filename=$(echo "$file_info" | cut -d'|' -f1)
                  status=$(echo "$file_info" | cut -d'|' -f2)
                  
                  # éªŒè¯æ–‡ä»¶åæœ‰æ•ˆæ€§
                  if [ -n "$filename" ] && [ "$filename" != "null" ] && [ ${#filename} -gt 1 ]; then
                    # æ·»åŠ åˆ°æ€»æ–‡ä»¶åˆ—è¡¨ï¼ˆå»é‡ï¼‰
                    if [[ ! " ${all_commit_files[@]} " =~ " ${filename} " ]]; then
                      all_commit_files+=("$filename")
                    fi
                    
                    # æ ¹æ®çŠ¶æ€åˆ†ç±»
                    case $status in
                      added|A)
                        if [[ ! " ${files_to_add[@]} " =~ " ${filename} " ]]; then
                          files_to_add+=("$filename")
                        fi
                        ;;
                      modified|M)
                        if [[ ! " ${files_to_modify[@]} " =~ " ${filename} " ]]; then
                          files_to_modify+=("$filename")
                        fi
                        ;;
                      removed|D)
                        if [[ ! " ${files_to_delete[@]} " =~ " ${filename} " ]]; then
                          files_to_delete+=("$filename")
                        fi
                        ;;
                      renamed|R)
                        if [[ ! " ${files_to_modify[@]} " =~ " ${filename} " ]]; then
                          files_to_modify+=("$filename")
                        fi
                        ;;
                    esac
                  fi
                fi
              done <<< "$files_json"
            else
              echo "âŒ æ— æ³•è§£ææäº¤æ–‡ä»¶ä¿¡æ¯: $COMMIT"
              exit 1
            fi
          else
            echo "âŒ æ— æ³•è·å–æäº¤ä¿¡æ¯: $COMMIT"
            echo "APIå“åº”: $commit_response"
            exit 1
          fi
        done
        
        # ä¿å­˜æ–‡ä»¶åˆ—è¡¨
        printf "%s\n" "${all_commit_files[@]}" | sort -u > all_commit_files.txt
        printf "%s\n" "${files_to_add[@]}" | sort -u > files_to_add.txt
        printf "%s\n" "${files_to_modify[@]}" | sort -u > files_to_modify.txt
        printf "%s\n" "${files_to_delete[@]}" | sort -u > files_to_delete.txt
        
        echo "commit_files_count=$(wc -l < all_commit_files.txt)" >> $GITHUB_OUTPUT
        echo "add_count=$(wc -l < files_to_add.txt)" >> $GITHUB_OUTPUT
        echo "modify_count=$(wc -l < files_to_modify.txt)" >> $GITHUB_OUTPUT
        echo "delete_count=$(wc -l < files_to_delete.txt)" >> $GITHUB_OUTPUT
        
        echo "âœ… æ–‡ä»¶åˆ†æå®Œæˆ:"
        echo "   æäº¤ä¸­å˜æ›´æ–‡ä»¶: $(wc -l < all_commit_files.txt) ä¸ª"
        echo "   æ–°å¢æ–‡ä»¶: $(wc -l < files_to_add.txt) ä¸ª"
        echo "   ä¿®æ”¹æ–‡ä»¶: $(wc -l < files_to_modify.txt) ä¸ª"
        echo "   åˆ é™¤æ–‡ä»¶: $(wc -l < files_to_delete.txt) ä¸ª"

    - name: ğŸ“¥ ä»æºä»“åº“ä¸‹è½½æäº¤ä¸­çš„æ–‡ä»¶
      id: download-commit-files
      run: |
        echo "=== ä»æºä»“åº“ä¸‹è½½æäº¤ä¸­çš„æ–‡ä»¶ ==="
        
        readarray -t COMMITS < commit_hashes.txt
        readarray -t REPOS < repo_names.txt
        
        if [ ${#COMMITS[@]} -eq 0 ]; then
          echo "âŒ æ²¡æœ‰æäº¤ä¿¡æ¯"
          exit 1
        fi
        
        # ä½¿ç”¨ç¬¬ä¸€ä¸ªæäº¤çš„ä»“åº“ä¿¡æ¯
        FIRST_REPO="${REPOS[0]}"
        FIRST_COMMIT="${COMMITS[0]}"
        
        echo "ä½¿ç”¨ä»“åº“: $FIRST_REPO"
        echo "ä½¿ç”¨æäº¤: $FIRST_COMMIT"
        
        mkdir -p source-files
        
        # ä¸‹è½½ç»Ÿè®¡
        downloaded_count=0
        failed_count=0
        skipped_count=0
        
        if [ -s all_commit_files.txt ]; then
          total_files=$(wc -l < all_commit_files.txt)
          echo "å¼€å§‹ä¸‹è½½æäº¤ä¸­çš„ $total_files ä¸ªæ–‡ä»¶..."
          
          while IFS= read -r file; do
            [ -z "$file" ] && continue
            
            # æ„å»ºrawæ–‡ä»¶URL
            raw_url="https://raw.githubusercontent.com/$FIRST_REPO/$FIRST_COMMIT/$file"
            
            echo "ä¸‹è½½: $file"
            
            # åˆ›å»ºç›®å½•ç»“æ„
            mkdir -p "source-files/$(dirname "$file")"
            
            # ä¸‹è½½æ–‡ä»¶ï¼ˆå¸¦é‡è¯•ï¼‰
            max_retries=3
            retry_count=0
            success=false
            
            while [ $retry_count -lt $max_retries ] && [ "$success" = false ]; do
              if curl -s -f -L "$raw_url" -o "source-files/$file"; then
                if [ -s "source-files/$file" ]; then
                  success=true
                  downloaded_count=$((downloaded_count + 1))
                  echo "âœ… ä¸‹è½½æˆåŠŸ ($((retry_count + 1))/$max_retries): $file"
                else
                  echo "âš ï¸  æ–‡ä»¶ä¸ºç©ºï¼Œé‡è¯•... ($((retry_count + 1))/$max_retries): $file"
                  rm -f "source-files/$file"
                fi
              else
                echo "âŒ ä¸‹è½½å¤±è´¥ ($((retry_count + 1))/$max_retries): $file"
              fi
              
              if [ "$success" = false ]; then
                retry_count=$((retry_count + 1))
                if [ $retry_count -lt $max_retries ]; then
                  sleep 0.5
                fi
              fi
            done
            
            if [ "$success" = false ]; then
              failed_count=$((failed_count + 1))
              echo "âŒ æœ€ç»ˆä¸‹è½½å¤±è´¥: $file"
              
              # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
              check_url="https://api.github.com/repos/$FIRST_REPO/contents/$file?ref=$FIRST_COMMIT"
              http_code=$(curl -s -o /dev/null -w "%{http_code}" -L "$check_url")
              echo "æ–‡ä»¶å­˜åœ¨æ€§æ£€æŸ¥ (HTTP $http_code): $file"
            fi
            
            # çŸ­æš‚å»¶è¿Ÿé¿å…é™æµ
            sleep 0.1
            
          done < all_commit_files.txt
        fi
        
        echo "downloaded_count=$downloaded_count" >> $GITHUB_OUTPUT
        echo "failed_count=$failed_count" >> $GITHUB_OUTPUT
        
        echo "âœ… ä¸‹è½½å®Œæˆ:"
        echo "   æˆåŠŸä¸‹è½½: $downloaded_count ä¸ªæ–‡ä»¶"
        echo "   ä¸‹è½½å¤±è´¥: $failed_count ä¸ªæ–‡ä»¶"

    - name: ğŸ”„ åŒæ­¥æäº¤æ–‡ä»¶åˆ°ç›®æ ‡ä»“åº“
      id: sync-commit-files
      run: |
        echo "=== åŒæ­¥æäº¤æ–‡ä»¶åˆ°ç›®æ ‡ä»“åº“ ==="
        
        # æ“ä½œç»Ÿè®¡
        added_count=0
        modified_count=0
        deleted_count=0
        error_count=0
        
        # 1. å¤„ç†åˆ é™¤æ–‡ä»¶
        if [ -s files_to_delete.txt ]; then
          echo "=== åˆ é™¤æ–‡ä»¶ ==="
          while IFS= read -r file; do
            [ -z "$file" ] && continue
            
            if [ -f "target-repo/$file" ]; then
              if rm -f "target-repo/$file"; then
                deleted_count=$((deleted_count + 1))
                echo "ğŸ—‘ï¸  åˆ é™¤: $file"
                
                # å°è¯•åˆ é™¤ç©ºç›®å½•
                dir=$(dirname "$file")
                while [ "$dir" != "." ] && [ -d "target-repo/$dir" ]; do
                  if [ -z "$(ls -A "target-repo/$dir")" ]; then
                    rmdir "target-repo/$dir" 2>/dev/null && echo "ğŸ“ åˆ é™¤ç©ºç›®å½•: $dir" || break
                    dir=$(dirname "$dir")
                  else
                    break
                  fi
                done
              else
                error_count=$((error_count + 1))
                echo "âŒ åˆ é™¤å¤±è´¥: $file"
              fi
            else
              echo "â­ï¸  è·³è¿‡åˆ é™¤: $file (ç›®æ ‡æ–‡ä»¶ä¸å­˜åœ¨)"
            fi
          done < files_to_delete.txt
        fi
        
        # 2. å¤„ç†æ–°å¢æ–‡ä»¶
        if [ -s files_to_add.txt ]; then
          echo "=== æ–°å¢æ–‡ä»¶ ==="
          while IFS= read -r file; do
            [ -z "$file" ] && continue
            
            if [ -f "source-files/$file" ] && [ -s "source-files/$file" ]; then
              mkdir -p "target-repo/$(dirname "$file")"
              if cp "source-files/$file" "target-repo/$file"; then
                added_count=$((added_count + 1))
                echo "â• æ–°å¢: $file"
              else
                error_count=$((error_count + 1))
                echo "âŒ æ–°å¢å¤±è´¥: $file"
              fi
            else
              echo "â­ï¸  è·³è¿‡æ–°å¢: $file (æºæ–‡ä»¶ä¸å­˜åœ¨æˆ–ä¸ºç©º)"
            fi
          done < files_to_add.txt
        fi
        
        # 3. å¤„ç†ä¿®æ”¹æ–‡ä»¶ï¼ˆå¼ºåˆ¶è¦†ç›–ï¼‰
        if [ -s files_to_modify.txt ]; then
          echo "=== ä¿®æ”¹æ–‡ä»¶ï¼ˆå¼ºåˆ¶è¦†ç›–ï¼‰==="
          while IFS= read -r file; do
            [ -z "$file" ] && continue
            
            if [ -f "source-files/$file" ] && [ -s "source-files/$file" ]; then
              mkdir -p "target-repo/$(dirname "$file")"
              if cp -f "source-files/$file" "target-repo/$file"; then
                modified_count=$((modified_count + 1))
                echo "âœï¸  ä¿®æ”¹: $file"
              else
                error_count=$((error_count + 1))
                echo "âŒ ä¿®æ”¹å¤±è´¥: $file"
              fi
            else
              echo "â­ï¸  è·³è¿‡ä¿®æ”¹: $file (æºæ–‡ä»¶ä¸å­˜åœ¨æˆ–ä¸ºç©º)"
            fi
          done < files_to_modify.txt
        fi
        
        echo "added_count=$added_count" >> $GITHUB_OUTPUT
        echo "modified_count=$modified_count" >> $GITHUB_OUTPUT
        echo "deleted_count=$deleted_count" >> $GITHUB_OUTPUT
        echo "error_count=$error_count" >> $GITHUB_OUTPUT
        
        echo "âœ… åŒæ­¥å®Œæˆ:"
        echo "   æ–°å¢æ–‡ä»¶: $added_count ä¸ª"
        echo "   ä¿®æ”¹æ–‡ä»¶: $modified_count ä¸ª"
        echo "   åˆ é™¤æ–‡ä»¶: $deleted_count ä¸ª"
        echo "   é”™è¯¯æ“ä½œ: $error_count ä¸ª"

    - name: ğŸ’¾ æäº¤å˜æ›´
      id: commit-changes
      run: |
        cd target-repo
        
        echo "=== æäº¤å˜æ›´ ==="
        
        if git diff-index --quiet HEAD --; then
          echo "â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "ğŸ“ å‘ç°å˜æ›´ï¼Œå‡†å¤‡æäº¤..."
          
          git add -A
          
          # è·å–å˜æ›´ç»Ÿè®¡
          CHANGED_FILES=$(git diff --name-only --cached)
          CHANGED_COUNT=$(echo "$CHANGED_FILES" | wc -l)
          
          echo "å˜æ›´æ–‡ä»¶ ($CHANGED_COUNT ä¸ª):"
          echo "$CHANGED_FILES" | head -20
          if [ $CHANGED_COUNT -gt 20 ]; then
            echo "... (è¿˜æœ‰ $((CHANGED_COUNT - 20)) ä¸ªæ–‡ä»¶)"
          fi
          
          # åˆ›å»ºæäº¤ä¿¡æ¯
          commit_msg="${{ github.event.inputs.commit_title }}"
          
          if [ -n "${{ github.event.inputs.commit_description }}" ]; then
            commit_msg="$commit_msg"$'\n'$'\n'"${{ github.event.inputs.commit_description }}"
          fi
          
          git commit -m "$commit_msg"
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "changed_files_count=$CHANGED_COUNT" >> $GITHUB_OUTPUT
          echo "âœ… æäº¤åˆ›å»ºæˆåŠŸ"
        fi

    - name: ğŸš€ æ¨é€æ›´æ”¹
      if: steps.commit-changes.outputs.has_changes == 'true'
      run: |
        cd target-repo
        
        echo "=== æ¨é€æ›´æ”¹ ==="
        
        git push origin "${{ github.event.inputs.target_branch }}"
        echo "âœ… æ¨é€æˆåŠŸ"

    - name: ğŸ“‹ ç”Ÿæˆè¯¦ç»†æŠ¥å‘Š
      if: always()
      run: |
        cat > "$GITHUB_STEP_SUMMARY" << EOF
        # æäº¤æ–‡ä»¶åŒæ­¥æŠ¥å‘Š
        
        ## æ€»ä½“ç»Ÿè®¡
        - **åˆ†ææäº¤**: ${{ steps.parse-commit-urls.outputs.commits_count }} ä¸ª
        - **æäº¤ä¸­å˜æ›´æ–‡ä»¶**: ${{ steps.get-commit-files.outputs.commit_files_count }} ä¸ª
        - **ä¸‹è½½ç»“æœ**: ${{ steps.download-commit-files.outputs.downloaded_count }} æˆåŠŸ, ${{ steps.download-commit-files.outputs.failed_count }} å¤±è´¥
        - **æ–‡ä»¶æ“ä½œ**: ${{ steps.sync-commit-files.outputs.added_count }} æ–°å¢, ${{ steps.sync-commit-files.outputs.modified_count }} ä¿®æ”¹, ${{ steps.sync-commit-files.outputs.deleted_count }} åˆ é™¤
        - **æœ€ç»ˆæäº¤**: ${{ steps.commit-changes.outputs.changed_files_count || '0' }} ä¸ªæ–‡ä»¶
        - **æ“ä½œçŠ¶æ€**: ${{ steps.commit-changes.outputs.has_changes == 'true' && 'âœ… æˆåŠŸæäº¤' || 'â„¹ï¸ æ— å˜æ›´' }}
        
        ## è¯¦ç»†æ“ä½œè®°å½•
        EOF
        
        # æ˜¾ç¤ºæäº¤ä¸­çš„æ–‡ä»¶
        if [ -s all_commit_files.txt ]; then
          echo "### ğŸ“„ æäº¤ä¸­å˜æ›´çš„æ–‡ä»¶ (${{ steps.get-commit-files.outputs.commit_files_count }} ä¸ª)" >> "$GITHUB_STEP_SUMMARY"
          while IFS= read -r file; do
            echo "- \`$file\`" >> "$GITHUB_STEP_SUMMARY"
          done < all_commit_files.txt
          echo "" >> "$GITHUB_STEP_SUMMARY"
        fi
        
        # æ˜¾ç¤ºä¸‹è½½å¤±è´¥çš„æ–‡ä»¶
        if [ -s all_commit_files.txt ] && [ "${{ steps.download-commit-files.outputs.failed_count }}" != "0" ]; then
          echo "### âŒ ä¸‹è½½å¤±è´¥çš„æ–‡ä»¶ (${{ steps.download-commit-files.outputs.failed_count }} ä¸ª)" >> "$GITHUB_STEP_SUMMARY"
          while IFS= read -r file; do
            if [ ! -f "source-files/$file" ] || [ ! -s "source-files/$file" ]; then
              echo "- \`$file\`" >> "$GITHUB_STEP_SUMMARY"
            fi
          done < all_commit_files.txt
          echo "" >> "$GITHUB_STEP_SUMMARY"
        fi
        
        cat >> "$GITHUB_STEP_SUMMARY" << EOF
        ## æ“ä½œè¯´æ˜
        - **åªå¤„ç†æäº¤ä¸­å˜æ›´çš„æ–‡ä»¶**ï¼Œä¸å¤„ç†æ•´ä¸ªä»“åº“
        - **å¼ºåˆ¶è¦†ç›–**ä¿®æ”¹çš„æ–‡ä»¶ï¼Œä¸æ¯”è¾ƒå†…å®¹
        - **ç²¾ç¡®åŒæ­¥**æ–°å¢å’Œåˆ é™¤çš„æ–‡ä»¶
        
        **æ‰§è¡Œæ—¶é—´**: é¢„è®¡2-3åˆ†é’Ÿ
        EOF

    - name: ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶
      if: always()
      run: |
        rm -rf source-files
        rm -f commit_hashes.txt repo_names.txt all_commit_files.txt
        rm -f files_to_add.txt files_to_modify.txt files_to_delete.txt 2>/dev/null || true

name: Delete Files from Commits - Mozi9 Identity

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: 'æºä»“åº“åœ°å€ (æ ¼å¼: owner/repo)'
        required: true
        default: 'owner/source-repo'
      target_repo:
        description: 'ç›®æ ‡ä»“åº“åœ°å€ (æ ¼å¼: owner/repo)'
        required: true
        default: 'owner/target-repo'
      source_branch:
        description: 'æºåˆ†æ”¯å'
        required: true
        default: 'main'
      target_branch:
        description: 'ç›®æ ‡åˆ†æ”¯å'
        required: true
        default: 'main'
      commit_hashes:
        description: 'æäº¤å“ˆå¸Œï¼ˆå¤šä¸ªç”¨é€—å·åˆ†éš”ï¼‰'
        required: true
        default: 'abc123,def456'
      commit_message:
        description: 'åˆ é™¤æ“ä½œçš„æäº¤ä¿¡æ¯'
        required: true
        default: 'chore: åˆ é™¤æäº¤ä¸­çš„æ–‡ä»¶'
      max_commits:
        description: 'æœ€å¤§å¤„ç†æäº¤æ•°é‡'
        required: true
        default: '50'

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  delete-files-from-commits:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout target repository
      uses: actions/checkout@v4
      with:
        repository: ${{ github.event.inputs.target_repo }}
        token: ${{ secrets.Mozi9_PAT }}
        ref: ${{ github.event.inputs.target_branch }}
        fetch-depth: 0

    - name: Add source repository as remote
      run: |
        echo "ğŸ”— æ·»åŠ æºä»“åº“..."
        git remote add source-repo https://github.com/${{ github.event.inputs.source_repo }}.git
        git fetch source-repo ${{ github.event.inputs.source_branch }} --depth=100
        echo "âœ… æºä»“åº“æ·»åŠ å®Œæˆ"

    - name: Setup Mozi9 Git identity
      run: |
        echo "âš™ï¸ é…ç½® Mozi9 Git èº«ä»½..."
        git config --global user.name "mozi9"
        git config --global user.email "mozi9"
        git config --global push.default simple
        echo "âœ… Gitèº«ä»½å·²è®¾ç½®ä¸º: mozi9 <mozi9>"

    - name: Parse and validate commit hashes
      id: parse_commits
      run: |
        echo "ğŸ” éªŒè¯æäº¤å“ˆå¸Œ..."
        COMMIT_HASHES=$(echo '${{ github.event.inputs.commit_hashes }}' | tr -d '[:space:]' | tr ',' ' ')
        
        VALID_COMMITS=()
        INVALID_COMMITS=()
        
        for commit in $COMMIT_HASHES; do
          if git rev-parse --verify "$commit" >/dev/null 2>&1; then
            COMMIT_SUBJECT=$(git log -1 --format="%s" "$commit" 2>/dev/null || echo "æ— æ³•è·å–æäº¤ä¿¡æ¯")
            echo "âœ… æäº¤æœ‰æ•ˆ: $commit - $COMMIT_SUBJECT"
            VALID_COMMITS+=("$commit")
          else
            echo "âŒ æäº¤æ— æ•ˆ: $commit"
            INVALID_COMMITS+=("$commit")
          fi
        done
        
        if [ ${#VALID_COMMITS[@]} -eq 0 ]; then
          echo "âŒ é”™è¯¯: æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„æäº¤"
          exit 1
        fi
        
        # é™åˆ¶æäº¤æ•°é‡
        MAX_COMMITS=${{ github.event.inputs.max_commits }}
        if [ ${#VALID_COMMITS[@]} -gt $MAX_COMMITS ]; then
          echo "âš ï¸ è­¦å‘Š: æäº¤æ•°é‡ ${#VALID_COMMITS[@]} è¶…è¿‡æœ€å¤§é™åˆ¶ $MAX_COMMITS"
          VALID_COMMITS=("${VALID_COMMITS[@]:0:$MAX_COMMITS}")
        fi
        
        printf "%s\n" "${VALID_COMMITS[@]}" > /tmp/valid_commits.txt
        echo "commit_count=${#VALID_COMMITS[@]}" >> $GITHUB_OUTPUT
        echo "ğŸ“Š å°†å¤„ç† ${#VALID_COMMITS[@]} ä¸ªæœ‰æ•ˆæäº¤"

    - name: Extract files from source commits
      id: extract_files
      run: |
        echo "ğŸ“ ä»æºæäº¤æå–æ–‡ä»¶åˆ—è¡¨..."
        COMMITS=$(cat /tmp/valid_commits.txt)
        
        ALL_FILES=""
        
        for COMMIT in $COMMITS; do
          echo "ğŸ“ åˆ†ææäº¤: $COMMIT"
          
          # è·å–æäº¤ä¸­çš„æ‰€æœ‰æ–‡ä»¶ï¼ˆåŒ…æ‹¬æ–°å¢ã€ä¿®æ”¹ã€åˆ é™¤çš„æ–‡ä»¶ï¼‰
          COMMIT_FILES=$(git show --name-only --format= "$COMMIT" 2>/dev/null | grep -v '^$' || true)
          
          if [ -n "$COMMIT_FILES" ]; then
            FILE_COUNT_IN_COMMIT=$(echo "$COMMIT_FILES" | wc -l)
            echo "  åŒ…å«æ–‡ä»¶: $FILE_COUNT_IN_COMMIT ä¸ª"
            ALL_FILES="$ALL_FILES"$'\n'"$COMMIT_FILES"
          else
            echo "  â„¹ï¸ æäº¤ä¸­æ²¡æœ‰æ–‡ä»¶å˜æ›´"
          fi
        done
        
        # å»é‡å¹¶æ’åº
        UNIQUE_FILES=$(echo "$ALL_FILES" | sort | uniq | grep -v '^$')
        UNIQUE_COUNT=$(echo "$UNIQUE_FILES" | wc -l)
        
        echo "$UNIQUE_FILES" > /tmp/files_from_commits.txt
        echo "ğŸ“Š æå–å®Œæˆ: å»é‡åæ–‡ä»¶æ•°: $UNIQUE_COUNT"
        echo "unique_file_count=$UNIQUE_COUNT" >> $GITHUB_OUTPUT

    - name: Delete files from target repository
      id: delete_files
      run: |
        echo "ğŸ—‘ï¸ ä»ç›®æ ‡ä»“åº“åˆ é™¤æ–‡ä»¶..."
        FILES_TO_DELETE=$(cat /tmp/files_from_commits.txt)
        
        DELETED_COUNT=0
        FAILED_COUNT=0
        NOT_FOUND_COUNT=0
        
        for file in $FILES_TO_DELETE; do
          if [ ! -e "$file" ]; then
            NOT_FOUND_COUNT=$((NOT_FOUND_COUNT + 1))
            continue
          fi
          
          if [ -f "$file" ]; then
            if rm -f "$file"; then
              DELETED_COUNT=$((DELETED_COUNT + 1))
            else
              FAILED_COUNT=$((FAILED_COUNT + 1))
            fi
          elif [ -d "$file" ]; then
            if rm -rf "$file"; then
              DELETED_COUNT=$((DELETED_COUNT + 1))
            else
              FAILED_COUNT=$((FAILED_COUNT + 1))
            fi
          fi
        done
        
        echo "ğŸ“Š åˆ é™¤æ“ä½œå®Œæˆ:"
        echo "  æˆåŠŸåˆ é™¤: $DELETED_COUNT ä¸ª"
        echo "  åˆ é™¤å¤±è´¥: $FAILED_COUNT ä¸ª"
        echo "  æ–‡ä»¶ä¸å­˜åœ¨: $NOT_FOUND_COUNT ä¸ª"
        
        echo "deleted_count=$DELETED_COUNT" >> $GITHUB_OUTPUT
        echo "failed_count=$FAILED_COUNT" >> $GITHUB_OUTPUT
        echo "not_found_count=$NOT_FOUND_COUNT" >> $GITHUB_OUTPUT

    - name: Stage changes in Git
      id: stage_changes
      run: |
        echo "ğŸ“¦ æš‚å­˜å˜æ›´åˆ° Git..."
        git add -A
        
        STAGED_COUNT=$(git diff --cached --name-only | wc -l)
        if [ "$STAGED_COUNT" -eq 0 ]; then
          echo "â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "âœ… æ£€æµ‹åˆ° $STAGED_COUNT ä¸ªæ–‡ä»¶å˜æ›´"
          echo "has_changes=true" >> $GITHUB_OUTPUT
        fi

    - name: Commit changes as Mozi9
      id: commit_changes
      if: steps.stage_changes.outputs.has_changes == 'true'
      run: |
        echo "ğŸ’¾ åˆ›å»ºæäº¤..."
        
        # åªä½¿ç”¨ç”¨æˆ·æä¾›çš„æäº¤ä¿¡æ¯ï¼Œä¸æ·»åŠ é¢å¤–æŠ¥å‘Š
        COMMIT_MSG="${{ github.event.inputs.commit_message }}"
        
        # ç®€æ´çš„æäº¤
        git commit -m "$COMMIT_MSG" --author="mozi9 <mozi9>"
        
        echo "âœ… æäº¤åˆ›å»ºå®Œæˆ"
        echo "commit_hash=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

    - name: Push changes with Mozi9 token
      id: push_changes
      if: steps.stage_changes.outputs.has_changes == 'true'
      run: |
        echo "ğŸš€ æ¨é€åˆ°è¿œç¨‹ä»“åº“..."
        
        CURRENT_BRANCH=$(git branch --show-current)
        TARGET_REPO="${{ github.event.inputs.target_repo }}"
        
        git push https://mozi9:${{ secrets.Mozi9_PAT }}@github.com/$TARGET_REPO.git $CURRENT_BRANCH
        
        echo "âœ… æ¨é€å®Œæˆ"

    - name: Generate final report
      run: |
        echo ""
        echo "ğŸ‰ æ ¹æ®æäº¤åˆ é™¤æ–‡ä»¶æµç¨‹å®Œæˆ!"
        echo "=========================================="
        echo "ğŸ“Š æ‰§è¡ŒæŠ¥å‘Š:"
        echo "  æºä»“åº“: ${{ github.event.inputs.source_repo }}"
        echo "  ç›®æ ‡ä»“åº“: ${{ github.event.inputs.target_repo }}"
        echo "  å¤„ç†æäº¤: ${{ steps.parse_commits.outputs.commit_count }} ä¸ª"
        echo "  æå–æ–‡ä»¶: ${{ steps.extract_files.outputs.unique_file_count }} ä¸ª(å»é‡å)"
        echo "  æˆåŠŸåˆ é™¤: ${{ steps.delete_files.outputs.deleted_count || 0 }} ä¸ª"
        echo "  æ–‡ä»¶ä¸å­˜åœ¨: ${{ steps.delete_files.outputs.not_found_count || 0 }} ä¸ª"
        echo "  åˆ é™¤å¤±è´¥: ${{ steps.delete_files.outputs.failed_count || 0 }} ä¸ª"
        
        if [ "${{ steps.stage_changes.outputs.has_changes }}" = "true" ]; then
          echo "  Git æäº¤: âœ… å·²åˆ›å»º"
          echo "  æäº¤ä¿¡æ¯: ${{ github.event.inputs.commit_message }}"
          echo "  æ¨é€çŠ¶æ€: âœ… å·²æ¨é€"
        else
          echo "  Git æäº¤: â„¹ï¸ æ— å˜æ›´"
          echo "  æ¨é€çŠ¶æ€: â„¹ï¸ æ— éœ€æ¨é€"
        fi
        
        echo ""
        echo "ğŸ“‹ å¤„ç†çš„æäº¤åˆ—è¡¨:"
        cat /tmp/valid_commits.txt | while read commit; do
          if [ -n "$commit" ]; then
            SUBJECT=$(git log -1 --format="%s" "$commit" 2>/dev/null || echo "æœªçŸ¥æäº¤")
            echo "  $commit - $SUBJECT"
          fi
        done
        
        echo ""
        echo "â° å®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "=========================================="

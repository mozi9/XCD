name: Repository File Sync

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: 'æºä»“åº“åœ°å€ (æ ¼å¼: owner/repo æˆ–å®Œæ•´URL)'
        required: true
        default: 'https://github.com/owner/source-repo'
      source_commits:
        description: 'æºæäº¤å“ˆå¸Œåˆ—è¡¨ (é€—å·åˆ†éš”çš„çŸ­å“ˆå¸Œæˆ–å®Œæ•´å“ˆå¸Œ)'
        required: true
        default: ''
      target_repo:
        description: 'ç›®æ ‡ä»“åº“åœ°å€ (æ ¼å¼: owner/repo æˆ–å®Œæ•´URL)'
        required: true
        default: 'https://github.com/owner/target-repo'
      target_branch:
        description: 'ç›®æ ‡åˆ†æ”¯å'
        required: false
        default: 'main'
      commit_name:
        description: 'æäº¤æ˜¾ç¤ºåç§° (ç•™ç©ºä½¿ç”¨é»˜è®¤mozi9)'
        required: false
        default: ''
      commit_message:
        description: 'æäº¤ä¿¡æ¯'
        required: true
        default: 'Sync from source repository'
      sync_author_name:
        description: 'åŒæ­¥æäº¤ä½œè€…å (ç•™ç©ºä½¿ç”¨é»˜è®¤mozi9)'
        required: false
        default: ''
      sync_author_email:
        description: 'åŒæ­¥æäº¤ä½œè€…é‚®ç®± (ç•™ç©ºä½¿ç”¨é»˜è®¤mozi9)'
        required: false
        default: ''

env:
  PAT: ${{ secrets.MOZI9_PAT }}
  GIT_USER: 'mozi9'
  GIT_EMAIL: 'mozi9'

jobs:
  sync-repo:
    runs-on: ubuntu-latest
    
    steps:
    - name: è§£æä»“åº“åœ°å€
      id: parse_urls
      run: |
        extract_repo() {
          local url="$1"
          if [[ $url == http* ]] && [[ $url == *"github.com"* ]]; then
            echo "$url" | sed -n 's|.*github.com/\([^/]*/[^/?]*\).*|\1|p'
          else
            echo "$url"
          fi
        }
        
        SOURCE_REPO=$(extract_repo "${{ github.event.inputs.source_repo }}")
        TARGET_REPO=$(extract_repo "${{ github.event.inputs.target_repo }}")
        
        echo "source_repo=$SOURCE_REPO" >> $GITHUB_OUTPUT
        echo "target_repo=$TARGET_REPO" >> $GITHUB_OUTPUT
        echo "target_branch=${{ github.event.inputs.target_branch || 'main' }}" >> $GITHUB_OUTPUT
        
    - name: è®¾ç½®æäº¤è€…ä¿¡æ¯
      id: set_commit_info
      run: |
        # è®¾ç½®æäº¤æ˜¾ç¤ºåç§°
        COMMIT_NAME="${{ github.event.inputs.commit_name }}"
        if [ -z "$COMMIT_NAME" ]; then
          COMMIT_NAME="mozi9"
        fi
        echo "commit_name=$COMMIT_NAME" >> $GITHUB_OUTPUT
        
        # è®¾ç½®æäº¤ä½œè€…å
        AUTHOR_NAME="${{ github.event.inputs.sync_author_name }}"
        if [ -z "$AUTHOR_NAME" ]; then
          AUTHOR_NAME="mozi9"
        fi
        echo "author_name=$AUTHOR_NAME" >> $GITHUB_OUTPUT
        
        # è®¾ç½®æäº¤ä½œè€…é‚®ç®±
        AUTHOR_EMAIL="${{ github.event.inputs.sync_author_email }}"
        if [ -z "$AUTHOR_EMAIL" ]; then
          AUTHOR_EMAIL="mozi9"
        fi
        echo "author_email=$AUTHOR_EMAIL" >> $GITHUB_OUTPUT
        
        echo "ğŸ“ æäº¤ä¿¡æ¯é…ç½®:"
        echo "  æäº¤æ˜¾ç¤ºåç§°: $COMMIT_NAME"
        echo "  æäº¤ä½œè€…å: $AUTHOR_NAME"
        echo "  æäº¤ä½œè€…é‚®ç®±: $AUTHOR_EMAIL"
        
    - name: åˆ›å»ºä¸´æ—¶å·¥ä½œç›®å½•
      run: |
        echo "åˆ›å»ºä¸´æ—¶å·¥ä½œç›®å½•..."
        mkdir -p /tmp/sync_workspace
        cd /tmp/sync_workspace
        git init
        git config user.name "${{ steps.set_commit_info.outputs.author_name }}"
        git config user.email "${{ steps.set_commit_info.outputs.author_email }}"
        
    - name: æ·»åŠ æºä»“åº“è¿œç¨‹
      run: |
        cd /tmp/sync_workspace
        git remote add source https://${{ env.PAT }}@github.com/${{ steps.parse_urls.outputs.source_repo }}.git
        
    - name: è§£æå’ŒéªŒè¯æäº¤åˆ—è¡¨
      id: parse_commits
      run: |
        cd /tmp/sync_workspace
        COMMITS_INPUT="${{ github.event.inputs.source_commits }}"
        
        if [ -z "$COMMITS_INPUT" ]; then
          echo "âŒ é”™è¯¯ï¼šå¿…é¡»æä¾›æºæäº¤å“ˆå¸Œåˆ—è¡¨"
          exit 1
        fi
        
        # æ¸…ç†è¾“å…¥ï¼Œåˆ†å‰²ä¸ºæ•°ç»„
        CLEANED_COMMITS=$(echo "$COMMITS_INPUT" | tr -d '[:space:]')
        IFS=',' read -ra COMMIT_ARRAY <<< "$CLEANED_COMMITS"
        
        echo "è§£æåˆ° ${#COMMIT_ARRAY[@]} ä¸ªæäº¤å“ˆå¸Œ: ${COMMIT_ARRAY[*]}"
        
        # éªŒè¯æ¯ä¸ªæäº¤å¹¶è·å–å®Œæ•´å“ˆå¸Œ
        VALID_COMMITS=()
        
        for commit in "${COMMIT_ARRAY[@]}"; do
          if [ -n "$commit" ]; then
            # è·å–æäº¤å…ƒæ•°æ®ï¼ˆä¸ä¸‹è½½æ–‡ä»¶å†…å®¹ï¼‰
            if git fetch source --depth=1 $commit 2>/dev/null; then
              if git cat-file -e $commit 2>/dev/null; then
                FULL_HASH=$(git rev-parse $commit)
                if [ "$(git cat-file -t $FULL_HASH)" = "commit" ]; then
                  VALID_COMMITS+=("$FULL_HASH")
                  echo "âœ… è·å–å¹¶éªŒè¯æäº¤: $commit -> $FULL_HASH"
                else
                  echo "âŒ æ— æ•ˆæäº¤å¯¹è±¡: $commit"
                fi
              else
                echo "âŒ æäº¤ä¸å­˜åœ¨: $commit"
              fi
            else
              echo "âŒ æ— æ³•è·å–æäº¤: $commit"
            fi
          fi
        done
        
        if [ ${#VALID_COMMITS[@]} -eq 0 ]; then
          echo "âŒ é”™è¯¯ï¼šæ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„æäº¤"
          exit 1
        fi
        
        COMMITS_CSV=$(IFS=','; echo "${VALID_COMMITS[*]}")
        echo "commits_csv=$COMMITS_CSV" >> $GITHUB_OUTPUT
        echo "commits_count=${#VALID_COMMITS[@]}" >> $GITHUB_OUTPUT
        
    - name: ä»æŒ‡å®šæäº¤ä¸­æå–æ–‡ä»¶åˆ—è¡¨ï¼ˆå»é‡ï¼‰
      id: extract_files
      run: |
        cd /tmp/sync_workspace
        IFS=',' read -ra COMMITS <<< "${{ steps.parse_commits.outputs.commits_csv }}"
        
        echo "=== ä»æŒ‡å®šæäº¤æå–æ–‡ä»¶åˆ—è¡¨ï¼ˆå»é‡ï¼‰==="
        
        # ä½¿ç”¨å…³è”æ•°ç»„å­˜å‚¨æ–‡ä»¶ï¼ˆè‡ªåŠ¨å»é‡ï¼‰
        declare -A UNIQUE_FILES_MAP
        declare -A FILE_SOURCES  # è®°å½•æ–‡ä»¶æ¥æºæäº¤
        
        COMMIT_INDEX=0
        TOTAL_FILES=0
        
        for commit in "${COMMITS[@]}"; do
          COMMIT_INDEX=$((COMMIT_INDEX + 1))
          echo ""
          echo "ğŸ“ å¤„ç†æäº¤ $COMMIT_INDEX/${#COMMITS[@]}: ${commit:0:8}"
          
          # è·å–è¯¥æäº¤çš„æ–‡ä»¶åˆ—è¡¨ï¼ˆåªè·å–å…ƒæ•°æ®ï¼Œä¸ä¸‹è½½æ–‡ä»¶å†…å®¹ï¼‰
          COMMIT_FILES=$(git ls-tree -r --name-only $commit)
          FILE_COUNT=$(echo "$COMMIT_FILES" | wc -l)
          TOTAL_FILES=$((TOTAL_FILES + FILE_COUNT))
          
          echo "æäº¤åŒ…å« $FILE_COUNT ä¸ªæ–‡ä»¶"
          
          # æ·»åŠ åˆ°å”¯ä¸€æ–‡ä»¶æ˜ å°„
          while IFS= read -r file; do
            if [ -n "$file" ]; then
              UNIQUE_FILES_MAP["$file"]=1
              # è®°å½•æ–‡ä»¶æ¥æºï¼ˆä½¿ç”¨æœ€åä¸€ä¸ªåŒ…å«è¯¥æ–‡ä»¶çš„æäº¤ï¼‰
              FILE_SOURCES["$file"]=$commit
            fi
          done <<< "$COMMIT_FILES"
          
          # æ˜¾ç¤ºæäº¤ä¿¡æ¯
          COMMIT_MSG=$(git show --no-patch --format="%s" $commit 2>/dev/null || echo "æ— æ³•è·å–æäº¤ä¿¡æ¯")
          echo "æäº¤ä¿¡æ¯: $COMMIT_MSG"
        done
        
        # è½¬æ¢ä¸ºæ•°ç»„
        UNIQUE_FILES=("${!UNIQUE_FILES_MAP[@]}")
        UNIQUE_FILE_COUNT=${#UNIQUE_FILES[@]}
        
        echo ""
        echo "ğŸ“Š æ–‡ä»¶æå–ç»Ÿè®¡:"
        echo "  å¤„ç†æäº¤æ•°: ${#COMMITS[@]}"
        echo "  æ€»æ–‡ä»¶æ•°ï¼ˆå»é‡å‰ï¼‰: $TOTAL_FILES"
        echo "  å”¯ä¸€æ–‡ä»¶æ•°ï¼ˆå»é‡åï¼‰: $UNIQUE_FILE_COUNT"
        echo "  å»é‡ç‡: $(( (TOTAL_FILES - UNIQUE_FILE_COUNT) * 100 / TOTAL_FILES ))%"
        
        # ä¿å­˜æ–‡ä»¶åˆ—è¡¨å’Œæ¥æºä¿¡æ¯
        printf "%s\n" "${UNIQUE_FILES[@]}" > /tmp/unique_files.txt
        
        # ä¿å­˜æ–‡ä»¶æ¥æºæ˜ å°„
        for file in "${UNIQUE_FILES[@]}"; do
          echo "$file|${FILE_SOURCES[$file]}" >> /tmp/file_sources.txt
        done
        
        echo "file_count=$UNIQUE_FILE_COUNT" >> $GITHUB_OUTPUT
        
        # æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨é¢„è§ˆ
        echo ""
        echo "ğŸ“ å”¯ä¸€æ–‡ä»¶åˆ—è¡¨é¢„è§ˆ:"
        printf "%s\n" "${UNIQUE_FILES[@]}" | head -10
        if [ $UNIQUE_FILE_COUNT -gt 10 ]; then
          echo "... è¿˜æœ‰ $((UNIQUE_FILE_COUNT - 10)) ä¸ªæ–‡ä»¶"
        fi
        
    - name: æ£€å‡ºç›®æ ‡ä»“åº“ï¼ˆå‡†å¤‡åŒæ­¥ï¼‰
      run: |
        echo "=== æ£€å‡ºç›®æ ‡ä»“åº“ ==="
        cd /tmp/sync_workspace
        
        # æ·»åŠ ç›®æ ‡ä»“åº“è¿œç¨‹
        git remote add target https://${{ env.PAT }}@github.com/${{ steps.parse_urls.outputs.target_repo }}.git
        
        # æ£€å‡ºç›®æ ‡ä»“åº“
        git fetch target --depth=1
        git checkout -b sync-branch target/${{ steps.parse_urls.outputs.target_branch }} || git checkout -b sync-branch
        
        echo "âœ… ç›®æ ‡ä»“åº“æ£€å‡ºå®Œæˆ"
        
    - name: æŒ‰æ–‡ä»¶åä»æºä»“åº“è·å–æ–‡ä»¶å†…å®¹
      run: |
        echo "=== ä»æºä»“åº“è·å–æŒ‡å®šæ–‡ä»¶å†…å®¹ ==="
        cd /tmp/sync_workspace
        
        # è¯»å–æ–‡ä»¶åˆ—è¡¨
        mapfile -t UNIQUE_FILES < /tmp/unique_files.txt
        echo "éœ€è¦è·å–çš„æ–‡ä»¶æ•°é‡: ${#UNIQUE_FILES[@]}"
        
        # è¯»å–æ–‡ä»¶æ¥æºæ˜ å°„
        declare -A FILE_SOURCES
        while IFS='|' read -r file commit; do
          FILE_SOURCES["$file"]=$commit
        done < /tmp/file_sources.txt
        
        SUCCESS_COUNT=0
        FAIL_COUNT=0
        
        # é€ä¸ªæ–‡ä»¶ä»æºä»“åº“è·å–
        for file in "${UNIQUE_FILES[@]}"; do
          SOURCE_COMMIT="${FILE_SOURCES[$file]}"
          if [ -n "$SOURCE_COMMIT" ]; then
            # ç¡®ä¿ç›®å½•å­˜åœ¨
            mkdir -p "$(dirname "$file")"
            
            # ä»æºä»“åº“çš„ç‰¹å®šæäº¤è·å–æ–‡ä»¶
            if git show "$SOURCE_COMMIT:$file" > "$file" 2>/dev/null; then
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
              echo "âœ… [$SUCCESS_COUNT] è·å–: $file (æ¥è‡ª ${SOURCE_COMMIT:0:8})"
            else
              FAIL_COUNT=$((FAIL_COUNT + 1))
              echo "âŒ è·å–å¤±è´¥: $file"
            fi
          else
            FAIL_COUNT=$((FAIL_COUNT + 1))
            echo "âŒ æ‰¾ä¸åˆ°æ–‡ä»¶æ¥æº: $file"
          fi
        done
        
        echo "æ–‡ä»¶è·å–å®Œæˆ: æˆåŠŸ $SUCCESS_COUNT, å¤±è´¥ $FAIL_COUNT"
        
    - name: åˆ é™¤ç›®æ ‡ä»“åº“å¤šä½™æ–‡ä»¶
      run: |
        echo "=== æ¸…ç†ç›®æ ‡ä»“åº“å¤šä½™æ–‡ä»¶ ==="
        cd /tmp/sync_workspace
        
        # è¯»å–éœ€è¦ä¿ç•™çš„æ–‡ä»¶åˆ—è¡¨
        mapfile -t UNIQUE_FILES < /tmp/unique_files.txt
        
        # è·å–ç›®æ ‡ä»“åº“å½“å‰æ–‡ä»¶
        TARGET_FILES=$(git ls-files)
        
        DELETE_COUNT=0
        ERROR_COUNT=0
        
        for file in $TARGET_FILES; do
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦åœ¨éœ€è¦ä¿ç•™çš„åˆ—è¡¨ä¸­
          FILE_EXISTS=0
          for keep_file in "${UNIQUE_FILES[@]}"; do
            if [ "$file" = "$keep_file" ]; then
              FILE_EXISTS=1
              break
            fi
          done
          
          if [ $FILE_EXISTS -eq 0 ]; then
            if git rm --cached "$file" 2>/dev/null || rm -f "$file" 2>/dev/null; then
              DELETE_COUNT=$((DELETE_COUNT + 1))
              echo "ğŸ—‘ï¸ åˆ é™¤: $file"
            else
              ERROR_COUNT=$((ERROR_COUNT + 1))
              echo "âš ï¸ åˆ é™¤å¤±è´¥: $file"
            fi
          fi
        done
        
        echo "æ¸…ç†å®Œæˆ: åˆ é™¤ $DELETE_COUNT ä¸ªæ–‡ä»¶, å¤±è´¥ $ERROR_COUNT ä¸ª"
        
    - name: æ·»åŠ è·å–çš„æ–‡ä»¶åˆ°Gitç´¢å¼•
      run: |
        echo "=== æ·»åŠ æ–‡ä»¶åˆ°Gitç´¢å¼• ==="
        cd /tmp/sync_workspace
        
        # è¯»å–æ–‡ä»¶åˆ—è¡¨
        mapfile -t UNIQUE_FILES < /tmp/unique_files.txt
        
        ADD_COUNT=0
        for file in "${UNIQUE_FILES[@]}"; do
          if [ -f "$file" ]; then
            git add "$file"
            ADD_COUNT=$((ADD_COUNT + 1))
            echo "âœ… æ·»åŠ : $file"
          else
            echo "âš ï¸ æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡: $file"
          fi
        done
        
        echo "æ·»åŠ å®Œæˆ: $ADD_COUNT ä¸ªæ–‡ä»¶"
        
    - name: æäº¤åŒæ­¥æ›´æ”¹
      run: |
        echo "=== æäº¤æ–‡ä»¶åŒæ­¥ ==="
        cd /tmp/sync_workspace
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹éœ€è¦æäº¤
        if git diff --cached --quiet && git diff --quiet; then
          echo "ğŸ“ æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶æ›´æ”¹"
        else
          # æ·»åŠ æ‰€æœ‰æ›´æ”¹
          git add -A
          
          # ä½¿ç”¨ç”¨æˆ·æä¾›çš„æäº¤ä¿¡æ¯
          git commit -m "${{ github.event.inputs.commit_message }}"
          echo "âœ… åŒæ­¥æäº¤å®Œæˆ"
        fi
        
    - name: æ¨é€åˆ°ç›®æ ‡ä»“åº“
      run: |
        echo "=== æ¨é€åˆ°ç›®æ ‡ä»“åº“ ==="
        cd /tmp/sync_workspace
        
        if git log target/${{ steps.parse_urls.outputs.target_branch }}..HEAD --oneline | grep -q .; then
          echo "æ¨é€åˆ°ç›®æ ‡ä»“åº“..."
          git push target sync-branch:${{ steps.parse_urls.outputs.target_branch }}
          echo "âœ… æ¨é€å®Œæˆ"
        else
          echo "ğŸ“ æ²¡æœ‰éœ€è¦æ¨é€çš„æ›´æ”¹"
        fi
        
    - name: åˆ›å»ºåŒæ­¥æ ‡ç­¾
      run: |
        cd /tmp/sync_workspace
        TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        TAG_NAME="sync-${TIMESTAMP}"
        git tag -a "$TAG_NAME" -m "åŒæ­¥è‡ª ${{ steps.parse_commits.outputs.commits_count }} ä¸ªæäº¤ - ${{ github.event.inputs.commit_message }}"
        git push target "$TAG_NAME"
        echo "âœ… åŒæ­¥æ ‡ç­¾å·²åˆ›å»º: $TAG_NAME"
        
    - name: æ¸…ç†å·¥ä½œåŒº
      run: |
        rm -f /tmp/unique_files.txt
        rm -f /tmp/file_sources.txt
        rm -rf /tmp/sync_workspace
        
    - name: æ˜¾ç¤ºåŒæ­¥æ‘˜è¦
      run: |
        echo "=== ğŸ‰ æ–‡ä»¶åŒæ­¥å®Œæˆ ==="
        echo ""
        echo "ğŸ“Š åŒæ­¥æ‘˜è¦:"
        echo "  ğŸ“¦ æºä»“åº“: ${{ steps.parse_urls.outputs.source_repo }}"
        echo "  ğŸ”— å¤„ç†æäº¤æ•°: ${{ steps.parse_commits.outputs.commits_count }}"
        echo "  ğŸ“ åŒæ­¥æ–‡ä»¶æ•°: ${{ steps.extract_files.outputs.file_count }}"
        echo "  ğŸ¯ ç›®æ ‡ä»“åº“: ${{ steps.parse_urls.outputs.target_repo }}"
        echo "  ğŸŒ¿ ç›®æ ‡åˆ†æ”¯: ${{ steps.parse_urls.outputs.target_branch }}"
        echo "  ğŸ‘¤ æäº¤ä½œè€…: ${{ steps.set_commit_info.outputs.author_name }}"
        echo "  ğŸ’¬ æäº¤ä¿¡æ¯: ${{ github.event.inputs.commit_message }}"
        echo ""
        echo "âš¡ åŒæ­¥ç­–ç•¥:"
        echo "  âœ… ä¸´æ—¶å·¥ä½œç›®å½•å¤„ç†"
        echo "  âœ… å…ˆåˆ†ææºä»“åº“æ–‡ä»¶"
        echo "  âœ… åæ£€å‡ºç›®æ ‡ä»“åº“"
        echo "  âœ… ç²¾ç¡®æ–‡ä»¶çº§åŒæ­¥"

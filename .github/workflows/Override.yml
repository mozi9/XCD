name: Repository File Sync

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: 'æºä»“åº“åœ°å€ (æ ¼å¼: owner/repo æˆ–å®Œæ•´URL)'
        required: true
        default: 'https://github.com/owner/source-repo'
      source_commits:
        description: 'æºæäº¤å“ˆå¸Œåˆ—è¡¨ (é€—å·åˆ†éš”çš„çŸ­å“ˆå¸Œæˆ–å®Œæ•´å“ˆå¸Œ)'
        required: true
        default: ''
      target_repo:
        description: 'ç›®æ ‡ä»“åº“åœ°å€ (æ ¼å¼: owner/repo æˆ–å®Œæ•´URL)'
        required: true
        default: 'https://github.com/owner/target-repo'
      target_branch:
        description: 'ç›®æ ‡åˆ†æ”¯å'
        required: false
        default: 'main'
      commit_name:
        description: 'æäº¤æ˜¾ç¤ºåç§° (ç•™ç©ºä½¿ç”¨é»˜è®¤mozi9)'
        required: false
        default: ''
      commit_message:
        description: 'æäº¤ä¿¡æ¯'
        required: true
        default: 'Sync from source repository'
      sync_author_name:
        description: 'åŒæ­¥æäº¤ä½œè€…å (ç•™ç©ºä½¿ç”¨é»˜è®¤mozi9)'
        required: false
        default: ''
      sync_author_email:
        description: 'åŒæ­¥æäº¤ä½œè€…é‚®ç®± (ç•™ç©ºä½¿ç”¨é»˜è®¤mozi9)'
        required: false
        default: ''

env:
  PAT: ${{ secrets.MOZI9_PAT }}
  GIT_USER: 'mozi9'
  GIT_EMAIL: 'mozi9'

jobs:
  sync-repo:
    runs-on: ubuntu-latest
    
    steps:
    - name: è§£æä»“åº“åœ°å€
      id: parse_urls
      run: |
        extract_repo() {
          local url="$1"
          if [[ $url == http* ]] && [[ $url == *"github.com"* ]]; then
            echo "$url" | sed -n 's|.*github.com/\([^/]*/[^/?]*\).*|\1|p'
          else
            echo "$url"
          fi
        }
        
        SOURCE_REPO=$(extract_repo "${{ github.event.inputs.source_repo }}")
        TARGET_REPO=$(extract_repo "${{ github.event.inputs.target_repo }}")
        
        echo "source_repo=$SOURCE_REPO" >> $GITHUB_OUTPUT
        echo "target_repo=$TARGET_REPO" >> $GITHUB_OUTPUT
        echo "target_branch=${{ github.event.inputs.target_branch || 'main' }}" >> $GITHUB_OUTPUT
        
    - name: è®¾ç½®æäº¤è€…ä¿¡æ¯
      id: set_commit_info
      run: |
        # è®¾ç½®æäº¤æ˜¾ç¤ºåç§°
        COMMIT_NAME="${{ github.event.inputs.commit_name }}"
        if [ -z "$COMMIT_NAME" ]; then
          COMMIT_NAME="mozi9"
        fi
        echo "commit_name=$COMMIT_NAME" >> $GITHUB_OUTPUT
        
        # è®¾ç½®æäº¤ä½œè€…å
        AUTHOR_NAME="${{ github.event.inputs.sync_author_name }}"
        if [ -z "$AUTHOR_NAME" ]; then
          AUTHOR_NAME="mozi9"
        fi
        echo "author_name=$AUTHOR_NAME" >> $GITHUB_OUTPUT
        
        # è®¾ç½®æäº¤ä½œè€…é‚®ç®±
        AUTHOR_EMAIL="${{ github.event.inputs.sync_author_email }}"
        if [ -z "$AUTHOR_EMAIL" ]; then
          AUTHOR_EMAIL="mozi9"
        fi
        echo "author_email=$AUTHOR_EMAIL" >> $GITHUB_OUTPUT
        
        echo "ğŸ“ æäº¤ä¿¡æ¯é…ç½®:"
        echo "  æäº¤æ˜¾ç¤ºåç§°: $COMMIT_NAME"
        echo "  æäº¤ä½œè€…å: $AUTHOR_NAME"
        echo "  æäº¤ä½œè€…é‚®ç®±: $AUTHOR_EMAIL"
        
    - name: åˆ›å»ºä¸´æ—¶å·¥ä½œç›®å½•
      run: |
        echo "åˆ›å»ºä¸´æ—¶å·¥ä½œç›®å½•..."
        mkdir -p /tmp/sync_workspace
        cd /tmp/sync_workspace
        git init
        git config user.name "${{ steps.set_commit_info.outputs.author_name }}"
        git config user.email "${{ steps.set_commit_info.outputs.author_email }}"
        echo "âœ… ä¸´æ—¶å·¥ä½œç›®å½•å·²åˆ›å»º"
        
    - name: æ·»åŠ æºä»“åº“è¿œç¨‹
      run: |
        cd /tmp/sync_workspace
        git remote add source https://${{ env.PAT }}@github.com/${{ steps.parse_urls.outputs.source_repo }}.git
        echo "âœ… æºä»“åº“è¿œç¨‹å·²æ·»åŠ : ${{ steps.parse_urls.outputs.source_repo }}"
        
    - name: è·å–æºä»“åº“æ•°æ®
      run: |
        cd /tmp/sync_workspace
        echo "å¼€å§‹è·å–æºä»“åº“æ•°æ®..."
        
        # è·å–æºä»“åº“çš„å¼•ç”¨ä¿¡æ¯
        git fetch source --depth=100
        echo "âœ… æºä»“åº“æ•°æ®è·å–å®Œæˆ"
        
    - name: è§£æå’ŒéªŒè¯æäº¤åˆ—è¡¨
      id: parse_commits
      run: |
        cd /tmp/sync_workspace
        COMMITS_INPUT="${{ github.event.inputs.source_commits }}"
        
        if [ -z "$COMMITS_INPUT" ]; then
          echo "âŒ é”™è¯¯ï¼šå¿…é¡»æä¾›æºæäº¤å“ˆå¸Œåˆ—è¡¨"
          exit 1
        fi
        
        # æ¸…ç†è¾“å…¥ï¼Œåˆ†å‰²ä¸ºæ•°ç»„
        CLEANED_COMMITS=$(echo "$COMMITS_INPUT" | tr -d '[:space:]')
        IFS=',' read -ra COMMIT_ARRAY <<< "$CLEANED_COMMITS"
        
        echo "è§£æåˆ° ${#COMMIT_ARRAY[@]} ä¸ªæäº¤å“ˆå¸Œ: ${COMMIT_ARRAY[*]}"
        
        # éªŒè¯æ¯ä¸ªæäº¤å¹¶è·å–å®Œæ•´å“ˆå¸Œ
        VALID_COMMITS=()
        INVALID_COMMITS=()
        
        for commit in "${COMMIT_ARRAY[@]}"; do
          if [ -n "$commit" ]; then
            # å°è¯•å¤šç§æ–¹å¼è§£ææäº¤
            FULL_HASH=""
            
            # æ–¹æ³•1: ç›´æ¥éªŒè¯æäº¤
            if git cat-file -e $commit 2>/dev/null; then
              FULL_HASH=$(git rev-parse $commit)
              if [ "$(git cat-file -t $FULL_HASH)" = "commit" ]; then
                VALID_COMMITS+=("$FULL_HASH")
                echo "âœ… éªŒè¯æäº¤: $commit -> $FULL_HASH"
                continue
              fi
            fi
            
            # æ–¹æ³•2: å°è¯•è·å–æäº¤
            echo "å°è¯•è·å–æäº¤: $commit"
            if git fetch source --depth=1 $commit 2>/dev/null; then
              if git cat-file -e $commit 2>/dev/null; then
                FULL_HASH=$(git rev-parse $commit)
                if [ "$(git cat-file -t $FULL_HASH)" = "commit" ]; then
                  VALID_COMMITS+=("$FULL_HASH")
                  echo "âœ… è·å–å¹¶éªŒè¯æäº¤: $commit -> $FULL_HASH"
                  continue
                fi
              fi
            fi
            
            # æ–¹æ³•3: å°è¯•ä»å¼•ç”¨ä¸­æŸ¥æ‰¾
            echo "å°è¯•ä»å¼•ç”¨ä¸­æŸ¥æ‰¾æäº¤: $commit"
            if git ls-remote source | grep -q "$commit"; then
              # æäº¤å­˜åœ¨ä½†éœ€è¦è·å–
              if git fetch source --depth=1 $commit 2>/dev/null; then
                if git cat-file -e $commit 2>/dev/null; then
                  FULL_HASH=$(git rev-parse $commit)
                  VALID_COMMITS+=("$FULL_HASH")
                  echo "âœ… ä»è¿œç¨‹è·å–æäº¤: $commit -> $FULL_HASH"
                  continue
                fi
              fi
            fi
            
            # æ‰€æœ‰æ–¹æ³•éƒ½å¤±è´¥
            INVALID_COMMITS+=("$commit")
            echo "âŒ æ— æ³•è·å–æäº¤: $commit"
          fi
        done
        
        if [ ${#VALID_COMMITS[@]} -eq 0 ]; then
          echo "âŒ é”™è¯¯ï¼šæ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„æäº¤"
          echo "æ— æ•ˆçš„æäº¤: ${INVALID_COMMITS[*]}"
          exit 1
        fi
        
        if [ ${#INVALID_COMMITS[@]} -gt 0 ]; then
          echo "âš ï¸ è­¦å‘Šï¼šä»¥ä¸‹æäº¤æ— æ•ˆï¼Œå°†è¢«å¿½ç•¥: ${INVALID_COMMITS[*]}"
        fi
        
        COMMITS_CSV=$(IFS=','; echo "${VALID_COMMITS[*]}")
        echo "commits_csv=$COMMITS_CSV" >> $GITHUB_OUTPUT
        echo "commits_count=${#VALID_COMMITS[@]}" >> $GITHUB_OUTPUT
        
        echo "âœ… æœ‰æ•ˆæäº¤åˆ—è¡¨: $COMMITS_CSV"
        echo "ğŸ“Š æœ‰æ•ˆæäº¤æ•°é‡: ${#VALID_COMMITS[@]}"
        
    - name: ä»æŒ‡å®šæäº¤ä¸­æå–æ–‡ä»¶åˆ—è¡¨ï¼ˆå»é‡ï¼‰
      id: extract_files
      run: |
        cd /tmp/sync_workspace
        IFS=',' read -ra COMMITS <<< "${{ steps.parse_commits.outputs.commits_csv }}"
        
        echo "=== ä»æŒ‡å®šæäº¤æå–æ–‡ä»¶åˆ—è¡¨ï¼ˆå»é‡ï¼‰==="
        
        # ä½¿ç”¨å…³è”æ•°ç»„å­˜å‚¨æ–‡ä»¶ï¼ˆè‡ªåŠ¨å»é‡ï¼‰
        declare -A UNIQUE_FILES_MAP
        declare -A FILE_SOURCES  # è®°å½•æ–‡ä»¶æ¥æºæäº¤
        
        COMMIT_INDEX=0
        TOTAL_FILES=0
        
        for commit in "${COMMITS[@]}"; do
          COMMIT_INDEX=$((COMMIT_INDEX + 1))
          echo ""
          echo "ğŸ“ å¤„ç†æäº¤ $COMMIT_INDEX/${#COMMITS[@]}: ${commit:0:8}"
          
          # è·å–è¯¥æäº¤çš„æ–‡ä»¶åˆ—è¡¨
          COMMIT_FILES=$(git ls-tree -r --name-only $commit)
          FILE_COUNT=$(echo "$COMMIT_FILES" | wc -l)
          TOTAL_FILES=$((TOTAL_FILES + FILE_COUNT))
          
          echo "æäº¤åŒ…å« $FILE_COUNT ä¸ªæ–‡ä»¶"
          
          # æ·»åŠ åˆ°å”¯ä¸€æ–‡ä»¶æ˜ å°„
          while IFS= read -r file; do
            if [ -n "$file" ]; then
              UNIQUE_FILES_MAP["$file"]=1
              # è®°å½•æ–‡ä»¶æ¥æºï¼ˆä½¿ç”¨æœ€åä¸€ä¸ªåŒ…å«è¯¥æ–‡ä»¶çš„æäº¤ï¼‰
              FILE_SOURCES["$file"]=$commit
            fi
          done <<< "$COMMIT_FILES"
          
          # æ˜¾ç¤ºæäº¤ä¿¡æ¯
          COMMIT_MSG=$(git show --no-patch --format="%s" $commit 2>/dev/null || echo "æ— æ³•è·å–æäº¤ä¿¡æ¯")
          echo "æäº¤ä¿¡æ¯: $COMMIT_MSG"
        done
        
        # è½¬æ¢ä¸ºæ•°ç»„
        UNIQUE_FILES=("${!UNIQUE_FILES_MAP[@]}")
        UNIQUE_FILE_COUNT=${#UNIQUE_FILES[@]}
        
        echo ""
        echo "ğŸ“Š æ–‡ä»¶æå–ç»Ÿè®¡:"
        echo "  å¤„ç†æäº¤æ•°: ${#COMMITS[@]}"
        echo "  æ€»æ–‡ä»¶æ•°ï¼ˆå»é‡å‰ï¼‰: $TOTAL_FILES"
        echo "  å”¯ä¸€æ–‡ä»¶æ•°ï¼ˆå»é‡åï¼‰: $UNIQUE_FILE_COUNT"
        echo "  å»é‡ç‡: $(( (TOTAL_FILES - UNIQUE_FILE_COUNT) * 100 / TOTAL_FILES ))%"
        
        # ä¿å­˜æ–‡ä»¶åˆ—è¡¨å’Œæ¥æºä¿¡æ¯
        printf "%s\n" "${UNIQUE_FILES[@]}" > /tmp/unique_files.txt
        
        # ä¿å­˜æ–‡ä»¶æ¥æºæ˜ å°„
        for file in "${UNIQUE_FILES[@]}"; do
          echo "$file|${FILE_SOURCES[$file]}" >> /tmp/file_sources.txt
        done
        
        echo "file_count=$UNIQUE_FILE_COUNT" >> $GITHUB_OUTPUT
        
        # æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨é¢„è§ˆ
        echo ""
        echo "ğŸ“ å”¯ä¸€æ–‡ä»¶åˆ—è¡¨é¢„è§ˆ:"
        printf "%s\n" "${UNIQUE_FILES[@]}" | head -10
        if [ $UNIQUE_FILE_COUNT -gt 10 ]; then
          echo "... è¿˜æœ‰ $((UNIQUE_FILE_COUNT - 10)) ä¸ªæ–‡ä»¶"
        fi
        
    - name: æ·»åŠ ç›®æ ‡ä»“åº“è¿œç¨‹
      run: |
        cd /tmp/sync_workspace
        git remote add target https://${{ env.PAT }}@github.com/${{ steps.parse_urls.outputs.target_repo }}.git
        echo "âœ… ç›®æ ‡ä»“åº“è¿œç¨‹å·²æ·»åŠ : ${{ steps.parse_urls.outputs.target_repo }}"
        
    - name: æ£€å‡ºç›®æ ‡ä»“åº“
      run: |
        cd /tmp/sync_workspace
        echo "=== æ£€å‡ºç›®æ ‡ä»“åº“ ==="
        
        # è·å–ç›®æ ‡ä»“åº“æ•°æ®
        git fetch target --depth=1
        
        # æ£€å‡ºç›®æ ‡åˆ†æ”¯
        if git show-ref --verify --quiet refs/remotes/target/${{ steps.parse_urls.outputs.target_branch }}; then
          git checkout -b sync-branch target/${{ steps.parse_urls.outputs.target_branch }}
          echo "âœ… æ£€å‡ºç›®æ ‡åˆ†æ”¯: ${{ steps.parse_urls.outputs.target_branch }}"
        else
          echo "âŒ ç›®æ ‡åˆ†æ”¯ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°åˆ†æ”¯"
          git checkout -b sync-branch
        fi
        
    - name: æ¸…ç©ºå·¥ä½œç›®å½•å‡†å¤‡åŒæ­¥
      run: |
        cd /tmp/sync_workspace
        echo "=== æ¸…ç©ºå·¥ä½œç›®å½•å‡†å¤‡åŒæ­¥ ==="
        
        # ä¿å­˜å½“å‰çŠ¶æ€
        git status
        
        # é‡ç½®åˆ°ç›®æ ‡åˆ†æ”¯çŠ¶æ€
        git reset --hard
        git clean -fd
        
        echo "âœ… å·¥ä½œç›®å½•å·²é‡ç½®åˆ°ç›®æ ‡åˆ†æ”¯çŠ¶æ€"
        
    - name: æŒ‰æ–‡ä»¶åä»æºä»“åº“è·å–æ–‡ä»¶å†…å®¹
      run: |
        cd /tmp/sync_workspace
        echo "=== ä»æºä»“åº“è·å–æŒ‡å®šæ–‡ä»¶å†…å®¹ ==="
        
        # è¯»å–æ–‡ä»¶åˆ—è¡¨
        mapfile -t UNIQUE_FILES < /tmp/unique_files.txt
        echo "éœ€è¦è·å–çš„æ–‡ä»¶æ•°é‡: ${#UNIQUE_FILES[@]}"
        
        # è¯»å–æ–‡ä»¶æ¥æºæ˜ å°„
        declare -A FILE_SOURCES
        while IFS='|' read -r file commit; do
          FILE_SOURCES["$file"]=$commit
        done < /tmp/file_sources.txt
        
        SUCCESS_COUNT=0
        FAIL_COUNT=0
        
        # é€ä¸ªæ–‡ä»¶ä»æºä»“åº“è·å–
        for file in "${UNIQUE_FILES[@]}"; do
          SOURCE_COMMIT="${FILE_SOURCES[$file]}"
          if [ -n "$SOURCE_COMMIT" ]; then
            # ç¡®ä¿ç›®å½•å­˜åœ¨
            mkdir -p "$(dirname "$file")"
            
            # ä»æºä»“åº“çš„ç‰¹å®šæäº¤è·å–æ–‡ä»¶
            if git show "$SOURCE_COMMIT:$file" > "$file" 2>/dev/null; then
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
              echo "âœ… [$SUCCESS_COUNT] è·å–: $file (æ¥è‡ª ${SOURCE_COMMIT:0:8})"
            else
              FAIL_COUNT=$((FAIL_COUNT + 1))
              echo "âŒ è·å–å¤±è´¥: $file"
            fi
          else
            FAIL_COUNT=$((FAIL_COUNT + 1))
            echo "âŒ æ‰¾ä¸åˆ°æ–‡ä»¶æ¥æº: $file"
          fi
        done
        
        echo "æ–‡ä»¶è·å–å®Œæˆ: æˆåŠŸ $SUCCESS_COUNT, å¤±è´¥ $FAIL_COUNT"
        
    - name: ç²¾ç¡®æ·»åŠ æºæäº¤æ–‡ä»¶åˆ°Gitç´¢å¼•
      run: |
        cd /tmp/sync_workspace
        echo "=== ç²¾ç¡®æ·»åŠ æºæäº¤æ–‡ä»¶åˆ°Gitç´¢å¼• ==="
        
        # è¯»å–æ–‡ä»¶åˆ—è¡¨
        mapfile -t UNIQUE_FILES < /tmp/unique_files.txt
        
        ADD_COUNT=0
        MISSING_COUNT=0
        
        # åªæ·»åŠ æºæäº¤ä¸­çš„æ–‡ä»¶
        for file in "${UNIQUE_FILES[@]}"; do
          if [ -f "$file" ]; then
            # ç²¾ç¡®æ·»åŠ æ–‡ä»¶
            git add "$file"
            ADD_COUNT=$((ADD_COUNT + 1))
            echo "âœ… [$ADD_COUNT] æ·»åŠ : $file"
          else
            MISSING_COUNT=$((MISSING_COUNT + 1))
            echo "âš ï¸ æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡: $file"
          fi
        done
        
        echo "ç²¾ç¡®æ·»åŠ å®Œæˆ: æˆåŠŸ $ADD_COUNT ä¸ªæ–‡ä»¶, ç¼ºå¤± $MISSING_COUNT ä¸ªæ–‡ä»¶"
        
    - name: åˆ é™¤ç›®æ ‡ä»“åº“å¤šä½™æ–‡ä»¶
      run: |
        cd /tmp/sync_workspace
        echo "=== æ¸…ç†ç›®æ ‡ä»“åº“å¤šä½™æ–‡ä»¶ ==="
        
        # è¯»å–éœ€è¦ä¿ç•™çš„æ–‡ä»¶åˆ—è¡¨
        mapfile -t UNIQUE_FILES < /tmp/unique_files.txt
        
        # è·å–ç›®æ ‡ä»“åº“å½“å‰æ–‡ä»¶ï¼ˆåœ¨ç´¢å¼•ä¸­ï¼‰
        TARGET_FILES=$(git ls-files)
        
        DELETE_COUNT=0
        ERROR_COUNT=0
        
        for file in $TARGET_FILES; do
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦åœ¨éœ€è¦ä¿ç•™çš„åˆ—è¡¨ä¸­
          FILE_EXISTS=0
          for keep_file in "${UNIQUE_FILES[@]}"; do
            if [ "$file" = "$keep_file" ]; then
              FILE_EXISTS=1
              break
            fi
          done
          
          if [ $FILE_EXISTS -eq 0 ]; then
            # ä»ç´¢å¼•ä¸­åˆ é™¤æ–‡ä»¶
            if git rm --cached "$file" 2>/dev/null; then
              DELETE_COUNT=$((DELETE_COUNT + 1))
              echo "ğŸ—‘ï¸ ä»ç´¢å¼•åˆ é™¤: $file"
            else
              ERROR_COUNT=$((ERROR_COUNT + 1))
              echo "âš ï¸ åˆ é™¤å¤±è´¥: $file"
            fi
          fi
        done
        
        echo "æ¸…ç†å®Œæˆ: åˆ é™¤ $DELETE_COUNT ä¸ªæ–‡ä»¶, å¤±è´¥ $ERROR_COUNT ä¸ª"
        
    - name: éªŒè¯æ–‡ä»¶çŠ¶æ€
      run: |
        cd /tmp/sync_workspace
        echo "=== éªŒè¯æ–‡ä»¶çŠ¶æ€ ==="
        
        # æ£€æŸ¥å·¥ä½œç›®å½•çŠ¶æ€
        echo "å·¥ä½œç›®å½•çŠ¶æ€:"
        git status --short
        
        # æ£€æŸ¥ç´¢å¼•çŠ¶æ€
        echo "ç´¢å¼•çŠ¶æ€:"
        git diff --cached --name-status
        
        # éªŒè¯æ–‡ä»¶æ•°é‡
        EXPECTED_COUNT=$(wc -l < /tmp/unique_files.txt)
        ACTUAL_COUNT=$(git ls-files | wc -l)
        
        echo "é¢„æœŸæ–‡ä»¶æ•°: $EXPECTED_COUNT"
        echo "å®é™…æ–‡ä»¶æ•°: $ACTUAL_COUNT"
        
        if [ "$EXPECTED_COUNT" -eq "$ACTUAL_COUNT" ]; then
          echo "âœ… æ–‡ä»¶æ•°é‡ä¸€è‡´"
        else
          echo "âš ï¸ æ–‡ä»¶æ•°é‡ä¸ä¸€è‡´"
        fi
        
    - name: æäº¤åŒæ­¥æ›´æ”¹
      run: |
        cd /tmp/sync_workspace
        echo "=== æäº¤æ–‡ä»¶åŒæ­¥ ==="
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹éœ€è¦æäº¤
        if git diff --cached --quiet; then
          echo "ğŸ“ æ²¡æœ‰æ£€æµ‹åˆ°æš‚å­˜çš„æ›´æ”¹"
        else
          # åªæäº¤ç´¢å¼•ä¸­çš„æ›´æ”¹ï¼ˆç²¾ç¡®æ§åˆ¶ï¼‰
          git commit -m "${{ github.event.inputs.commit_message }}"
          echo "âœ… åŒæ­¥æäº¤å®Œæˆ"
          
          # æ˜¾ç¤ºæäº¤è¯¦æƒ…
          echo "æäº¤è¯¦æƒ…:"
          git show --stat --oneline HEAD
        fi
        
    - name: æ¨é€åˆ°ç›®æ ‡ä»“åº“
      run: |
        cd /tmp/sync_workspace
        echo "=== æ¨é€åˆ°ç›®æ ‡ä»“åº“ ==="
        
        if git log target/${{ steps.parse_urls.outputs.target_branch }}..HEAD --oneline | grep -q .; then
          echo "æ¨é€åˆ°ç›®æ ‡ä»“åº“..."
          git push target sync-branch:${{ steps.parse_urls.outputs.target_branch }}
          echo "âœ… æ¨é€å®Œæˆ"
        else
          echo "ğŸ“ æ²¡æœ‰éœ€è¦æ¨é€çš„æ›´æ”¹"
        fi
        
    - name: åˆ›å»ºåŒæ­¥æ ‡ç­¾
      run: |
        cd /tmp/sync_workspace
        TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        TAG_NAME="sync-${TIMESTAMP}"
        git tag -a "$TAG_NAME" -m "åŒæ­¥è‡ª ${{ steps.parse_commits.outputs.commits_count }} ä¸ªæäº¤ - ${{ github.event.inputs.commit_message }}"
        git push target "$TAG_NAME"
        echo "âœ… åŒæ­¥æ ‡ç­¾å·²åˆ›å»º: $TAG_NAME"
        
    - name: æ¸…ç†å·¥ä½œåŒº
      run: |
        rm -f /tmp/unique_files.txt
        rm -f /tmp/file_sources.txt
        rm -rf /tmp/sync_workspace
        
    - name: æ˜¾ç¤ºåŒæ­¥æ‘˜è¦
      run: |
        echo "=== ğŸ‰ æ–‡ä»¶åŒæ­¥å®Œæˆ ==="
        echo ""
        echo "ğŸ“Š åŒæ­¥æ‘˜è¦:"
        echo "  ğŸ“¦ æºä»“åº“: ${{ steps.parse_urls.outputs.source_repo }}"
        echo "  ğŸ”— å¤„ç†æäº¤æ•°: ${{ steps.parse_commits.outputs.commits_count }}"
        echo "  ğŸ“ åŒæ­¥æ–‡ä»¶æ•°: ${{ steps.extract_files.outputs.file_count }}"
        echo "  ğŸ¯ ç›®æ ‡ä»“åº“: ${{ steps.parse_urls.outputs.target_repo }}"
        echo "  ğŸŒ¿ ç›®æ ‡åˆ†æ”¯: ${{ steps.parse_urls.outputs.target_branch }}"
        echo "  ğŸ‘¤ æäº¤ä½œè€…: ${{ steps.set_commit_info.outputs.author_name }}"
        echo "  ğŸ’¬ æäº¤ä¿¡æ¯: ${{ github.event.inputs.commit_message }}"
        echo ""
        echo "âš¡ åŒæ­¥ç­–ç•¥:"
        echo "  âœ… ä»…ä»æŒ‡å®šæäº¤æå–æ–‡ä»¶åˆ—è¡¨ï¼ˆå»é‡ï¼‰"
        echo "  âœ… æŒ‰æ–‡ä»¶åä»æºä»“åº“è·å–æ–‡ä»¶å†…å®¹"
        echo "  âœ… ä¸ä¸‹è½½æ•´ä¸ªæºä»“åº“"
        echo "  âœ… ç²¾ç¡®æ§åˆ¶æ–‡ä»¶æ¥æº"
        echo "  âœ… ä¿ç•™ç›®æ ‡ä»“åº“å®Œæ•´å†å²"

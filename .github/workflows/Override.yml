name: Repository File Sync

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: 'æºä»“åº“åœ°å€ (æ ¼å¼: owner/repo æˆ–å®Œæ•´URL)'
        required: true
        default: 'https://github.com/owner/source-repo'
      source_commits:
        description: 'æºæäº¤å“ˆå¸Œåˆ—è¡¨ (é€—å·åˆ†éš”çš„çŸ­å“ˆå¸Œæˆ–å®Œæ•´å“ˆå¸Œ)'
        required: true
        default: ''
      target_repo:
        description: 'ç›®æ ‡ä»“åº“åœ°å€ (æ ¼å¼: owner/repo æˆ–å®Œæ•´URL)'
        required: true
        default: 'https://github.com/owner/target-repo'
      target_branch:
        description: 'ç›®æ ‡åˆ†æ”¯å'
        required: false
        default: 'main'
      commit_name:
        description: 'æäº¤æ˜¾ç¤ºåç§° (ç•™ç©ºä½¿ç”¨é»˜è®¤mozi9)'
        required: false
        default: ''
      commit_message:
        description: 'æäº¤ä¿¡æ¯'
        required: true
        default: 'Sync from source repository'
      sync_author_name:
        description: 'åŒæ­¥æäº¤ä½œè€…å (ç•™ç©ºä½¿ç”¨é»˜è®¤mozi9)'
        required: false
        default: ''
      sync_author_email:
        description: 'åŒæ­¥æäº¤ä½œè€…é‚®ç®± (ç•™ç©ºä½¿ç”¨é»˜è®¤mozi9)'
        required: false
        default: ''

env:
  PAT: ${{ secrets.MOZI9_PAT }}
  GIT_USER: 'mozi9'
  GIT_EMAIL: 'mozi9'

jobs:
  sync-repo:
    runs-on: ubuntu-latest
    
    steps:
    - name: è§£æä»“åº“åœ°å€
      id: parse_urls
      run: |
        extract_repo() {
          local url="$1"
          if [[ $url == http* ]] && [[ $url == *"github.com"* ]]; then
            echo "$url" | sed -n 's|.*github.com/\([^/]*/[^/?]*\).*|\1|p'
          else
            echo "$url"
          fi
        }
        
        SOURCE_REPO=$(extract_repo "${{ github.event.inputs.source_repo }}")
        TARGET_REPO=$(extract_repo "${{ github.event.inputs.target_repo }}")
        
        echo "source_repo=$SOURCE_REPO" >> $GITHUB_OUTPUT
        echo "target_repo=$TARGET_REPO" >> $GITHUB_OUTPUT
        echo "target_branch=${{ github.event.inputs.target_branch || 'main' }}" >> $GITHUB_OUTPUT
        
    - name: è®¾ç½®æäº¤è€…ä¿¡æ¯
      id: set_commit_info
      run: |
        COMMIT_NAME="${{ github.event.inputs.commit_name }}"
        if [ -z "$COMMIT_NAME" ]; then
          COMMIT_NAME="mozi9"
        fi
        echo "commit_name=$COMMIT_NAME" >> $GITHUB_OUTPUT
        
        AUTHOR_NAME="${{ github.event.inputs.sync_author_name }}"
        if [ -z "$AUTHOR_NAME" ]; then
          AUTHOR_NAME="mozi9"
        fi
        echo "author_name=$AUTHOR_NAME" >> $GITHUB_OUTPUT
        
        AUTHOR_EMAIL="${{ github.event.inputs.sync_author_email }}"
        if [ -z "$AUTHOR_EMAIL" ]; then
          AUTHOR_EMAIL="mozi9"
        fi
        echo "author_email=$AUTHOR_EMAIL" >> $GITHUB_OUTPUT
        
    - name: å…‹éš†æºä»“åº“
      run: |
        echo "å…‹éš†æºä»“åº“..."
        git clone https://${{ env.PAT }}@github.com/${{ steps.parse_urls.outputs.source_repo }}.git /tmp/source_repo
        cd /tmp/source_repo
        echo "âœ… æºä»“åº“å…‹éš†å®Œæˆ"
        
    - name: éªŒè¯æäº¤å“ˆå¸Œ
      id: validate_commits
      run: |
        cd /tmp/source_repo
        COMMITS_INPUT="${{ github.event.inputs.source_commits }}"
        
        if [ -z "$COMMITS_INPUT" ]; then
          echo "âŒ é”™è¯¯ï¼šå¿…é¡»æä¾›æºæäº¤å“ˆå¸Œåˆ—è¡¨"
          exit 1
        fi
        
        CLEANED_COMMITS=$(echo "$COMMITS_INPUT" | tr -d '[:space:]')
        IFS=',' read -ra COMMIT_ARRAY <<< "$CLEANED_COMMITS"
        
        echo "è§£æåˆ° ${#COMMIT_ARRAY[@]} ä¸ªæäº¤å“ˆå¸Œ: ${COMMIT_ARRAY[*]}"
        
        VALID_COMMITS=()
        for commit in "${COMMIT_ARRAY[@]}"; do
          if [ -n "$commit" ]; then
            if git cat-file -e $commit 2>/dev/null; then
              FULL_HASH=$(git rev-parse $commit)
              if [ "$(git cat-file -t $FULL_HASH)" = "commit" ]; then
                VALID_COMMITS+=("$FULL_HASH")
                echo "âœ… éªŒè¯æäº¤: $commit -> $FULL_HASH"
              else
                echo "âŒ æ— æ•ˆæäº¤å¯¹è±¡: $commit"
              fi
            else
              echo "âŒ æäº¤ä¸å­˜åœ¨: $commit"
            fi
          fi
        done
        
        if [ ${#VALID_COMMITS[@]} -eq 0 ]; then
          echo "âŒ é”™è¯¯ï¼šæ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„æäº¤"
          exit 1
        fi
        
        COMMITS_CSV=$(IFS=','; echo "${VALID_COMMITS[*]}")
        echo "commits_csv=$COMMITS_CSV" >> $GITHUB_OUTPUT
        echo "commits_count=${#VALID_COMMITS[@]}" >> $GITHUB_OUTPUT
        
    - name: è·å–æäº¤ä¸­çš„æ–‡ä»¶åˆ—è¡¨
      id: get_commit_files
      run: |
        cd /tmp/source_repo
        
        IFS=',' read -ra COMMIT_HASHES <<< "${{ steps.validate_commits.outputs.commits_csv }}"
        
        ALL_FILES=()
        DELETED_FILES=()
        
        for commit_hash in "${COMMIT_HASHES[@]}"; do
          echo "å¤„ç†æäº¤: $commit_hash"
          
          # è·å–è¯¥æäº¤ä¸­ä¿®æ”¹çš„æ–‡ä»¶åˆ—è¡¨
          FILES_IN_COMMIT=$(git show --name-only --format=format: $commit_hash | grep -v '^$' || true)
          
          # è·å–è¯¥æäº¤ä¸­çŠ¶æ€å˜æ›´çš„æ–‡ä»¶ï¼ˆåŒ…æ‹¬åˆ é™¤çš„æ–‡ä»¶ï¼‰
          FILES_WITH_STATUS=$(git show --name-status --format=format: $commit_hash | tail -n +2 || true)
          
          if [ -n "$FILES_IN_COMMIT" ]; then
            while IFS= read -r file; do
              if [ -n "$file" ]; then
                ALL_FILES+=("$file")
                echo "ğŸ“„ æ‰¾åˆ°æ–‡ä»¶: $file"
              fi
            done <<< "$FILES_IN_COMMIT"
          fi
          
          if [ -n "$FILES_WITH_STATUS" ]; then
            while IFS= read -r line; do
              if [ -n "$line" ]; then
                STATUS=$(echo "$line" | awk '{print $1}')
                FILE=$(echo "$line" | awk '{for(i=2;i<=NF;i++) printf "%s", $i (i==NF?ORS:OFS)}')
                
                if [ "$STATUS" = "D" ] || [ "$STATUS" = "D000" ]; then
                  DELETED_FILES+=("$FILE")
                  echo "ğŸ—‘ï¸  æ ‡è®°ä¸ºåˆ é™¤çš„æ–‡ä»¶: $FILE"
                fi
              fi
            done <<< "$FILES_WITH_STATUS"
          fi
        done
        
        # å»é‡æ–‡ä»¶åˆ—è¡¨
        UNIQUE_FILES=($(printf "%s\n" "${ALL_FILES[@]}" | sort -u))
        UNIQUE_DELETED=($(printf "%s\n" "${DELETED_FILES[@]}" | sort -u))
        
        echo "æ€»å…±æ‰¾åˆ° ${#UNIQUE_FILES[@]} ä¸ªå”¯ä¸€æ–‡ä»¶"
        echo "æ€»å…±æ‰¾åˆ° ${#UNIQUE_DELETED[@]} ä¸ªå”¯ä¸€åˆ é™¤æ–‡ä»¶"
        
        # å°†æ–‡ä»¶åˆ—è¡¨è½¬æ¢ä¸ºJSONæ ¼å¼å­˜å‚¨
        echo "files_json=$(printf '%s\n' "${UNIQUE_FILES[@]}" | jq -R -s -c 'split("\n") | map(select(. != ""))')" >> $GITHUB_OUTPUT
        echo "deleted_files_json=$(printf '%s\n' "${UNIQUE_DELETED[@]}" | jq -R -s -c 'split("\n") | map(select(. != ""))')" >> $GITHUB_OUTPUT
        
        # ä¹Ÿä¿å­˜ä¸ºé€—å·åˆ†éš”çš„å­—ç¬¦ä¸²ï¼ˆç”¨äºæ—¥å¿—æ˜¾ç¤ºï¼‰
        echo "files_list=$(IFS=','; echo "${UNIQUE_FILES[*]}")" >> $GITHUB_OUTPUT
        echo "deleted_files_list=$(IFS=','; echo "${UNIQUE_DELETED[*]}")" >> $GITHUB_OUTPUT
        
    - name: æ˜¾ç¤ºæ–‡ä»¶ç»Ÿè®¡ä¿¡æ¯
      run: |
        echo "ğŸ“Š æ–‡ä»¶ç»Ÿè®¡ä¿¡æ¯:"
        echo "æœ‰æ•ˆæ–‡ä»¶æ•°é‡: $(echo '${{ steps.get_commit_files.outputs.files_json }}' | jq length)"
        echo "åˆ é™¤æ–‡ä»¶æ•°é‡: $(echo '${{ steps.get_commit_files.outputs.deleted_files_json }}' | jq length)"
        
        echo "æœ‰æ•ˆæ–‡ä»¶åˆ—è¡¨:"
        echo "${{ steps.get_commit_files.outputs.files_list }}"
        
        echo "åˆ é™¤æ–‡ä»¶åˆ—è¡¨:"
        echo "${{ steps.get_commit_files.outputs.deleted_files_list }}"
        
    - name: å…‹éš†ç›®æ ‡ä»“åº“
      run: |
        echo "å…‹éš†ç›®æ ‡ä»“åº“..."
        git clone https://${{ env.PAT }}@github.com/${{ steps.parse_urls.outputs.target_repo }}.git /tmp/target_repo
        cd /tmp/target_repo
        
        # åˆ‡æ¢åˆ°ç›®æ ‡åˆ†æ”¯ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»º
        git checkout ${{ steps.parse_urls.outputs.target_branch }} 2>/dev/null || git checkout -b ${{ steps.parse_urls.outputs.target_branch }}
        echo "âœ… ç›®æ ‡ä»“åº“å…‹éš†å®Œæˆ"
        
    - name: åŒæ­¥æ–‡ä»¶åˆ°ç›®æ ‡ä»“åº“
      id: sync_files
      run: |
        cd /tmp/target_repo
        
        # ä»JSONä¸­è§£ææ–‡ä»¶åˆ—è¡¨
        FILES_JSON='${{ steps.get_commit_files.outputs.files_json }}'
        DELETED_FILES_JSON='${{ steps.get_commit_files.outputs.deleted_files_json }}'
        
        # ä½¿ç”¨jqè§£æJSONæ•°ç»„
        FILES_ARRAY=$(echo "$FILES_JSON" | jq -r '.[]' 2>/dev/null || echo "")
        DELETED_ARRAY=$(echo "$DELETED_FILES_JSON" | jq -r '.[]' 2>/dev/null || echo "")
        
        echo "å¼€å§‹åŒæ­¥æ–‡ä»¶..."
        
        SYNC_COUNT=0
        DELETE_COUNT=0
        SKIP_COUNT=0
        ERROR_COUNT=0
        
        # åŒæ­¥æ–°å¢/ä¿®æ”¹çš„æ–‡ä»¶ - å¼ºåˆ¶è¦†ç›–ç­–ç•¥
        if [ -n "$FILES_ARRAY" ]; then
          while IFS= read -r file; do
            if [ -n "$file" ]; then
              # åˆ›å»ºç›®æ ‡ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
              FILE_DIR=$(dirname "$file")
              if [ "$FILE_DIR" != "." ]; then
                mkdir -p "$FILE_DIR"
              fi
              
              # æ£€æŸ¥æºæ–‡ä»¶æ˜¯å¦å­˜åœ¨
              if [ ! -f "/tmp/source_repo/$file" ]; then
                echo "âš ï¸  è­¦å‘Š: æºæ–‡ä»¶ä¸å­˜åœ¨ /tmp/source_repo/$file"
                ERROR_COUNT=$((ERROR_COUNT + 1))
                continue
              fi
              
              # æ£€æŸ¥ç›®æ ‡æ–‡ä»¶æ˜¯å¦å­˜åœ¨
              if [ -f "$file" ]; then
                # æ£€æŸ¥æ–‡ä»¶å†…å®¹æ˜¯å¦ç›¸åŒ
                if cmp -s "/tmp/source_repo/$file" "$file"; then
                  echo "âœ… æ–‡ä»¶å†…å®¹ç›¸åŒï¼Œè·³è¿‡: $file"
                  SKIP_COUNT=$((SKIP_COUNT + 1))
                else
                  # æ–‡ä»¶å†…å®¹ä¸åŒï¼Œå¼ºåˆ¶è¦†ç›–
                  cp "/tmp/source_repo/$file" "$file"
                  SYNC_COUNT=$((SYNC_COUNT + 1))
                  echo "ğŸ”„ æ–‡ä»¶å†…å®¹å†²çªï¼Œå·²è¦†ç›–: $file"
                fi
              else
                # ç›®æ ‡æ–‡ä»¶ä¸å­˜åœ¨ï¼Œç›´æ¥å¤åˆ¶
                cp "/tmp/source_repo/$file" "$file"
                SYNC_COUNT=$((SYNC_COUNT + 1))
                echo "ğŸ“„ æ–°å¢æ–‡ä»¶: $file"
              fi
            fi
          done <<< "$FILES_ARRAY"
        fi
        
        # å¤„ç†åˆ é™¤çš„æ–‡ä»¶
        if [ -n "$DELETED_ARRAY" ]; then
          while IFS= read -r file; do
            if [ -n "$file" ]; then
              if [ -f "$file" ] || [ -d "$file" ]; then
                rm -rf "$file"
                DELETE_COUNT=$((DELETE_COUNT + 1))
                echo "ğŸ—‘ï¸  å·²åˆ é™¤æ–‡ä»¶: $file"
              else
                echo "â„¹ï¸  æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ— éœ€åˆ é™¤: $file"
                SKIP_COUNT=$((SKIP_COUNT + 1))
              fi
            fi
          done <<< "$DELETED_ARRAY"
        fi
        
        echo "sync_count=$SYNC_COUNT" >> $GITHUB_OUTPUT
        echo "delete_count=$DELETE_COUNT" >> $GITHUB_OUTPUT
        echo "skip_count=$SKIP_COUNT" >> $GITHUB_OUTPUT
        echo "error_count=$ERROR_COUNT" >> $GITHUB_OUTPUT
        
        echo "ğŸ“Š åŒæ­¥å®Œæˆç»Ÿè®¡:"
        echo "   æ–°å¢/ä¿®æ”¹æ–‡ä»¶: $SYNC_COUNT"
        echo "   åˆ é™¤æ–‡ä»¶: $DELETE_COUNT"
        echo "   è·³è¿‡æ–‡ä»¶: $SKIP_COUNT"
        echo "   é”™è¯¯æ–‡ä»¶: $ERROR_COUNT"
        
    - name: æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜æ›´
      id: check_changes
      run: |
        cd /tmp/target_repo
        
        if git diff --quiet && git diff --cached --quiet; then
          echo "ğŸ“ æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "ğŸ“ æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
          git status
          git diff --name-status
          echo "has_changes=true" >> $GITHUB_OUTPUT
        fi
        
    - name: æäº¤å˜æ›´åˆ°ç›®æ ‡ä»“åº“
      if: steps.check_changes.outputs.has_changes == 'true'
      run: |
        cd /tmp/target_repo
        
        # é…ç½®gitç”¨æˆ·ä¿¡æ¯
        git config user.name "${{ steps.set_commit_info.outputs.author_name }}"
        git config user.email "${{ steps.set_commit_info.outputs.author_email }}"
        
        # æ·»åŠ æ‰€æœ‰å˜æ›´
        git add -A
        
        # æäº¤å˜æ›´
        COMMIT_MESSAGE="${{ github.event.inputs.commit_message }}"
        if [ -z "$COMMIT_MESSAGE" ]; then
          COMMIT_MESSAGE="Sync files from ${{ steps.parse_urls.outputs.source_repo }}"
        fi
        
        # æ·»åŠ æäº¤è¯¦æƒ…
        COMMIT_DETAILS="\n\nåŒæ­¥è¯¦æƒ…:\n- æºä»“åº“: ${{ steps.parse_urls.outputs.source_repo }}\n- æäº¤å“ˆå¸Œ: ${{ github.event.inputs.source_commits }}\n- åŒæ­¥æ–‡ä»¶æ•°: ${{ steps.sync_files.outputs.sync_count }}\n- åˆ é™¤æ–‡ä»¶æ•°: ${{ steps.sync_files.outputs.delete_count }}\n- è·³è¿‡æ–‡ä»¶æ•°: ${{ steps.sync_files.outputs.skip_count }}\n- é”™è¯¯æ•°: ${{ steps.sync_files.outputs.error_count }}"
        
        git commit -m "${COMMIT_MESSAGE}${COMMIT_DETAILS}"
        
        echo "âœ… å˜æ›´å·²æäº¤"
        
    - name: æ¨é€å˜æ›´åˆ°ç›®æ ‡ä»“åº“
      if: steps.check_changes.outputs.has_changes == 'true'
      run: |
        cd /tmp/target_repo
        
        echo "æ¨é€å˜æ›´åˆ°ç›®æ ‡ä»“åº“..."
        git push origin ${{ steps.parse_urls.outputs.target_branch }}
        
        echo "ğŸ‰ åŒæ­¥å®Œæˆï¼"
        echo "ğŸ“Š æœ€ç»ˆç»Ÿè®¡:"
        echo "   æ–°å¢/ä¿®æ”¹æ–‡ä»¶: ${{ steps.sync_files.outputs.sync_count }}"
        echo "   åˆ é™¤æ–‡ä»¶: ${{ steps.sync_files.outputs.delete_count }}"
        echo "   è·³è¿‡æ–‡ä»¶: ${{ steps.sync_files.outputs.skip_count }}"
        echo "   é”™è¯¯æ–‡ä»¶: ${{ steps.sync_files.outputs.error_count }}"
        
    - name: æ˜¾ç¤ºæ— å˜æ›´ä¿¡æ¯
      if: steps.check_changes.outputs.has_changes == 'false'
      run: |
        echo "â„¹ï¸  æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡æäº¤å’Œæ¨é€"
        echo "ğŸ“Š å¤„ç†ç»Ÿè®¡:"
        echo "   æ–°å¢/ä¿®æ”¹æ–‡ä»¶: ${{ steps.sync_files.outputs.sync_count }}"
        echo "   åˆ é™¤æ–‡ä»¶: ${{ steps.sync_files.outputs.delete_count }}"
        echo "   è·³è¿‡æ–‡ä»¶: ${{ steps.sync_files.outputs.skip_count }}"
        echo "   é”™è¯¯æ–‡ä»¶: ${{ steps.sync_files.outputs.error_count }}"
        
    - name: æ¸…ç†å·¥ä½œç›®å½•
      if: always()
      run: |
        echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
        rm -rf /tmp/source_repo
        rm -rf /tmp/target_repo
        echo "âœ… æ¸…ç†å®Œæˆ"

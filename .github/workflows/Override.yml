name: Repository File Sync

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: 'æºä»“åº“åœ°å€ (æ ¼å¼: owner/repo æˆ–å®Œæ•´URL)'
        required: true
        default: 'https://github.com/owner/source-repo'
      source_commit:
        description: 'æºæäº¤å“ˆå¸Œ (çŸ­å“ˆå¸Œæˆ–å®Œæ•´å“ˆå¸Œ)'
        required: true
        default: ''
      target_repo:
        description: 'ç›®æ ‡ä»“åº“åœ°å€ (æ ¼å¼: owner/repo æˆ–å®Œæ•´URL)'
        required: true
        default: 'https://github.com/owner/target-repo'
      target_branch:
        description: 'ç›®æ ‡åˆ†æ”¯å'
        required: false
        default: 'main'
      commit_name:
        description: 'æäº¤æ˜¾ç¤ºåç§° (ç•™ç©ºä½¿ç”¨é»˜è®¤mozi9)'
        required: false
        default: ''
      commit_message:
        description: 'æäº¤ä¿¡æ¯'
        required: true
        default: 'Sync from source repository'

env:
  PAT: ${{ secrets.MOZI9_PAT }}
  GIT_USER: 'mozi9'
  GIT_EMAIL: 'mozi9'

jobs:
  sync-repo:
    runs-on: ubuntu-latest
    
    steps:
    - name: è§£æä»“åº“åœ°å€
      id: parse_urls
      run: |
        # æå–ä»“åº“owner/repo
        extract_repo() {
          local url="$1"
          if [[ $url == http* ]] && [[ $url == *"github.com"* ]]; then
            echo "$url" | sed -n 's|.*github.com/\([^/]*/[^/?]*\).*|\1|p'
          else
            echo "$url"
          fi
        }
        
        SOURCE_REPO=$(extract_repo "${{ github.event.inputs.source_repo }}")
        TARGET_REPO=$(extract_repo "${{ github.event.inputs.target_repo }}")
        
        echo "æºä»“åº“: $SOURCE_REPO"
        echo "ç›®æ ‡ä»“åº“: $TARGET_REPO"
        echo "ç›®æ ‡åˆ†æ”¯: ${{ github.event.inputs.target_branch || 'main' }}"
        
        echo "source_repo=$SOURCE_REPO" >> $GITHUB_OUTPUT
        echo "target_repo=$TARGET_REPO" >> $GITHUB_OUTPUT
        echo "target_branch=${{ github.event.inputs.target_branch || 'main' }}" >> $GITHUB_OUTPUT
        
    - name: è®¾ç½®æäº¤è€…ä¿¡æ¯
      id: set_commit_name
      run: |
        COMMIT_NAME="${{ github.event.inputs.commit_name }}"
        if [ -z "$COMMIT_NAME" ]; then
          COMMIT_NAME="mozi9"
        fi
        echo "commit_name=$COMMIT_NAME" >> $GITHUB_OUTPUT
        echo "ä½¿ç”¨æäº¤è€…: $COMMIT_NAME"
        
    - name: æ£€å‡ºç›®æ ‡ä»“åº“
      uses: actions/checkout@v4
      with:
        repository: ${{ steps.parse_urls.outputs.target_repo }}
        ref: ${{ steps.parse_urls.outputs.target_branch }}
        token: ${{ env.PAT }}
        fetch-depth: 1
        
    - name: é…ç½®Git
      run: |
        git config user.name "${{ steps.set_commit_name.outputs.commit_name }}"
        git config user.email "${{ env.GIT_EMAIL }}"
        
    - name: æ·»åŠ æºä»“åº“è¿œç¨‹
      run: |
        git remote add source https://${{ env.PAT }}@github.com/${{ steps.parse_urls.outputs.source_repo }}.git
        
    - name: è·å–æºæäº¤
      run: |
        git fetch source --depth=1 ${{ github.event.inputs.source_commit }}
        
    - name: éªŒè¯æºæäº¤
      id: resolve_commit
      run: |
        SOURCE_COMMIT="${{ github.event.inputs.source_commit }}"
        
        if [ -z "$SOURCE_COMMIT" ]; then
          echo "âŒ é”™è¯¯ï¼šå¿…é¡»æä¾›æºæäº¤å“ˆå¸Œ"
          exit 1
        fi
        
        if git cat-file -e $SOURCE_COMMIT 2>/dev/null; then
          FULL_HASH=$(git rev-parse $SOURCE_COMMIT)
          if [ "$(git cat-file -t $FULL_HASH)" = "commit" ]; then
            echo "full_hash=$FULL_HASH" >> $GITHUB_OUTPUT
            echo "âœ… æäº¤éªŒè¯æˆåŠŸ: $FULL_HASH"
            echo "æäº¤ä¿¡æ¯:"
            git show --no-patch --format=fuller $FULL_HASH
          else
            echo "âŒ é”™è¯¯ï¼š$FULL_HASH ä¸æ˜¯æœ‰æ•ˆçš„æäº¤å¯¹è±¡"
            exit 1
          fi
        else
          echo "âŒ é”™è¯¯ï¼šæäº¤ $SOURCE_COMMIT åœ¨æºä»“åº“ä¸­ä¸å­˜åœ¨"
          exit 1
        fi
        
    - name: æå–æºæäº¤æ–‡ä»¶åˆ—è¡¨
      id: extract_files
      run: |
        FULL_HASH="${{ steps.resolve_commit.outputs.full_hash }}"
        
        echo "=== ä»æäº¤ $FULL_HASH æå–æ–‡ä»¶åˆ—è¡¨ ==="
        
        SOURCE_FILES=$(git ls-tree -r --name-only $FULL_HASH)
        FILE_COUNT=$(echo "$SOURCE_FILES" | wc -l)
        
        echo "æäº¤åŒ…å« $FILE_COUNT ä¸ªæ–‡ä»¶"
        echo "$SOURCE_FILES" > /tmp/source_files.txt
        echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
        
        # æ˜¾ç¤ºå‰10ä¸ªæ–‡ä»¶ä½œä¸ºç¤ºä¾‹
        echo "æ–‡ä»¶åˆ—è¡¨ç¤ºä¾‹:"
        echo "$SOURCE_FILES" | head -10
        
    - name: æ— æ¡ä»¶è¦†ç›–æºæäº¤æ–‡ä»¶
      run: |
        FULL_HASH="${{ steps.resolve_commit.outputs.full_hash }}"
        SOURCE_FILES=$(cat /tmp/source_files.txt)
        
        echo "=== å¼€å§‹æ— æ¡ä»¶æ–‡ä»¶è¦†ç›– ==="
        echo "ç­–ç•¥ï¼šæ— è®ºæ–‡ä»¶æ˜¯å¦ç›¸åŒï¼Œå…¨éƒ¨ç”¨æºæäº¤æ–‡ä»¶è¦†ç›–"
        
        FILE_COUNT=0
        SUCCESS_COUNT=0
        FAIL_COUNT=0
        
        for file in $SOURCE_FILES; do
          FILE_COUNT=$((FILE_COUNT + 1))
          if git checkout $FULL_HASH -- "$file" 2>/dev/null; then
            echo "âœ… [$FILE_COUNT] è¦†ç›–: $file"
            SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
          else
            echo "âŒ [$FILE_COUNT] å¤±è´¥: $file"
            FAIL_COUNT=$((FAIL_COUNT + 1))
          fi
        done
        
        echo "æ–‡ä»¶è¦†ç›–å®Œæˆ: æˆåŠŸ $SUCCESS_COUNT, å¤±è´¥ $FAIL_COUNT, æ€»è®¡ $FILE_COUNT"
        
    - name: åˆ é™¤ç›®æ ‡ä»“åº“å¤šä½™æ–‡ä»¶
      run: |
        SOURCE_FILES=$(cat /tmp/source_files.txt)
        TARGET_FILES=$(git ls-files)
        
        echo "=== åˆ é™¤ç›®æ ‡ä»“åº“ä¸­å¤šä½™çš„æ–‡ä»¶ ==="
        
        DELETE_COUNT=0
        for file in $TARGET_FILES; do
          if ! echo "$SOURCE_FILES" | grep -q "^$file$"; then
            if git rm --cached "$file" 2>/dev/null || rm -f "$file" 2>/dev/null; then
              echo "ğŸ—‘ï¸ åˆ é™¤: $file"
              DELETE_COUNT=$((DELETE_COUNT + 1))
            else
              echo "âš ï¸ åˆ é™¤å¤±è´¥: $file"
            fi
          fi
        done
        
        echo "åˆ é™¤äº† $DELETE_COUNT ä¸ªå¤šä½™æ–‡ä»¶"
        
    - name: æœ€ç»ˆä¸€è‡´æ€§éªŒè¯
      run: |
        FULL_HASH="${{ steps.resolve_commit.outputs.full_hash }}"
        SOURCE_FILES=$(cat /tmp/source_files.txt)
        
        echo "=== æœ€ç»ˆä¸€è‡´æ€§éªŒè¯ ==="
        
        # éªŒè¯æ–‡ä»¶æ•°é‡
        SOURCE_COUNT=$(cat /tmp/source_files.txt | wc -l)
        CURRENT_COUNT=$(git ls-files | wc -l)
        
        echo "æºæäº¤æ–‡ä»¶æ•°: $SOURCE_COUNT"
        echo "å½“å‰æ–‡ä»¶æ•°: $CURRENT_COUNT"
        
        if [ "$SOURCE_COUNT" -eq "$CURRENT_COUNT" ]; then
          echo "âœ… æ–‡ä»¶æ•°é‡ä¸€è‡´"
        else
          echo "âš ï¸ æ–‡ä»¶æ•°é‡ä¸ä¸€è‡´"
        fi
        
        # æ˜¾ç¤ºæ›´æ”¹çŠ¶æ€
        echo "å½“å‰æ›´æ”¹çŠ¶æ€:"
        git status --short
        
    - name: æäº¤åŒæ­¥æ›´æ”¹
      run: |
        echo "=== æäº¤æ–‡ä»¶åŒæ­¥ ==="
        
        # æ·»åŠ æ‰€æœ‰æ›´æ”¹
        git add -A
        
        # æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦æäº¤çš„æ›´æ”¹
        if git diff --cached --quiet; then
          echo "ğŸ“ æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶æ›´æ”¹ï¼ˆæ–‡ä»¶å·²å®Œå…¨ä¸€è‡´ï¼‰"
        else
          git commit -m "${{ github.event.inputs.commit_message }} (åŒæ­¥è‡ªæäº¤ ${{ steps.resolve_commit.outputs.full_hash }})"
          echo "âœ… åŒæ­¥æäº¤å®Œæˆ"
          echo "æäº¤å“ˆå¸Œ: $(git rev-parse HEAD)"
        fi
        
    - name: æ¨é€åˆ°ç›®æ ‡ä»“åº“
      run: |
        echo "=== æ¨é€åˆ°ç›®æ ‡ä»“åº“ ==="
        
        # æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦æ¨é€çš„æäº¤
        if git log @{u}..HEAD --oneline | grep -q .; then
          echo "å¼€å§‹æ¨é€..."
          git push origin ${{ steps.parse_urls.outputs.target_branch }}
          echo "âœ… æ¨é€å®Œæˆ"
        else
          echo "ğŸ“ æ²¡æœ‰éœ€è¦æ¨é€çš„æ›´æ”¹ï¼ˆå·¥ä½œç›®å½•å·²ä¸æºæäº¤ä¸€è‡´ï¼‰"
        fi
        
    - name: åˆ›å»ºåŒæ­¥æ ‡ç­¾
      run: |
        TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        SHORT_HASH=$(echo ${{ steps.resolve_commit.outputs.full_hash }} | cut -c1-8)
        TAG_NAME="sync-$TIMESTAMP-$SHORT_HASH"
        
        git tag -a "$TAG_NAME" -m "æ–‡ä»¶åŒæ­¥è‡ªæäº¤ ${{ steps.resolve_commit.outputs.full_hash }} - ${{ github.event.inputs.commit_message }}"
        git push origin "$TAG_NAME"
        echo "âœ… åŒæ­¥æ ‡ç­¾å·²åˆ›å»º: $TAG_NAME"
        
    - name: æ¸…ç†å·¥ä½œåŒº
      run: |
        rm -f /tmp/source_files.txt
        git remote remove source
        echo "âœ… å·¥ä½œåŒºæ¸…ç†å®Œæˆ"
        
    - name: æ˜¾ç¤ºåŒæ­¥æ‘˜è¦
      run: |
        echo "=== ğŸ‰ æ–‡ä»¶åŒæ­¥å®Œæˆ ==="
        echo ""
        echo "ğŸ“Š åŒæ­¥æ‘˜è¦:"
        echo "  ğŸ“¦ æºä»“åº“: ${{ steps.parse_urls.outputs.source_repo }}"
        echo "  ğŸ”— æºæäº¤: ${{ steps.resolve_commit.outputs.full_hash }}"
        echo "  ğŸ¯ ç›®æ ‡ä»“åº“: ${{ steps.parse_urls.outputs.target_repo }}"
        echo "  ğŸŒ¿ ç›®æ ‡åˆ†æ”¯: ${{ steps.parse_urls.outputs.target_branch }}"
        echo "  ğŸ“ åŒæ­¥æ–‡ä»¶æ•°: ${{ steps.extract_files.outputs.file_count }}"
        echo "  ğŸ‘¤ æäº¤è€…: ${{ steps.set_commit_name.outputs.commit_name }}"
        echo "  ğŸ’¬ æäº¤ä¿¡æ¯: ${{ github.event.inputs.commit_message }}"
        echo ""
        echo "âš¡ åŒæ­¥ç­–ç•¥:"
        echo "  âœ… æ— æ¡ä»¶æ–‡ä»¶è¦†ç›–ï¼ˆæ— è®ºæ˜¯å¦ç›¸åŒï¼‰"
        echo "  âœ… ä¿ç•™ç›®æ ‡ä»“åº“å®Œæ•´å†å²"
        echo "  âœ… ç²¾ç¡®æ–‡ä»¶çº§åŒæ­¥"
        echo ""
        echo "âœ… ç›®æ ‡ä»“åº“æ–‡ä»¶çŠ¶æ€ç°åœ¨ä¸æºæäº¤å®Œå…¨ä¸€è‡´"

name: Repository File Sync

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: 'Ê∫ê‰ªìÂ∫ìÂú∞ÂùÄ (Ê†ºÂºè: owner/repo)'
        required: true
        default: 'owner/source-repo'
      target_repo:
        description: 'ÁõÆÊ†á‰ªìÂ∫ìÂú∞ÂùÄ (Ê†ºÂºè: owner/repo)'
        required: true
        default: 'owner/target-repo'
      source_branch:
        description: 'Ê∫êÂàÜÊîØÂêç'
        required: true
        default: 'main'
      target_branch:
        description: 'ÁõÆÊ†áÂàÜÊîØÂêç'
        required: true
        default: 'main'
      commit_hashes:
        description: 'Ë¶ÅÂêåÊ≠•ÁöÑÊèê‰∫§ÂìàÂ∏åÔºàÂ§ö‰∏™Áî®ÈÄóÂè∑ÂàÜÈöîÔºâ'
        required: true
        default: '75fef37dde7c3cbcde63ae7542f115fb04d9ee70,fa957cbe93c6260f4968cf3d01ec3974bcd49ff8'
      commit_name:
        description: 'Ëá™ÂÆö‰πâÊèê‰∫§ÂêçÁß∞'
        required: true
        default: 'mozi9: ÂêåÊ≠•Êñá‰ª∂'
      commit_message:
        description: 'Ëá™ÂÆö‰πâÊèê‰∫§‰ø°ÊÅØ'
        required: true
        default: '‰ªéÊ∫ê‰ªìÂ∫ìÂêåÊ≠•Êñá‰ª∂ÂèòÊõ¥'

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  sync-files:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout target repository
      uses: actions/checkout@v4
      with:
        repository: ${{ github.event.inputs.target_repo }}
        token: ${{ secrets.GITHUB_TOKEN || secrets.Mozi9_PAT }}
        ref: ${{ github.event.inputs.target_branch }}
        fetch-depth: 0

    - name: Clone source repository
      run: |
        echo "Cloning source repository..."
        git clone https://${{ secrets.GITHUB_TOKEN || secrets.Mozi9_PAT }}@github.com/${{ github.event.inputs.source_repo }}.git /tmp/source-repo
        cd /tmp/source-repo
        git checkout ${{ github.event.inputs.source_branch }}

    - name: Setup Git identity
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

    - name: Validate source commits
      id: validate-commits
      run: |
        echo "Validating source commits..."
        cd /tmp/source-repo
        
        # Clean and split commit hashes
        CLEAN_HASHES=$(echo '${{ github.event.inputs.commit_hashes }}' | tr -d '[:space:]' | tr ',' '\n')
        VALID_COMMITS=""
        COUNT=0
        
        for hash in $CLEAN_HASHES; do
          if [ -n "$hash" ] && git rev-parse "$hash" >/dev/null 2>&1; then
            VALID_COMMITS="$VALID_COMMITS$hash"$'\n'
            COUNT=$((COUNT + 1))
            COMMIT_MSG=$(git log -1 --format="%s" "$hash" 2>/dev/null || echo "N/A")
            echo "‚úÖ Valid commit: $hash - $COMMIT_MSG"
          else
            echo "‚ùå Invalid commit: $hash"
          fi
        done
        
        if [ $COUNT -eq 0 ]; then
          echo "Error: No valid commits found"
          exit 1
        fi
        
        echo "$VALID_COMMITS" > /tmp/valid_commits.txt
        echo "count=$COUNT" >> $GITHUB_OUTPUT
        echo "Found $COUNT valid commits"

    - name: Extract files from source commits
      id: extract-files
      run: |
        echo "Extracting files from source commits..."
        cd /tmp/source-repo
        
        # Create working directories
        mkdir -p /tmp/workdir/extracted
        
        # Initialize counters
        ADD_COUNT=0
        DEL_COUNT=0
        
        # Process each commit
        while IFS= read -r commit; do
          [ -z "$commit" ] && continue
          echo "Processing commit: $commit"
          
          # Get all files in this commit
          FILES_IN_COMMIT=$(git ls-tree -r --name-only "$commit" 2>/dev/null || true)
          
          if [ -n "$FILES_IN_COMMIT" ]; then
            for file in $FILES_IN_COMMIT; do
              # Extract file content
              if git show "$commit:$file" >/dev/null 2>&1; then
                mkdir -p "/tmp/workdir/extracted/$(dirname "$file")"
                git show "$commit:$file" > "/tmp/workdir/extracted/$file" 2>/dev/null || echo "Warning: Could not extract $file"
                echo "$file" >> /tmp/workdir/files_to_add.txt
                ADD_COUNT=$((ADD_COUNT + 1))
                echo "üìÑ Extracted: $file"
              fi
            done
          fi
          
          # Check for deleted files by comparing with parent
          if git rev-parse "${commit}^" >/dev/null 2>&1; then
            DELETED_FILES=$(git diff --name-only --diff-filter=D "${commit}^" "$commit" 2>/dev/null || true)
            if [ -n "$DELETED_FILES" ]; then
              for file in $DELETED_FILES; do
                echo "$file" >> /tmp/workdir/files_to_delete.txt
                DEL_COUNT=$((DEL_COUNT + 1))
                echo "üóëÔ∏è Marked for deletion: $file"
              done
            fi
          fi
          
        done < /tmp/valid_commits.txt
        
        # Remove duplicates from file lists
        if [ -f "/tmp/workdir/files_to_add.txt" ]; then
          sort -u /tmp/workdir/files_to_add.txt > /tmp/workdir/files_to_add_unique.txt
          mv /tmp/workdir/files_to_add_unique.txt /tmp/workdir/files_to_add.txt
        fi
        
        if [ -f "/tmp/workdir/files_to_delete.txt" ]; then
          sort -u /tmp/workdir/files_to_delete.txt > /tmp/workdir/files_to_delete_unique.txt
          mv /tmp/workdir/files_to_delete_unique.txt /tmp/workdir/files_to_delete.txt
        fi
        
        FINAL_ADD_COUNT=0
        FINAL_DEL_COUNT=0
        
        if [ -f "/tmp/workdir/files_to_add.txt" ]; then
          FINAL_ADD_COUNT=$(wc -l < /tmp/workdir/files_to_add.txt | tr -d ' ')
        fi
        
        if [ -f "/tmp/workdir/files_to_delete.txt" ]; then
          FINAL_DEL_COUNT=$(wc -l < /tmp/workdir/files_to_delete.txt | tr -d ' ')
        fi
        
        echo "add_count=$FINAL_ADD_COUNT" >> $GITHUB_OUTPUT
        echo "del_count=$FINAL_DEL_COUNT" >> $GITHUB_OUTPUT
        echo "Extraction completed: $FINAL_ADD_COUNT files to add, $FINAL_DEL_COUNT files to delete"

    - name: Copy extracted files to target
      run: |
        echo "Copying extracted files to target repository..."
        
        if [ -f "/tmp/workdir/files_to_add.txt" ] && [ -s "/tmp/workdir/files_to_add.txt" ]; then
          while IFS= read -r file; do
            [ -z "$file" ] && continue
            
            if [ -f "/tmp/workdir/extracted/$file" ]; then
              # Create directory structure
              mkdir -p "$(dirname "$file")"
              # Copy file
              cp "/tmp/workdir/extracted/$file" "$file"
              echo "‚úÖ Copied: $file"
            else
              echo "‚ö†Ô∏è Source file not found, skipping: $file"
            fi
          done < /tmp/workdir/files_to_add.txt
          echo "Files copied successfully"
        else
          echo "No files to copy"
        fi

    - name: Delete marked files
      run: |
        echo "Deleting marked files..."
        
        if [ -f "/tmp/workdir/files_to_delete.txt" ] && [ -s "/tmp/workdir/files_to_delete.txt" ]; then
          while IFS= read -r file; do
            [ -z "$file" ] && continue
            
            if [ -f "$file" ] || [ -d "$file" ]; then
              rm -rf "$file"
              echo "üóëÔ∏è Deleted: $file"
            else
              echo "‚ö†Ô∏è File not found, skipping: $file"
            fi
          done < /tmp/workdir/files_to_delete.txt
          echo "Deletion completed"
        else
          echo "No files to delete"
        fi

    - name: Create commit
      run: |
        echo "Creating commit..."
        
        # Add all changes
        git add -A
        
        # Check if there are changes
        if git diff --cached --quiet; then
          echo "No changes detected, creating empty commit"
          git commit --allow-empty \
            -m "${{ github.event.inputs.commit_name }}" \
            -m "${{ github.event.inputs.commit_message }}" \
            --author="github-actions[bot] <github-actions[bot]@users.noreply.github.com>"
        else
          # Read valid commits for commit message
          COMMITS_LIST=""
          while IFS= read -r commit; do
            [ -n "$commit" ] && COMMITS_LIST="$COMMITS_LIST  - $commit"$'\n'
          done < /tmp/valid_commits.txt
          
          # Create commit message with proper formatting
          COMMIT_MESSAGE="${{ github.event.inputs.commit_name }}

Êñá‰ª∂ÂêåÊ≠•ËØ¶ÊÉÖ:
  - Ê∫ê‰ªìÂ∫ì: ${{ github.event.inputs.source_repo }}
  - Ê∫êÂàÜÊîØ: ${{ github.event.inputs.source_branch }}
  - Â§ÑÁêÜÊèê‰∫§Êï∞: ${{ steps.validate-commits.outputs.count }}
  - Ê∑ªÂä†Êñá‰ª∂Êï∞: ${{ steps.extract-files.outputs.add_count }}
  - Âà†Èô§Êñá‰ª∂Êï∞: ${{ steps.extract-files.outputs.del_count }}

Â§ÑÁêÜÁöÑÊèê‰∫§:
$COMMITS_LIST

${{ github.event.inputs.commit_message }}"
          
          echo "Commit message:"
          echo "$COMMIT_MESSAGE"
          echo "---"
          
          git commit -m "$COMMIT_MESSAGE" --author="github-actions[bot] <github-actions[bot]@users.noreply.github.com>"
        fi
        
        echo "‚úÖ Commit created"

    - name: Push to target repository
      run: |
        echo "Pushing to target repository..."
        git push origin ${{ github.event.inputs.target_branch }}
        echo "‚úÖ Push completed"

    - name: Generate summary
      run: |
        echo "üéâ File sync completed successfully!"
        echo "========================================"
        echo "Summary:"
        echo "  Source repository: ${{ github.event.inputs.source_repo }}"
        echo "  Source branch: ${{ github.event.inputs.source_branch }}"
        echo "  Target repository: ${{ github.event.inputs.target_repo }}"
        echo "  Target branch: ${{ github.event.inputs.target_branch }}"
        echo "  Commits processed: ${{ steps.validate-commits.outputs.count }}"
        echo "  Files added: ${{ steps.extract-files.outputs.add_count }}"
        echo "  Files deleted: ${{ steps.extract-files.outputs.del_count }}"
        echo "  Commit author: github-actions[bot]"
        echo "  Commit message: ${{ github.event.inputs.commit_name }}"
        echo ""
        echo "Processed commits:"
        cat /tmp/valid_commits.txt | while read commit; do
          [ -n "$commit" ] && echo "  - $commit"
        done
        echo "========================================"

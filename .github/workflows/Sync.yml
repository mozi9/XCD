name: Manual Repository Sync - Extract and Pack Files

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: 'æºä»“åº“åœ°å€ (æ ¼å¼: owner/repo)'
        required: true
        default: 'owner/source-repo'
      target_repo:
        description: 'ç›®æ ‡ä»“åº“åœ°å€ (æ ¼å¼: owner/repo)'
        required: true
        default: 'owner/target-repo'
      source_branch:
        description: 'æºåˆ†æ”¯å'
        required: true
        default: 'main'
      target_branch:
        description: 'ç›®æ ‡åˆ†æ”¯å'
        required: true
        default: 'main'
      commit_hashes:
        description: 'è¦åŒæ­¥çš„æäº¤å“ˆå¸Œï¼ˆå¤šä¸ªç”¨é€—å·åˆ†éš”ï¼‰'
        required: true
        default: '75fef37dde7c3cbcde63ae7542f115fb04d9ee70,fa957cbe93c6260f4968cf3d01ec3974bcd49ff8'
      commit_name:
        description: 'è‡ªå®šä¹‰æäº¤åç§°'
        required: true
        default: 'mozi9: åŒæ­¥æ–‡ä»¶åŒ…'
      commit_message:
        description: 'è‡ªå®šä¹‰æäº¤ä¿¡æ¯'
        required: true
        default: 'ä»æºä»“åº“æå–å¹¶æ‰“åŒ…æ–‡ä»¶'

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  sync-repository:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout target repository
      uses: actions/checkout@v4
      with:
        repository: ${{ github.event.inputs.target_repo }}
        token: ${{ secrets.Mozi9_PAT }}
        ref: ${{ github.event.inputs.target_branch }}
        fetch-depth: 0

    - name: Add source repository as remote
      run: |
        git remote add source-repo https://github.com/${{ github.event.inputs.source_repo }}.git
        git fetch source-repo ${{ github.event.inputs.source_branch }}

    - name: Setup Git config for Mozi9
      run: |
        git config --global user.name "mozi9"
        git config --global user.email "mozi9"

    - name: Parse commit hashes
      id: parse_commits
      run: |
        # æ¸…ç†å’ŒéªŒè¯æäº¤å“ˆå¸Œ
        CLEAN_HASHES=$(echo '${{ github.event.inputs.commit_hashes }}' | tr -d '[:space:]' | tr ',' '\n' | grep -v '^$')
        
        VALID_COMMITS=""
        COMMIT_COUNT=0
        
        for hash in $CLEAN_HASHES; do
          if git rev-parse $hash >/dev/null 2>&1; then
            VALID_COMMITS="$VALID_COMMITS$hash"$'\n'
            COMMIT_COUNT=$((COMMIT_COUNT + 1))
            echo "âœ… æäº¤æœ‰æ•ˆ: $hash"
          else
            echo "âŒ æäº¤æ— æ•ˆ: $hash"
          fi
        done
        
        if [ $COMMIT_COUNT -eq 0 ]; then
          echo "é”™è¯¯: æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„æäº¤å“ˆå¸Œ"
          exit 1
        fi
        
        echo "$VALID_COMMITS" > /tmp/valid_commits.txt
        echo "æ‰¾åˆ° $COMMIT_COUNT ä¸ªæœ‰æ•ˆæäº¤"
        echo "commit_count=$COMMIT_COUNT" >> $GITHUB_OUTPUT

    - name: Extract files from commits
      id: extract_files
      run: |
        mkdir -p /tmp/extracted_files
        COMMITS=$(cat /tmp/valid_commits.txt)
        
        # ç”¨äºè·Ÿè¸ªæ–‡ä»¶å†…å®¹å’Œè·¯å¾„
        declare -A file_checksums
        declare -A deleted_files
        
        echo "å¼€å§‹ä»æäº¤ä¸­æå–æ–‡ä»¶..."
        
        for COMMIT in $COMMITS; do
          echo "å¤„ç†æäº¤: $COMMIT"
          
          # è·å–æäº¤çš„æ–‡ä»¶å˜æ›´
          git show $COMMIT --name-status --format= > /tmp/commit_changes.txt 2>/dev/null || true
          
          # å¤„ç†æ–‡ä»¶å˜æ›´
          while IFS=$'\t' read -r status file1 file2; do
            case "$status" in
              A|M|C)  # æ–°å¢ã€ä¿®æ”¹ã€å¤åˆ¶
                if [ -n "$file1" ]; then
                  # æå–æ–‡ä»¶å†…å®¹
                  if git show $COMMIT:"$file1" >/dev/null 2>&1; then
                    FILE_CONTENT=$(git show $COMMIT:"$file1")
                    CHECKSUM=$(echo "$FILE_CONTENT" | sha1sum | cut -d' ' -f1)
                    
                    # å¦‚æœchecksumä¸å­˜åœ¨ï¼Œåˆ™ä¿å­˜æ–‡ä»¶
                    if [ -z "${file_checksums[$CHECKSUM]}" ]; then
                      mkdir -p "/tmp/extracted_files/$(dirname "$file1")"
                      echo "$FILE_CONTENT" > "/tmp/extracted_files/$file1"
                      file_checksums[$CHECKSUM]="$file1"
                      echo "ğŸ“„ æå–æ–‡ä»¶: $file1"
                    else
                      echo "ğŸ” è·³è¿‡é‡å¤æ–‡ä»¶: $file1 (ä¸ ${file_checksums[$CHECKSUM]} ç›¸åŒ)"
                    fi
                  fi
                fi
                ;;
              D)  # åˆ é™¤
                if [ -n "$file1" ]; then
                  deleted_files["$file1"]=1
                  echo "ğŸ—‘ï¸ æ ‡è®°åˆ é™¤: $file1"
                fi
                ;;
              R)  # é‡å‘½å
                if [ -n "$file1" ] && [ -n "$file2" ]; then
                  deleted_files["$file1"]=1
                  echo "ğŸ”„ é‡å‘½å: $file1 -> $file2"
                  # åŒæ—¶å¤„ç†æ–°æ–‡ä»¶
                  if git show $COMMIT:"$file2" >/dev/null 2>&1; then
                    FILE_CONTENT=$(git show $COMMIT:"$file2")
                    CHECKSUM=$(echo "$FILE_CONTENT" | sha1sum | cut -d' ' -f1)
                    
                    if [ -z "${file_checksums[$CHECKSUM]}" ]; then
                      mkdir -p "/tmp/extracted_files/$(dirname "$file2")"
                      echo "$FILE_CONTENT" > "/tmp/extracted_files/$file2"
                      file_checksums[$CHECKSUM]="$file2"
                      echo "ğŸ“„ æå–é‡å‘½åæ–‡ä»¶: $file2"
                    fi
                  fi
                fi
                ;;
            esac
          done < <(grep -v '^$' /tmp/commit_changes.txt | sed 's/^[ \t]*//;s/[ \t]*$//')
        done
        
        # ä¿å­˜åˆ é™¤æ–‡ä»¶åˆ—è¡¨
        for file in "${!deleted_files[@]}"; do
          echo "$file" >> /tmp/deleted_files.txt
        done
        
        EXTRACTED_COUNT=$(find /tmp/extracted_files -type f | wc -l)
        DELETED_COUNT=${#deleted_files[@]}
        
        echo "æ–‡ä»¶æå–å®Œæˆ:"
        echo "ğŸ“Š æå–æ–‡ä»¶æ•°: $EXTRACTED_COUNT"
        echo "ğŸ“Š åˆ é™¤æ–‡ä»¶æ•°: $DELETED_COUNT"
        
        echo "extracted_count=$EXTRACTED_COUNT" >> $GITHUB_OUTPUT
        echo "deleted_count=$DELETED_COUNT" >> $GITHUB_OUTPUT

    - name: Copy files to target repository
      run: |
        echo "å¤åˆ¶æ–‡ä»¶åˆ°ç›®æ ‡ä»“åº“..."
        
        # å¤åˆ¶æå–çš„æ–‡ä»¶
        if [ -d "/tmp/extracted_files" ]; then
          cp -r /tmp/extracted_files/* . 2>/dev/null || true
          cp -r /tmp/extracted_files/.* . 2>/dev/null || true
        fi
        
        # æ¸…ç†.gitç›®å½•
        rm -rf .git 2>/dev/null || true
        
        echo "æ–‡ä»¶å¤åˆ¶å®Œæˆ"

    - name: Delete marked files
      run: |
        echo "å¤„ç†åˆ é™¤çš„æ–‡ä»¶..."
        
        if [ -f "/tmp/deleted_files.txt" ]; then
          while IFS= read -r file; do
            if [ -n "$file" ] && { [ -f "$file" ] || [ -d "$file" ]; }; then
              echo "åˆ é™¤æ–‡ä»¶: $file"
              rm -rf "$file"
            fi
          done < /tmp/deleted_files.txt
        fi
        
        echo "åˆ é™¤æ“ä½œå®Œæˆ"

    - name: Create commit with custom message
      run: |
        echo "åˆ›å»ºæäº¤..."
        
        git add .
        
        if git diff --cached --quiet; then
          echo "æ²¡æœ‰æ–‡ä»¶å˜æ›´ï¼Œåˆ›å»ºç©ºæäº¤"
          git commit --allow-empty -m "${{ github.event.inputs.commit_name }}" -m "${{ github.event.inputs.commit_message }}" --author="mozi9 <mozi9>"
        else
          git commit -m "${{ github.event.inputs.commit_name }}" -m "${{ github.event.inputs.commit_message }}" --author="mozi9 <mozi9>"
        fi
        
        echo "âœ… æäº¤åˆ›å»ºå®Œæˆ"

    - name: Push to target repository
      run: |
        echo "æ¨é€åˆ°ç›®æ ‡ä»“åº“..."
        git push https://mozi9:${{ secrets.Mozi9_PAT }}@github.com/${{ github.event.inputs.target_repo }}.git ${{ github.event.inputs.target_branch }}
        echo "âœ… æ¨é€å®Œæˆ"

    - name: Create summary
      run: |
        echo "ğŸ‰ åŒæ­¥å®Œæˆï¼"
        echo "========================================"
        echo "å¤„ç†ç»Ÿè®¡:"
        echo "ğŸ“‹ æºæäº¤æ•°é‡: ${{ steps.parse_commits.outputs.commit_count }}"
        echo "ğŸ“¦ æå–æ–‡ä»¶æ•°: ${{ steps.extract_files.outputs.extracted_count }}"
        echo "ğŸ—‘ï¸ åˆ é™¤æ–‡ä»¶æ•°: ${{ steps.extract_files.outputs.deleted_count }}"
        echo "ğŸ‘¤ æäº¤ä½œè€…: mozi9"
        echo "ğŸ“ æäº¤åç§°: ${{ github.event.inputs.commit_name }}"
        echo "ğŸ“– æäº¤ä¿¡æ¯: ${{ github.event.inputs.commit_message }}"
        echo "ğŸ¯ ç›®æ ‡ä»“åº“: ${{ github.event.inputs.target_repo }}"
        echo "ğŸŒ¿ ç›®æ ‡åˆ†æ”¯: ${{ github.event.inputs.target_branch }}"
        echo ""
        echo "å¤„ç†çš„æäº¤:"
        cat /tmp/valid_commits.txt | while read commit; do
          [ -n "$commit" ] && echo "  - $commit"
        done
        echo "========================================"


name: Manual Repository Sync - Extract and Pack Files

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: 'æºä»“åº“åœ°å€ (æ ¼å¼: owner/repo)'
        required: true
        default: 'owner/source-repo'
      target_repo:
        description: 'ç›®æ ‡ä»“åº“åœ°å€ (æ ¼å¼: owner/repo)'
        required: true
        default: 'owner/target-repo'
      source_branch:
        description: 'æºåˆ†æ”¯å'
        required: true
        default: 'main'
      target_branch:
        description: 'ç›®æ ‡åˆ†æ”¯å'
        required: true
        default: 'main'
      commit_hashes:
        description: 'è¦åŒæ­¥çš„æäº¤å“ˆå¸Œï¼ˆå¤šä¸ªç”¨é€—å·åˆ†éš”ï¼‰'
        required: true
        default: '75fef37dde7c3cbcde63ae7542f115fb04d9ee70,fa957cbe93c6260f4968cf3d01ec3974bcd49ff8'
      commit_name:
        description: 'è‡ªå®šä¹‰æäº¤åç§°'
        required: true
        default: 'mozi9: åŒæ­¥æ–‡ä»¶åŒ…'
      commit_message:
        description: 'è‡ªå®šä¹‰æäº¤ä¿¡æ¯'
        required: true
        default: 'ä»æºä»“åº“æå–å¹¶æ‰“åŒ…æ–‡ä»¶'

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  sync-repository:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout target repository
      uses: actions/checkout@v4
      with:
        repository: ${{ github.event.inputs.target_repo }}
        token: ${{ secrets.Mozi9_PAT }}
        ref: ${{ github.event.inputs.target_branch }}
        fetch-depth: 0

    - name: Add source repository as remote
      run: |
        git remote add source-repo https://github.com/${{ github.event.inputs.source_repo }}.git
        git fetch source-repo ${{ github.event.inputs.source_branch }}

    - name: Setup Git config for Mozi9
      run: |
        git config --global user.name "mozi9"
        git config --global user.email "mozi9"

    - name: Parse commit hashes
      id: parse_commits
      run: |
        # æ¸…ç†å’ŒéªŒè¯æäº¤å“ˆå¸Œ
        CLEAN_HASHES=$(echo '${{ github.event.inputs.commit_hashes }}' | tr -d '[:space:]' | tr ',' '\n' | grep -v '^$')
        
        VALID_COMMITS=""
        COMMIT_COUNT=0
        
        for hash in $CLEAN_HASHES; do
          if git rev-parse $hash >/dev/null 2>&1; then
            VALID_COMMITS="$VALID_COMMITS$hash"$'\n'
            COMMIT_COUNT=$((COMMIT_COUNT + 1))
            echo "âœ… æäº¤æœ‰æ•ˆ: $hash"
          else
            echo "âŒ æäº¤æ— æ•ˆ: $hash"
          fi
        done
        
        if [ $COMMIT_COUNT -eq 0 ]; then
          echo "é”™è¯¯: æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„æäº¤å“ˆå¸Œ"
          exit 1
        fi
        
        echo "$VALID_COMMITS" > /tmp/valid_commits.txt
        echo "æ‰¾åˆ° $COMMIT_COUNT ä¸ªæœ‰æ•ˆæäº¤"
        echo "commit_count=$COMMIT_COUNT" >> $GITHUB_OUTPUT

    - name: Analyze file changes from source commits
      id: analyze_files
      run: |
        COMMITS=$(cat /tmp/valid_commits.txt)
        
        # ç”¨äºè·Ÿè¸ªæ–‡ä»¶æ“ä½œ
        declare -A files_to_add
        declare -A files_to_delete
        
        echo "åˆ†ææºæäº¤ä¸­çš„æ–‡ä»¶å˜æ›´..."
        
        for COMMIT in $COMMITS; do
          echo "åˆ†ææäº¤: $COMMIT"
          
          # è·å–æäº¤çš„æ–‡ä»¶å˜æ›´çŠ¶æ€
          git show $COMMIT --name-status --format= > /tmp/commit_changes.txt 2>/dev/null || true
          
          # å¤„ç†æ–‡ä»¶å˜æ›´
          while IFS=$'\t' read -r status file1 file2; do
            case "$status" in
              A|M|C)  # æ–°å¢ã€ä¿®æ”¹ã€å¤åˆ¶ - éœ€è¦æ·»åŠ çš„æ–‡ä»¶
                if [ -n "$file1" ]; then
                  files_to_add["$file1"]="$COMMIT"
                  echo "ğŸ“„ éœ€è¦æ·»åŠ : $file1"
                fi
                if [ -n "$file2" ]; then  # å¤åˆ¶æˆ–é‡å‘½åçš„æ–°æ–‡ä»¶
                  files_to_add["$file2"]="$COMMIT"
                  echo "ğŸ“„ éœ€è¦æ·»åŠ : $file2"
                fi
                ;;
              D)  # åˆ é™¤ - éœ€è¦åˆ é™¤çš„æ–‡ä»¶
                if [ -n "$file1" ]; then
                  files_to_delete["$file1"]="$COMMIT"
                  echo "ğŸ—‘ï¸ éœ€è¦åˆ é™¤: $file1"
                fi
                ;;
              R)  # é‡å‘½å
                if [ -n "$file1" ]; then
                  files_to_delete["$file1"]="$COMMIT"  # åŸæ–‡ä»¶åˆ é™¤
                  echo "ğŸ—‘ï¸ éœ€è¦åˆ é™¤(é‡å‘½å): $file1"
                fi
                if [ -n "$file2" ]; then
                  files_to_add["$file2"]="$COMMIT"  # æ–°æ–‡ä»¶æ·»åŠ 
                  echo "ğŸ“„ éœ€è¦æ·»åŠ (é‡å‘½å): $file2"
                fi
                ;;
            esac
          done < <(grep -v '^$' /tmp/commit_changes.txt | sed 's/^[ \t]*//;s/[ \t]*$//')
        done
        
        # ä¿å­˜éœ€è¦æ·»åŠ çš„æ–‡ä»¶åˆ—è¡¨
        for file in "${!files_to_add[@]}"; do
          echo "$file" >> /tmp/files_to_add.txt
        done
        
        # ä¿å­˜éœ€è¦åˆ é™¤çš„æ–‡ä»¶åˆ—è¡¨
        for file in "${!files_to_delete[@]}"; do
          echo "$file" >> /tmp/files_to_delete.txt
        done
        
        ADD_COUNT=${#files_to_add[@]}
        DELETE_COUNT=${#files_to_delete[@]}
        
        echo "æ–‡ä»¶åˆ†æå®Œæˆ:"
        echo "ğŸ“Š éœ€è¦æ·»åŠ çš„æ–‡ä»¶æ•°: $ADD_COUNT"
        echo "ğŸ“Š éœ€è¦åˆ é™¤çš„æ–‡ä»¶æ•°: $DELETE_COUNT"
        
        echo "add_count=$ADD_COUNT" >> $GITHUB_OUTPUT
        echo "delete_count=$DELETE_COUNT" >> $GITHUB_OUTPUT

    - name: Copy files from source commits
      run: |
        echo "ä»æºæäº¤å¤åˆ¶æ–‡ä»¶åˆ°ç›®æ ‡ä»“åº“..."
        
        if [ ! -f "/tmp/files_to_add.txt" ] || [ ! -s "/tmp/files_to_add.txt" ]; then
          echo "æ²¡æœ‰éœ€è¦æ·»åŠ çš„æ–‡ä»¶"
          exit 0
        fi
        
        ADD_COUNT=0
        while IFS= read -r file; do
          if [ -z "$file" ]; then
            continue
          fi
          
          # ä»æœ€åä¸€ä¸ªåŒ…å«è¯¥æ–‡ä»¶çš„æäº¤ä¸­è·å–æ–‡ä»¶
          COMMIT=$(git log --oneline -1 --format=%H -- "$file" source-repo/${{ github.event.inputs.source_branch }} 2>/dev/null || echo "")
          
          if [ -n "$COMMIT" ] && git show $COMMIT:"$file" >/dev/null 2>&1; then
            # åˆ›å»ºç›®å½•
            mkdir -p "$(dirname "$file")"
            # å¤åˆ¶æ–‡ä»¶
            git show $COMMIT:"$file" > "$file"
            ADD_COUNT=$((ADD_COUNT + 1))
            echo "âœ… å¤åˆ¶æ–‡ä»¶: $file"
          else
            echo "âŒ æ— æ³•è·å–æ–‡ä»¶: $file"
          fi
        done < /tmp/files_to_add.txt
        
        echo "æ–‡ä»¶å¤åˆ¶å®Œæˆ: æˆåŠŸå¤åˆ¶ $ADD_COUNT ä¸ªæ–‡ä»¶"

    - name: Delete files marked for deletion
      run: |
        echo "åˆ é™¤æºæäº¤ä¸­æ ‡è®°ä¸ºåˆ é™¤çš„æ–‡ä»¶..."
        
        if [ ! -f "/tmp/files_to_delete.txt" ] || [ ! -s "/tmp/files_to_delete.txt" ]; then
          echo "æ²¡æœ‰éœ€è¦åˆ é™¤çš„æ–‡ä»¶"
          exit 0
        fi
        
        DELETE_COUNT=0
        while IFS= read -r file; do
          if [ -z "$file" ]; then
            continue
          fi
          
          if [ -f "$file" ] || [ -d "$file" ]; then
            rm -rf "$file"
            DELETE_COUNT=$((DELETE_COUNT + 1))
            echo "âœ… åˆ é™¤æ–‡ä»¶: $file"
          else
            echo "âš ï¸ æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡åˆ é™¤: $file"
          fi
        done < /tmp/files_to_delete.txt
        
        echo "åˆ é™¤å®Œæˆ: å®é™…åˆ é™¤ $DELETE_COUNT ä¸ªæ–‡ä»¶"

    - name: Create commit with custom message
      run: |
        echo "åˆ›å»ºæäº¤..."
        
        # æ·»åŠ æ‰€æœ‰å˜æ›´åˆ°æš‚å­˜åŒº
        git add .
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
        if git diff --cached --quiet; then
          echo "æ²¡æœ‰æ–‡ä»¶å˜æ›´ï¼Œåˆ›å»ºç©ºæäº¤"
          git commit --allow-empty \
            -m "${{ github.event.inputs.commit_name }}" \
            -m "${{ github.event.inputs.commit_message }}" \
            --author="mozi9 <mozi9>"
        else
          # åˆ›å»ºè¯¦ç»†çš„æäº¤ä¿¡æ¯
          COMMIT_BODY="æ–‡ä»¶å˜æ›´è¯¦æƒ…:
- æ·»åŠ æ–‡ä»¶: ${{ steps.analyze_files.outputs.add_count }} ä¸ª
- åˆ é™¤æ–‡ä»¶: ${{ steps.analyze_files.outputs.delete_count }} ä¸ª
- æºæäº¤æ•°é‡: ${{ steps.parse_commits.outputs.commit_count }}

æºæäº¤åˆ—è¡¨:
$(cat /tmp/valid_commits.txt | while read commit; do 
  [ -n "$commit" ] && echo "  - $commit"; 
done)

${{ github.event.inputs.commit_message }}"
          
          git commit \
            -m "${{ github.event.inputs.commit_name }}" \
            -m "$COMMIT_BODY" \
            --author="mozi9 <mozi9>"
        fi
        
        echo "âœ… æäº¤åˆ›å»ºå®Œæˆ"

    - name: Push to target repository
      run: |
        echo "æ¨é€åˆ°ç›®æ ‡ä»“åº“..."
        git push origin ${{ github.event.inputs.target_branch }}
        echo "âœ… æ¨é€å®Œæˆ"

    - name: Create summary
      run: |
        echo "ğŸ‰ åŒæ­¥å®Œæˆï¼"
        echo "========================================"
        echo "å¤„ç†ç»Ÿè®¡:"
        echo "ğŸ“‹ æºæäº¤æ•°é‡: ${{ steps.parse_commits.outputs.commit_count }}"
        echo "ğŸ“¦ æ·»åŠ æ–‡ä»¶æ•°: ${{ steps.analyze_files.outputs.add_count }}"
        echo "ğŸ—‘ï¸ åˆ é™¤æ–‡ä»¶æ•°: ${{ steps.analyze_files.outputs.delete_count }}"
        echo "ğŸ‘¤ æäº¤ä½œè€…: mozi9"
        echo "ğŸ“ æäº¤åç§°: ${{ github.event.inputs.commit_name }}"
        echo "ğŸ“– æäº¤ä¿¡æ¯: ${{ github.event.inputs.commit_message }}"
        echo "ğŸ¯ ç›®æ ‡ä»“åº“: ${{ github.event.inputs.target_repo }}"
        echo "ğŸŒ¿ ç›®æ ‡åˆ†æ”¯: ${{ github.event.inputs.target_branch }}"
        echo ""
        echo "æ·»åŠ çš„æ–‡ä»¶:"
        cat /tmp/files_to_add.txt 2>/dev/null | head -10 | sed 's/^/  - /' || echo "  - æ— "
        echo ""
        echo "åˆ é™¤çš„æ–‡ä»¶:"
        cat /tmp/files_to_delete.txt 2>/dev/null | head -10 | sed 's/^/  - /' || echo "  - æ— "
        echo "========================================"

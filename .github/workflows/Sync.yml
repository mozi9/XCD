name: Repository Sync - Extract and Commit Files

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: 'æºä»“åº“åœ°å€ (æ ¼å¼: owner/repo)'
        required: true
        default: 'owner/source-repo'
      target_repo:
        description: 'ç›®æ ‡ä»“åº“åœ°å€ (æ ¼å¼: owner/repo)'
        required: true
        default: 'owner/target-repo'
      source_branch:
        description: 'æºåˆ†æ”¯å'
        required: true
        default: 'main'
      target_branch:
        description: 'ç›®æ ‡åˆ†æ”¯å'
        required: true
        default: 'main'
      commit_hashes:
        description: 'è¦åŒæ­¥çš„æäº¤å“ˆå¸Œï¼ˆå¤šä¸ªç”¨é€—å·åˆ†éš”ï¼‰'
        required: true
        default: '75fef37dde7c3cbcde63ae7542f115fb04d9ee70,fa957cbe93c6260f4968cf3d01ec3974bcd49ff8'
      commit_name:
        description: 'è‡ªå®šä¹‰æäº¤åç§°'
        required: true
        default: 'mozi9: æ–‡ä»¶åŒæ­¥'
      commit_message:
        description: 'è‡ªå®šä¹‰æäº¤ä¿¡æ¯'
        required: true
        default: 'ä»æºä»“åº“åŒæ­¥æ–‡ä»¶'

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  sync-files:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout target repository
      uses: actions/checkout@v4
      with:
        repository: ${{ github.event.inputs.target_repo }}
        token: ${{ secrets.Mozi9_PAT }}
        ref: ${{ github.event.inputs.target_branch }}
        fetch-depth: 0

    - name: Add source repository remote
      run: |
        git remote add source-repo https://github.com/${{ github.event.inputs.source_repo }}.git
        git fetch source-repo ${{ github.event.inputs.source_branch }}

    - name: Configure Git identity
      run: |
        git config --global user.name "mozi9"
        git config --global user.email "mozi9"

    - name: Parse and validate commit hashes
      id: parse-commits
      run: |
        # Clean and split commit hashes
        CLEAN_HASHES=$(echo '${{ github.event.inputs.commit_hashes }}' | tr -d '[:space:]' | tr ',' '\n')
        VALID_COMMITS=""
        COUNT=0
        
        for hash in $CLEAN_HASHES; do
          if [ -n "$hash" ] && git rev-parse "$hash" >/dev/null 2>&1; then
            VALID_COMMITS="$VALID_COMMITS$hash"$'\n'
            COUNT=$((COUNT + 1))
            echo "âœ… Valid commit: $hash"
          else
            echo "âŒ Invalid commit: $hash"
          fi
        done
        
        if [ $COUNT -eq 0 ]; then
          echo "No valid commits found"
          exit 1
        fi
        
        echo "$VALID_COMMITS" > /tmp/valid_commits.txt
        echo "count=$COUNT" >> $GITHUB_OUTPUT
        echo "Found $COUNT valid commits"

    - name: Analyze file changes from source commits
      id: analyze-files
      run: |
        echo "Analyzing file changes from source commits..."
        
        # Initialize arrays
        declare -A files_to_add
        declare -A files_to_delete
        
        # Read commits
        while IFS= read -r commit; do
          [ -z "$commit" ] && continue
          echo "Analyzing commit: $commit"
          
          # Get file changes
          git show "$commit" --name-status --format= > /tmp/changes.txt 2>/dev/null || true
          
          while IFS=$'\t' read -r status file1 file2; do
            case "$status" in
              A|M|C)  # Add/Modify/Copy
                if [ -n "$file1" ]; then
                  files_to_add["$file1"]=1
                fi
                if [ -n "$file2" ]; then
                  files_to_add["$file2"]=1
                fi
                ;;
              D)  # Delete
                if [ -n "$file1" ]; then
                  files_to_delete["$file1"]=1
                fi
                ;;
              R)  # Rename
                if [ -n "$file1" ]; then
                  files_to_delete["$file1"]=1
                fi
                if [ -n "$file2" ]; then
                  files_to_add["$file2"]=1
                fi
                ;;
            esac
          done < <(grep -v '^$' /tmp/changes.txt)
        done < /tmp/valid_commits.txt
        
        # Save file lists
        for file in "${!files_to_add[@]}"; do
          echo "$file" >> /tmp/files_to_add.txt
        done
        
        for file in "${!files_to_delete[@]}"; do
          echo "$file" >> /tmp/files_to_delete.txt
        done
        
        add_count=${#files_to_add[@]}
        del_count=${#files_to_delete[@]}
        
        echo "add_count=$add_count" >> $GITHUB_OUTPUT
        echo "del_count=$del_count" >> $GITHUB_OUTPUT
        echo "Files to add: $add_count"
        echo "Files to delete: $del_count"

    - name: Copy new/modified files from source
      run: |
        echo "Copying files from source commits..."
        
        if [ ! -f "/tmp/files_to_add.txt" ]; then
          echo "No files to add"
          exit 0
        fi
        
        processed=0
        while IFS= read -r file; do
          [ -z "$file" ] && continue
          
          # Find which commit has this file
          commit=$(grep -l "$file" /tmp/valid_commits.txt 2>/dev/null | head -1 || echo "")
          if [ -z "$commit" ]; then
            commit=$(head -1 /tmp/valid_commits.txt)
          fi
          
          if git show "$commit:$file" >/dev/null 2>&1; then
            mkdir -p "$(dirname "$file")"
            git show "$commit:$file" > "$file"
            processed=$((processed + 1))
            echo "ğŸ“„ Copied: $file"
          fi
        done < /tmp/files_to_add.txt
        
        echo "Copied $processed files"

    - name: Delete files marked for removal
      run: |
        echo "Deleting files..."
        
        if [ ! -f "/tmp/files_to_delete.txt" ]; then
          echo "No files to delete"
          exit 0
        fi
        
        deleted=0
        while IFS= read -r file; do
          [ -z "$file" ] && continue
          
          if [ -e "$file" ]; then
            rm -rf "$file"
            deleted=$((deleted + 1))
            echo "ğŸ—‘ï¸ Deleted: $file"
          fi
        done < /tmp/files_to_delete.txt
        
        echo "Deleted $deleted files"

    - name: Create commit with custom messages
      run: |
        echo "Creating commit..."
        
        git add .
        
        if git diff --cached --quiet; then
          echo "No changes to commit"
          git commit --allow-empty \
            -m "${{ github.event.inputs.commit_name }}" \
            -m "${{ github.event.inputs.commit_message }}" \
            --author="mozi9 <mozi9>"
        else
          git commit \
            -m "${{ github.event.inputs.commit_name }}" \
            -m "${{ github.event.inputs.commit_message }}" \
            --author="mozi9 <mozi9>"
        fi
        
        echo "âœ… Commit created"

    - name: Push changes to target repository
      run: |
        echo "Pushing to target repository..."
        git push origin ${{ github.event.inputs.target_branch }}
        echo "âœ… Push completed"

    - name: Generate summary
      run: |
        echo "ğŸ‰ Sync completed successfully!"
        echo "========================================"
        echo "Summary:"
        echo "ğŸ“‹ Source commits: ${{ steps.parse-commits.outputs.count }}"
        echo "ğŸ“¦ Files added: ${{ steps.analyze-files.outputs.add_count }}"
        echo "ğŸ—‘ï¸ Files deleted: ${{ steps.analyze-files.outputs.del_count }}"
        echo "ğŸ‘¤ Commit author: mozi9"
        echo "ğŸ“ Commit name: ${{ github.event.inputs.commit_name }}"
        echo "ğŸ”— Target repo: ${{ github.event.inputs.target_repo }}"
        echo "ğŸŒ¿ Target branch: ${{ github.event.inputs.target_branch }}"
        echo "========================================"

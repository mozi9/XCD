name: Repository Sync - Custom Commit with Add/Delete Only

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: 'æºä»“åº“åœ°å€ (æ ¼å¼: owner/repo)'
        required: true
        default: 'owner/source-repo'
      target_repo:
        description: 'ç›®æ ‡ä»“åº“åœ°å€ (æ ¼å¼: owner/repo)'
        required: true
        default: 'owner/target-repo'
      source_branch:
        description: 'æºåˆ†æ”¯å'
        required: true
        default: 'main'
      target_branch:
        description: 'ç›®æ ‡åˆ†æ”¯å'
        required: true
        default: 'main'
      commit_hashes:
        description: 'è¦åŒæ­¥çš„æäº¤å“ˆå¸Œï¼ˆå¤šä¸ªç”¨é€—å·åˆ†éš”ï¼‰'
        required: true
        default: '75fef37dde7c3cbcde63ae7542f115fb04d9ee70,fa957cbe93c6260f4968cf3d01ec3974bcd49ff8,5a3d762db366d870e8959c143dc7037c51450675'
      commit_name:
        description: 'è‡ªå®šä¹‰æäº¤åï¼ˆæäº¤ä¿¡æ¯æ ‡é¢˜ï¼‰'
        required: true
        default: 'mozi9: åŒæ­¥æ–‡ä»¶å˜æ›´'
      commit_description:
        description: 'è‡ªå®šä¹‰æäº¤æè¿°ï¼ˆå¯é€‰ï¼‰'
        required: false
        default: ''
      max_commits:
        description: 'æœ€å¤§åŒæ­¥æäº¤æ•°é‡'
        required: true
        default: '50'

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  sync-repository:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout target repository
      uses: actions/checkout@v4
      with:
        repository: ${{ github.event.inputs.target_repo }}
        token: ${{ secrets.Mozi9_PAT }}
        ref: ${{ github.event.inputs.target_branch }}
        fetch-depth: 0

    - name: Add source repository as remote
      run: |
        git remote add source-repo https://github.com/${{ github.event.inputs.source_repo }}.git
        git fetch source-repo ${{ github.event.inputs.source_branch }} --depth=100

    - name: Setup Git config for Mozi9
      run: |
        git config --global user.name "mozi9"
        git config --global user.email "mozi9"

    - name: Parse and validate commit hashes
      id: parse_commits
      run: |
        # æ¸…ç†è¾“å…¥ï¼Œç§»é™¤ç©ºæ ¼å’Œæ¢è¡Œ
        CLEAN_HASHES=$(echo '${{ github.event.inputs.commit_hashes }}' | tr -d '[:space:]' | tr ',' '\n' | grep -v '^$')
        
        # éªŒè¯æ¯ä¸ªæäº¤å“ˆå¸Œæ˜¯å¦å­˜åœ¨
        VALID_COMMITS=""
        INVALID_COMMITS=""
        COMMIT_COUNT=0
        
        for hash in $CLEAN_HASHES; do
          if git rev-parse --verify "$hash" >/dev/null 2>&1; then
            COMMIT_SUBJECT=$(git log -1 --format="%s" "$hash" 2>/dev/null || echo "æ— æ³•è·å–æäº¤ä¿¡æ¯")
            echo "âœ… æäº¤æœ‰æ•ˆ: $hash - $COMMIT_SUBJECT"
            VALID_COMMITS="$VALID_COMMITS$hash"$'\n'
            COMMIT_COUNT=$((COMMIT_COUNT + 1))
          else
            echo "âŒ æäº¤æ— æ•ˆ: $hash"
            INVALID_COMMITS="$INVALID_COMMITS$hash"$'\n'
          fi
        done
        
        if [ $COMMIT_COUNT -eq 0 ]; then
          echo "âŒ é”™è¯¯: æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„æäº¤å“ˆå¸Œ"
          exit 1
        fi
        
        # é™åˆ¶æäº¤æ•°é‡
        MAX_COMMITS=${{ github.event.inputs.max_commits }}
        if [ $COMMIT_COUNT -gt $MAX_COMMITS ]; then
          echo "âš ï¸ è­¦å‘Š: æäº¤æ•°é‡ $COMMIT_COUNT è¶…è¿‡æœ€å¤§é™åˆ¶ $MAX_COMMITSï¼Œå°†åªå¤„ç†å‰ $MAX_COMMITS ä¸ªæäº¤"
          VALID_COMMITS=$(echo "$VALID_COMMITS" | head -n $MAX_COMMITS)
          COMMIT_COUNT=$MAX_COMMITS
        fi
        
        # ä¿å­˜æœ‰æ•ˆæäº¤åˆ°æ–‡ä»¶
        echo "$VALID_COMMITS" > /tmp/valid_commits.txt
        
        # è¾“å‡ºç»Ÿè®¡ä¿¡æ¯
        echo "ğŸ“Š æäº¤éªŒè¯å®Œæˆ:"
        echo "  æœ‰æ•ˆæäº¤: $COMMIT_COUNT ä¸ª"
        if [ -n "$INVALID_COMMITS" ]; then
          echo "  æ— æ•ˆæäº¤: $(echo "$INVALID_COMMITS" | grep -c .) ä¸ª"
          echo "$INVALID_COMMITS"
        fi
        
        echo "commit_count=$COMMIT_COUNT" >> $GITHUB_OUTPUT

    - name: Collect and deduplicate files from source commits
      id: collect_files
      run: |
        echo "ä»æºæäº¤ä¸­æ”¶é›†æ–‡ä»¶å¹¶å»é‡..."
        
        # ä½¿ç”¨å…³è”æ•°ç»„å»é‡ï¼ˆåé¢çš„æäº¤è¦†ç›–å‰é¢çš„ï¼‰
        declare -A ALL_FILES_HASH
        declare -A FILE_TO_COMMIT_MAP
        declare -A DELETED_FILES_HASH
        
        COMMITS=$(cat /tmp/valid_commits.txt)
        
        # æŒ‰æäº¤é¡ºåºå¤„ç†æ–‡ä»¶
        for COMMIT in $COMMITS; do
          echo "ğŸ“ å¤„ç†æäº¤: $COMMIT"
          
          # è·å–è¯¥æäº¤çš„æ‰€æœ‰å˜æ›´æ–‡ä»¶
          COMMIT_FILES=$(git show --name-only --format= "$COMMIT" 2>/dev/null | grep -v '^$' || true)
          
          # è·å–è¯¥æäº¤ä¸­åˆ é™¤çš„æ–‡ä»¶
          DELETED_IN_COMMIT=$(git show "$COMMIT" --name-only --diff-filter=D --format= 2>/dev/null || true)
          if [ -n "$DELETED_IN_COMMIT" ]; then
            echo "  åˆ é™¤æ–‡ä»¶: $(echo "$DELETED_IN_COMMIT" | wc -l) ä¸ª"
            for file in $DELETED_IN_COMMIT; do
              DELETED_FILES_HASH["$file"]=1
              # ä»æ–‡ä»¶é›†åˆä¸­ç§»é™¤è¢«åˆ é™¤çš„æ–‡ä»¶
              unset ALL_FILES_HASH["$file"]
              unset FILE_TO_COMMIT_MAP["$file"]
            done
          fi
          
          # å¤„ç†æ–°å¢å’Œä¿®æ”¹çš„æ–‡ä»¶
          AM_FILES=$(git show "$COMMIT" --name-only --diff-filter=AM --format= 2>/dev/null || true)
          if [ -n "$AM_FILES" ]; then
            echo "  æ–°å¢/ä¿®æ”¹æ–‡ä»¶: $(echo "$AM_FILES" | wc -l) ä¸ª"
            for file in $AM_FILES; do
              # è·³è¿‡åˆ é™¤çš„æ–‡ä»¶
              if [ -n "${DELETED_FILES_HASH[$file]}" ]; then
                continue
              fi
              # è®°å½•æ–‡ä»¶åŠå…¶å¯¹åº”çš„æœ€æ–°æäº¤
              ALL_FILES_HASH["$file"]=1
              FILE_TO_COMMIT_MAP["$file"]=$COMMIT
            done
          fi
        done
        
        # ä¿å­˜ç»“æœ
        printf "%s\n" "${!ALL_FILES_HASH[@]}" | sort > /tmp/all_files.txt
        printf "%s\n" "${!DELETED_FILES_HASH[@]}" | sort > /tmp/deleted_files.txt
        
        # ä¿å­˜æ–‡ä»¶åˆ°æäº¤çš„æ˜ å°„
        for file in "${!FILE_TO_COMMIT_MAP[@]}"; do
          echo "$file:${FILE_TO_COMMIT_MAP[$file]}" >> /tmp/file_commit_map.txt
        done
        
        echo "ğŸ“Š æ–‡ä»¶æ”¶é›†å®Œæˆ:"
        echo "  ä¿ç•™æ–‡ä»¶: ${#ALL_FILES_HASH[@]} ä¸ª"
        echo "  åˆ é™¤æ–‡ä»¶: ${#DELETED_FILES_HASH[@]} ä¸ª"
        echo "  æ–‡ä»¶æ˜ å°„: /tmp/file_commit_map.txt"

    - name: Copy files from source commits
      id: copy_files
      run: |
        echo "ä»æºæäº¤å¤åˆ¶æ–‡ä»¶åˆ°ç›®æ ‡ä»“åº“..."
        
        ALL_FILES=$(cat /tmp/all_files.txt 2>/dev/null || true)
        
        if [ -n "$ALL_FILES" ]; then
          COPY_COUNT=0
          FAIL_COUNT=0
          
          for file in $ALL_FILES; do
            # ä»æ–‡ä»¶æ˜ å°„ä¸­è·å–å¯¹åº”çš„æäº¤
            COMMIT=$(grep "^$file:" /tmp/file_commit_map.txt 2>/dev/null | cut -d: -f2)
            
            if [ -z "$COMMIT" ]; then
              echo "âš ï¸ è­¦å‘Š: æœªæ‰¾åˆ°æ–‡ä»¶ $file çš„æäº¤æ˜ å°„"
              continue
            fi
            
            if git show "$COMMIT":"$file" >/dev/null 2>&1; then
              echo "ğŸ“„ å¤åˆ¶: $file (æ¥è‡ªæäº¤ $COMMIT)"
              mkdir -p "$(dirname "$file")"
              
              # å¤åˆ¶æ–‡ä»¶å†…å®¹
              if git show "$COMMIT":"$file" > "$file" 2>/dev/null; then
                git add "$file"
                COPY_COUNT=$((COPY_COUNT + 1))
              else
                echo "âŒ å¤åˆ¶å¤±è´¥: $file"
                FAIL_COUNT=$((FAIL_COUNT + 1))
              fi
            else
              echo "âŒ æ— æ³•è·å–æ–‡ä»¶: $file"
              FAIL_COUNT=$((FAIL_COUNT + 1))
            fi
          done
          
          echo "âœ… æ–‡ä»¶å¤åˆ¶å®Œæˆ:"
          echo "  æˆåŠŸ: $COPY_COUNT ä¸ªæ–‡ä»¶"
          echo "  å¤±è´¥: $FAIL_COUNT ä¸ªæ–‡ä»¶"
          
          echo "copy_count=$COPY_COUNT" >> $GITHUB_OUTPUT
          echo "fail_count=$FAIL_COUNT" >> $GITHUB_OUTPUT
        else
          echo "â„¹ï¸ æ²¡æœ‰æ–‡ä»¶éœ€è¦å¤åˆ¶"
          echo "copy_count=0" >> $GITHUB_OUTPUT
          echo "fail_count=0" >> $GITHUB_OUTPUT
        fi

    - name: Create commit with file changes
      id: create_commit
      run: |
        echo "åˆ›å»ºæ–‡ä»¶å˜æ›´æäº¤..."
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜æ›´
        if git diff --cached --quiet; then
          echo "â„¹ï¸ æ²¡æœ‰æ–‡ä»¶å˜æ›´éœ€è¦æäº¤"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "ğŸ“ æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´ï¼Œå‡†å¤‡æäº¤..."
          echo "has_changes=true" >> $GITHUB_OUTPUT
          
          # å‡†å¤‡æäº¤ä¿¡æ¯
          COMMIT_NAME="${{ github.event.inputs.commit_name }}"
          COMMIT_DESC="${{ github.event.inputs.commit_description }}"
          
          if [ -z "$COMMIT_NAME" ]; then
            COMMIT_NAME="mozi9: åŒæ­¥æ–‡ä»¶å˜æ›´"
          fi
          
          COMMIT_MSG="$COMMIT_NAME"
          if [ -n "$COMMIT_DESC" ]; then
            COMMIT_MSG="$COMMIT_MSG"$'\n\n'"$COMMIT_DESC"
          fi
          
          # æ·»åŠ ç»Ÿè®¡ä¿¡æ¯
          FILE_COUNT=${{ steps.copy_files.outputs.copy_count || 0 }}
          DEL_COUNT=$(cat /tmp/deleted_files.txt 2>/dev/null | wc -l || echo 0)
          COMMIT_COUNT=${{ steps.parse_commits.outputs.commit_count }}
          
          COMMIT_MSG="$COMMIT_MSG"$'\n\n'"åŒæ­¥ç»Ÿè®¡:"
          COMMIT_MSG="$COMMIT_MSG"$'\n'"- æ–°å¢/ä¿®æ”¹æ–‡ä»¶: $FILE_COUNT ä¸ª"
          COMMIT_MSG="$COMMIT_MSG"$'\n'"- æ ‡è®°åˆ é™¤æ–‡ä»¶: $DEL_COUNT ä¸ª" 
          COMMIT_MSG="$COMMIT_MSG"$'\n'"- æºæäº¤æ•°é‡: $COMMIT_COUNT ä¸ª"
          
          # åˆ›å»ºæäº¤
          git commit -m "$COMMIT_MSG" --author="mozi9 <mozi9>"
          echo "âœ… æ–‡ä»¶å˜æ›´æäº¤åˆ›å»ºå®Œæˆ"
          echo "æäº¤å“ˆå¸Œ: $(git rev-parse HEAD)"
        fi

    - name: Delete marked files
      id: delete_files
      run: |
        echo "å¤„ç†æ ‡è®°ä¸ºåˆ é™¤çš„æ–‡ä»¶..."
        
        DELETED_FILES=$(cat /tmp/deleted_files.txt 2>/dev/null || true)
        
        if [ -n "$DELETED_FILES" ]; then
          DEL_COUNT=0
          SKIP_COUNT=0
          
          for file in $DELETED_FILES; do
            if [ -e "$file" ]; then
              echo "ğŸ—‘ï¸ åˆ é™¤: $file"
              # ä½¿ç”¨ git rm æ¥ç¡®ä¿æ­£ç¡®åˆ é™¤
              git rm "$file" >/dev/null 2>&1 || rm -rf "$file"
              DEL_COUNT=$((DEL_COUNT + 1))
            else
              echo "â„¹ï¸ è·³è¿‡(ä¸å­˜åœ¨): $file"
              SKIP_COUNT=$((SKIP_COUNT + 1))
            fi
          done
          
          if [ $DEL_COUNT -gt 0 ]; then
            git commit -m "mozi9: åˆ é™¤æ ‡è®°ä¸ºåˆ é™¤çš„æ–‡ä»¶ ($DEL_COUNT ä¸ª)" --author="mozi9 <mozi9>"
            echo "âœ… åˆ é™¤æ“ä½œå®Œæˆ:"
            echo "  å®é™…åˆ é™¤: $DEL_COUNT ä¸ªæ–‡ä»¶"
            echo "  è·³è¿‡(ä¸å­˜åœ¨): $SKIP_COUNT ä¸ªæ–‡ä»¶"
          else
            echo "â„¹ï¸ æ²¡æœ‰éœ€è¦åˆ é™¤çš„æ–‡ä»¶"
          fi
          
          echo "deleted_count=$DEL_COUNT" >> $GITHUB_OUTPUT
          echo "skipped_count=$SKIP_COUNT" >> $GITHUB_OUTPUT
        else
          echo "â„¹ï¸ æ²¡æœ‰æ ‡è®°ä¸ºåˆ é™¤çš„æ–‡ä»¶"
          echo "deleted_count=0" >> $GITHUB_OUTPUT
          echo "skipped_count=0" >> $GITHUB_OUTPUT
        fi

    - name: Push changes to target repository
      run: |
        echo "æ¨é€åˆ°ç›®æ ‡ä»“åº“..."
        
        # æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦æ¨é€çš„å˜æ›´
        if git diff --quiet origin/${{ github.event.inputs.target_branch }} ${{ github.event.inputs.target_branch }}; then
          echo "â„¹ï¸ æ²¡æœ‰éœ€è¦æ¨é€çš„å˜æ›´"
        else
          echo "ğŸš€ æ¨é€å˜æ›´åˆ°ç›®æ ‡ä»“åº“..."
          git push https://mozi9:${{ secrets.Mozi9_PAT }}@github.com/${{ github.event.inputs.target_repo }}.git ${{ github.event.inputs.target_branch }}
          echo "âœ… æ¨é€å®Œæˆ"
        fi

    - name: Generate final report
      run: |
        echo "ğŸ‰ åŒæ­¥å®Œæˆï¼"
        echo "=================================================="
        echo "ğŸ“Š æœ€ç»ˆç»Ÿè®¡:"
        echo "  æºæäº¤æ•°é‡: ${{ steps.parse_commits.outputs.commit_count }} ä¸ª"
        echo "  æˆåŠŸå¤åˆ¶æ–‡ä»¶: ${{ steps.copy_files.outputs.copy_count || 0 }} ä¸ª"
        echo "  å¤åˆ¶å¤±è´¥æ–‡ä»¶: ${{ steps.copy_files.outputs.fail_count || 0 }} ä¸ª"
        echo "  å®é™…åˆ é™¤æ–‡ä»¶: ${{ steps.delete_files.outputs.deleted_count || 0 }} ä¸ª"
        echo "  è·³è¿‡åˆ é™¤æ–‡ä»¶: ${{ steps.delete_files.outputs.skipped_count || 0 }} ä¸ª"
        echo ""
        echo "ğŸ”§ é…ç½®ä¿¡æ¯:"
        echo "  ç›®æ ‡ä»“åº“: ${{ github.event.inputs.target_repo }}"
        echo "  ç›®æ ‡åˆ†æ”¯: ${{ github.event.inputs.target_branch }}"
        echo "  æäº¤åç§°: ${{ github.event.inputs.commit_name }}"
        echo ""
        
        # æ˜¾ç¤ºæäº¤ä¿¡æ¯
        if [ "${{ steps.create_commit.outputs.has_changes }}" = "true" ]; then
          echo "ğŸ“ æ–‡ä»¶å˜æ›´æäº¤:"
          git log --format=%B -n 1 HEAD~$(({{ steps.delete_files.outputs.deleted_count || 0 }} > 0 ? 1 : 0))
          echo ""
        fi
        
        if [ "${{ steps.delete_files.outputs.deleted_count || 0 }}" -gt 0 ]; then
          echo "ğŸ—‘ï¸ åˆ é™¤æ“ä½œæäº¤:"
          git log -1 --format=%B
          echo ""
        fi
        
        # æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨æ‘˜è¦
        echo "ğŸ“‹ æ–‡ä»¶åˆ—è¡¨æ‘˜è¦:"
        if [ -s /tmp/all_files.txt ]; then
          echo "ä¿ç•™æ–‡ä»¶ ($(cat /tmp/all_files.txt | wc -l) ä¸ª):"
          head -5 /tmp/all_files.txt | sed 's/^/  /'
          if [ $(cat /tmp/all_files.txt | wc -l) -gt 5 ]; then
            echo "  ... å’Œ $(($(cat /tmp/all_files.txt | wc -l) - 5)) ä¸ªæ›´å¤šæ–‡ä»¶"
          fi
        fi
        
        if [ -s /tmp/deleted_files.txt ]; then
          echo "åˆ é™¤æ–‡ä»¶ ($(cat /tmp/deleted_files.txt | wc -l) ä¸ª):"
          head -5 /tmp/deleted_files.txt | sed 's/^/  /'
          if [ $(cat /tmp/deleted_files.txt | wc -l) -gt 5 ]; then
            echo "  ... å’Œ $(($(cat /tmp/deleted_files.txt | wc -l) - 5)) ä¸ªæ›´å¤šæ–‡ä»¶"
          fi
        fi
        
        echo ""
        echo "ğŸ’¾ å¤‡ä»½æ–‡ä»¶ä½ç½®:"
        echo "  åˆ é™¤æ–‡ä»¶åˆ—è¡¨: /tmp/deleted_files.txt"
        echo "  æ–‡ä»¶æ˜ å°„å…³ç³»: /tmp/file_commit_map.txt"
        echo "  æœ‰æ•ˆæäº¤åˆ—è¡¨: /tmp/valid_commits.txt"


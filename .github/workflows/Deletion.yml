name: Real File Deletion - Mozi9

on:
  workflow_dispatch:
    inputs:
      target_repo:
        description: '目标仓库地址 (格式: owner/repo)'
        required: true
        default: 'owner/repository'
      target_branch:
        description: '目标分支名'
        required: true
        default: 'main'
      files_to_delete:
        description: '要删除的文件路径（多个用逗号分隔）'
        required: true
        default: '*.log, temp/, build/'
      commit_message:
        description: '提交信息'
        required: true
        default: 'chore: 删除文件'

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  real-delete-files:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout target repository
      uses: actions/checkout@v4
      with:
        repository: ${{ github.event.inputs.target_repo }}
        token: ${{ secrets.Mozi9_PAT }}
        ref: ${{ github.event.inputs.target_branch }}
        fetch-depth: 0

    - name: Setup Mozi9 identity
      run: |
        git config --global user.name "mozi9"
        git config --global user.email "mozi9"
        echo "Git identity: mozi9 <mozi9>"

    - name: Find and delete files
      id: delete_files
      run: |
        echo "开始删除文件..."
        
        # 解析文件模式
        PATTERNS=$(echo '${{ github.event.inputs.files_to_delete }}' | tr ',' ' ')
        
        DELETED_COUNT=0
        
        for pattern in $PATTERNS; do
          pattern=$(echo "$pattern" | sed 's/^ *//;s/ *$//')
          echo "处理模式: $pattern"
          
          # 删除文件
          if [ -f "$pattern" ]; then
            echo "删除文件: $pattern"
            rm -f "$pattern"
            DELETED_COUNT=$((DELETED_COUNT + 1))
          # 删除目录
          elif [ -d "$pattern" ]; then
            echo "删除目录: $pattern"
            rm -rf "$pattern"
            DELETED_COUNT=$((DELETED_COUNT + 1))
          # 使用通配符删除
          else
            for file in $pattern; do
              if [ -e "$file" ]; then
                echo "删除: $file"
                rm -rf "$file"
                DELETED_COUNT=$((DELETED_COUNT + 1))
              fi
            done
          fi
        done
        
        echo "deleted_count=$DELETED_COUNT" >> $GITHUB_OUTPUT
        echo "删除完成: $DELETED_COUNT 个文件/目录"

    - name: Stage changes in Git
      id: stage_changes
      run: |
        git add -A
        
        if git diff --cached --quiet; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
        fi

    - name: Create commit
      if: steps.stage_changes.outputs.has_changes == 'true'
      run: |
        # 只使用用户提供的提交信息，不添加额外内容
        git commit -m "${{ github.event.inputs.commit_message }}" --author="mozi9 <mozi9>"
        echo "提交创建完成"

    - name: Push changes
      if: steps.stage_changes.outputs.has_changes == 'true'
      run: |
        git push origin ${{ github.event.inputs.target_branch }}
        echo "推送完成"

    - name: Generate report
      run: |
        echo "=== 执行报告 ==="
        echo "目标仓库: ${{ github.event.inputs.target_repo }}"
        echo "目标分支: ${{ github.event.inputs.target_branch }}"
        echo "删除文件: ${{ steps.delete_files.outputs.deleted_count || 0 }} 个"
        echo "提交信息: ${{ github.event.inputs.commit_message }}"
        echo "Git作者: mozi9 <mozi9>"
        echo "================"

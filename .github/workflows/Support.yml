name: Source Commit Sync with Branch Support

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: 'æºä»“åº“åœ°å€'
        required: true
        default: 'owner/source-repo'
      source_branch:
        description: 'æºåˆ†æ”¯å'
        required: true
        default: 'main'
      target_repo:
        description: 'ç›®æ ‡ä»“åº“åœ°å€'
        required: true
        default: 'owner/target-repo'
      target_branch:
        description: 'ç›®æ ‡åˆ†æ”¯å'
        required: true
        default: 'main'
      commit_hashes:
        description: 'è¦åŒæ­¥çš„æäº¤å“ˆå¸Œ'
        required: true
        default: ''
      new_branch_name:
        description: 'æ–°åˆ†æ”¯åï¼ˆç•™ç©ºæ¨é€åˆ°ç›®æ ‡åˆ†æ”¯ï¼‰'
        required: false
        default: ''

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  branch-sync:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout target repository
      uses: actions/checkout@v4
      with:
        repository: ${{ github.event.inputs.target_repo }}
        token: ${{ secrets.Mozi9_PAT }}
        ref: ${{ github.event.inputs.target_branch }}
        fetch-depth: 0

    - name: Setup Git identity
      run: |
        git config user.name "mozi9"
        git config user.email "mozi9"

    - name: Add source repository
      run: |
        echo "æ·»åŠ æºä»“åº“: ${{ github.event.inputs.source_repo }}"
        echo "æºåˆ†æ”¯: ${{ github.event.inputs.source_branch }}"
        git remote add source https://github.com/${{ github.event.inputs.source_repo }}.git
        git fetch source ${{ github.event.inputs.source_branch }}

    - name: Determine target branch
      id: set_branch
      run: |
        if [ -z "${{ github.event.inputs.new_branch_name }}" ]; then
          TARGET_BRANCH="${{ github.event.inputs.target_branch }}"
          echo "ä½¿ç”¨ç›®æ ‡åˆ†æ”¯: $TARGET_BRANCH"
        else
          TARGET_BRANCH="${{ github.event.inputs.new_branch_name }}"
          echo "åˆ›å»ºæ–°åˆ†æ”¯: $TARGET_BRANCH"
          git checkout -b "$TARGET_BRANCH"
        fi
        echo "target_branch=$TARGET_BRANCH" >> $GITHUB_OUTPUT

    - name: Apply source commits
      run: |
        echo "åº”ç”¨æºæäº¤..."
        echo "æºåˆ†æ”¯: ${{ github.event.inputs.source_branch }}"
        echo "ç›®æ ‡åˆ†æ”¯: ${{ steps.set_branch.outputs.target_branch }}"
        
        COMMITS=$(echo '${{ github.event.inputs.commit_hashes }}' | tr ',' ' ')
        for COMMIT in $COMMITS; do
          echo "åº”ç”¨æäº¤: $COMMIT"
          git cherry-pick $COMMIT
          git commit --amend --author="mozi9 <mozi9>" --no-edit
        done

    - name: Push to target branch
      run: |
        TARGET_BRANCH="${{ steps.set_branch.outputs.target_branch }}"
        echo "æ¨é€åˆ°åˆ†æ”¯: $TARGET_BRANCH"
        git push origin "$TARGET_BRANCH"

    - name: Generate report
      run: |
        echo ""
        echo "ğŸ‰ æäº¤åŒæ­¥å®Œæˆ!"
        echo "=========================================="
        echo "ğŸ“Š åˆ†æ”¯ä¿¡æ¯:"
        echo "  æºä»“åº“: ${{ github.event.inputs.source_repo }}"
        echo "  æºåˆ†æ”¯: ${{ github.event.inputs.source_branch }}"
        echo "  ç›®æ ‡ä»“åº“: ${{ github.event.inputs.target_repo }}"
        echo "  ç›®æ ‡åˆ†æ”¯: ${{ steps.set_branch.outputs.target_branch }}"
        echo ""
        echo "âœ… æäº¤å¤„ç†:"
        echo "  ä½œè€…ç»Ÿä¸€ä¸º: mozi9 <mozi9>"
        echo "  å†…å®¹ä¿æŒä¸æºæäº¤ä¸€è‡´"
        echo "=========================================="

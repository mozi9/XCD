name: Exact Source Commit Sync - Mozi9

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: 'æºä»“åº“åœ°å€ (æ ¼å¼: owner/repo)'
        required: true
        default: 'mozi9/source-repo'
      source_branch:
        description: 'æºåˆ†æ”¯å (ç•™ç©ºä½¿ç”¨é»˜è®¤åˆ†æ”¯)'
        required: false
        default: ''
      target_repo:
        description: 'ç›®æ ‡ä»“åº“åœ°å€ (æ ¼å¼: owner/repo)'
        required: true
        default: 'mozi9/target-repo'
      target_branch:
        description: 'ç›®æ ‡åˆ†æ”¯å'
        required: true
        default: 'main'
      commit_hashes:
        description: 'è¦åŒæ­¥çš„æäº¤å“ˆå¸Œï¼ˆå¤šä¸ªç”¨é€—å·åˆ†éš”ï¼‰'
        required: true
        default: ''
      commit_message:
        description: 'åˆå¹¶æäº¤ä¿¡æ¯'
        required: true
        default: 'sync: åŒæ­¥æäº¤'
      max_commits:
        description: 'æœ€å¤§åŒæ­¥æäº¤æ•°é‡'
        required: true
        default: '20'

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  exact-sync:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout target repository
      uses: actions/checkout@v4
      with:
        repository: ${{ github.event.inputs.target_repo }}
        token: ${{ secrets.Mozi9_PAT }}
        ref: ${{ github.event.inputs.target_branch }}
        fetch-depth: 0

    - name: Setup Mozi9 Git identity
      run: |
        git config --global user.name "mozi9"
        git config --global user.email "mozi9"
        echo "Git identity: mozi9 <mozi9>"

    - name: Add source repository
      run: |
        echo "æ·»åŠ æºä»“åº“..."
        SOURCE_REPO="${{ github.event.inputs.source_repo }}"
        SOURCE_BRANCH="${{ github.event.inputs.source_branch }}"
        
        if [ -z "$SOURCE_BRANCH" ]; then
          git remote add source-repo https://github.com/$SOURCE_REPO.git
          git fetch source-repo
        else
          git remote add source-repo https://github.com/$SOURCE_REPO.git
          git fetch source-repo $SOURCE_BRANCH
        fi
        echo "âœ… æºä»“åº“æ·»åŠ å®Œæˆ"

    - name: Parse and validate commit hashes
      id: parse_commits
      run: |
        echo "è§£ææäº¤å“ˆå¸Œ..."
        COMMIT_HASHES=$(echo '${{ github.event.inputs.commit_hashes }}' | tr -d '[:space:]' | tr ',' ' ')
        
        VALID_COMMITS=()
        for hash in $COMMIT_HASHES; do
          if git rev-parse --verify "$hash" >/dev/null 2>&1; then
            COMMIT_SUBJECT=$(git log -1 --format="%s" "$hash")
            echo "âœ… æäº¤æœ‰æ•ˆ: $hash - $COMMIT_SUBJECT"
            VALID_COMMITS+=("$hash")
          else
            echo "âŒ æäº¤æ— æ•ˆ: $hash"
          fi
        done
        
        if [ ${#VALID_COMMITS[@]} -eq 0 ]; then
          echo "âŒ é”™è¯¯: æ²¡æœ‰æœ‰æ•ˆçš„æäº¤"
          exit 1
        fi
        
        MAX_COMMITS=${{ github.event.inputs.max_commits }}
        if [ ${#VALID_COMMITS[@]} -gt $MAX_COMMITS ]; then
          VALID_COMMITS=("${VALID_COMMITS[@]:0:$MAX_COMMITS}")
        fi
        
        printf "%s\n" "${VALID_COMMITS[@]}" > /tmp/valid_commits.txt
        echo "commit_count=${#VALID_COMMITS[@]}" >> $GITHUB_OUTPUT

    - name: Create exact sync branch
      run: |
        echo "åˆ›å»ºç²¾ç¡®åŒæ­¥åˆ†æ”¯..."
        SYNC_BRANCH="exact-sync-$(date +%s)"
        git checkout -b "$SYNC_BRANCH"
        echo "sync_branch=$SYNC_BRANCH" >> $GITHUB_OUTPUT

    - name: Apply exact source commits
      id: apply_commits
      run: |
        echo "åº”ç”¨ç²¾ç¡®æºæäº¤..."
        COMMITS=$(cat /tmp/valid_commits.txt)
        APPLIED_COUNT=0
        
        for COMMIT in $COMMITS; do
          echo "åº”ç”¨æäº¤: $COMMIT"
          
          # è·å–åŸå§‹æäº¤ä¿¡æ¯
          COMMIT_MSG=$(git log -1 --format=%B "$COMMIT")
          COMMIT_DATE=$(git log -1 --format=%ci "$COMMIT")
          COMMIT_AUTHOR=$(git log -1 --format="%an <%ae>" "$COMMIT")
          
          echo "åŸå§‹ä½œè€…: $COMMIT_AUTHOR"
          echo "æäº¤æ—¶é—´: $COMMIT_DATE"
          echo "æäº¤ä¿¡æ¯: $COMMIT_MSG"
          
          # ä½¿ç”¨git format-patchå’Œamæ¥ä¿æŒå®Œå…¨ä¸€è‡´
          git format-patch "$COMMIT"^.."$COMMIT" --stdout > /tmp/commit.patch
          
          # åº”ç”¨è¡¥ä¸
          if git am /tmp/commit.patch; then
            APPLIED_COUNT=$((APPLIED_COUNT + 1))
            echo "âœ… æäº¤åº”ç”¨æˆåŠŸ"
          else
            echo "âŒ æäº¤åº”ç”¨å¤±è´¥ï¼Œå°è¯•cherry-pick"
            git am --abort 2>/dev/null || true
            
            # å›é€€åˆ°cherry-pickæ–¹æ¡ˆ
            if git cherry-pick "$COMMIT"; then
              APPLIED_COUNT=$((APPLIED_COUNT + 1))
              echo "âœ… Cherry-pickæˆåŠŸ"
            else
              echo "âŒ æ‰€æœ‰æ–¹æ³•éƒ½å¤±è´¥ï¼Œè·³è¿‡æäº¤"
              git cherry-pick --abort 2>/dev/null || true
            fi
          fi
        done
        
        echo "applied_count=$APPLIED_COUNT" >> $GITHUB_OUTPUT

    - name: Verify exact match
      id: verify_match
      run: |
        echo "éªŒè¯ä¸æºæäº¤çš„ç²¾ç¡®åŒ¹é…..."
        COMMITS=$(cat /tmp/valid_commits.txt)
        VERIFIED_COUNT=0
        
        for i in $(seq 1 ${#COMMITS[@]}); do
          SOURCE_COMMIT=$(echo "$COMMITS" | sed -n "${i}p")
          TARGET_COMMIT=$(git log --oneline -1 --skip=$((i-1)) | cut -d' ' -f1)
          
          # æ¯”è¾ƒæ–‡ä»¶æ ‘
          SOURCE_TREE=$(git show --pretty="format:" --name-only "$SOURCE_COMMIT" | sort)
          TARGET_TREE=$(git show --pretty="format:" --name-only "HEAD~$(( ${#COMMITS[@]} - i ))" | sort)
          
          if [ "$SOURCE_TREE" = "$TARGET_TREE" ]; then
            echo "âœ… æäº¤ $i æ–‡ä»¶æ ‘åŒ¹é…"
            VERIFIED_COUNT=$((VERIFIED_COUNT + 1))
          else
            echo "âŒ æäº¤ $i æ–‡ä»¶æ ‘ä¸åŒ¹é…"
            echo "æºæäº¤æ–‡ä»¶:"
            echo "$SOURCE_TREE"
            echo "ç›®æ ‡æäº¤æ–‡ä»¶:"
            echo "$TARGET_TREE"
          fi
        done
        
        echo "verified_count=$VERIFIED_COUNT" >> $GITHUB_OUTPUT

    - name: Merge to target branch
      run: |
        echo "åˆå¹¶åˆ°ç›®æ ‡åˆ†æ”¯..."
        git checkout ${{ github.event.inputs.target_branch }}
        
        SYNC_BRANCH="${{ steps.apply_commits.outputs.sync_branch }}"
        git merge --no-ff -m "${{ github.event.inputs.commit_message }}" "$SYNC_BRANCH"

    - name: Push exact commits
      run: |
        echo "æ¨é€ç²¾ç¡®æäº¤..."
        git push https://mozi9:${{ secrets.Mozi9_PAT }}@github.com/${{ github.event.inputs.target_repo }}.git ${{ github.event.inputs.target_branch }}

    - name: Generate verification report
      run: |
        echo ""
        echo "ğŸ‰ ç²¾ç¡®åŒæ­¥å®Œæˆ!"
        echo "=========================================="
        echo "ğŸ“Š ç²¾ç¡®æ€§éªŒè¯:"
        echo "  æºæäº¤æ•°é‡: ${{ steps.parse_commits.outputs.commit_count }}"
        echo "  æˆåŠŸåº”ç”¨: ${{ steps.apply_commits.outputs.applied_count }}"
        echo "  éªŒè¯åŒ¹é…: ${{ steps.verify_match.outputs.verified_count }}"
        echo ""
        echo "âœ… ä¿è¯ä¸æºæäº¤å®Œå…¨ä¸€è‡´:"
        echo "  - ç›¸åŒçš„æ–‡ä»¶å†…å®¹"
        echo "  - ç›¸åŒçš„æ–‡ä»¶ç»“æ„" 
        echo "  - ç›¸åŒçš„æäº¤é¡ºåº"
        echo "  - ä»…ä¿®æ”¹ä½œè€…ä¿¡æ¯ä¸º mozi9"
        echo ""
        echo "â° å®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "=========================================="

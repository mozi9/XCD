name: Cross Repository Sync

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: '源仓库地址 (格式: owner/repo)'
        required: true
        default: 'mozi9/source-repo'
        type: string
      source_branch:
        description: '源仓库分支'
        required: true
        default: 'main'
        type: string
      source_commits:
        description: '源提交哈希 (多个用逗号分隔，如: abc123,def456)'
        required: true
        type: string
      target_repo:
        description: '目标仓库地址 (格式: owner/repo)'
        required: true
        type: string
      target_branch:
        description: '目标仓库分支'
        required: true
        default: 'main'
        type: string
      new_author_name:
        description: '新作者名称'
        required: true
        default: 'mozi9'
        type: string
      new_author_email:
        description: '新作者邮箱'
        required: true
        default: 'mozi9@example.com'
        type: string
      commit_message:
        description: '提交信息'
        required: true
        default: 'Sync commit from source repository'
        type: string

jobs:
  sync-repository:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        name: Checkout current repository
        
      - name: Setup Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
      - name: Parse commit hashes
        id: parse_commits
        run: |
          COMMITS="${{ github.event.inputs.source_commits }}"
          COMMITS="${COMMITS//,/$'\n'}"
          COUNT=0
          for commit in $COMMITS; do
            commit=$(echo "$commit" | xargs)
            if [ -n "$commit" ]; then
              echo "commit_$COUNT=$commit" >> $GITHUB_OUTPUT
              COUNT=$((COUNT+1))
            fi
          done
          echo "commit_count=$COUNT" >> $GITHUB_OUTPUT
          echo "Found $COUNT commits"
          
      - name: Setup target repository
        run: |
          echo "Setting up target repository"
          git clone https://Mozi9_PAT@github.com/${{ github.event.inputs.target_repo }}.git target-repo
          cd target-repo
          git checkout ${{ github.event.inputs.target_branch }} || git checkout -b ${{ github.event.inputs.target_branch }}
          
      - name: Add source remote
        run: |
          cd target-repo
          git remote add source https://github.com/${{ github.event.inputs.source_repo }}.git
          git fetch source ${{ github.event.inputs.source_branch }}
          
      - name: Sync commits
        run: |
          cd target-repo
          COUNT=${{ steps.parse_commits.outputs.commit_count }}
          SUCCESS=0
          
          for ((i=0; i<COUNT; i++)); do
            COMMIT_HASH=${{ steps.parse_commits.outputs['commit_'$i] }}
            echo "Processing commit: $COMMIT_HASH"
            
            if git cherry-pick $COMMIT_HASH --no-commit 2>/dev/null; then
              echo "Cherry-pick succeeded"
              CHANGES=true
            else
              echo "Resolving conflicts"
              CHANGES=false
              
              # Handle conflicts
              git status --porcelain | while read line; do
                STATUS=${line:0:2}
                FILE=${line:3}
                if [[ $STATUS == "UU" || $STATUS == "AA" || $STATUS == "DD" ]]; then
                  if [ -f "$FILE" ]; then
                    git checkout --ours "$FILE"
                    git add "$FILE"
                  fi
                elif [[ $STATUS == " D" ]]; then
                  if [ -f "$FILE" ]; then
                    git rm "$FILE"
                    CHANGES=true
                  fi
                fi
              done
            fi
            
            git add -A
            
            if [ "$CHANGES" = "true" ] || git diff --cached --quiet; then
              git commit -m "${{ github.event.inputs.commit_message }} [$COMMIT_HASH]" \
                --author="${{ github.event.inputs.new_author_name }} <${{ github.event.inputs.new_author_email }}>" \
                --allow-empty \
                --keep-redundant-commits
              SUCCESS=$((SUCCESS+1))
              echo "Commit created"
            fi
          done
          echo "Sync finished: $SUCCESS/$COUNT successful"
          
      - name: Push changes
        run: |
          cd target-repo
          git push origin ${{ github.event.inputs.target_branch }}
          echo "Push completed"
          
      - name: Cleanup
        if: always()
        run: |
          rm -rf target-repo
          
      - name: Summary
        run: |
          echo "Sync completed successfully"
          echo "Processed: ${{ steps.parse_commits.outputs.commit_count }} commits"
          echo "Author: ${{ github.event.inputs.new_author_name }}"

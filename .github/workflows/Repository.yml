name: Update Repository

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: 'æºä»“åº“åœ°å€ (æ ¼å¼: owner/repo)'
        required: true
        type: string
        default: 'mozi9/source-repo'
      source_branch:
        description: 'æºä»“åº“åˆ†æ”¯'
        required: true
        type: string
        default: 'main'
      source_commits:
        description: 'æºæäº¤å“ˆå¸Œ (å¤šä¸ªç”¨é€—å·åˆ†éš”ï¼Œå¦‚: abc123,def456)'
        required: true
        type: string
      target_repo:
        description: 'ç›®æ ‡ä»“åº“åœ°å€ (æ ¼å¼: owner/repo)'
        required: true
        type: string
      target_branch:
        description: 'ç›®æ ‡ä»“åº“åˆ†æ”¯'
        required: true
        type: string
        default: 'main'
      new_author_name:
        description: 'æ–°ä½œè€…åç§°'
        required: true
        type: string
        default: 'mozi9'
      new_author_email:
        description: 'æ–°ä½œè€…é‚®ç®±'
        required: true
        type: string
        default: 'mozi9@example.com'
      commit_message:
        description: 'æäº¤ä¿¡æ¯'
        required: true
        type: string
        default: 'Sync commit from source repository'

jobs:
  update-repository:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout current repository
        uses: actions/checkout@v4
        
      - name: Setup Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
      - name: Parse commit hashes
        id: parse_commits
        run: |
          COMMITS="${{ github.event.inputs.source_commits }}"
          COUNT=0
          IFS=',' read -ra COMMIT_ARRAY <<< "$COMMITS"
          for commit in "${COMMIT_ARRAY[@]}"; do
            commit=$(echo "$commit" | xargs)
            if [ -n "$commit" ]; then
              echo "commit_$COUNT=$commit" >> $GITHUB_OUTPUT
              COUNT=$((COUNT+1))
            fi
          done
          echo "commit_count=$COUNT" >> $GITHUB_OUTPUT
          echo "Found $COUNT commits to process"
          
      - name: Setup target repository
        run: |
          echo "Setting up target repository: ${{ github.event.inputs.target_repo }}"
          git clone https://Mozi9_PAT@github.com/${{ github.event.inputs.target_repo }}.git target-repo
          cd target-repo
          git checkout ${{ github.event.inputs.target_branch }} || git checkout -b ${{ github.event.inputs.target_branch }}
          
      - name: Add source remote
        run: |
          cd target-repo
          git remote add source https://github.com/${{ github.event.inputs.source_repo }}.git
          git fetch source ${{ github.event.inputs.source_branch }}
          
      - name: Sync commits with unified author
        run: |
          cd target-repo
          COUNT=${{ steps.parse_commits.outputs.commit_count }}
          SUCCESS=0
          
          echo "Starting sync of $COUNT commits..."
          
          for ((i=0; i<COUNT; i++)); do
            COMMIT_HASH=${{ steps.parse_commits.outputs['commit_'$i] }}
            echo "[$((i+1))/$COUNT] Processing: $COMMIT_HASH"
            
            if git cherry-pick $COMMIT_HASH --no-commit 2>/dev/null; then
              echo "  âœ“ Changes applied successfully"
              HAS_CHANGES=true
            else
              echo "  âš  Handling conflicts and file operations..."
              HAS_CHANGES=false
              
              git status --porcelain | while read line; do
                STATUS=${line:0:2}
                FILE=${line:3}
                
                case $STATUS in
                  "UU"|"AA"|"DD")
                    if [ -f "$FILE" ]; then
                      git checkout --ours "$FILE"
                      git add "$FILE"
                    fi
                    ;;
                  " D")
                    if [ -f "$FILE" ]; then
                      git rm "$FILE"
                      HAS_CHANGES=true
                    fi
                    ;;
                  "R"*)
                    OLD_FILE=$(echo "$line" | cut -d' ' -f2)
                    NEW_FILE=$(echo "$line" | cut -d' ' -f3)
                    if [ -f "$OLD_FILE" ]; then
                      git mv "$OLD_FILE" "$NEW_FILE"
                      HAS_CHANGES=true
                    fi
                    ;;
                esac
              done
            fi
            
            git add -A
            
            if [ "$HAS_CHANGES" = "true" ] || git diff --cached --quiet; then
              git commit -m "${{ github.event.inputs.commit_message }} [$COMMIT_HASH]" \
                --author="${{ github.event.inputs.new_author_name }} <${{ github.event.inputs.new_author_email }}>" \
                --allow-empty \
                --keep-redundant-commits
              SUCCESS=$((SUCCESS+1))
              echo "  âœ“ Commit created with author: ${{ github.event.inputs.new_author_name }}"
            else
              echo "  â­ Skipped empty commit"
            fi
          done
          
          echo "Sync completed: $SUCCESS/$COUNT commits successful"
          
      - name: Push changes to target
        run: |
          cd target-repo
          git push origin ${{ github.event.inputs.target_branch }}
          echo "âœ“ Changes pushed to ${{ github.event.inputs.target_branch }}"
          
      - name: Cleanup workspace
        if: always()
        run: |
          rm -rf target-repo
          
      - name: Workflow summary
        run: |
          echo "ğŸ‰ Repository update completed!"
          echo "ğŸ“¦ Source: ${{ github.event.inputs.source_repo }}:${{ github.event.inputs.source_branch }}"
          echo "ğŸ¯ Target: ${{ github.event.inputs.target_repo }}:${{ github.event.inputs.target_branch }}"
          echo "ğŸ“ Commits processed: ${{ steps.parse_commits.outputs.commit_count }}"
          echo "ğŸ‘¤ Author: ${{ github.event.inputs.new_author_name }} <${{ github.event.inputs.new_author_email }}>"
          echo "âœ¨ All source commit authors have been replaced with mozi9"

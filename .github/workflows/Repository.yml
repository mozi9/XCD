name: Manual Repository Sync - Smart Overwrite

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: 'æºä»“åº“åœ°å€ (æ ¼å¼: owner/repo)'
        required: true
        default: 'mozi9/source-repo'
      source_branch:
        description: 'æºåˆ†æ”¯å (ç•™ç©ºä½¿ç”¨é»˜è®¤åˆ†æ”¯)'
        required: false
        default: ''
      target_repo:
        description: 'ç›®æ ‡ä»“åº“åœ°å€ (æ ¼å¼: owner/repo)'
        required: true
        default: 'mozi9/target-repo'
      target_branch:
        description: 'ç›®æ ‡åˆ†æ”¯å'
        required: true
        default: 'main'
      commit_hashes:
        description: 'è¦åŒæ­¥çš„æäº¤å“ˆå¸Œï¼ˆå¤šä¸ªç”¨é€—å·åˆ†éš”ï¼‰'
        required: true
        default: ''
      commit_name:
        description: 'åˆå¹¶æäº¤å'
        required: true
        default: 'sync: åŒæ­¥æäº¤'
      commit_description:
        description: 'åˆå¹¶æäº¤æè¿°ï¼ˆå¯é€‰ï¼‰'
        required: false
        default: ''
      delete_commit_message:
        description: 'åˆ é™¤æ–‡ä»¶æäº¤ä¿¡æ¯'
        required: true
        default: 'delete: åˆ é™¤æ ‡è®°æ–‡ä»¶'
      max_commits:
        description: 'æœ€å¤§åŒæ­¥æäº¤æ•°é‡'
        required: true
        default: '20'

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  sync-repository:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout target repository
      uses: actions/checkout@v4
      with:
        repository: ${{ github.event.inputs.target_repo }}
        token: ${{ secrets.Mozi9_PAT }}
        ref: ${{ github.event.inputs.target_branch }}
        fetch-depth: 0

    - name: Setup Mozi9 Git identity
      run: |
        git config --global user.name "mozi9"
        git config --global user.email "mozi9"
        echo "Git identity set to: mozi9 <mozi9>"

    - name: Add source repository
      id: add_source
      run: |
        echo "æ·»åŠ æºä»“åº“..."
        SOURCE_REPO="${{ github.event.inputs.source_repo }}"
        SOURCE_BRANCH="${{ github.event.inputs.source_branch }}"
        
        if [ -z "$SOURCE_BRANCH" ]; then
          echo "ä½¿ç”¨æºä»“åº“é»˜è®¤åˆ†æ”¯"
          git remote add source-repo https://github.com/$SOURCE_REPO.git
          git fetch source-repo
        else
          echo "ä½¿ç”¨æºä»“åº“åˆ†æ”¯: $SOURCE_BRANCH"
          git remote add source-repo https://github.com/$SOURCE_REPO.git
          git fetch source-repo $SOURCE_BRANCH
        fi
        echo "âœ… æºä»“åº“æ·»åŠ å®Œæˆ"

    - name: Parse and validate commit hashes
      id: parse_commits
      run: |
        echo "è§£æå’ŒéªŒè¯æäº¤å“ˆå¸Œ..."
        COMMIT_HASHES=$(echo '${{ github.event.inputs.commit_hashes }}' | tr -d '[:space:]' | tr ',' ' ')
        
        VALID_COMMITS=()
        
        for hash in $COMMIT_HASHES; do
          FULL_HASH=$(git rev-parse --verify "$hash" 2>/dev/null || echo "")
          if [ -n "$FULL_HASH" ]; then
            COMMIT_SUBJECT=$(git log -1 --format="%s" "$FULL_HASH" 2>/dev/null || echo "æ— æ³•è·å–æäº¤ä¿¡æ¯")
            echo "âœ… æäº¤æœ‰æ•ˆ: $hash -> $FULL_HASH - $COMMIT_SUBJECT"
            VALID_COMMITS+=("$FULL_HASH")
          else
            echo "âŒ æäº¤æ— æ•ˆ: $hash"
          fi
        done
        
        if [ ${#VALID_COMMITS[@]} -eq 0 ]; then
          echo "âŒ é”™è¯¯: æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„æäº¤"
          exit 1
        fi
        
        MAX_COMMITS=${{ github.event.inputs.max_commits }}
        if [ ${#VALID_COMMITS[@]} -gt $MAX_COMMITS ]; then
          echo "âš ï¸ æäº¤æ•°é‡ ${#VALID_COMMITS[@]} è¶…è¿‡æœ€å¤§é™åˆ¶ $MAX_COMMITS"
          VALID_COMMITS=("${VALID_COMMITS[@]:0:$MAX_COMMITS}")
        fi
        
        printf "%s\n" "${VALID_COMMITS[@]}" > /tmp/valid_commits.txt
        echo "commit_count=${#VALID_COMMITS[@]}" >> $GITHUB_OUTPUT
        echo "ğŸ“Š å°†å¤„ç† ${#VALID_COMMITS[@]} ä¸ªæœ‰æ•ˆæäº¤"

    - name: Collect files marked for deletion
      id: collect_deleted_files
      run: |
        echo "æ”¶é›†æºæäº¤ä¸­æ ‡è®°ä¸ºåˆ é™¤çš„æ–‡ä»¶..."
        COMMITS=$(cat /tmp/valid_commits.txt)
        DELETED_FILES=""
        
        for COMMIT in $COMMITS; do
          DELETED_IN_COMMIT=$(git show "$COMMIT" --name-only --diff-filter=D --format= 2>/dev/null || true)
          if [ -n "$DELETED_IN_COMMIT" ]; then
            DELETED_FILES="$DELETED_FILES"$'\n'"$DELETED_IN_COMMIT"
          fi
        done
        
        echo "$DELETED_FILES" | sort | uniq | grep -v '^$' > /tmp/deleted_files.txt
        DEL_COUNT=$(cat /tmp/deleted_files.txt 2>/dev/null | wc -l || echo 0)
        echo "deleted_files_count=$DEL_COUNT" >> $GITHUB_OUTPUT
        echo "ğŸ“Š æ”¶é›†åˆ° $DEL_COUNT ä¸ªåˆ é™¤æ–‡ä»¶æ ‡è®°"

    - name: Create sync branch
      id: create_branch
      run: |
        echo "åˆ›å»ºåŒæ­¥åˆ†æ”¯..."
        SYNC_BRANCH="sync-$(date +%s)"
        git checkout -b "$SYNC_BRANCH"
        echo "branch_name=$SYNC_BRANCH" >> $GITHUB_OUTPUT

    - name: Smart overwrite with source files
      id: smart_overwrite
      run: |
        echo "æ™ºèƒ½è¦†ç›–ï¼šç›¸åŒæ–‡ä»¶ä¹Ÿè¦†ç›–ï¼Œä¸åŒæ–‡ä»¶ç”¨æºæ–‡ä»¶..."
        COMMITS=$(cat /tmp/valid_commits.txt)
        
        # è·å–æ‰€æœ‰æºæäº¤ä¸­çš„æ–‡ä»¶
        ALL_SOURCE_FILES=""
        for COMMIT in $COMMITS; do
          COMMIT_FILES=$(git show --name-only --format= "$COMMIT" 2>/dev/null | grep -v '^$' || true)
          ALL_SOURCE_FILES="$ALL_SOURCE_FILES"$'\n'"$COMMIT_FILES"
        done
        
        # å»é‡å¾—åˆ°æºæ–‡ä»¶åˆ—è¡¨
        SOURCE_FILES=$(echo "$ALL_SOURCE_FILES" | sort | uniq | grep -v '^$')
        echo "$SOURCE_FILES" > /tmp/source_files.txt
        
        # é€ä¸ªæ–‡ä»¶ä»æºæäº¤å¤åˆ¶ï¼ˆå¼ºåˆ¶è¦†ç›–ï¼‰
        COPIED_COUNT=0
        for file in $SOURCE_FILES; do
          # æ‰¾åˆ°åŒ…å«è¯¥æ–‡ä»¶çš„æœ€åä¸€ä¸ªæäº¤
          SOURCE_COMMIT=""
          for COMMIT in $COMMITS; do
            if git show "$COMMIT":"$file" >/dev/null 2>&1; then
              SOURCE_COMMIT=$COMMIT
            fi
          done
          
          if [ -n "$SOURCE_COMMIT" ]; then
            echo "è¦†ç›–æ–‡ä»¶: $file (æ¥è‡ªæäº¤ $SOURCE_COMMIT)"
            mkdir -p "$(dirname "$file")"
            git show "$SOURCE_COMMIT":"$file" > "$file" 2>/dev/null && COPIED_COUNT=$((COPIED_COUNT + 1))
          fi
        done
        
        echo "copied_count=$COPIED_COUNT" >> $GITHUB_OUTPUT
        echo "ğŸ“Š è¦†ç›–äº† $COPIED_COUNT ä¸ªæ–‡ä»¶"

    - name: Commit overwritten files
      id: commit_overwrite
      run: |
        echo "æäº¤è¦†ç›–çš„æ–‡ä»¶..."
        git add -A
        
        # å‡†å¤‡æäº¤ä¿¡æ¯
        COMMIT_NAME="${{ github.event.inputs.commit_name }}"
        COMMIT_DESC="${{ github.event.inputs.commit_description }}"
        
        COMMIT_MSG="$COMMIT_NAME"
        if [ -n "$COMMIT_DESC" ]; then
          COMMIT_MSG="$COMMIT_MSG"$'\n\n'"$COMMIT_DESC"
        fi
        
        git commit -m "$COMMIT_MSG" --author="mozi9 <mozi9>"
        echo "âœ… æ–‡ä»¶è¦†ç›–æäº¤å®Œæˆ"

    - name: Delete marked files in target repository
      id: delete_files
      run: |
        echo "åœ¨ç›®æ ‡ä»“åº“ä¸­åˆ é™¤æ ‡è®°æ–‡ä»¶..."
        DELETED_FILES=$(cat /tmp/deleted_files.txt 2>/dev/null || true)
        
        if [ -n "$DELETED_FILES" ]; then
          DEL_COUNT=0
          for file in $DELETED_FILES; do
            if [ -e "$file" ]; then
              git rm "$file" >/dev/null 2>&1
              DEL_COUNT=$((DEL_COUNT + 1))
            fi
          done
          
          if [ $DEL_COUNT -gt 0 ]; then
            git commit -m "${{ github.event.inputs.delete_commit_message }}" --author="mozi9 <mozi9>"
            echo "deleted_count=$DEL_COUNT" >> $GITHUB_OUTPUT
          else
            echo "deleted_count=0" >> $GITHUB_OUTPUT
          fi
        else
          echo "deleted_count=0" >> $GITHUB_OUTPUT
        fi

    - name: Push changes to target repository
      id: push_changes
      run: |
        echo "æ¨é€åˆ°ç›®æ ‡ä»“åº“..."
        TARGET_REPO="${{ github.event.inputs.target_repo }}"
        TARGET_BRANCH="${{ github.event.inputs.target_branch }}"
        
        git push https://mozi9:${{ secrets.Mozi9_PAT }}@github.com/$TARGET_REPO.git $TARGET_BRANCH
        echo "âœ… æ¨é€å®Œæˆ"

    - name: Cleanup
      run: |
        git branch -D sync-* 2>/dev/null || true

    - name: Generate final report
      run: |
        echo ""
        echo "ğŸ‰ æ™ºèƒ½è¦†ç›–åŒæ­¥å®Œæˆ!"
        echo "=========================================="
        echo "ğŸ“Š æ‰§è¡ŒæŠ¥å‘Š:"
        echo "  æºä»“åº“: ${{ github.event.inputs.source_repo }}"
        echo "  ç›®æ ‡ä»“åº“: ${{ github.event.inputs.target_repo }}"
        echo "  å¤„ç†æäº¤: ${{ steps.parse_commits.outputs.commit_count }} ä¸ª"
        echo "  è¦†ç›–æ–‡ä»¶: ${{ steps.smart_overwrite.outputs.copied_count }} ä¸ª"
        echo "  åˆ é™¤æ–‡ä»¶: ${{ steps.delete_files.outputs.deleted_count || 0 }} ä¸ª"
        echo ""
        echo "ğŸ”§ åŒæ­¥ç­–ç•¥:"
        echo "  âœ… ç›¸åŒæ–‡ä»¶: å¼ºåˆ¶è¦†ç›–"
        echo "  âœ… ä¸åŒæ–‡ä»¶: ä½¿ç”¨æºæ–‡ä»¶"
        echo "  âœ… æ–°å¢æ–‡ä»¶: è‡ªåŠ¨æ·»åŠ "
        echo "  âœ… åˆ é™¤æ–‡ä»¶: æ ‡è®°åå¤„ç†"
        echo ""
        echo "ğŸ‘¤ æ“ä½œèº«ä»½: mozi9 <mozi9>"
        echo "=========================================="

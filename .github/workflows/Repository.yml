name: Cross Repository Sync

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: 'æºä»“åº“åœ°å€ (æ ¼å¼: owner/repo)'
        required: true
        type: string
        default: 'mozi9/source-repo'
      source_branch:
        description: 'æºä»“åº“åˆ†æ”¯'
        required: true
        type: string
        default: 'main'
      source_commits:
        description: 'æºæäº¤å“ˆå¸Œ (å¤šä¸ªç”¨é€—å·åˆ†éš”ï¼Œå¦‚: abc123,def456)'
        required: true
        type: string
      target_repo:
        description: 'ç›®æ ‡ä»“åº“åœ°å€ (æ ¼å¼: owner/repo)'
        required: true
        type: string
      target_branch:
        description: 'ç›®æ ‡ä»“åº“åˆ†æ”¯'
        required: true
        type: string
        default: 'main'
      new_author_name:
        description: 'æ–°ä½œè€…åç§°'
        required: true
        type: string
        default: 'mozi9'
      new_author_email:
        description: 'æ–°ä½œè€…é‚®ç®±'
        required: true
        type: string
        default: 'mozi9@example.com'
      commit_message:
        description: 'æäº¤ä¿¡æ¯'
        required: true
        type: string
        default: 'Sync commit from source repository'

jobs:
  sync-repository:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout current repository
        uses: actions/checkout@v4
        
      - name: Setup Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
      - name: Parse commit hashes
        id: parse_commits
        run: |
          # ç®€å•çš„å­—ç¬¦ä¸²å¤„ç†
          INPUT_COMMITS="${{ github.event.inputs.source_commits }}"
          echo "Input: $INPUT_COMMITS"
          
          # åˆå§‹åŒ–è®¡æ•°å™¨
          COUNT=0
          
          # ä½¿ç”¨é€—å·åˆ†å‰²
          IFS=',' read -ra COMMIT_ARRAY <<< "$INPUT_COMMITS"
          
          for commit in "${COMMIT_ARRAY[@]}"; do
            # å»é™¤ç©ºæ ¼
            COMMIT_CLEAN=$(echo "$commit" | xargs)
            if [ -n "$COMMIT_CLEAN" ]; then
              echo "commit_$COUNT=$COMMIT_CLEAN" >> $GITHUB_OUTPUT
              echo "Found commit: $COMMIT_CLEAN"
              COUNT=$((COUNT + 1))
            fi
          done
          
          echo "commit_count=$COUNT" >> $GITHUB_OUTPUT
          echo "Total commits found: $COUNT"
          
      - name: Setup target repository
        run: |
          echo "Cloning target repository: ${{ github.event.inputs.target_repo }}"
          
          # å…‹éš†ç›®æ ‡ä»“åº“
          git clone https://${{ secrets.Mozi9_PAT }}@github.com/${{ github.event.inputs.target_repo }}.git target-repo
          cd target-repo
          
          # æ£€æŸ¥åˆ†æ”¯æ˜¯å¦å­˜åœ¨
          if git show-ref --verify --quiet refs/heads/${{ github.event.inputs.target_branch }}; then
            git checkout ${{ github.event.inputs.target_branch }}
            echo "Checked out existing branch: ${{ github.event.inputs.target_branch }}"
          else
            git checkout -b ${{ github.event.inputs.target_branch }}
            echo "Created new branch: ${{ github.event.inputs.target_branch }}"
          fi
          
      - name: Add source remote
        run: |
          cd target-repo
          echo "Adding source remote: ${{ github.event.inputs.source_repo }}"
          
          git remote add source https://github.com/${{ github.event.inputs.source_repo }}.git
          git fetch source ${{ github.event.inputs.source_branch }}
          
          echo "Source repository fetched successfully"
          
      - name: Sync commits with unified author
        run: |
          cd target-repo
          echo "Starting commit synchronization..."
          
          # è·å–æäº¤æ€»æ•°
          TOTAL_COMMITS=${{ steps.parse_commits.outputs.commit_count }}
          SUCCESS_COUNT=0
          
          echo "Processing $TOTAL_COMMITS commits"
          
          # å¤„ç†æ¯ä¸ªæäº¤
          for ((i=0; i<TOTAL_COMMITS; i++)); do
            COMMIT_HASH=${{ steps.parse_commits.outputs['commit_'$i] }}
            echo "=== Processing commit $i: $COMMIT_HASH ==="
            
            # å°è¯•cherry-pick
            if git cherry-pick "$COMMIT_HASH" --no-commit 2>/dev/null; then
              echo "Cherry-pick successful for $COMMIT_HASH"
              HAS_CHANGES=true
            else
              echo "Cherry-pick encountered conflicts for $COMMIT_HASH"
              HAS_CHANGES=false
              
              # å¤„ç†å†²çªæ–‡ä»¶
              git status --porcelain | while read -r line; do
                if [ -n "$line" ]; then
                  STATUS="${line:0:2}"
                  FILE_PATH="${line:3}"
                  
                  case "$STATUS" in
                    "UU"|"AA"|"DD")
                      if [ -f "$FILE_PATH" ]; then
                        echo "Resolving conflict: $FILE_PATH (using source version)"
                        git checkout --ours "$FILE_PATH"
                        git add "$FILE_PATH"
                      fi
                      ;;
                    " D")
                      if [ -f "$FILE_PATH" ]; then
                        echo "Deleting file: $FILE_PATH"
                        git rm "$FILE_PATH"
                        HAS_CHANGES=true
                      fi
                      ;;
                  esac
                fi
              done
            fi
            
            # æ·»åŠ æ‰€æœ‰æ›´æ”¹
            git add -A
            
            # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹æˆ–éœ€è¦åˆ›å»ºç©ºæäº¤
            if [ "$HAS_CHANGES" = "true" ] || git diff --cached --quiet; then
              # åˆ›å»ºæäº¤ï¼Œå¼ºåˆ¶ä½¿ç”¨æŒ‡å®šçš„ä½œè€…
              NEW_MESSAGE="${{ github.event.inputs.commit_message }} [$COMMIT_HASH]"
              
              git commit -m "$NEW_MESSAGE" \
                --author="${{ github.event.inputs.new_author_name }} <${{ github.event.inputs.new_author_email }}>" \
                --allow-empty \
                --keep-redundant-commits
              
              echo "Committed with author: ${{ github.event.inputs.new_author_name }}"
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
            else
              echo "No changes to commit for $COMMIT_HASH"
            fi
          done
          
          echo "Synchronization completed: $SUCCESS_COUNT/$TOTAL_COMMITS commits processed successfully"
          
      - name: Push to target repository
        run: |
          cd target-repo
          echo "Pushing changes to target repository..."
          
          git push origin ${{ github.event.inputs.target_branch }}
          
          echo "Push completed successfully"
          
      - name: Cleanup
        if: always()
        run: |
          echo "Cleaning up temporary files..."
          rm -rf target-repo
          echo "Cleanup completed"
          
      - name: Workflow summary
        run: |
          echo "ğŸ‰ Cross repository sync completed!"
          echo "Source: ${{ github.event.inputs.source_repo }}:${{ github.event.inputs.source_branch }}"
          echo "Target: ${{ github.event.inputs.target_repo }}:${{ github.event.inputs.target_branch }}"
          echo "Commits processed: ${{ steps.parse_commits.outputs.commit_count }}"
          echo "Author: ${{ github.event.inputs.new_author_name }} <${{ github.event.inputs.new_author_email }}>"
          echo "All source commit authors have been replaced with mozi9"

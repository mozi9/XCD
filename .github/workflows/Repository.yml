name: Cross Repository Sync (mozi9 - Complete)

on:
  workflow_dispatch:
    inputs:
      # æºä»“åº“é…ç½®
      source_repo:
        description: 'æºä»“åº“åœ°å€ (æ ¼å¼: owner/repo)'
        required: true
        default: 'mozi9/source-repo'
        type: string
      source_branch:
        description: 'æºä»“åº“åˆ†æ”¯'
        required: true
        default: 'main'
        type: string
      source_commits:
        description: 'æºæäº¤å“ˆå¸Œ (å¤šä¸ªç”¨é€—å·åˆ†éš”ï¼Œå¦‚: abc123,def456)'
        required: true
        type: string
      
      # ç›®æ ‡ä»“åº“é…ç½®
      target_repo:
        description: 'ç›®æ ‡ä»“åº“åœ°å€ (æ ¼å¼: owner/repo)'
        required: true
        type: string
      target_branch:
        description: 'ç›®æ ‡ä»“åº“åˆ†æ”¯'
        required: true
        default: 'main'
        type: string
      
      # æäº¤é…ç½® - æ–°å¢ä½œè€…é…ç½®
      new_author_name:
        description: 'æ–°ä½œè€…åç§°'
        required: true
        default: 'mozi9'
        type: string
      new_author_email:
        description: 'æ–°ä½œè€…é‚®ç®±'
        required: true
        default: 'mozi9@example.com'
        type: string
      commit_message:
        description: 'æäº¤ä¿¡æ¯'
        required: true
        default: 'Sync commit from source repository'
        type: string

jobs:
  sync-repository:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºå½“å‰ä»“åº“
        uses: actions/checkout@v4
        
      - name: è®¾ç½®Gitç”¨æˆ·ä¿¡æ¯
        run: |
          git config --global user.name "mozi9"
          git config --global user.email "mozi9@example.com"
      
      - name: è§£ææäº¤å“ˆå¸Œ
        id: parse_commits
        run: |
          # æ¸…ç†è¾“å…¥å¹¶åˆ†å‰²æˆæ•°ç»„
          CLEAN_INPUT=$(echo "${{ github.event.inputs.source_commits }}" | tr -d ' ')
          IFS=',' read -ra COMMITS <<< "$CLEAN_INPUT"
          echo "commit_count=${#COMMITS[@]}" >> $GITHUB_OUTPUT
          
          for i in "${!COMMITS[@]}"; do
            echo "commit_$i=${COMMITS[$i]}" >> $GITHUB_OUTPUT
            echo "âœ… è§£ææäº¤ $((i+1)): ${COMMITS[$i]}"
          done
          
          if [ ${#COMMITS[@]} -eq 0 ]; then
            echo "âŒ æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„æäº¤å“ˆå¸Œ"
            exit 1
          fi
      
      - name: è®¾ç½®ç›®æ ‡ä»“åº“
        run: |
          echo "ğŸ¯ è®¾ç½®ç›®æ ‡ä»“åº“: ${{ github.event.inputs.target_repo }}"
          
          # å…‹éš†ç›®æ ‡ä»“åº“ï¼ˆä¿ç•™å®Œæ•´å†å²ï¼Œé™é»˜æ¨¡å¼ï¼‰
          git clone --quiet https://Mozi9_PAT@github.com/${{ github.event.inputs.target_repo }}.git target-repo
          cd target-repo
          
          # åˆ‡æ¢åˆ°ç›®æ ‡åˆ†æ”¯
          if git show-ref --verify --quiet refs/heads/${{ github.event.inputs.target_branch }}; then
            git checkout --quiet ${{ github.event.inputs.target_branch }}
          else
            echo "ğŸ†• åˆ›å»ºæ–°åˆ†æ”¯: ${{ github.event.inputs.target_branch }}"
            git checkout -b ${{ github.event.inputs.target_branch }}
          fi
          
          echo "âœ… ç›®æ ‡ä»“åº“è®¾ç½®å®Œæˆ"
      
      - name: æ·»åŠ æºä»“åº“
        run: |
          cd target-repo
          echo "ğŸ”— æ·»åŠ æºä»“åº“..."
          
          git remote add source https://github.com/${{ github.event.inputs.source_repo }}.git
          git fetch --quiet source ${{ github.event.inputs.source_branch }}
          
          echo "âœ… æºä»“åº“è¿æ¥å°±ç»ª"
      
      - name: æ‰§è¡ŒåŒæ­¥æ“ä½œï¼ˆç»Ÿä¸€ä½œè€…mozi9ï¼‰
        run: |
          cd target-repo
          echo "ğŸš€ å¼€å§‹åŒæ­¥æäº¤ï¼ˆæ‰€æœ‰ä½œè€…æ”¹ä¸º ${{ github.event.inputs.new_author_name }}ï¼‰..."
          
          SUCCESS_COUNT=0
          TOTAL_COUNT=${{ steps.parse_commits.outputs.commit_count }}
          
          # é€ä¸ªåŒæ­¥æäº¤
          for ((i=0; i<TOTAL_COUNT; i++)); do
            COMMIT_HASH=${{ steps.parse_commits.outputs['commit_'$i] }}
            INDEX=$((i+1))
            
            echo "ğŸ”„ [$INDEX/$TOTAL_COUNT] $COMMIT_HASH"
            
            # æ‰§è¡Œcherry-pick
            if git cherry-pick $COMMIT_HASH --no-commit 2>/dev/null; then
              echo "   âœ… åº”ç”¨æˆåŠŸ"
              HAS_CHANGES=true
            else
              echo "   âš ï¸  å¤„ç†å†²çª..."
              HAS_CHANGES=false
              
              # å¤„ç†å†²çªå’Œæ–‡ä»¶æ“ä½œ
              git status --porcelain | grep "^UU\|^AA\|^DD" | cut -c4- | while read file; do
                [ -f "$file" ] && git checkout --ours "$file" && git add "$file"
              done
              
              git status --porcelain | grep "^ D" | cut -c3- | while read file; do
                [ -f "$file" ] && git rm "$file" && HAS_CHANGES=true
              done
              
              git status --porcelain | grep "^R" | while read line; do
                OLD=$(echo "$line" | awk '{print $2}')
                NEW=$(echo "$line" | awk '{print $3}')
                [ -f "$OLD" ] && git mv "$OLD" "$NEW" && HAS_CHANGES=true
              done
            fi
            
            # æ·»åŠ æ›´æ”¹
            git add -A
            
            # åˆ›å»ºæäº¤ - å¼ºåˆ¶ä½¿ç”¨mozi9ä½œä¸ºä½œè€…ï¼Œå¿½ç•¥æºæäº¤çš„æ‰€æœ‰ä½œè€…ä¿¡æ¯
            if [ "$HAS_CHANGES" = "true" ] || git diff --cached --quiet; then
              git commit -m "${{ github.event.inputs.commit_message }} [$COMMIT_HASH]" \
                --author="${{ github.event.inputs.new_author_name }} <${{ github.event.inputs.new_author_email }}>" \
                --allow-empty \
                --keep-redundant-commits
              echo "   âœ… å·²æäº¤ (ä½œè€…: ${{ github.event.inputs.new_author_name }})"
              ((SUCCESS_COUNT++))
            else
              echo "   â­ï¸  è·³è¿‡ç©ºæäº¤"
            fi
          done
          
          echo "ğŸ“Š åŒæ­¥å®Œæˆ: $SUCCESS_COUNT/$TOTAL_COUNT"
          echo "ğŸ‘¤ æ‰€æœ‰æäº¤ä½œè€…å·²ç»Ÿä¸€ä¸º: ${{ github.event.inputs.new_author_name }}"
      
      - name: æ¨é€æ›´æ”¹
        run: |
          cd target-repo
          echo "ğŸ“¤ æ¨é€æ›´æ”¹..."
          
          git push origin ${{ github.event.inputs.target_branch }}
          
          echo "âœ… æ¨é€æˆåŠŸ"
      
      - name: æ¸…ç†
        if: always()
        run: |
          rm -rf target-repo
      
      - name: å®Œæˆ
        run: |
          echo "ğŸ‰ åŒæ­¥å®Œæˆï¼"
          echo "æº: ${{ github.event.inputs.source_repo }}"
          echo "ç›®æ ‡: ${{ github.event.inputs.target_repo }}"
          echo "æäº¤æ•°: ${{ steps.parse_commits.outputs.commit_count }}"
          echo "ğŸ‘¤ ç»Ÿä¸€ä½œè€…: ${{ github.event.inputs.new_author_name }} <${{ github.event.inputs.new_author_email }}>"
          echo "âœ… æ‰€æœ‰æºæäº¤çš„ä½œè€…ä¿¡æ¯å·²è¢«æ›¿æ¢ä¸º mozi9"

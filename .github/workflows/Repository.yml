name: Exact Source Commit Apply - No Reset

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: '源仓库地址 (格式: owner/repo)'
        required: true
        default: 'mozi9/source-repo'
      target_repo:
        description: '目标仓库地址 (格式: owner/repo)'
        required: true
        default: 'mozi9/target-repo'
      commit_hashes:
        description: '要同步的提交哈希（多个用逗号分隔）'
        required: true
        default: ''
      commit_message:
        description: '合并提交信息'
        required: true
        default: 'sync: 同步提交'

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  exact-apply:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout target repository
      uses: actions/checkout@v4
      with:
        repository: ${{ github.event.inputs.target_repo }}
        token: ${{ secrets.Mozi9_PAT }}
        ref: 'main'
        fetch-depth: 0

    - name: Setup Git identity
      run: |
        git config --global user.name "mozi9"
        git config --global user.email "mozi9"

    - name: Add source repository
      run: |
        git remote add source https://github.com/${{ github.event.inputs.source_repo }}.git
        git fetch source

    - name: Create apply branch
      run: |
        git checkout -b apply-commits

    - name: Apply commits exactly
      run: |
        echo "应用提交（完全保留源内容）..."
        COMMITS=$(echo '${{ github.event.inputs.commit_hashes }}' | tr ',' ' ')
        
        for COMMIT in $COMMITS; do
          echo "应用提交: $COMMIT"
          
          # 直接使用 cherry-pick 应用提交
          git cherry-pick $COMMIT
          
          # 仅修改作者，保持所有内容不变
          git commit --amend --author="mozi9 <mozi9>" --no-edit
          
          echo "✅ 提交应用完成"
        done

    - name: Merge to main
      run: |
        git checkout main
        git merge --no-ff -m "${{ github.event.inputs.commit_message }}" apply-commits
        git commit --amend --author="mozi9 <mozi9>" --no-edit

    - name: Final report
      run: |
        echo "✅ 提交应用完成"
        echo "所有源提交内容已完全应用到目标仓库"
        echo "作者信息已统一为: mozi9 <mozi9>"

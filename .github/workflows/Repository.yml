name: Cross Repository Sync

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: '源仓库地址 (格式: owner/repo)'
        required: true
        default: 'mozi9/source-repo'
        type: string
      source_branch:
        description: '源仓库分支'
        required: true
        default: 'main'
        type: string
      source_commits:
        description: '源提交哈希 (多个用逗号分隔，如: abc123,def456)'
        required: true
        type: string
      target_repo:
        description: '目标仓库地址 (格式: owner/repo)'
        required: true
        type: string
      target_branch:
        description: '目标仓库分支'
        required: true
        default: 'main'
        type: string
      new_author_name:
        description: '新作者名称'
        required: true
        default: 'mozi9'
        type: string
      new_author_email:
        description: '新作者邮箱'
        required: true
        default: 'mozi9@example.com'
        type: string
      commit_message:
        description: '提交信息'
        required: true
        default: 'Sync commit from source repository'
        type: string

jobs:
  sync-repository:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout current repository
        uses: actions/checkout@v4
        
      - name: Setup Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
      - name: Parse commit hashes
        id: parse_commits
        run: |
          # 清理输入
          CLEAN_INPUT="${{ github.event.inputs.source_commits }}"
          CLEAN_INPUT="${CLEAN_INPUT// /}"  # 移除所有空格
          
          # 使用逗号分割
          IFS=',' read -ra COMMITS <<< "$CLEAN_INPUT"
          echo "commit_count=${#COMMITS[@]}" >> $GITHUB_OUTPUT
          
          # 输出每个提交
          for i in "${!COMMITS[@]}"; do
            echo "commit_$i=${COMMITS[$i]}" >> $GITHUB_OUTPUT
            echo "Found commit: ${COMMITS[$i]}"
          done
          
      - name: Setup target repository
        run: |
          echo "Setting up target repository: ${{ github.event.inputs.target_repo }}"
          
          # 克隆目标仓库
          git clone https://Mozi9_PAT@github.com/${{ github.event.inputs.target_repo }}.git target-repo
          cd target-repo
          
          # 切换分支
          if git show-ref --verify --quiet refs/heads/${{ github.event.inputs.target_branch }}; then
            git checkout ${{ github.event.inputs.target_branch }}
          else
            git checkout -b ${{ github.event.inputs.target_branch }}
          fi
          
      - name: Add source remote
        run: |
          cd target-repo
          git remote add source https://github.com/${{ github.event.inputs.source_repo }}.git
          git fetch source ${{ github.event.inputs.source_branch }}
          
      - name: Sync commits
        run: |
          cd target-repo
          echo "Starting sync process..."
          
          total=${{ steps.parse_commits.outputs.commit_count }}
          success=0
          
          for ((i=0; i<total; i++)); do
            commit_hash=${{ steps.parse_commits.outputs['commit_'$i] }}
            index=$((i+1))
            
            echo "Processing [$index/$total]: $commit_hash"
            
            # 尝试cherry-pick
            if git cherry-pick $commit_hash --no-commit 2>/dev/null; then
              echo "Cherry-pick successful"
              has_changes=true
            else
              echo "Handling conflicts..."
              has_changes=false
              
              # 处理冲突文件
              git status --porcelain | grep "^UU\|^AA\|^DD" | while read line; do
                file="${line:3}"
                if [ -f "$file" ]; then
                  git checkout --ours "$file"
                  git add "$file"
                fi
              done
              
              # 处理删除的文件
              git status --porcelain | grep "^ D" | while read line; do
                file="${line:3}"
                if [ -f "$file" ]; then
                  git rm "$file"
                  has_changes=true
                fi
              done
            fi
            
            # 添加所有更改
            git add -A
            
            # 创建提交（强制使用mozi9作者）
            if [ "$has_changes" = "true" ] || git diff --cached --quiet; then
              git commit -m "${{ github.event.inputs.commit_message }} [$commit_hash]" \
                --author="${{ github.event.inputs.new_author_name }} <${{ github.event.inputs.new_author_email }}>" \
                --allow-empty \
                --keep-redundant-commits
              echo "Commit created with author: ${{ github.event.inputs.new_author_name }}"
              success=$((success+1))
            fi
          done
          
          echo "Sync completed: $success/$total commits successful"
          
      - name: Push changes
        run: |
          cd target-repo
          git push origin ${{ github.event.inputs.target_branch }}
          echo "Changes pushed successfully"
          
      - name: Cleanup
        if: always()
        run: |
          rm -rf target-repo
          
      - name: Summary
        run: |
          echo "Repository sync completed!"
          echo "Source: ${{ github.event.inputs.source_repo }}"
          echo "Target: ${{ github.event.inputs.target_repo }}"
          echo "Commits processed: ${{ steps.parse_commits.outputs.commit_count }}"
          echo "Author: ${{ github.event.inputs.new_author_name }}"

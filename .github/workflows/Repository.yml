name: Cross Repository Sync

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: 'Source repository (format: owner/repo)'
        required: true
        default: 'mozi9/source-repo'
        type: string
      source_branch:
        description: 'Source repository branch'
        required: true
        default: 'main'
        type: string
      source_commits:
        description: 'Source commit hashes (comma separated, e.g.: abc123,def456)'
        required: true
        type: string
      target_repo:
        description: 'Target repository (format: owner/repo)'
        required: true
        type: string
      target_branch:
        description: 'Target repository branch'
        required: true
        default: 'main'
        type: string
      new_author_name:
        description: 'New author name'
        required: true
        default: 'mozi9'
        type: string
      new_author_email:
        description: 'New author email'
        required: true
        default: 'mozi9@example.com'
        type: string
      commit_message:
        description: 'Commit message'
        required: true
        default: 'Sync commit from source repository'
        type: string

jobs:
  sync-repository:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup git config
        run: |
          git config --global user.name "mozi9"
          git config --global user.email "mozi9@example.com"
      
      - name: Parse commit hashes
        id: parse_commits
        run: |
          CLEAN_INPUT=$(echo "${{ github.event.inputs.source_commits }}" | tr -d ' ')
          IFS=',' read -ra COMMITS <<< "$CLEAN_INPUT"
          echo "commit_count=${#COMMITS[@]}" >> $GITHUB_OUTPUT
          
          for i in "${!COMMITS[@]}"; do
            echo "commit_$i=${COMMITS[$i]}" >> $GITHUB_OUTPUT
          done
      
      - name: Setup target repository
        run: |
          git clone --quiet https://Mozi9_PAT@github.com/${{ github.event.inputs.target_repo }}.git target-repo
          cd target-repo
          
          if git show-ref --verify --quiet refs/heads/${{ github.event.inputs.target_branch }}; then
            git checkout --quiet ${{ github.event.inputs.target_branch }}
          else
            git checkout -b ${{ github.event.inputs.target_branch }}
          fi
      
      - name: Add source remote
        run: |
          cd target-repo
          git remote add source https://github.com/${{ github.event.inputs.source_repo }}.git
          git fetch --quiet source ${{ github.event.inputs.source_branch }}
      
      - name: Sync commits
        run: |
          cd target-repo
          SUCCESS_COUNT=0
          TOTAL_COUNT=${{ steps.parse_commits.outputs.commit_count }}
          
          for ((i=0; i<TOTAL_COUNT; i++)); do
            COMMIT_HASH=${{ steps.parse_commits.outputs['commit_'$i] }}
            
            if git cherry-pick $COMMIT_HASH --no-commit 2>/dev/null; then
              HAS_CHANGES=true
            else
              HAS_CHANGES=false
              
              git status --porcelain | grep "^UU\|^AA\|^DD" | cut -c4- | while read file; do
                [ -f "$file" ] && git checkout --ours "$file" && git add "$file"
              done
              
              git status --porcelain | grep "^ D" | cut -c3- | while read file; do
                [ -f "$file" ] && git rm "$file" && HAS_CHANGES=true
              done
              
              git status --porcelain | grep "^R" | while read line; do
                OLD=$(echo "$line" | awk '{print $2}')
                NEW=$(echo "$line" | awk '{print $3}')
                [ -f "$OLD" ] && git mv "$OLD" "$NEW" && HAS_CHANGES=true
              done
            fi
            
            git add -A
            
            if [ "$HAS_CHANGES" = "true" ] || git diff --cached --quiet; then
              git commit -m "${{ github.event.inputs.commit_message }} [$COMMIT_HASH]" \
                --author="${{ github.event.inputs.new_author_name }} <${{ github.event.inputs.new_author_email }}>" \
                --allow-empty \
                --keep-redundant-commits
              ((SUCCESS_COUNT++))
            fi
          done
      
      - name: Push changes
        run: |
          cd target-repo
          git push origin ${{ github.event.inputs.target_branch }}
      
      - name: Cleanup
        if: always()
        run: |
          rm -rf target-repo
      
      - name: Summary
        run: |
          echo "Sync completed"
          echo "Source: ${{ github.event.inputs.source_repo }}"
          echo "Target: ${{ github.event.inputs.target_repo }}"
          echo "Commits: ${{ steps.parse_commits.outputs.commit_count }}"
          echo "Author: ${{ github.event.inputs.new_author_name }}"

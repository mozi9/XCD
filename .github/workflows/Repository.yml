name: Manual Repository Sync - Force Overwrite

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: 'æºä»“åº“åœ°å€ (æ ¼å¼: owner/repo)'
        required: true
        default: 'mozi9/source-repo'
      source_branch:
        description: 'æºåˆ†æ”¯å (ç•™ç©ºä½¿ç”¨é»˜è®¤åˆ†æ”¯)'
        required: false
        default: ''
      target_repo:
        description: 'ç›®æ ‡ä»“åº“åœ°å€ (æ ¼å¼: owner/repo)'
        required: true
        default: 'mozi9/target-repo'
      target_branch:
        description: 'ç›®æ ‡åˆ†æ”¯å'
        required: true
        default: 'main'
      commit_hashes:
        description: 'è¦åŒæ­¥çš„æäº¤å“ˆå¸Œï¼ˆå¤šä¸ªç”¨é€—å·åˆ†éš”ï¼‰'
        required: true
        default: ''
      commit_name:
        description: 'åˆå¹¶æäº¤å'
        required: true
        default: 'sync: åŒæ­¥æäº¤'
      commit_description:
        description: 'åˆå¹¶æäº¤æè¿°ï¼ˆå¯é€‰ï¼‰'
        required: false
        default: ''
      delete_message:
        description: 'åˆ é™¤æ–‡ä»¶æäº¤ä¿¡æ¯'
        required: true
        default: 'delete: åˆ é™¤æ ‡è®°æ–‡ä»¶'
      max_commits:
        description: 'æœ€å¤§åŒæ­¥æäº¤æ•°é‡'
        required: true
        default: '20'

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  sync-repository:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout target repository
      uses: actions/checkout@v4
      with:
        repository: ${{ github.event.inputs.target_repo }}
        token: ${{ secrets.Mozi9_PAT }}
        ref: ${{ github.event.inputs.target_branch }}
        fetch-depth: 0

    - name: Setup Mozi9 Git identity
      run: |
        git config --global user.name "mozi9"
        git config --global user.email "mozi9"
        git config --global push.default simple
        echo "Git identity set to: mozi9 <mozi9>"

    - name: Add source repository
      id: add_source
      run: |
        echo "æ·»åŠ æºä»“åº“..."
        SOURCE_REPO="${{ github.event.inputs.source_repo }}"
        SOURCE_BRANCH="${{ github.event.inputs.source_branch }}"
        
        if [ -z "$SOURCE_BRANCH" ]; then
          echo "ä½¿ç”¨æºä»“åº“é»˜è®¤åˆ†æ”¯"
          git remote add source-repo https://github.com/$SOURCE_REPO.git
          git fetch source-repo
        else
          echo "ä½¿ç”¨æºä»“åº“åˆ†æ”¯: $SOURCE_BRANCH"
          git remote add source-repo https://github.com/$SOURCE_REPO.git
          git fetch source-repo $SOURCE_BRANCH
        fi
        echo "âœ… æºä»“åº“æ·»åŠ å®Œæˆ"

    - name: Parse and validate commit hashes
      id: parse_commits
      run: |
        echo "è§£æå’ŒéªŒè¯æäº¤å“ˆå¸Œ..."
        COMMIT_HASHES=$(echo '${{ github.event.inputs.commit_hashes }}' | tr -d '[:space:]' | tr ',' ' ')
        
        VALID_COMMITS=()
        INVALID_COMMITS=()
        
        for hash in $COMMIT_HASHES; do
          if git rev-parse --verify "$hash" >/dev/null 2>&1; then
            COMMIT_SUBJECT=$(git log -1 --format="%s" "$hash" 2>/dev/null || echo "æ— æ³•è·å–æäº¤ä¿¡æ¯")
            echo "âœ… æäº¤æœ‰æ•ˆ: $hash - $COMMIT_SUBJECT"
            VALID_COMMITS+=("$hash")
          else
            echo "âŒ æäº¤æ— æ•ˆ: $hash"
            INVALID_COMMITS+=("$hash")
          fi
        done
        
        if [ ${#VALID_COMMITS[@]} -eq 0 ]; then
          echo "âŒ é”™è¯¯: æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„æäº¤"
          exit 1
        fi
        
        MAX_COMMITS=${{ github.event.inputs.max_commits }}
        if [ ${#VALID_COMMITS[@]} -gt $MAX_COMMITS ]; then
          echo "âš ï¸ è­¦å‘Š: æäº¤æ•°é‡ ${#VALID_COMMITS[@]} è¶…è¿‡æœ€å¤§é™åˆ¶ $MAX_COMMITS"
          VALID_COMMITS=("${VALID_COMMITS[@]:0:$MAX_COMMITS}")
        fi
        
        printf "%s\n" "${VALID_COMMITS[@]}" > /tmp/valid_commits.txt
        echo "commit_count=${#VALID_COMMITS[@]}" >> $GITHUB_OUTPUT
        echo "ğŸ“Š å°†å¤„ç† ${#VALID_COMMITS[@]} ä¸ªæœ‰æ•ˆæäº¤"

    - name: Collect files marked for deletion
      id: collect_deleted
      run: |
        echo "æ”¶é›†æºæäº¤ä¸­æ ‡è®°ä¸ºåˆ é™¤çš„æ–‡ä»¶..."
        
        # ç¦ç”¨é”™è¯¯é€€å‡º
        set +e
        
        COMMITS=$(cat /tmp/valid_commits.txt)
        DELETED_FILES=""
        
        for COMMIT in $COMMITS; do
          echo "åˆ†ææäº¤: $COMMIT"
          DELETED_IN_COMMIT=$(git show "$COMMIT" --name-only --diff-filter=D --format= 2>/dev/null)
          
          if [ -n "$DELETED_IN_COMMIT" ]; then
            DEL_COUNT_IN_COMMIT=$(echo "$DELETED_IN_COMMIT" | grep -c . || echo 0)
            echo "  åˆ é™¤æ–‡ä»¶: $DEL_COUNT_IN_COMMIT ä¸ª"
            DELETED_FILES="$DELETED_FILES"$'\n'"$DELETED_IN_COMMIT"
          fi
        done
        
        # é‡æ–°å¯ç”¨é”™è¯¯é€€å‡º
        set -e
        
        # å¤„ç†ç»“æœ
        if [ -z "$DELETED_FILES" ]; then
          echo "â„¹ï¸ æ²¡æœ‰æ‰¾åˆ°æ ‡è®°ä¸ºåˆ é™¤çš„æ–‡ä»¶"
          touch /tmp/deleted_files.txt
          echo "deleted_files_count=0" >> $GITHUB_OUTPUT
        else
          CLEAN_DELETED=$(echo "$DELETED_FILES" | grep -v '^$' | sort | uniq)
          echo "$CLEAN_DELETED" > /tmp/deleted_files.txt
          DEL_COUNT=$(echo "$CLEAN_DELETED" | wc -l)
          echo "deleted_files_count=$DEL_COUNT" >> $GITHUB_OUTPUT
          echo "ğŸ“Š æ”¶é›†åˆ° $DEL_COUNT ä¸ªåˆ é™¤æ–‡ä»¶æ ‡è®°"
        fi

    - name: Create sync branch
      id: create_branch
      run: |
        echo "åˆ›å»ºåŒæ­¥åˆ†æ”¯..."
        SYNC_BRANCH="sync-$(date +%s)"
        git checkout -b "$SYNC_BRANCH"
        echo "branch_name=$SYNC_BRANCH" >> $GITHUB_OUTPUT
        echo "âœ… åˆ†æ”¯åˆ›å»º: $SYNC_BRANCH"

    - name: Extract all files from source commits
      id: extract_files
      run: |
        echo "æå–æºæäº¤ä¸­çš„æ‰€æœ‰æ–‡ä»¶..."
        
        # ç¦ç”¨é”™è¯¯é€€å‡º
        set +e
        
        COMMITS=$(cat /tmp/valid_commits.txt)
        ALL_FILES=""
        
        for COMMIT in $COMMITS; do
          echo "æå–æäº¤: $COMMIT ä¸­çš„æ–‡ä»¶"
          COMMIT_FILES=$(git show "$COMMIT" --name-only --format= 2>/dev/null | grep -v '^$')
          
          if [ -n "$COMMIT_FILES" ]; then
            FILE_COUNT=$(echo "$COMMIT_FILES" | wc -l)
            echo "  æ–‡ä»¶æ•°é‡: $FILE_COUNT"
            ALL_FILES="$ALL_FILES"$'\n'"$COMMIT_FILES"
          fi
        done
        
        # é‡æ–°å¯ç”¨é”™è¯¯é€€å‡º
        set -e
        
        # å»é‡å¤„ç†
        UNIQUE_FILES=$(echo "$ALL_FILES" | grep -v '^$' | sort | uniq)
        echo "$UNIQUE_FILES" > /tmp/all_source_files.txt
        FILE_COUNT=$(echo "$UNIQUE_FILES" | wc -l)
        echo "unique_file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
        echo "ğŸ“Š æå–åˆ° $FILE_COUNT ä¸ªå”¯ä¸€æ–‡ä»¶"

    - name: Force copy all files from source commits
      id: copy_files
      run: |
        echo "å¼ºåˆ¶å¤åˆ¶æºæäº¤ä¸­çš„æ‰€æœ‰æ–‡ä»¶..."
        
        COMMITS=$(cat /tmp/valid_commits.txt)
        ALL_FILES=$(cat /tmp/all_source_files.txt)
        DELETED_FILES=$(cat /tmp/deleted_files.txt 2>/dev/null || true)
        
        COPIED_COUNT=0
        FAILED_COUNT=0
        
        for file in $ALL_FILES; do
          # è·³è¿‡æ ‡è®°ä¸ºåˆ é™¤çš„æ–‡ä»¶ï¼ˆåç»­å•ç‹¬å¤„ç†ï¼‰
          if echo "$DELETED_FILES" | grep -q "^$file$"; then
            echo "è·³è¿‡åˆ é™¤æ–‡ä»¶: $file"
            continue
          fi
          
          # æ‰¾åˆ°åŒ…å«è¯¥æ–‡ä»¶çš„æœ€åä¸€ä¸ªæäº¤ï¼ˆè·å–æœ€æ–°ç‰ˆæœ¬ï¼‰
          SOURCE_COMMIT=""
          for COMMIT in $COMMITS; do
            if git show "$COMMIT":"$file" >/dev/null 2>&1; then
              SOURCE_COMMIT=$COMMIT
            fi
          done
          
          if [ -n "$SOURCE_COMMIT" ]; then
            echo "å¤åˆ¶: $file (æ¥è‡ª $SOURCE_COMMIT)"
            # åˆ›å»ºç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            mkdir -p "$(dirname "$file")"
            
            # å¼ºåˆ¶å¤åˆ¶æ–‡ä»¶ï¼ˆæ— è®ºå†…å®¹æ˜¯å¦ç›¸åŒï¼‰
            if git show "$SOURCE_COMMIT":"$file" > "$file" 2>/dev/null; then
              COPIED_COUNT=$((COPIED_COUNT + 1))
            else
              echo "âŒ å¤åˆ¶å¤±è´¥: $file"
              FAILED_COUNT=$((FAILED_COUNT + 1))
            fi
          else
            echo "âš ï¸ æœªæ‰¾åˆ°æ–‡ä»¶æ¥æº: $file"
            FAILED_COUNT=$((FAILED_COUNT + 1))
          fi
        done
        
        echo "copied_count=$COPIED_COUNT" >> $GITHUB_OUTPUT
        echo "failed_count=$FAILED_COUNT" >> $GITHUB_OUTPUT
        echo "ğŸ“Š å¤åˆ¶å®Œæˆ: $COPIED_COUNT æˆåŠŸ, $FAILED_COUNT å¤±è´¥"

    - name: Commit copied files
      id: commit_files
      run: |
        echo "æäº¤å¤åˆ¶çš„æ–‡ä»¶..."
        
        # æ·»åŠ æ‰€æœ‰æ–‡ä»¶åˆ°æš‚å­˜åŒº
        git add -A
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
        if git diff --cached --quiet; then
          echo "â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "âœ… æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´ï¼Œå‡†å¤‡æäº¤"
          echo "has_changes=true" >> $GITHUB_OUTPUT
          
          # å‡†å¤‡æäº¤ä¿¡æ¯
          COMMIT_NAME="${{ github.event.inputs.commit_name }}"
          COMMIT_DESC="${{ github.event.inputs.commit_description }}"
          
          COMMIT_MSG="$COMMIT_NAME"
          if [ -n "$COMMIT_DESC" ]; then
            COMMIT_MSG="$COMMIT_MSG"$'\n\n'"$COMMIT_DESC"
          fi
          
          # åˆ›å»ºæäº¤
          git commit -m "$COMMIT_MSG" --author="mozi9 <mozi9>"
          echo "âœ… æ–‡ä»¶å¤åˆ¶æäº¤å®Œæˆ"
        fi

    - name: Merge to target branch
      id: merge_branch
      run: |
        echo "åˆå¹¶åˆ°ç›®æ ‡åˆ†æ”¯..."
        git checkout ${{ github.event.inputs.target_branch }}
        
        # ä½¿ç”¨éå¿«è¿›åˆå¹¶ï¼Œä¿ç•™åˆå¹¶å†å²
        git merge --no-ff -m "merge: åŒæ­¥æäº¤" sync-* --author="mozi9 <mozi9>"
        echo "âœ… åˆå¹¶å®Œæˆ"

    - name: Process deleted files
      id: process_deleted
      run: |
        echo "å¤„ç†æ ‡è®°çš„åˆ é™¤æ–‡ä»¶..."
        DELETED_FILES=$(cat /tmp/deleted_files.txt 2>/dev/null || true)
        
        if [ -n "$DELETED_FILES" ]; then
          DEL_COUNT=0
          SKIP_COUNT=0
          
          for file in $DELETED_FILES; do
            if [ -e "$file" ]; then
              echo "åˆ é™¤: $file"
              git rm "$file" >/dev/null 2>&1 || rm -rf "$file"
              DEL_COUNT=$((DEL_COUNT + 1))
            else
              echo "è·³è¿‡(ä¸å­˜åœ¨): $file"
              SKIP_COUNT=$((SKIP_COUNT + 1))
            fi
          done
          
          if [ $DEL_COUNT -gt 0 ]; then
            git commit -m "${{ github.event.inputs.delete_message }}" --author="mozi9 <mozi9>"
            echo "deleted_count=$DEL_COUNT" >> $GITHUB_OUTPUT
            echo "skipped_count=$SKIP_COUNT" >> $GITHUB_OUTPUT
            echo "âœ… åˆ é™¤å®Œæˆ: $DEL_COUNT ä¸ªæ–‡ä»¶"
          else
            echo "deleted_count=0" >> $GITHUB_OUTPUT
            echo "skipped_count=$SKIP_COUNT" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ æ²¡æœ‰éœ€è¦åˆ é™¤çš„æ–‡ä»¶"
          fi
        else
          echo "deleted_count=0" >> $GITHUB_OUTPUT
          echo "skipped_count=0" >> $GITHUB_OUTPUT
          echo "â„¹ï¸ æ²¡æœ‰æ ‡è®°ä¸ºåˆ é™¤çš„æ–‡ä»¶"
        fi

    - name: Push changes
      id: push_changes
      run: |
        echo "æ¨é€åˆ°ç›®æ ‡ä»“åº“..."
        TARGET_REPO="${{ github.event.inputs.target_repo }}"
        TARGET_BRANCH="${{ github.event.inputs.target_branch }}"
        
        git push https://mozi9:${{ secrets.Mozi9_PAT }}@github.com/$TARGET_REPO.git $TARGET_BRANCH
        echo "âœ… æ¨é€å®Œæˆ"

    - name: Cleanup
      run: |
        echo "æ¸…ç†ä¸´æ—¶åˆ†æ”¯..."
        git branch -D sync-* 2>/dev/null || true
        echo "âœ… æ¸…ç†å®Œæˆ"

    - name: Generate final report
      run: |
        echo ""
        echo "ğŸ‰ å¼ºåˆ¶è¦†ç›–åŒæ­¥å®Œæˆ!"
        echo "=========================================="
        echo "ğŸ“Š æ‰§è¡ŒæŠ¥å‘Š:"
        echo "  æºä»“åº“: ${{ github.event.inputs.source_repo }}"
        echo "  ç›®æ ‡ä»“åº“: ${{ github.event.inputs.target_repo }}"
        echo "  å¤„ç†æäº¤: ${{ steps.parse_commits.outputs.commit_count }} ä¸ª"
        echo "  æå–æ–‡ä»¶: ${{ steps.extract_files.outputs.unique_file_count }} ä¸ª"
        echo "  æˆåŠŸå¤åˆ¶: ${{ steps.copy_files.outputs.copied_count || 0 }} ä¸ª"
        echo "  å¤åˆ¶å¤±è´¥: ${{ steps.copy_files.outputs.failed_count || 0 }} ä¸ª"
        echo "  åˆ é™¤æ–‡ä»¶: ${{ steps.process_deleted.outputs.deleted_count || 0 }} ä¸ª"
        echo "  è·³è¿‡åˆ é™¤: ${{ steps.process_deleted.outputs.skipped_count || 0 }} ä¸ª"
        echo ""
        echo "ğŸ”§ åŒæ­¥ç­–ç•¥:"
        echo "  âœ… ç›¸åŒæ–‡ä»¶: å¼ºåˆ¶è¦†ç›–"
        echo "  âœ… ä¸åŒæ–‡ä»¶: ä½¿ç”¨æºæ–‡ä»¶"
        echo "  âœ… åˆ é™¤æ–‡ä»¶: æ ‡è®°åå¤„ç†"
        echo ""
        echo "ğŸ“ æäº¤ä¿¡æ¯:"
        echo "  åˆå¹¶æäº¤: ${{ github.event.inputs.commit_name }}"
        if [ -n "${{ github.event.inputs.commit_description }}" ]; then
          echo "  æäº¤æè¿°: ${{ github.event.inputs.commit_description }}"
        fi
        echo "  åˆ é™¤æäº¤: ${{ github.event.inputs.delete_message }}"
        echo ""
        echo "ğŸ‘¤ æ“ä½œèº«ä»½: mozi9 <mozi9>"
        echo "ğŸ”‘ ä½¿ç”¨ä»¤ç‰Œ: Mozi9_PAT"
        echo ""
        echo "â° å®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "=========================================="

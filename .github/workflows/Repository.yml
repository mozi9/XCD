name: Source Commit Sync with Author Processing

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: 'æºä»“åº“åœ°å€'
        required: true
        default: 'owner/source-repo'
      source_branch:
        description: 'æºåˆ†æ”¯å'
        required: true
        default: 'main'
      target_repo:
        description: 'ç›®æ ‡ä»“åº“åœ°å€'
        required: true
        default: 'owner/target-repo'
      target_branch:
        description: 'ç›®æ ‡åˆ†æ”¯å'
        required: true
        default: 'main'
      commit_hashes:
        description: 'è¦æ¨é€çš„æäº¤å“ˆå¸Œ'
        required: true
        default: ''
      new_branch_name:
        description: 'æ–°åˆ†æ”¯åï¼ˆç•™ç©ºä½¿ç”¨ç›®æ ‡åˆ†æ”¯ï¼‰'
        required: false
        default: ''
      push_strategy:
        description: 'æ¨é€ç­–ç•¥'
        required: true
        default: 'new-branch'
        type: choice
        options:
        - new-branch
        - direct-push

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  sync-with-author:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout source repository
      uses: actions/checkout@v4
      with:
        repository: ${{ github.event.inputs.source_repo }}
        token: ${{ secrets.Mozi9_PAT }}
        ref: ${{ github.event.inputs.source_branch }}
        fetch-depth: 0

    - name: Setup Mozi9 Git identity
      run: |
        git config --global user.name "mozi9"
        git config --global user.email "mozi9"
        echo "Git identity set to: mozi9 <mozi9>"

    - name: Add target repository
      run: |
        git remote add target https://github.com/${{ github.event.inputs.target_repo }}.git
        git fetch target

    - name: Create sync branch
      id: create_branch
      run: |
        if [ -z "${{ github.event.inputs.new_branch_name }}" ]; then
          BRANCH_NAME="${{ github.event.inputs.target_branch }}"
        else
          BRANCH_NAME="${{ github.event.inputs.new_branch_name }}"
        fi
        git checkout -b sync-branch target/${{ github.event.inputs.target_branch }}
        echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

    - name: Process commits with author cleanup
      id: process_commits
      run: |
        echo "å¤„ç†æäº¤ï¼ˆæ¸…ç†ä½œè€…ä¿¡æ¯ï¼‰..."
        COMMITS=$(echo '${{ github.event.inputs.commit_hashes }}' | tr ',' ' ')
        PROCESSED_COUNT=0
        
        for COMMIT in $COMMITS; do
          echo "å¤„ç†æäº¤: $COMMIT"
          
          # è·å–åŸå§‹æäº¤ä¿¡æ¯
          ORIG_MSG=$(git log -1 --format=%B "$COMMIT")
          ORIG_AUTHOR=$(git log -1 --format="%an <%ae>" "$COMMIT")
          ORIG_DATE=$(git log -1 --format="%ci" "$COMMIT")
          
          echo "åŸå§‹ä½œè€…: $ORIG_AUTHOR"
          echo "æäº¤æ—¶é—´: $ORIG_DATE"
          
          # æ¸…ç†æäº¤ä¿¡æ¯ä¸­çš„ä½œè€…ç›¸å…³è¡Œ
          CLEAN_MSG=$(echo "$ORIG_MSG" | \
            grep -v -E "(Co-authored-by|Reviewed-by|Signed-off-by|Acked-by|Tested-by):" | \
            grep -v "^$" | \
            sed '/^[[:space:]]*$/d')
          
          echo "æ¸…ç†åçš„æäº¤ä¿¡æ¯:"
          echo "$CLEAN_MSG"
          
          # åº”ç”¨æäº¤
          git cherry-pick "$COMMIT"
          
          # ä¿®æ”¹ä½œè€…ä¿¡æ¯ä¸º mozi9
          git commit --amend --author="mozi9 <mozi9>" --date="$ORIG_DATE" -m "$CLEAN_MSG"
          
          PROCESSED_COUNT=$((PROCESSED_COUNT + 1))
          echo "âœ… æäº¤å¤„ç†å®Œæˆï¼ˆä½œè€…: mozi9ï¼‰"
        done
        
        echo "processed_count=$PROCESSED_COUNT" >> $GITHUB_OUTPUT

    - name: Push with strategy
      run: |
        BRANCH_NAME="${{ steps.create_branch.outputs.branch_name }}"
        
        case "${{ github.event.inputs.push_strategy }}" in
          "new-branch")
            echo "æ¨é€åˆ°æ–°åˆ†æ”¯: $BRANCH_NAME"
            git push target sync-branch:$BRANCH_NAME
            ;;
          "direct-push")
            echo "ç›´æ¥æ¨é€åˆ°ç›®æ ‡åˆ†æ”¯: $BRANCH_NAME"
            git push target sync-branch:$BRANCH_NAME --force
            ;;
        esac

    - name: Generate report
      run: |
        echo ""
        echo "ğŸ‰ æäº¤åŒæ­¥å®Œæˆ!"
        echo "=========================================="
        echo "ğŸ“Š æ‰§è¡Œç»“æœ:"
        echo "  æºä»“åº“: ${{ github.event.inputs.source_repo }}"
        echo "  ç›®æ ‡ä»“åº“: ${{ github.event.inputs.target_repo }}"
        echo "  ç›®æ ‡åˆ†æ”¯: ${{ steps.create_branch.outputs.branch_name }}"
        echo "  å¤„ç†æäº¤: ${{ steps.process_commits.outputs.processed_count }} ä¸ª"
        echo ""
        echo "âœ… ä½œè€…ä¿¡æ¯å¤„ç†:"
        echo "  - åŸå§‹ä½œè€…: å…¨éƒ¨ç§»é™¤"
        echo "  - Co-authored-by: å…¨éƒ¨ç§»é™¤"
        echo "  - Reviewed-by: å…¨éƒ¨ç§»é™¤"
        echo "  - Signed-off-by: å…¨éƒ¨ç§»é™¤"
        echo "  - ç»Ÿä¸€ä½œè€…: mozi9 <mozi9>"
        echo "  - ä¿ç•™æäº¤æ—¶é—´æˆ³"
        echo ""
        echo "ğŸ‘¤ æœ€ç»ˆä½œè€…: mozi9 <mozi9>"
        echo "=========================================="

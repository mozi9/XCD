name: Exact Source Commit Sync - Mozi9 Author Only

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: 'æºä»“åº“åœ°å€ (æ ¼å¼: owner/repo)'
        required: true
        default: 'mozi9/source-repo'
      source_branch:
        description: 'æºåˆ†æ”¯å (ç•™ç©ºä½¿ç”¨é»˜è®¤åˆ†æ”¯)'
        required: false
        default: ''
      target_repo:
        description: 'ç›®æ ‡ä»“åº“åœ°å€ (æ ¼å¼: owner/repo)'
        required: true
        default: 'mozi9/target-repo'
      target_branch:
        description: 'ç›®æ ‡åˆ†æ”¯å'
        required: true
        default: 'main'
      commit_hashes:
        description: 'è¦åŒæ­¥çš„æäº¤å“ˆå¸Œï¼ˆå¤šä¸ªç”¨é€—å·åˆ†éš”ï¼‰'
        required: true
        default: ''
      commit_message:
        description: 'åˆå¹¶æäº¤ä¿¡æ¯'
        required: true
        default: 'sync: åŒæ­¥æäº¤'
      max_commits:
        description: 'æœ€å¤§åŒæ­¥æäº¤æ•°é‡'
        required: true
        default: '20'

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  exact-sync:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout target repository
      uses: actions/checkout@v4
      with:
        repository: ${{ github.event.inputs.target_repo }}
        token: ${{ secrets.Mozi9_PAT }}
        ref: ${{ github.event.inputs.target_branch }}
        fetch-depth: 0

    - name: Setup Mozi9 Git identity
      run: |
        git config --global user.name "mozi9"
        git config --global user.email "mozi9"
        echo "Git identity: mozi9 <mozi9>"

    - name: Add source repository
      id: add_source
      run: |
        echo "æ·»åŠ æºä»“åº“..."
        SOURCE_REPO="${{ github.event.inputs.source_repo }}"
        SOURCE_BRANCH="${{ github.event.inputs.source_branch }}"
        
        if [ -z "$SOURCE_BRANCH" ]; then
          echo "ä½¿ç”¨æºä»“åº“é»˜è®¤åˆ†æ”¯"
          git remote add source-repo https://github.com/$SOURCE_REPO.git
          git fetch source-repo
        else
          echo "ä½¿ç”¨æºä»“åº“åˆ†æ”¯: $SOURCE_BRANCH"
          git remote add source-repo https://github.com/$SOURCE_REPO.git
          git fetch source-repo $SOURCE_BRANCH
        fi
        echo "âœ… æºä»“åº“æ·»åŠ å®Œæˆ"

    - name: Parse and validate commit hashes
      id: parse_commits
      run: |
        echo "è§£ææäº¤å“ˆå¸Œ..."
        COMMIT_HASHES=$(echo '${{ github.event.inputs.commit_hashes }}' | tr -d '[:space:]' | tr ',' ' ')
        
        VALID_COMMITS=()
        INVALID_COMMITS=()
        
        for hash in $COMMIT_HASHES; do
          if git rev-parse --verify "$hash" >/dev/null 2>&1; then
            COMMIT_SUBJECT=$(git log -1 --format="%s" "$hash")
            COMMIT_AUTHOR=$(git log -1 --format="%an <%ae>" "$hash")
            echo "âœ… æäº¤æœ‰æ•ˆ: $hash - $COMMIT_SUBJECT"
            echo "   åŸå§‹ä½œè€…: $COMMIT_AUTHOR"
            VALID_COMMITS+=("$hash")
          else
            echo "âŒ æäº¤æ— æ•ˆ: $hash"
            INVALID_COMMITS+=("$hash")
          fi
        done
        
        if [ ${#VALID_COMMITS[@]} -eq 0 ]; then
          echo "âŒ é”™è¯¯: æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„æäº¤"
          exit 1
        fi
        
        MAX_COMMITS=${{ github.event.inputs.max_commits }}
        if [ ${#VALID_COMMITS[@]} -gt $MAX_COMMITS ]; then
          echo "âš ï¸ æäº¤æ•°é‡ ${#VALID_COMMITS[@]} è¶…è¿‡æœ€å¤§é™åˆ¶ $MAX_COMMITS"
          VALID_COMMITS=("${VALID_COMMITS[@]:0:$MAX_COMMITS}")
        fi
        
        printf "%s\n" "${VALID_COMMITS[@]}" > /tmp/valid_commits.txt
        echo "commit_count=${#VALID_COMMITS[@]}" >> $GITHUB_OUTPUT
        echo "ğŸ“Š å°†å¤„ç† ${#VALID_COMMITS[@]} ä¸ªæœ‰æ•ˆæäº¤"

    - name: Create sync branch
      id: create_branch
      run: |
        echo "åˆ›å»ºåŒæ­¥åˆ†æ”¯..."
        SYNC_BRANCH="sync-$(date +%s)"
        git checkout -b "$SYNC_BRANCH"
        echo "branch_name=$SYNC_BRANCH" >> $GITHUB_OUTPUT
        echo "âœ… åˆ†æ”¯åˆ›å»º: $SYNC_BRANCH"

    - name: Apply commits with mozi9 author only
      id: apply_commits
      run: |
        echo "åº”ç”¨æäº¤ï¼ˆä»…ä½¿ç”¨ mozi9 ä½œè€…ï¼‰..."
        COMMITS=$(cat /tmp/valid_commits.txt)
        APPLIED_COUNT=0
        
        for COMMIT in $COMMITS; do
          echo "å¤„ç†æäº¤: $COMMIT"
          
          # è·å–åŸå§‹æäº¤ä¿¡æ¯
          COMMIT_MSG=$(git log -1 --format=%B "$COMMIT")
          ORIG_AUTHOR=$(git log -1 --format="%an <%ae>" "$COMMIT")
          CO_AUTHORS=$(git log -1 --format="%(trailers:key=Co-authored-by)" "$COMMIT" 2>/dev/null || true)
          
          echo "åŸå§‹ä½œè€…: $ORIG_AUTHOR"
          if [ -n "$CO_AUTHORS" ]; then
            echo "åä½œä½œè€…: $CO_AUTHORS"
          fi
          
          # åº”ç”¨æäº¤
          set +e
          git cherry-pick "$COMMIT" >/dev/null 2>&1
          CHERRY_PICK_RESULT=$?
          set -e
          
          if [ $CHERRY_PICK_RESULT -eq 0 ]; then
            # æ¸…ç†æ‰€æœ‰ä½œè€…ä¿¡æ¯
            CLEAN_MSG=$(echo "$COMMIT_MSG" | grep -v -E "(Co-authored-by|Reviewed-by|Signed-off-by|Acked-by|Tested-by):")
            
            # åˆ›å»ºä»…åŒ…å« mozi9 ä½œè€…çš„æäº¤
            git commit --amend --author="mozi9 <mozi9>" -m "$CLEAN_MSG"
            echo "âœ… æäº¤åº”ç”¨æˆåŠŸ"
          else
            echo "âš ï¸ æ£€æµ‹åˆ°å†²çªï¼Œä½¿ç”¨æºæ–‡ä»¶è§£å†³..."
            
            # ä½¿ç”¨æºæ–‡ä»¶è¦†ç›–å†²çª
            CONFLICT_FILES=$(git diff --name-only --diff-filter=U 2>/dev/null || true)
            for file in $CONFLICT_FILES; do
              git show "$COMMIT":"$file" > "$file" 2>/dev/null || true
            done
            
            git add .
            git cherry-pick --continue
            git commit --amend --author="mozi9 <mozi9>" --no-edit
            echo "âœ… å†²çªè§£å†³ï¼Œæäº¤åº”ç”¨æˆåŠŸ"
          fi
          
          APPLIED_COUNT=$((APPLIED_COUNT + 1))
          
          # æ˜¾ç¤ºæäº¤ç»Ÿè®¡
          COMMIT_STATS=$(git log -1 --oneline --stat)
          echo "æäº¤ç»Ÿè®¡: $COMMIT_STATS"
        done
        
        echo "applied_count=$APPLIED_COUNT" >> $GITHUB_OUTPUT
        echo "ğŸ“Š æˆåŠŸåº”ç”¨ $APPLIED_COUNT ä¸ªæäº¤"

    - name: Merge to target branch
      id: merge_branch
      run: |
        echo "åˆå¹¶åˆ°ç›®æ ‡åˆ†æ”¯..."
        TARGET_BRANCH="${{ github.event.inputs.target_branch }}"
        SYNC_BRANCH="${{ steps.create_branch.outputs.branch_name }}"
        
        echo "ç›®æ ‡åˆ†æ”¯: $TARGET_BRANCH"
        echo "åŒæ­¥åˆ†æ”¯: $SYNC_BRANCH"
        
        # åˆ‡æ¢å›ç›®æ ‡åˆ†æ”¯
        git checkout "$TARGET_BRANCH"
        
        # æ£€æŸ¥åŒæ­¥åˆ†æ”¯æ˜¯å¦å­˜åœ¨
        if ! git show-ref --verify --quiet refs/heads/"$SYNC_BRANCH"; then
          echo "âŒ é”™è¯¯: åŒæ­¥åˆ†æ”¯ $SYNC_BRANCH ä¸å­˜åœ¨"
          exit 1
        fi
        
        # æ‰§è¡Œåˆå¹¶
        git merge --no-ff -m "${{ github.event.inputs.commit_message }}" "$SYNC_BRANCH"
        
        # ä¿®æ”¹åˆå¹¶æäº¤çš„ä½œè€…
        git commit --amend --author="mozi9 <mozi9>" --no-edit
        echo "âœ… åˆå¹¶å®Œæˆ"

    - name: Verify final state
      id: verify_state
      run: |
        echo "éªŒè¯æœ€ç»ˆçŠ¶æ€..."
        echo "å½“å‰åˆ†æ”¯: $(git branch --show-current)"
        echo "æœ€æ–°æäº¤:"
        git log -1 --oneline
        echo "æ–‡ä»¶çŠ¶æ€:"
        git status --short
        echo "âœ… çŠ¶æ€éªŒè¯å®Œæˆ"

    - name: Generate final report
      run: |
        echo ""
        echo "ğŸ‰ å®Œå®Œæ•´æ•´çš„æºæäº¤åŒæ­¥å®Œæˆ!"
        echo "=========================================="
        echo "ğŸ“Š æ‰§è¡ŒæŠ¥å‘Š:"
        echo "  æºä»“åº“: ${{ github.event.inputs.source_repo }}"
        echo "  ç›®æ ‡ä»“åº“: ${{ github.event.inputs.target_repo }}"
        echo "  ç›®æ ‡åˆ†æ”¯: ${{ github.event.inputs.target_branch }}"
        echo "  å¤„ç†æäº¤: ${{ steps.parse_commits.outputs.commit_count }} ä¸ª"
        echo "  æˆåŠŸåº”ç”¨: ${{ steps.apply_commits.outputs.applied_count }} ä¸ª"
        echo ""
        echo "âœ… ä¿è¯ä¸æºæäº¤å®Œå…¨ä¸€è‡´:"
        echo "  - ç›¸åŒçš„æ–‡ä»¶å†…å®¹"
        echo "  - ç›¸åŒçš„æ–‡ä»¶ç»“æ„" 
        echo "  - ç›¸åŒçš„åˆ é™¤æ“ä½œ"
        echo "  - ç›¸åŒçš„æäº¤ä¿¡æ¯"
        echo "  - ä»…ä½œè€…ä¿¡æ¯æ”¹ä¸º mozi9"
        echo ""
        echo "âœ… ä½œè€…ä¿¡æ¯å¤„ç†:"
        echo "  - ç§»é™¤æ‰€æœ‰åŸå§‹ä½œè€…ä¿¡æ¯"
        echo "  - ç§»é™¤æ‰€æœ‰ Co-authored-by ä¿¡æ¯"
        echo "  - ç§»é™¤æ‰€æœ‰ Reviewed-by ä¿¡æ¯"
        echo "  - ç§»é™¤æ‰€æœ‰ Signed-off-by ä¿¡æ¯"
        echo "  - ç»Ÿä¸€ä½¿ç”¨ mozi9 <mozi9>"
        echo ""
        echo "ğŸ‘¤ æ“ä½œèº«ä»½: mozi9 <mozi9>"
        echo "ğŸ”‘ ä½¿ç”¨ä»¤ç‰Œ: Mozi9_PAT"
        echo ""
        echo "â° å®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "=========================================="
        echo ""
        echo "ğŸ“ ä¸‹ä¸€æ­¥æ“ä½œ:"
        echo "  å¦‚éœ€æ¨é€ï¼Œè¯·æ‰‹åŠ¨æ‰§è¡Œ: git push"
        echo "  å¦‚éœ€æŸ¥çœ‹å·®å¼‚ï¼Œè¯·æ‰§è¡Œ: git log --oneline -10"
        echo "  å¦‚éœ€æ’¤é”€ï¼Œè¯·æ‰§è¡Œ: git reset --hard HEAD~1"

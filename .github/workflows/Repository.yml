name: Exact Source Commit Sync - Mozi9

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: 'æºä»“åº“åœ°å€ (æ ¼å¼: owner/repo)'
        required: true
        default: 'mozi9/source-repo'
      source_branch:
        description: 'æºåˆ†æ”¯å (ç•™ç©ºä½¿ç”¨é»˜è®¤åˆ†æ”¯)'
        required: false
        default: ''
      target_repo:
        description: 'ç›®æ ‡ä»“åº“åœ°å€ (æ ¼å¼: owner/repo)'
        required: true
        default: 'mozi9/target-repo'
      target_branch:
        description: 'ç›®æ ‡åˆ†æ”¯å'
        required: true
        default: 'main'
      commit_hashes:
        description: 'è¦åŒæ­¥çš„æäº¤å“ˆå¸Œï¼ˆå¤šä¸ªç”¨é€—å·åˆ†éš”ï¼‰'
        required: true
        default: ''
      commit_message:
        description: 'åˆå¹¶æäº¤ä¿¡æ¯'
        required: true
        default: 'sync: åŒæ­¥æäº¤'
      max_commits:
        description: 'æœ€å¤§åŒæ­¥æäº¤æ•°é‡'
        required: true
        default: '20'

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  exact-sync:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout target repository
      uses: actions/checkout@v4
      with:
        repository: ${{ github.event.inputs.target_repo }}
        token: ${{ secrets.Mozi9_PAT }}
        ref: ${{ github.event.inputs.target_branch }}
        fetch-depth: 0

    - name: Setup Mozi9 Git identity
      run: |
        git config --global user.name "mozi9"
        git config --global user.email "mozi9"
        echo "Git identity: mozi9 <mozi9>"

    - name: Add source repository
      run: |
        echo "æ·»åŠ æºä»“åº“..."
        SOURCE_REPO="${{ github.event.inputs.source_repo }}"
        SOURCE_BRANCH="${{ github.event.inputs.source_branch }}"
        
        if [ -z "$SOURCE_BRANCH" ]; then
          git remote add source-repo https://github.com/$SOURCE_REPO.git
          git fetch source-repo
        else
          git remote add source-repo https://github.com/$SOURCE_REPO.git
          git fetch source-repo $SOURCE_BRANCH
        fi
        echo "âœ… æºä»“åº“æ·»åŠ å®Œæˆ"

    - name: Parse and validate commit hashes
      id: parse_commits
      run: |
        echo "è§£ææäº¤å“ˆå¸Œ..."
        COMMIT_HASHES=$(echo '${{ github.event.inputs.commit_hashes }}' | tr -d '[:space:]' | tr ',' ' ')
        
        VALID_COMMITS=()
        for hash in $COMMIT_HASHES; do
          if git rev-parse --verify "$hash" >/dev/null 2>&1; then
            COMMIT_SUBJECT=$(git log -1 --format="%s" "$hash")
            echo "âœ… æäº¤æœ‰æ•ˆ: $hash - $COMMIT_SUBJECT"
            VALID_COMMITS+=("$hash")
          else
            echo "âŒ æäº¤æ— æ•ˆ: $hash"
          fi
        done
        
        if [ ${#VALID_COMMITS[@]} -eq 0 ]; then
          echo "âŒ é”™è¯¯: æ²¡æœ‰æœ‰æ•ˆçš„æäº¤"
          exit 1
        fi
        
        MAX_COMMITS=${{ github.event.inputs.max_commits }}
        if [ ${#VALID_COMMITS[@]} -gt $MAX_COMMITS ]; then
          VALID_COMMITS=("${VALID_COMMITS[@]:0:$MAX_COMMITS}")
        fi
        
        printf "%s\n" "${VALID_COMMITS[@]}" > /tmp/valid_commits.txt
        echo "commit_count=${#VALID_COMMITS[@]}" >> $GITHUB_OUTPUT
        echo "ğŸ“Š å°†å¤„ç† ${#VALID_COMMITS[@]} ä¸ªæäº¤"

    - name: Create sync branch
      id: create_branch
      run: |
        echo "åˆ›å»ºåŒæ­¥åˆ†æ”¯..."
        SYNC_BRANCH="sync-$(date +%s)"
        git checkout -b "$SYNC_BRANCH"
        echo "branch_name=$SYNC_BRANCH" >> $GITHUB_OUTPUT
        echo "âœ… åˆ†æ”¯åˆ›å»º: $SYNC_BRANCH"

    - name: Apply source commits exactly
      id: apply_commits
      run: |
        echo "åº”ç”¨æºæäº¤..."
        COMMITS=$(cat /tmp/valid_commits.txt)
        APPLIED_COUNT=0
        
        for COMMIT in $COMMITS; do
          echo "å¤„ç†æäº¤: $COMMIT"
          
          # è·å–åŸå§‹æäº¤ä¿¡æ¯
          COMMIT_MSG=$(git log -1 --format=%B "$COMMIT")
          echo "æäº¤ä¿¡æ¯: $COMMIT_MSG"
          
          # ä½¿ç”¨cherry-pickåº”ç”¨æäº¤
          set +e
          git cherry-pick "$COMMIT" >/dev/null 2>&1
          RESULT=$?
          set -e
          
          if [ $RESULT -eq 0 ]; then
            # ä»…ä¿®æ”¹ä½œè€…ï¼Œä¿æŒå…¶ä»–æ‰€æœ‰å†…å®¹ä¸å˜
            git commit --amend --author="mozi9 <mozi9>" --no-edit
            APPLIED_COUNT=$((APPLIED_COUNT + 1))
            echo "âœ… æäº¤åº”ç”¨æˆåŠŸ"
          else
            echo "âŒ æäº¤åº”ç”¨å¤±è´¥ï¼Œå°è¯•è§£å†³å†²çª..."
            # å†²çªæ—¶ä½¿ç”¨æºæ–‡ä»¶
            git checkout --theirs . 2>/dev/null || true
            git add .
            git cherry-pick --continue
            git commit --amend --author="mozi9 <mozi9>" --no-edit
            APPLIED_COUNT=$((APPLIED_COUNT + 1))
            echo "âœ… å†²çªè§£å†³ï¼Œæäº¤åº”ç”¨æˆåŠŸ"
          fi
        done
        
        echo "applied_count=$APPLIED_COUNT" >> $GITHUB_OUTPUT
        echo "ğŸ“Š æˆåŠŸåº”ç”¨ $APPLIED_COUNT ä¸ªæäº¤"

    - name: Get current branch name
      id: get_branch
      run: |
        CURRENT_BRANCH=$(git branch --show-current)
        echo "current_branch=$CURRENT_BRANCH" >> $GITHUB_OUTPUT
        echo "å½“å‰åˆ†æ”¯: $CURRENT_BRANCH"

    - name: Merge to target branch
      id: merge_branch
      run: |
        echo "åˆå¹¶åˆ°ç›®æ ‡åˆ†æ”¯..."
        TARGET_BRANCH="${{ github.event.inputs.target_branch }}"
        SYNC_BRANCH="${{ steps.get_branch.outputs.current_branch }}"
        
        echo "ç›®æ ‡åˆ†æ”¯: $TARGET_BRANCH"
        echo "åŒæ­¥åˆ†æ”¯: $SYNC_BRANCH"
        
        # åˆ‡æ¢å›ç›®æ ‡åˆ†æ”¯
        git checkout "$TARGET_BRANCH"
        
        # æ£€æŸ¥åŒæ­¥åˆ†æ”¯æ˜¯å¦å­˜åœ¨
        if ! git show-ref --verify --quiet refs/heads/"$SYNC_BRANCH"; then
          echo "âŒ é”™è¯¯: åŒæ­¥åˆ†æ”¯ $SYNC_BRANCH ä¸å­˜åœ¨"
          exit 1
        fi
        
        # æ‰§è¡Œåˆå¹¶
        git merge --no-ff -m "${{ github.event.inputs.commit_message }}" "$SYNC_BRANCH"
        
        # ä¿®æ”¹åˆå¹¶æäº¤çš„ä½œè€…
        git commit --amend --author="mozi9 <mozi9>" --no-edit
        echo "âœ… åˆå¹¶å®Œæˆ"

    - name: Push changes
      id: push_changes
      run: |
        echo "æ¨é€å˜æ›´..."
        TARGET_REPO="${{ github.event.inputs.target_repo }}"
        TARGET_BRANCH="${{ github.event.inputs.target_branch }}"
        
        # å…ˆæ‹‰å–æœ€æ–°å˜æ›´
        git pull https://mozi9:${{ secrets.Mozi9_PAT }}@github.com/$TARGET_REPO.git $TARGET_BRANCH --allow-unrelated-histories --no-edit -Xtheirs
        
        # å¼ºåˆ¶æ¨é€
        git push https://mozi9:${{ secrets.Mozi9_PAT }}@github.com/$TARGET_REPO.git $TARGET_BRANCH --force
        echo "âœ… æ¨é€å®Œæˆ"

    - name: Cleanup
      run: |
        echo "æ¸…ç†ä¸´æ—¶åˆ†æ”¯..."
        SYNC_BRANCH="${{ steps.get_branch.outputs.current_branch }}"
        if [ -n "$SYNC_BRANCH" ]; then
          git branch -D "$SYNC_BRANCH" 2>/dev/null || true
        fi
        echo "âœ… æ¸…ç†å®Œæˆ"

    - name: Generate report
      run: |
        echo ""
        echo "ğŸ‰ ç²¾ç¡®åŒæ­¥å®Œæˆ!"
        echo "=========================================="
        echo "ğŸ“Š æ‰§è¡ŒæŠ¥å‘Š:"
        echo "  æºä»“åº“: ${{ github.event.inputs.source_repo }}"
        echo "  ç›®æ ‡ä»“åº“: ${{ github.event.inputs.target_repo }}"
        echo "  ç›®æ ‡åˆ†æ”¯: ${{ github.event.inputs.target_branch }}"
        echo "  å¤„ç†æäº¤: ${{ steps.parse_commits.outputs.commit_count }} ä¸ª"
        echo "  æˆåŠŸåº”ç”¨: ${{ steps.apply_commits.outputs.applied_count }} ä¸ª"
        echo ""
        echo "âœ… ä¿è¯ä¸æºæäº¤å®Œå…¨ä¸€è‡´:"
        echo "  - ç›¸åŒçš„æ–‡ä»¶å†…å®¹"
        echo "  - ç›¸åŒçš„æ–‡ä»¶ç»“æ„"
        echo "  - ç›¸åŒçš„æäº¤ä¿¡æ¯"
        echo "  - ä»…ä½œè€…ä¿¡æ¯æ”¹ä¸º mozi9"
        echo ""
        echo "ğŸ‘¤ æ“ä½œèº«ä»½: mozi9 <mozi9>"
        echo "â° å®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "=========================================="

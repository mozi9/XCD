name: Manual Repository Sync - Mozi9

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: 'æºä»“åº“åœ°å€ (æ ¼å¼: owner/repo)'
        required: true
        default: 'mozi9/source-repo'
      source_branch:
        description: 'æºåˆ†æ”¯å (ç•™ç©ºä½¿ç”¨é»˜è®¤åˆ†æ”¯)'
        required: false
        default: ''
      target_repo:
        description: 'ç›®æ ‡ä»“åº“åœ°å€ (æ ¼å¼: owner/repo)'
        required: true
        default: 'mozi9/target-repo'
      target_branch:
        description: 'ç›®æ ‡åˆ†æ”¯å'
        required: true
        default: 'main'
      commit_hashes:
        description: 'è¦åŒæ­¥çš„æäº¤å“ˆå¸Œï¼ˆå¤šä¸ªç”¨é€—å·åˆ†éš”ï¼‰'
        required: true
        default: ''
      commit_name:
        description: 'åˆå¹¶æäº¤å'
        required: true
        default: 'sync: åŒæ­¥æäº¤'
      commit_description:
        description: 'åˆå¹¶æäº¤æè¿°ï¼ˆå¯é€‰ï¼‰'
        required: false
        default: ''
      delete_message:
        description: 'åˆ é™¤æ–‡ä»¶æäº¤ä¿¡æ¯'
        required: true
        default: 'delete: åˆ é™¤æ–‡ä»¶'
      max_commits:
        description: 'æœ€å¤§åŒæ­¥æäº¤æ•°é‡'
        required: true
        default: '20'

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  sync-repository:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout target repository
      uses: actions/checkout@v4
      with:
        repository: ${{ github.event.inputs.target_repo }}
        token: ${{ secrets.Mozi9_PAT }}
        ref: ${{ github.event.inputs.target_branch }}
        fetch-depth: 0

    - name: Setup Mozi9 Git identity
      run: |
        git config --global user.name "mozi9"
        git config --global user.email "mozi9"
        git config --global push.default simple
        echo "Git identity: mozi9 <mozi9>"

    - name: Add source repository
      id: add_source
      run: |
        echo "æ·»åŠ æºä»“åº“..."
        SOURCE_REPO="${{ github.event.inputs.source_repo }}"
        SOURCE_BRANCH="${{ github.event.inputs.source_branch }}"
        
        if [ -z "$SOURCE_BRANCH" ]; then
          echo "ä½¿ç”¨æºä»“åº“é»˜è®¤åˆ†æ”¯"
          git remote add source-repo https://github.com/$SOURCE_REPO.git
          git fetch source-repo
        else
          echo "ä½¿ç”¨æºä»“åº“åˆ†æ”¯: $SOURCE_BRANCH"
          git remote add source-repo https://github.com/$SOURCE_REPO.git
          git fetch source-repo $SOURCE_BRANCH
        fi
        echo "âœ… æºä»“åº“æ·»åŠ å®Œæˆ"

    - name: Parse and validate commit hashes
      id: parse_commits
      run: |
        echo "è§£ææäº¤å“ˆå¸Œ..."
        COMMIT_HASHES=$(echo '${{ github.event.inputs.commit_hashes }}' | tr -d '[:space:]' | tr ',' ' ')
        
        VALID_COMMITS=()
        for hash in $COMMIT_HASHES; do
          if git rev-parse --verify "$hash" >/dev/null 2>&1; then
            VALID_COMMITS+=("$hash")
            echo "âœ… æäº¤æœ‰æ•ˆ: $hash"
          else
            echo "âŒ æäº¤æ— æ•ˆ: $hash"
          fi
        done
        
        if [ ${#VALID_COMMITS[@]} -eq 0 ]; then
          echo "âŒ é”™è¯¯: æ²¡æœ‰æœ‰æ•ˆçš„æäº¤"
          exit 1
        fi
        
        MAX_COMMITS=${{ github.event.inputs.max_commits }}
        if [ ${#VALID_COMMITS[@]} -gt $MAX_COMMITS ]; then
          echo "âš ï¸ æäº¤æ•°é‡è¶…è¿‡é™åˆ¶ï¼Œåªå¤„ç†å‰ $MAX_COMMITS ä¸ª"
          VALID_COMMITS=("${VALID_COMMITS[@]:0:$MAX_COMMITS}")
        fi
        
        printf "%s\n" "${VALID_COMMITS[@]}" > /tmp/valid_commits.txt
        echo "commit_count=${#VALID_COMMITS[@]}" >> $GITHUB_OUTPUT
        echo "ğŸ“Š å°†å¤„ç† ${#VALID_COMMITS[@]} ä¸ªæäº¤"

    - name: Collect files marked for deletion
      id: collect_deleted
      run: |
        echo "æ”¶é›†åˆ é™¤æ–‡ä»¶æ ‡è®°..."
        COMMITS=$(cat /tmp/valid_commits.txt)
        DELETED_FILES=""
        
        for COMMIT in $COMMITS; do
          set +e
          DELETED_IN_COMMIT=$(git show "$COMMIT" --name-only --diff-filter=D --format= 2>/dev/null)
          set -e
          if [ -n "$DELETED_IN_COMMIT" ]; then
            DELETED_FILES="$DELETED_FILES"$'\n'"$DELETED_IN_COMMIT"
          fi
        done
        
        if [ -n "$DELETED_FILES" ]; then
          echo "$DELETED_FILES" | sort | uniq | grep -v '^$' > /tmp/deleted_files.txt
          DEL_COUNT=$(cat /tmp/deleted_files.txt | wc -l)
          echo "deleted_files_count=$DEL_COUNT" >> $GITHUB_OUTPUT
          echo "ğŸ“Š æ”¶é›†åˆ° $DEL_COUNT ä¸ªåˆ é™¤æ–‡ä»¶"
        else
          touch /tmp/deleted_files.txt
          echo "deleted_files_count=0" >> $GITHUB_OUTPUT
          echo "â„¹ï¸ æ²¡æœ‰åˆ é™¤æ–‡ä»¶æ ‡è®°"
        fi

    - name: Create sync branch
      id: create_branch
      run: |
        echo "åˆ›å»ºåŒæ­¥åˆ†æ”¯..."
        SYNC_BRANCH="sync-$(date +%s)"
        git checkout -b "$SYNC_BRANCH"
        echo "branch_name=$SYNC_BRANCH" >> $GITHUB_OUTPUT

    - name: Process commits one by one
      id: process_commits
      run: |
        echo "é€ä¸ªå¤„ç†æäº¤..."
        COMMITS=$(cat /tmp/valid_commits.txt)
        PROCESSED_COUNT=0
        
        for COMMIT in $COMMITS; do
          echo "å¤„ç†æäº¤: $COMMIT"
          
          # è·å–æäº¤ä¿¡æ¯
          COMMIT_MSG=$(git log -1 --format="%s" "$COMMIT")
          echo "æäº¤ä¿¡æ¯: $COMMIT_MSG"
          
          # è·å–æäº¤ä¸­çš„æ‰€æœ‰æ–‡ä»¶
          COMMIT_FILES=$(git show --name-only --format= "$COMMIT" 2>/dev/null | grep -v '^$' || true)
          
          # å¤åˆ¶æ‰€æœ‰æ–‡ä»¶ï¼ˆå¼ºåˆ¶è¦†ç›–ï¼‰
          for file in $COMMIT_FILES; do
            # è·³è¿‡åˆ é™¤æ ‡è®°çš„æ–‡ä»¶
            if grep -q "^$file$" /tmp/deleted_files.txt 2>/dev/null; then
              continue
            fi
            
            # åˆ›å»ºç›®å½•å¹¶å¤åˆ¶æ–‡ä»¶
            mkdir -p "$(dirname "$file")"
            git show "$COMMIT":"$file" > "$file" 2>/dev/null || echo "âš ï¸ æ— æ³•å¤åˆ¶: $file"
          done
          
          # æ·»åŠ æ‰€æœ‰æ–‡ä»¶
          git add -A
          
          # åˆ›å»ºæäº¤ï¼ˆä½¿ç”¨åŸå§‹æäº¤ä¿¡æ¯ï¼‰
          git commit -m "$COMMIT_MSG" --author="mozi9 <mozi9>"
          
          PROCESSED_COUNT=$((PROCESSED_COUNT + 1))
          echo "âœ… å®Œæˆæäº¤: $COMMIT"
        done
        
        echo "processed_count=$PROCESSED_COUNT" >> $GITHUB_OUTPUT
        echo "ğŸ“Š å¤„ç†å®Œæˆ: $PROCESSED_COUNT ä¸ªæäº¤"

    - name: Merge to target branch
      id: merge_branch
      run: |
        echo "åˆå¹¶åˆ°ç›®æ ‡åˆ†æ”¯..."
        git checkout ${{ github.event.inputs.target_branch }}
        
        # è·å–åŒæ­¥åˆ†æ”¯åç§°
        SYNC_BRANCH="${{ steps.create_branch.outputs.branch_name }}"
        
        # åˆå¹¶åˆ†æ”¯
        git merge --no-ff -m "${{ github.event.inputs.commit_name }}" "$SYNC_BRANCH"
        
        # ä¿®æ”¹ä½œè€…ä¿¡æ¯
        git commit --amend --author="mozi9 <mozi9>" --no-edit
        echo "âœ… åˆå¹¶å®Œæˆ"

    - name: Delete marked files
      id: delete_files
      run: |
        echo "åˆ é™¤æ ‡è®°æ–‡ä»¶..."
        DELETED_FILES=$(cat /tmp/deleted_files.txt 2>/dev/null || true)
        
        if [ -n "$DELETED_FILES" ]; then
          DEL_COUNT=0
          for file in $DELETED_FILES; do
            if [ -e "$file" ]; then
              git rm "$file" >/dev/null 2>&1 && DEL_COUNT=$((DEL_COUNT + 1)) || true
            fi
          done
          
          if [ $DEL_COUNT -gt 0 ]; then
            git commit -m "${{ github.event.inputs.delete_message }}" --author="mozi9 <mozi9>"
            echo "deleted_count=$DEL_COUNT" >> $GITHUB_OUTPUT
          else
            echo "deleted_count=0" >> $GITHUB_OUTPUT
          fi
        else
          echo "deleted_count=0" >> $GITHUB_OUTPUT
        fi

    - name: Push changes
      id: push_changes
      run: |
        echo "æ¨é€å˜æ›´..."
        TARGET_REPO="${{ github.event.inputs.target_repo }}"
        TARGET_BRANCH="${{ github.event.inputs.target_branch }}"
        
        # æ‹‰å–æœ€æ–°å˜æ›´
        git pull https://mozi9:${{ secrets.Mozi9_PAT }}@github.com/$TARGET_REPO.git $TARGET_BRANCH --allow-unrelated-histories --no-edit -Xtheirs
        
        # å¼ºåˆ¶æ¨é€
        git push https://mozi9:${{ secrets.Mozi9_PAT }}@github.com/$TARGET_REPO.git $TARGET_BRANCH --force
        echo "âœ… æ¨é€å®Œæˆ"

    - name: Cleanup
      run: |
        echo "æ¸…ç†ä¸´æ—¶åˆ†æ”¯..."
        SYNC_BRANCH="${{ steps.create_branch.outputs.branch_name }}"
        git branch -D "$SYNC_BRANCH" 2>/dev/null || true
        echo "âœ… æ¸…ç†å®Œæˆ"

    - name: Generate report
      run: |
        echo ""
        echo "ğŸ‰ åŒæ­¥å®Œæˆ!"
        echo "=========================================="
        echo "æºä»“åº“: ${{ github.event.inputs.source_repo }}"
        echo "ç›®æ ‡ä»“åº“: ${{ github.event.inputs.target_repo }}"
        echo "å¤„ç†æäº¤: ${{ steps.parse_commits.outputs.commit_count }} ä¸ª"
        echo "åˆ é™¤æ–‡ä»¶: ${{ steps.delete_files.outputs.deleted_count || 0 }} ä¸ª"
        echo "å®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "=========================================="

name: Cross Repository Sync

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: '源仓库地址 (格式: owner/repo)'
        required: true
        type: string
        default: 'mozi9/source-repo'
      source_branch:
        description: '源仓库分支'
        required: true
        type: string
        default: 'main'
      source_commits:
        description: '源提交哈希 (多个用逗号分隔，如: abc123,def456)'
        required: true
        type: string
      target_repo:
        description: '目标仓库地址 (格式: owner/repo)'
        required: true
        type: string
      target_branch:
        description: '目标仓库分支'
        required: true
        type: string
        default: 'main'
      new_author_name:
        description: '新作者名称'
        required: true
        type: string
        default: 'mozi9'
      new_author_email:
        description: '新作者邮箱'
        required: true
        type: string
        default: 'mozi9@example.com'
      commit_message:
        description: '提交信息'
        required: true
        type: string
        default: 'Sync commit from source repository'

jobs:
  sync-repository:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout current repository
        uses: actions/checkout@v4
        
      - name: Setup Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
      - name: Parse commit hashes
        id: parse_commits
        run: |
          INPUT_COMMITS="${{ github.event.inputs.source_commits }}"
          COUNT=0
          IFS=',' read -ra COMMIT_ARRAY <<< "$INPUT_COMMITS"
          
          for commit in "${COMMIT_ARRAY[@]}"; do
            COMMIT_CLEAN=$(echo "$commit" | xargs)
            if [ -n "$COMMIT_CLEAN" ]; then
              echo "commit_$COUNT=$COMMIT_CLEAN" >> $GITHUB_OUTPUT
              COUNT=$((COUNT + 1))
            fi
          done
          echo "commit_count=$COUNT" >> $GITHUB_OUTPUT
          
      - name: Setup target repository
        run: |
          git clone https://${{ secrets.Mozi9_PAT }}@github.com/${{ github.event.inputs.target_repo }}.git target-repo
          cd target-repo
          git checkout ${{ github.event.inputs.target_branch }} || git checkout -b ${{ github.event.inputs.target_branch }}
          
      - name: Add source remote
        run: |
          cd target-repo
          git remote add source https://github.com/${{ github.event.inputs.source_repo }}.git
          git fetch source ${{ github.event.inputs.source_branch }}
          
      - name: Sync single commit
        if: ${{ steps.parse_commits.outputs.commit_count == '1' }}
        run: |
          cd target-repo
          COMMIT_HASH=${{ steps.parse_commits.outputs.commit_0 }}
          
          git cherry-pick "$COMMIT_HASH" --no-commit || {
            git status --porcelain | while read -r line; do
              if [ -n "$line" ]; then
                STATUS="${line:0:2}"
                FILE_PATH="${line:3}"
                case "$STATUS" in
                  "UU"|"AA"|"DD")
                    [ -f "$FILE_PATH" ] && git checkout --ours "$FILE_PATH" && git add "$FILE_PATH"
                    ;;
                  " D")
                    [ -f "$FILE_PATH" ] && git rm "$FILE_PATH"
                    ;;
                esac
              fi
            done
          }
          
          git add -A
          git commit -m "${{ github.event.inputs.commit_message }} [$COMMIT_HASH]" \
            --author="${{ github.event.inputs.new_author_name }} <${{ github.event.inputs.new_author_email }}>" \
            --allow-empty --keep-redundant-commits
            
      - name: Sync multiple commits
        if: ${{ steps.parse_commits.outputs.commit_count > '1' }}
        run: |
          cd target-repo
          TOTAL=${{ steps.parse_commits.outputs.commit_count }}
          
          for ((i=0; i<TOTAL; i++)); do
            COMMIT_HASH=${{ steps.parse_commits.outputs['commit_'$i] }}
            
            git cherry-pick "$COMMIT_HASH" --no-commit || {
              git status --porcelain | while read -r line; do
                if [ -n "$line" ]; then
                  STATUS="${line:0:2}"
                  FILE_PATH="${line:3}"
                  case "$STATUS" in
                    "UU"|"AA"|"DD")
                      [ -f "$FILE_PATH" ] && git checkout --ours "$FILE_PATH" && git add "$FILE_PATH"
                      ;;
                    " D")
                      [ -f "$FILE_PATH" ] && git rm "$FILE_PATH"
                      ;;
                  esac
                fi
              done
            }
            
            git add -A
            git commit -m "${{ github.event.inputs.commit_message }} [$COMMIT_HASH]" \
              --author="${{ github.event.inputs.new_author_name }} <${{ github.event.inputs.new_author_email }}>" \
              --allow-empty --keep-redundant-commits
          done
          
      - name: Push changes
        run: |
          cd target-repo
          git push origin ${{ github.event.inputs.target_branch }}
          
      - name: Cleanup
        if: always()
        run: rm -rf target-repo
        
      - name: Summary
        run: |
          echo "Sync completed: ${{ steps.parse_commits.outputs.commit_count }} commits"
          echo "Author: ${{ github.event.inputs.new_author_name }}"
